# =============================================================================
# SHERLOCK_SKY_3DSIM - ê°€ìƒ ê³µì¥ ì‹œë®¬ë ˆì´ì…˜ í™˜ê²½
# =============================================================================
# 3ê°œ ê³µì¥ (ì¤‘êµ­, ë² íŠ¸ë‚¨, í•œêµ­)ì˜ MSSQL ë°ì´í„°ë² ì´ìŠ¤ë¥¼ Dockerë¡œ êµ¬í˜„
# 
# ì‚¬ìš©ë²•:
#   ì‹œì‘: docker compose up -d
#   ì¤‘ì§€: docker compose down
#   ë¡œê·¸: docker compose logs -f
#   ìƒíƒœ: docker compose ps
# =============================================================================

services:
  # ===========================================================================
  # ğŸ‡¨ğŸ‡³ ì¤‘êµ­ ê³µì¥ ë°ì´í„°ë² ì´ìŠ¤ (118ëŒ€ ì„¤ë¹„)
  # ===========================================================================
  china-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: factory-china-db
    hostname: china-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD:-DockerTest123!}
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - china-db-data:/var/opt/mssql
      - ./database/init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - factory-network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${SA_PASSWORD:-DockerTest123!}" -Q "SELECT 1" || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ===========================================================================
  # ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ ê³µì¥ ë°ì´í„°ë² ì´ìŠ¤ (100ëŒ€ ì„¤ë¹„)
  # ===========================================================================
  vietnam-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: factory-vietnam-db
    hostname: vietnam-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD:-DockerTest123!}
      - MSSQL_PID=Developer
    ports:
      - "1434:1433"
    volumes:
      - vietnam-db-data:/var/opt/mssql
      - ./database/init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - factory-network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${SA_PASSWORD:-DockerTest123!}" -Q "SELECT 1" || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ===========================================================================
  # ğŸ‡°ğŸ‡· í•œêµ­ ê³µì¥ ë°ì´í„°ë² ì´ìŠ¤ (150ëŒ€ ì„¤ë¹„)
  # ===========================================================================
  korea-db:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: factory-korea-db
    hostname: korea-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD:-DockerTest123!}
      - MSSQL_PID=Developer
    ports:
      - "1435:1433"
    volumes:
      - korea-db-data:/var/opt/mssql
      - ./database/init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - factory-network
    healthcheck:
      test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "${SA_PASSWORD:-DockerTest123!}" -Q "SELECT 1" || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ===========================================================================
  # ğŸ¤– ì„¤ë¹„ ì‹œë®¬ë ˆì´í„° (ì˜µì…˜ - ë‚˜ì¤‘ì— í™œì„±í™”)
  # ===========================================================================
  # simulator:
  #   build:
  #     context: ./simulator
  #     dockerfile: Dockerfile
  #   container_name: equipment-simulator
  #   environment:
  #     - CHINA_DB_HOST=china-db
  #     - VIETNAM_DB_HOST=vietnam-db
  #     - KOREA_DB_HOST=korea-db
  #     - DB_PORT=1433
  #     - DB_USER=sa
  #     - DB_PASSWORD=${SA_PASSWORD:-DockerTest123!}
  #     - DB_NAME=SherlockSky
  #     - SIMULATION_INTERVAL=5
  #   depends_on:
  #     china-db:
  #       condition: service_healthy
  #     vietnam-db:
  #       condition: service_healthy
  #     korea-db:
  #       condition: service_healthy
  #   networks:
  #     - factory-network
  #   restart: unless-stopped

# =============================================================================
# ë„¤íŠ¸ì›Œí¬ ì„¤ì •
# =============================================================================
networks:
  factory-network:
    driver: bridge
    name: sherlock-factory-network

# =============================================================================
# ë³¼ë¥¨ ì„¤ì • (ë°ì´í„° ì˜ì†ì„±)
# =============================================================================
volumes:
  china-db-data:
    name: sherlock-china-db-data
  vietnam-db-data:
    name: sherlock-vietnam-db-data
  korea-db-data:
    name: sherlock-korea-db-data