<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4.4 Test - SceneManager & LayoutEditorMain Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* ì™¼ìª½: 3D Viewer */
        .viewer-panel {
            flex: 1;
            position: relative;
            background: #0f0f1a;
        }
        
        #viewer-container {
            width: 100%;
            height: 100%;
        }
        
        #viewer-container canvas {
            display: block;
        }
        
        /* ì˜¤ë¥¸ìª½: í…ŒìŠ¤íŠ¸ íŒ¨ë„ */
        .test-panel {
            width: 400px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #0f3460;
        }
        
        h1 {
            font-size: 1.4em;
            color: #e94560;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #0f3460;
        }
        
        h2 {
            font-size: 1.1em;
            color: #00d9ff;
            margin: 20px 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        h2::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00d9ff;
            border-radius: 50%;
        }
        
        .test-group {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .test-group h3 {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin: 8px 0;
            background: #0f3460;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            text-align: left;
        }
        
        button:hover {
            background: #1a4a7a;
            transform: translateX(5px);
        }
        
        button:active {
            background: #e94560;
        }
        
        button.success {
            background: #2ecc71;
        }
        
        button.error {
            background: #e74c3c;
        }
        
        button.primary {
            background: #e94560;
            font-weight: bold;
        }
        
        button.primary:hover {
            background: #ff6b8a;
        }
        
        /* ìƒíƒœ í‘œì‹œ */
        .status-bar {
            background: #0a0a15;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 0.85em;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #1a1a2e;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            color: #888;
        }
        
        .status-value {
            font-weight: bold;
        }
        
        .status-value.connected {
            color: #2ecc71;
        }
        
        .status-value.disconnected {
            color: #e74c3c;
        }
        
        .status-value.pending {
            color: #f39c12;
        }
        
        /* ë¡œê·¸ ì˜ì—­ */
        .log-area {
            background: #0a0a15;
            border-radius: 6px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.8em;
            line-height: 1.6;
        }
        
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #1a1a2e;
        }
        
        .log-entry.info {
            color: #00d9ff;
        }
        
        .log-entry.success {
            color: #2ecc71;
        }
        
        .log-entry.error {
            color: #e74c3c;
        }
        
        .log-entry.warn {
            color: #f39c12;
        }
        
        .log-time {
            color: #666;
            margin-right: 10px;
        }
        
        /* ì…ë ¥ í•„ë“œ */
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .input-group input {
            flex: 1;
            padding: 8px 12px;
            background: #0a0a15;
            border: 1px solid #0f3460;
            border-radius: 4px;
            color: #fff;
            font-size: 0.9em;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #00d9ff;
        }
        
        .input-group label {
            display: block;
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        
        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #0f3460;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #loading-overlay.hidden {
            display: none;
        }
        
        /* ê²°ê³¼ í‘œì‹œ */
        .result-display {
            background: #0a0a15;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* ì²´í¬ë¦¬ìŠ¤íŠ¸ */
        .checklist {
            list-style: none;
            padding: 0;
        }
        
        .checklist li {
            padding: 8px 10px;
            margin: 5px 0;
            background: #1a1a2e;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checklist li.pass {
            border-left: 3px solid #2ecc71;
        }
        
        .checklist li.fail {
            border-left: 3px solid #e74c3c;
        }
        
        .checklist li.pending {
            border-left: 3px solid #f39c12;
        }
        
        .check-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .pass .check-icon {
            background: #2ecc71;
        }
        
        .fail .check-icon {
            background: #e74c3c;
        }
        
        .pending .check-icon {
            background: #f39c12;
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>Phase 4.4 í…ŒìŠ¤íŠ¸ í™˜ê²½ ë¡œë”© ì¤‘...</div>
    </div>

    <div class="container">
        <!-- 3D Viewer ì˜ì—­ -->
        <div class="viewer-panel">
            <div id="viewer-container"></div>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ íŒ¨ë„ -->
        <div class="test-panel">
            <h1>ğŸ§ª Phase 4.4 Integration Test</h1>
            <p style="color: #888; font-size: 0.85em; margin-bottom: 15px;">
                SceneManager â†” LayoutEditorMain í†µí•© í…ŒìŠ¤íŠ¸
            </p>
            
            <!-- ìƒíƒœ í‘œì‹œ -->
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-label">SceneManager</span>
                    <span class="status-value" id="status-scenemanager">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">EquipmentLoader</span>
                    <span class="status-value" id="status-equipmentloader">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">SM-EL ì—°ê²°</span>
                    <span class="status-value" id="status-sm-el-connection">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">LayoutEditorMain</span>
                    <span class="status-value" id="status-layouteditormain">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">LEM-SM ì—°ê²°</span>
                    <span class="status-value" id="status-lem-sm-connection">-</span>
                </div>
            </div>
            
            <!-- Test 1: ê¸°ë³¸ ì´ˆê¸°í™” -->
            <h2>1ï¸âƒ£ ê¸°ë³¸ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</h2>
            <div class="test-group">
                <h3>SceneManager ë° EquipmentLoader ì´ˆê¸°í™” í™•ì¸</h3>
                <button onclick="testInitialization()">ğŸ” ì´ˆê¸°í™” ìƒíƒœ í™•ì¸</button>
                <button onclick="testSetEquipmentLoader()">ğŸ”— setEquipmentLoader() í…ŒìŠ¤íŠ¸</button>
                <button onclick="testGetEquipmentLoader()">ğŸ“¦ getEquipmentLoader() í…ŒìŠ¤íŠ¸</button>
            </div>
            
            <!-- Test 2: Scene ì¡°ì‘ -->
            <h2>2ï¸âƒ£ Scene ì¡°ì‘ í…ŒìŠ¤íŠ¸</h2>
            <div class="test-group">
                <h3>clearScene() / rebuildScene() í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testClearScene()">ğŸ—‘ï¸ clearScene() ì‹¤í–‰</button>
                <button onclick="testRebuildScene()">ğŸ”„ rebuildScene() ì‹¤í–‰</button>
                <button onclick="testSceneChildrenCount()">ğŸ“Š Scene Children ìˆ˜ í™•ì¸</button>
            </div>
            
            <!-- Test 3: Layout ì ìš© -->
            <h2>3ï¸âƒ£ Layout ì ìš© í…ŒìŠ¤íŠ¸</h2>
            <div class="test-group">
                <h3>applyLayoutFull() ì „ì²´ í…ŒìŠ¤íŠ¸</h3>
                <button onclick="testApplyLayoutFull_Small()" class="primary">ğŸ  Small Layout (30Ã—40) ì ìš©</button>
                <button onclick="testApplyLayoutFull_Standard()">ğŸ­ Standard Layout (50Ã—70) ì ìš©</button>
                <button onclick="testApplyLayoutFull_Large()">ğŸ—ï¸ Large Layout (80Ã—100) ì ìš©</button>
            </div>
            
            <!-- Test 4: LayoutEditorMain ì—°ë™ -->
            <h2>4ï¸âƒ£ LayoutEditorMain ì—°ë™</h2>
            <div class="test-group">
                <h3>SceneManager ì—°ê²° ë° goTo3DViewer()</h3>
                <button onclick="testSetSceneManager()">ğŸ”— setSceneManager() í…ŒìŠ¤íŠ¸</button>
                <button onclick="testGoTo3DViewer()">ğŸš€ goTo3DViewer() ì‹œë®¬ë ˆì´ì…˜</button>
                <button onclick="testEventDispatch()">ğŸ“¡ ì´ë²¤íŠ¸ ë°œìƒ í…ŒìŠ¤íŠ¸</button>
            </div>
            
            <!-- Test 5: í†µí•© í…ŒìŠ¤íŠ¸ -->
            <h2>5ï¸âƒ£ í†µí•© í…ŒìŠ¤íŠ¸</h2>
            <div class="test-group">
                <h3>ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h3>
                <button onclick="runFullIntegrationTest()" class="primary">ğŸ¯ ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
                <button onclick="resetToDefault()">â†©ï¸ ê¸°ë³¸ ìƒíƒœë¡œ ë¦¬ì…‹</button>
            </div>
            
            <!-- í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
            <h2>ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
            <ul class="checklist" id="test-checklist">
                <li class="pending" id="check-init">
                    <span class="check-icon">?</span>
                    <span>ì´ˆê¸°í™” ì™„ë£Œ</span>
                </li>
                <li class="pending" id="check-sm-el">
                    <span class="check-icon">?</span>
                    <span>SM-EL ì—°ê²°</span>
                </li>
                <li class="pending" id="check-clear">
                    <span class="check-icon">?</span>
                    <span>clearScene() ë™ì‘</span>
                </li>
                <li class="pending" id="check-rebuild">
                    <span class="check-icon">?</span>
                    <span>rebuildScene() ë™ì‘</span>
                </li>
                <li class="pending" id="check-apply-layout">
                    <span class="check-icon">?</span>
                    <span>applyLayoutFull() ë™ì‘</span>
                </li>
                <li class="pending" id="check-lem-sm">
                    <span class="check-icon">?</span>
                    <span>LEM-SM ì—°ê²°</span>
                </li>
                <li class="pending" id="check-goto3d">
                    <span class="check-icon">?</span>
                    <span>goTo3DViewer() ë™ì‘</span>
                </li>
            </ul>
            
            <!-- ë¡œê·¸ ì˜ì—­ -->
            <h2>ğŸ“œ í…ŒìŠ¤íŠ¸ ë¡œê·¸</h2>
            <div class="log-area" id="log-area">
                <div class="log-entry info">
                    <span class="log-time">[--:--:--]</span>
                    í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘...
                </div>
            </div>
            
            <button onclick="clearLogs()" style="margin-top: 10px; background: #333;">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <!-- Three.js -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // ============================================
        // ì „ì—­ ë³€ìˆ˜
        // ============================================
        let scene, camera, renderer, controls;
        let sceneManager = null;
        let equipmentLoader = null;
        let layoutEditorMain = null;
        
        // Mock ê°ì²´ë“¤
        let mockRoomEnvironment = null;
        let equipmentGroup = null;
        
        // ============================================
        // ë¡œê·¸ í•¨ìˆ˜
        // ============================================
        window.log = function(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            
            // ì½˜ì†”ì—ë„ ì¶œë ¥
            const consoleMethod = type === 'error' ? console.error : 
                                  type === 'warn' ? console.warn : console.log;
            consoleMethod(`[Test] ${message}`);
        };
        
        window.clearLogs = function() {
            const logArea = document.getElementById('log-area');
            logArea.innerHTML = '<div class="log-entry info"><span class="log-time">[' + 
                new Date().toLocaleTimeString() + ']</span> ë¡œê·¸ ì´ˆê¸°í™”ë¨</div>';
        };
        
        // ============================================
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        // ============================================
        function updateStatus(id, value, className) {
            const elem = document.getElementById(id);
            if (elem) {
                elem.textContent = value;
                elem.className = 'status-value ' + className;
            }
        }
        
        function updateChecklist(id, pass) {
            const elem = document.getElementById(id);
            if (elem) {
                elem.className = pass ? 'pass' : 'fail';
                elem.querySelector('.check-icon').textContent = pass ? 'âœ“' : 'âœ—';
            }
        }
        
        // ============================================
        // Mock SceneManager í´ë˜ìŠ¤
        // ============================================
        class MockSceneManager {
            constructor() {
                this.scene = scene;
                this.camera = camera;
                this.renderer = renderer;
                this._equipmentLoader = null;
                this._isRebuilding = false;
                this._roomEnvironment = null;
                
                log('MockSceneManager ìƒì„±ë¨', 'success');
            }
            
            init() {
                log('SceneManager.init() í˜¸ì¶œë¨');
                return true;
            }
            
            render() {
                renderer.render(scene, camera);
            }
            
            // Phase 4.4: EquipmentLoader ì—°ê²°
            setEquipmentLoader(loader) {
                if (!loader) {
                    log('setEquipmentLoader: loaderê°€ nullì…ë‹ˆë‹¤', 'warn');
                    return;
                }
                this._equipmentLoader = loader;
                log('âœ… setEquipmentLoader() ì™„ë£Œ - EquipmentLoader ì—°ê²°ë¨', 'success');
            }
            
            getEquipmentLoader() {
                return this._equipmentLoader;
            }
            
            // Phase 4.4: Scene ì •ë¦¬
            clearScene() {
                log('clearScene() ì‹œì‘...', 'info');
                
                // Room Environment ì •ë¦¬
                if (mockRoomEnvironment) {
                    scene.remove(mockRoomEnvironment);
                    mockRoomEnvironment = null;
                    log('  - RoomEnvironment ì œê±°ë¨');
                }
                
                // Equipment ì •ë¦¬
                if (equipmentGroup) {
                    scene.remove(equipmentGroup);
                    equipmentGroup = null;
                    log('  - Equipment ì œê±°ë¨');
                }
                
                log('âœ… clearScene() ì™„ë£Œ', 'success');
                return true;
            }
            
            // Phase 4.4: Scene ì¬êµ¬ì¶•
            rebuildScene(roomParams, equipmentConfig, callback) {
                log('rebuildScene() ì‹œì‘...', 'info');
                log(`  - roomParams: ${JSON.stringify(roomParams)}`, 'info');
                
                this._isRebuilding = true;
                
                // Room ì¬ìƒì„±
                this._createMockRoom(roomParams);
                
                // Equipment ì¬ìƒì„±
                this._createMockEquipment(equipmentConfig);
                
                this._isRebuilding = false;
                
                log('âœ… rebuildScene() ì™„ë£Œ', 'success');
                
                // ì´ë²¤íŠ¸ ë°œìƒ
                window.dispatchEvent(new CustomEvent('scene-rebuilt', {
                    detail: { roomParams, equipmentConfig }
                }));
                
                if (callback) callback();
                return true;
            }
            
            // Phase 4.4: ì „ì²´ Layout ì ìš©
            applyLayoutFull(layoutData, options = {}) {
                log('applyLayoutFull() ì‹œì‘...', 'info');
                log(`  - layoutData.site_id: ${layoutData?.site_id}`, 'info');
                log(`  - options: ${JSON.stringify(options)}`, 'info');
                
                if (!layoutData) {
                    log('âŒ layoutDataê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return false;
                }
                
                try {
                    // 1. Scene ì •ë¦¬
                    if (options.clearFirst !== false) {
                        this.clearScene();
                    }
                    
                    // 2. Layoutì—ì„œ params ì¶”ì¶œ
                    const roomParams = {
                        roomWidth: layoutData.room?.width || 40,
                        roomDepth: layoutData.room?.depth || 60,
                        wallHeight: layoutData.room?.wallHeight || 4
                    };
                    
                    const equipmentConfig = {
                        rows: layoutData.equipmentArrays?.[0]?.rows || 26,
                        cols: layoutData.equipmentArrays?.[0]?.cols || 6
                    };
                    
                    // 3. Scene ì¬êµ¬ì¶•
                    this.rebuildScene(roomParams, equipmentConfig);
                    
                    log('âœ… applyLayoutFull() ì™„ë£Œ', 'success');
                    
                    // ì´ë²¤íŠ¸ ë°œìƒ
                    window.dispatchEvent(new CustomEvent('layout-full-applied', {
                        detail: { layoutData, success: true }
                    }));
                    
                    return true;
                    
                } catch (error) {
                    log(`âŒ applyLayoutFull ì‹¤íŒ¨: ${error.message}`, 'error');
                    return false;
                }
            }
            
            isRebuilding() {
                return this._isRebuilding;
            }
            
            getRoomEnvironment() {
                return mockRoomEnvironment;
            }
            
            // ë‚´ë¶€ í—¬í¼: Mock Room ìƒì„±
            _createMockRoom(params) {
                const width = params.roomWidth || 40;
                const depth = params.roomDepth || 60;
                const height = params.wallHeight || 4;
                
                mockRoomEnvironment = new THREE.Group();
                mockRoomEnvironment.name = 'RoomEnvironment';
                
                // ë°”ë‹¥
                const floorGeo = new THREE.PlaneGeometry(width, depth);
                const floorMat = new THREE.MeshStandardMaterial({ 
                    color: 0x404040,
                    roughness: 0.8
                });
                const floor = new THREE.Mesh(floorGeo, floorMat);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                mockRoomEnvironment.add(floor);
                
                // ë²½ (ê°„ë‹¨íˆ ë°•ìŠ¤ë¡œ)
                const wallMat = new THREE.MeshStandardMaterial({ 
                    color: 0x666666,
                    transparent: true,
                    opacity: 0.3
                });
                
                // ë’¤ìª½ ë²½
                const backWall = new THREE.Mesh(
                    new THREE.BoxGeometry(width, height, 0.2),
                    wallMat
                );
                backWall.position.set(0, height/2, -depth/2);
                mockRoomEnvironment.add(backWall);
                
                // ì¢Œìš° ë²½
                const sideWallGeo = new THREE.BoxGeometry(0.2, height, depth);
                const leftWall = new THREE.Mesh(sideWallGeo, wallMat);
                leftWall.position.set(-width/2, height/2, 0);
                mockRoomEnvironment.add(leftWall);
                
                const rightWall = new THREE.Mesh(sideWallGeo, wallMat);
                rightWall.position.set(width/2, height/2, 0);
                mockRoomEnvironment.add(rightWall);
                
                scene.add(mockRoomEnvironment);
                log(`  - Room ìƒì„±ë¨ (${width}Ã—${depth}Ã—${height})`);
            }
            
            // ë‚´ë¶€ í—¬í¼: Mock Equipment ìƒì„±
            _createMockEquipment(config) {
                const rows = config?.rows || 26;
                const cols = config?.cols || 6;
                
                equipmentGroup = new THREE.Group();
                equipmentGroup.name = 'EquipmentGroup';
                
                const eqGeo = new THREE.BoxGeometry(1.2, 1.8, 1.2);
                
                for (let r = 0; r < Math.min(rows, 10); r++) {
                    for (let c = 0; c < cols; c++) {
                        const color = Math.random() > 0.8 ? 0xff4444 : 
                                     Math.random() > 0.5 ? 0x44ff44 : 0x4444ff;
                        const mat = new THREE.MeshStandardMaterial({ color });
                        const eq = new THREE.Mesh(eqGeo, mat);
                        eq.position.set(
                            (c - cols/2) * 2.5,
                            0.9,
                            (r - 5) * 2.5
                        );
                        eq.castShadow = true;
                        equipmentGroup.add(eq);
                    }
                }
                
                scene.add(equipmentGroup);
                log(`  - Equipment ìƒì„±ë¨ (${rows}Ã—${cols} = ${rows*cols}ê°œ, ë¯¸ë¦¬ë³´ê¸° ${Math.min(rows,10)*cols}ê°œ)`);
            }
            
            // ë””ë²„ê·¸
            debug() {
                console.log('=== MockSceneManager Debug ===');
                console.log('Scene children:', scene.children.length);
                console.log('EquipmentLoader connected:', !!this._equipmentLoader);
                console.log('RoomEnvironment:', !!mockRoomEnvironment);
                console.log('EquipmentGroup:', !!equipmentGroup);
                return {
                    sceneChildren: scene.children.length,
                    hasEquipmentLoader: !!this._equipmentLoader,
                    hasRoom: !!mockRoomEnvironment,
                    hasEquipment: !!equipmentGroup
                };
            }
        }
        
        // ============================================
        // Mock EquipmentLoader í´ë˜ìŠ¤
        // ============================================
        class MockEquipmentLoader {
            constructor(targetScene) {
                this.scene = targetScene;
                this.equipmentArray = [];
                log('MockEquipmentLoader ìƒì„±ë¨', 'success');
            }
            
            getEquipmentArray() {
                return this.equipmentArray;
            }
            
            dispose() {
                log('EquipmentLoader.dispose() í˜¸ì¶œë¨');
                this.equipmentArray = [];
            }
            
            loadEquipmentArray(callback) {
                log('EquipmentLoader.loadEquipmentArray() í˜¸ì¶œë¨');
                if (callback) callback('Equipment ë¡œë“œ ì™„ë£Œ', false);
            }
        }
        
        // ============================================
        // Mock LayoutEditorMain í´ë˜ìŠ¤
        // ============================================
        class MockLayoutEditorMain {
            constructor() {
                this.sceneManager = null;
                this.state = {
                    state: {
                        currentSiteId: 'test_site',
                        currentLayout: null,
                        mode: 'editor'
                    },
                    enterViewerMode: (siteId, layout) => {
                        this.state.state.mode = 'viewer';
                        this.state.state.currentSiteId = siteId;
                        this.state.state.currentLayout = layout;
                        log(`State.enterViewerMode(${siteId}) í˜¸ì¶œë¨`);
                    }
                };
                log('MockLayoutEditorMain ìƒì„±ë¨', 'success');
            }
            
            init() {
                log('LayoutEditorMain.init() í˜¸ì¶œë¨');
            }
            
            setSceneManager(sm) {
                if (!sm) {
                    log('setSceneManager: sceneManagerê°€ nullì…ë‹ˆë‹¤', 'warn');
                    return;
                }
                this.sceneManager = sm;
                log('âœ… setSceneManager() ì™„ë£Œ - SceneManager ì—°ê²°ë¨', 'success');
            }
            
            tryConnectSceneManager() {
                if (!this.sceneManager && window.sceneManager) {
                    this.sceneManager = window.sceneManager;
                    log('SceneManager ìë™ ì—°ê²°ë¨', 'success');
                }
            }
            
            goTo3DViewer() {
                log('goTo3DViewer() ì‹œì‘...', 'info');
                
                this.tryConnectSceneManager();
                
                const siteId = this.state.state.currentSiteId;
                const layout = this.state.state.currentLayout;
                
                if (!layout) {
                    log('âŒ Layout ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                try {
                    // 1. Viewer ëª¨ë“œë¡œ ì „í™˜
                    this.state.enterViewerMode(siteId, layout);
                    
                    // 2. SceneManagerì— Layout ì ìš©
                    if (this.sceneManager && typeof this.sceneManager.applyLayoutFull === 'function') {
                        const success = this.sceneManager.applyLayoutFull(layout, {
                            clearFirst: true
                        });
                        
                        if (success) {
                            log('âœ… goTo3DViewer() ì™„ë£Œ - SceneManager.applyLayoutFull ì„±ê³µ', 'success');
                        } else {
                            log('âš ï¸ applyLayoutFull ì‹¤íŒ¨', 'warn');
                        }
                    } else {
                        log('âš ï¸ SceneManager ì—°ê²° ì•ˆë¨, ì´ë²¤íŠ¸ë¡œ ëŒ€ì²´', 'warn');
                        window.dispatchEvent(new CustomEvent('apply-layout-request', {
                            detail: { layoutData: layout }
                        }));
                    }
                    
                    // 3. ì´ë²¤íŠ¸ ë°œìƒ
                    window.dispatchEvent(new CustomEvent('viewer-mode-entered', {
                        detail: { siteId, layout }
                    }));
                    
                } catch (error) {
                    log(`âŒ goTo3DViewer ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
            
            // í…ŒìŠ¤íŠ¸ìš©: Layout ì„¤ì •
            setTestLayout(layout) {
                this.state.state.currentLayout = layout;
                log(`í…ŒìŠ¤íŠ¸ Layout ì„¤ì •ë¨: ${layout.site_id}`);
            }
            
            debug() {
                return {
                    hasSceneManager: !!this.sceneManager,
                    mode: this.state.state.mode,
                    siteId: this.state.state.currentSiteId,
                    hasLayout: !!this.state.state.currentLayout
                };
            }
        }
        
        // ============================================
        // Three.js ì´ˆê¸°í™”
        // ============================================
        function initThreeJS() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            // Camera
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth * 0.7 / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(30, 40, 50);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            const container = document.getElementById('viewer-container');
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Grid Helper
            const gridHelper = new THREE.GridHelper(100, 50, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            // Axes Helper
            const axesHelper = new THREE.AxesHelper(20);
            scene.add(axesHelper);
            
            // Resize handler
            window.addEventListener('resize', () => {
                const container = document.getElementById('viewer-container');
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
            
            log('Three.js ì´ˆê¸°í™” ì™„ë£Œ', 'success');
        }
        
        // ============================================
        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        // ============================================
        function initSystem() {
            // SceneManager ìƒì„±
            sceneManager = new MockSceneManager();
            window.sceneManager = sceneManager;
            updateStatus('status-scenemanager', 'âœ“ ì´ˆê¸°í™”ë¨', 'connected');
            
            // EquipmentLoader ìƒì„±
            equipmentLoader = new MockEquipmentLoader(scene);
            window.equipmentLoader = equipmentLoader;
            updateStatus('status-equipmentloader', 'âœ“ ì´ˆê¸°í™”ë¨', 'connected');
            
            // LayoutEditorMain ìƒì„±
            layoutEditorMain = new MockLayoutEditorMain();
            window.layoutEditorMain = layoutEditorMain;
            updateStatus('status-layouteditormain', 'âœ“ ì´ˆê¸°í™”ë¨', 'connected');
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            log('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            updateChecklist('check-init', true);
        }
        
        // ============================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        // ============================================
        function setupEventListeners() {
            window.addEventListener('scene-rebuilt', (e) => {
                log(`[Event] scene-rebuilt: ${JSON.stringify(e.detail)}`, 'info');
            });
            
            window.addEventListener('layout-full-applied', (e) => {
                log(`[Event] layout-full-applied: success=${e.detail.success}`, 'info');
            });
            
            window.addEventListener('viewer-mode-entered', (e) => {
                log(`[Event] viewer-mode-entered: siteId=${e.detail.siteId}`, 'info');
            });
            
            window.addEventListener('apply-layout-request', (e) => {
                log(`[Event] apply-layout-request ìˆ˜ì‹ `, 'info');
            });
            
            log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
        }
        
        // ============================================
        // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        // ============================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // ============================================
        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        // ============================================
        
        // Test 1: ì´ˆê¸°í™” ìƒíƒœ í™•ì¸
        window.testInitialization = function() {
            log('=== ì´ˆê¸°í™” ìƒíƒœ í™•ì¸ ===', 'info');
            log(`SceneManager: ${sceneManager ? 'âœ“' : 'âœ—'}`);
            log(`EquipmentLoader: ${equipmentLoader ? 'âœ“' : 'âœ—'}`);
            log(`LayoutEditorMain: ${layoutEditorMain ? 'âœ“' : 'âœ—'}`);
            log(`Scene children: ${scene.children.length}`);
            
            const allInit = sceneManager && equipmentLoader && layoutEditorMain;
            updateChecklist('check-init', allInit);
            log(allInit ? 'âœ… ëª¨ë“  ì´ˆê¸°í™” ì™„ë£Œ' : 'âŒ ì¼ë¶€ ì´ˆê¸°í™” ì‹¤íŒ¨', allInit ? 'success' : 'error');
        };
        
        // Test: setEquipmentLoader
        window.testSetEquipmentLoader = function() {
            log('=== setEquipmentLoader() í…ŒìŠ¤íŠ¸ ===', 'info');
            
            if (!sceneManager) {
                log('âŒ SceneManagerê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            sceneManager.setEquipmentLoader(equipmentLoader);
            
            const connected = sceneManager.getEquipmentLoader() === equipmentLoader;
            updateStatus('status-sm-el-connection', connected ? 'âœ“ ì—°ê²°ë¨' : 'âœ— ì‹¤íŒ¨', connected ? 'connected' : 'disconnected');
            updateChecklist('check-sm-el', connected);
            
            log(connected ? 'âœ… SM-EL ì—°ê²° ì„±ê³µ' : 'âŒ SM-EL ì—°ê²° ì‹¤íŒ¨', connected ? 'success' : 'error');
        };
        
        // Test: getEquipmentLoader
        window.testGetEquipmentLoader = function() {
            log('=== getEquipmentLoader() í…ŒìŠ¤íŠ¸ ===', 'info');
            
            const loader = sceneManager?.getEquipmentLoader();
            log(`ë°˜í™˜ê°’: ${loader ? 'EquipmentLoader ì¸ìŠ¤í„´ìŠ¤' : 'null'}`);
            log(loader ? 'âœ… ì •ìƒ ë™ì‘' : 'âš ï¸ ì—°ê²°ë˜ì§€ ì•ŠìŒ', loader ? 'success' : 'warn');
        };
        
        // Test: clearScene
        window.testClearScene = function() {
            log('=== clearScene() í…ŒìŠ¤íŠ¸ ===', 'info');
            
            const beforeCount = scene.children.length;
            log(`ì‹¤í–‰ ì „ Scene children: ${beforeCount}`);
            
            const result = sceneManager?.clearScene();
            
            const afterCount = scene.children.length;
            log(`ì‹¤í–‰ í›„ Scene children: ${afterCount}`);
            
            const success = result && (mockRoomEnvironment === null);
            updateChecklist('check-clear', success);
            log(success ? 'âœ… clearScene ì„±ê³µ' : 'âŒ clearScene ì‹¤íŒ¨', success ? 'success' : 'error');
        };
        
        // Test: rebuildScene
        window.testRebuildScene = function() {
            log('=== rebuildScene() í…ŒìŠ¤íŠ¸ ===', 'info');
            
            const params = {
                roomWidth: 40,
                roomDepth: 60,
                wallHeight: 4
            };
            
            const config = {
                rows: 26,
                cols: 6
            };
            
            const result = sceneManager?.rebuildScene(params, config);
            
            const success = result && mockRoomEnvironment && equipmentGroup;
            updateChecklist('check-rebuild', success);
            log(success ? 'âœ… rebuildScene ì„±ê³µ' : 'âŒ rebuildScene ì‹¤íŒ¨', success ? 'success' : 'error');
        };
        
        // Test: Scene Children Count
        window.testSceneChildrenCount = function() {
            log('=== Scene Children ë¶„ì„ ===', 'info');
            
            scene.children.forEach((child, i) => {
                log(`  [${i}] ${child.name || child.type} (${child.constructor.name})`);
            });
            
            log(`ì´ ${scene.children.length}ê°œ ì˜¤ë¸Œì íŠ¸`);
        };
        
        // Test: applyLayoutFull - Small
        window.testApplyLayoutFull_Small = function() {
            log('=== applyLayoutFull (Small 30Ã—40) í…ŒìŠ¤íŠ¸ ===', 'info');
            
            const layoutData = {
                site_id: 'small_factory',
                room: { width: 30, depth: 40, wallHeight: 3.5 },
                equipmentArrays: [{ rows: 13, cols: 4 }]
            };
            
            const success = sceneManager?.applyLayoutFull(layoutData);
            updateChecklist('check-apply-layout', success);
        };
        
        // Test: applyLayoutFull - Standard
        window.testApplyLayoutFull_Standard = function() {
            log('=== applyLayoutFull (Standard 50Ã—70) í…ŒìŠ¤íŠ¸ ===', 'info');
            
            const layoutData = {
                site_id: 'standard_factory',
                room: { width: 50, depth: 70, wallHeight: 5 },
                equipmentArrays: [{ rows: 26, cols: 6 }]
            };
            
            const success = sceneManager?.applyLayoutFull(layoutData);
            updateChecklist('check-apply-layout', success);
        };
        
        // Test: applyLayoutFull - Large
        window.testApplyLayoutFull_Large = function() {
            log('=== applyLayoutFull (Large 80Ã—100) í…ŒìŠ¤íŠ¸ ===', 'info');
            
            const layoutData = {
                site_id: 'large_factory',
                room: { width: 80, depth: 100, wallHeight: 6 },
                equipmentArrays: [{ rows: 40, cols: 8 }]
            };
            
            const success = sceneManager?.applyLayoutFull(layoutData);
            updateChecklist('check-apply-layout', success);
        };
        
        // Test: setSceneManager
        window.testSetSceneManager = function() {
            log('=== setSceneManager() í…ŒìŠ¤íŠ¸ ===', 'info');
            
            if (!layoutEditorMain) {
                log('âŒ LayoutEditorMainì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            layoutEditorMain.setSceneManager(sceneManager);
            
            const connected = layoutEditorMain.sceneManager === sceneManager;
            updateStatus('status-lem-sm-connection', connected ? 'âœ“ ì—°ê²°ë¨' : 'âœ— ì‹¤íŒ¨', connected ? 'connected' : 'disconnected');
            updateChecklist('check-lem-sm', connected);
            
            log(connected ? 'âœ… LEM-SM ì—°ê²° ì„±ê³µ' : 'âŒ LEM-SM ì—°ê²° ì‹¤íŒ¨', connected ? 'success' : 'error');
        };
        
        // Test: goTo3DViewer
        window.testGoTo3DViewer = function() {
            log('=== goTo3DViewer() ì‹œë®¬ë ˆì´ì…˜ ===', 'info');
            
            if (!layoutEditorMain) {
                log('âŒ LayoutEditorMainì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // í…ŒìŠ¤íŠ¸ìš© Layout ì„¤ì •
            const testLayout = {
                site_id: 'test_goTo3D',
                room: { width: 45, depth: 65, wallHeight: 4.5 },
                equipmentArrays: [{ rows: 20, cols: 5 }]
            };
            
            layoutEditorMain.setTestLayout(testLayout);
            
            // SceneManager ì—°ê²° í™•ì¸
            if (!layoutEditorMain.sceneManager) {
                layoutEditorMain.setSceneManager(sceneManager);
            }
            
            // goTo3DViewer ì‹¤í–‰
            layoutEditorMain.goTo3DViewer();
            
            const success = layoutEditorMain.state.state.mode === 'viewer';
            updateChecklist('check-goto3d', success);
        };
        
        // Test: Event Dispatch
        window.testEventDispatch = function() {
            log('=== ì´ë²¤íŠ¸ ë°œìƒ í…ŒìŠ¤íŠ¸ ===', 'info');
            
            window.dispatchEvent(new CustomEvent('apply-layout-request', {
                detail: {
                    layoutData: {
                        site_id: 'event_test',
                        room: { width: 35, depth: 55 }
                    }
                }
            }));
            
            log('apply-layout-request ì´ë²¤íŠ¸ ë°œìƒë¨', 'success');
        };
        
        // Full Integration Test
        window.runFullIntegrationTest = function() {
            log('========================================', 'info');
            log('ğŸ¯ ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
            log('========================================', 'info');
            
            let allPassed = true;
            
            // Step 1: ì´ˆê¸°í™” í™•ì¸
            log('\n[Step 1] ì´ˆê¸°í™” í™•ì¸...');
            testInitialization();
            
            // Step 2: SM-EL ì—°ê²°
            log('\n[Step 2] SceneManager-EquipmentLoader ì—°ê²°...');
            testSetEquipmentLoader();
            if (!sceneManager?.getEquipmentLoader()) allPassed = false;
            
            // Step 3: LEM-SM ì—°ê²°
            log('\n[Step 3] LayoutEditorMain-SceneManager ì—°ê²°...');
            testSetSceneManager();
            if (!layoutEditorMain?.sceneManager) allPassed = false;
            
            // Step 4: clearScene
            log('\n[Step 4] clearScene í…ŒìŠ¤íŠ¸...');
            testClearScene();
            
            // Step 5: rebuildScene
            log('\n[Step 5] rebuildScene í…ŒìŠ¤íŠ¸...');
            testRebuildScene();
            if (!mockRoomEnvironment) allPassed = false;
            
            // Step 6: applyLayoutFull
            log('\n[Step 6] applyLayoutFull í…ŒìŠ¤íŠ¸...');
            testApplyLayoutFull_Standard();
            
            // Step 7: goTo3DViewer
            log('\n[Step 7] goTo3DViewer í…ŒìŠ¤íŠ¸...');
            testGoTo3DViewer();
            
            log('\n========================================', 'info');
            log(allPassed ? 'âœ… ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼!' : 'âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', allPassed ? 'success' : 'error');
            log('========================================', 'info');
        };
        
        // Reset to Default
        window.resetToDefault = function() {
            log('=== ê¸°ë³¸ ìƒíƒœë¡œ ë¦¬ì…‹ ===', 'info');
            
            // Scene ì •ë¦¬
            sceneManager?.clearScene();
            
            // ê¸°ë³¸ Room ìƒì„±
            sceneManager?.rebuildScene(
                { roomWidth: 40, roomDepth: 60, wallHeight: 4 },
                { rows: 26, cols: 6 }
            );
            
            // ì¹´ë©”ë¼ ë¦¬ì…‹
            camera.position.set(30, 40, 50);
            camera.lookAt(0, 0, 0);
            controls.reset();
            
            log('âœ… ë¦¬ì…‹ ì™„ë£Œ', 'success');
        };
        
        // ============================================
        // ì‹œì‘
        // ============================================
        function start() {
            initThreeJS();
            initSystem();
            
            // ì´ˆê¸° Scene ìƒì„±
            sceneManager.rebuildScene(
                { roomWidth: 40, roomDepth: 60, wallHeight: 4 },
                { rows: 26, cols: 6 }
            );
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            animate();
            
            // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
            document.getElementById('loading-overlay').classList.add('hidden');
            
            log('ğŸš€ Phase 4.4 í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!', 'success');
            log('ğŸ’¡ ì˜¤ë¥¸ìª½ íŒ¨ë„ì˜ ë²„íŠ¼ë“¤ì„ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ì„¸ìš”.');
        }
        
        // DOM ë¡œë“œ í›„ ì‹œì‘
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', start);
        } else {
            start();
        }
    </script>
</body>
</html>