<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3: ë ˆì¸ ì •ë ¬ ë¡œì§ í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            line-height: 1.6;
        }
        
        h1 {
            color: #0ff;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }
        
        h2 {
            color: #6c5ce7;
            margin: 30px 0 15px;
        }
        
        .test-section {
            background: #222;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-group {
            margin-bottom: 15px;
            padding: 15px;
            background: #2a2a3e;
            border-radius: 6px;
        }
        
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #74b9ff;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }
        
        .pass {
            background: #00b894;
            color: #000;
        }
        
        .fail {
            background: #e74c3c;
            color: #fff;
        }
        
        .info {
            background: #3498db;
            color: #fff;
        }
        
        button {
            background: #6c5ce7;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #5f4fcf;
            transform: translateY(-2px);
        }
        
        .summary {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a3e;
            padding: 15px 25px;
            border-radius: 8px;
            border: 2px solid #6c5ce7;
        }
        
        .summary span {
            font-size: 24px;
            font-weight: bold;
        }
        
        .summary .pass-count {
            color: #00b894;
        }
        
        .summary .fail-count {
            color: #e74c3c;
        }
        
        pre {
            background: #16213e;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        
        .lane-display {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
        }
        
        .lane-column {
            min-width: 150px;
            background: #2a2a3e;
            border-radius: 6px;
            padding: 10px;
        }
        
        .lane-header {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .lane-header.remote { background: #c0392b; }
        .lane-header.sudden-stop { background: #e74c3c; }
        .lane-header.stop { background: #f39c12; }
        .lane-header.run { background: #27ae60; }
        .lane-header.idle { background: #3498db; }
        .lane-header.wait { background: #95a5a6; }
        
        .equipment-item {
            background: #1a1a2e;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .equipment-item .id {
            font-weight: bold;
            color: #74b9ff;
        }
        
        .equipment-item .info {
            color: #888;
            font-size: 11px;
            background: transparent;
            padding: 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Phase 3: ë ˆì¸ ì •ë ¬ ë¡œì§ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="summary">
        <span class="pass-count" id="passCount">0</span> / 
        <span class="fail-count" id="failCount">0</span>
    </div>
    
    <div class="test-section">
        <button onclick="runAllTests()">â–¶ï¸ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <button onclick="runDurationTests()">â±ï¸ DurationCalculator í…ŒìŠ¤íŠ¸</button>
        <button onclick="runSorterTests()">ğŸ“Š LaneSorter í…ŒìŠ¤íŠ¸</button>
        <button onclick="runDataManagerTests()">ğŸ—„ï¸ DataManager í…ŒìŠ¤íŠ¸</button>
        <button onclick="runIntegrationTest()">ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸</button>
    </div>
    
    <div id="testResults"></div>
    
    <script type="module">
        // =========================================================================
        // Import Phase 3 ëª¨ë“ˆ
        // =========================================================================
        
        // í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì§ì ‘ import (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©)
        // import { DurationCalculator } from './utils/DurationCalculator.js';
        // import { LaneSorter } from './utils/LaneSorter.js';
        // import { RankingDataManager } from './managers/RankingDataManager.js';
        
        // í…ŒìŠ¤íŠ¸ìš© ì¸ë¼ì¸ êµ¬í˜„ (importê°€ ì•ˆ ë  ê²½ìš°ë¥¼ ìœ„í•œ í´ë°±)
        // ì‹¤ì œ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” import ì‚¬ìš©
        
        // =========================================================================
        // DurationCalculator ì¸ë¼ì¸ êµ¬í˜„ (í…ŒìŠ¤íŠ¸ìš©)
        // =========================================================================
        class DurationCalculator {
            static URGENCY_THRESHOLDS = { WARNING: 5, DANGER: 10, CRITICAL: 15 };
            static URGENCY_LEVELS = { NORMAL: 'normal', WARNING: 'warning', DANGER: 'danger', CRITICAL: 'critical' };
            static MS = { SECOND: 1000, MINUTE: 60000, HOUR: 3600000, DAY: 86400000 };
            
            static calculateStatusDuration(occurredAt, now = new Date()) {
                if (!occurredAt) return 0;
                const startTime = new Date(occurredAt);
                return Math.max(0, now.getTime() - startTime.getTime());
            }
            
            static calculateWaitDuration(lastLotInfo, now = new Date()) {
                if (!lastLotInfo || lastLotInfo.isStart !== 0) return 0;
                const completedAt = lastLotInfo.occurredAtUtc || lastLotInfo.OccurredAtUtc;
                return completedAt ? this.calculateStatusDuration(completedAt, now) : 0;
            }
            
            static formatDuration(durationMs, options = {}) {
                if (durationMs < 0 || !isFinite(durationMs)) return '00:00:00';
                const hours = Math.floor(durationMs / this.MS.HOUR);
                const minutes = Math.floor((durationMs % this.MS.HOUR) / this.MS.MINUTE);
                const seconds = Math.floor((durationMs % this.MS.MINUTE) / this.MS.SECOND);
                return [hours, minutes, seconds].map(n => n.toString().padStart(2, '0')).join(':');
            }
            
            static getDurationMinutes(durationMs) {
                return isFinite(durationMs) && durationMs >= 0 ? durationMs / this.MS.MINUTE : 0;
            }
            
            static getUrgencyLevel(durationMs, thresholds = this.URGENCY_THRESHOLDS) {
                const minutes = this.getDurationMinutes(durationMs);
                if (minutes > thresholds.CRITICAL) return this.URGENCY_LEVELS.CRITICAL;
                if (minutes > thresholds.DANGER) return this.URGENCY_LEVELS.DANGER;
                if (minutes > thresholds.WARNING) return this.URGENCY_LEVELS.WARNING;
                return this.URGENCY_LEVELS.NORMAL;
            }
            
            static calculateAverage(durations) {
                const valid = durations.filter(d => isFinite(d) && d >= 0);
                return valid.length ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
            }
            
            static calculateMax(durations) {
                const valid = durations.filter(d => isFinite(d) && d >= 0);
                return valid.length ? Math.max(...valid) : 0;
            }
        }
        
        // =========================================================================
        // LaneSorter ì¸ë¼ì¸ êµ¬í˜„ (í…ŒìŠ¤íŠ¸ìš©)
        // =========================================================================
        class LaneSorter {
            static SORT_RULES = {
                'remote': 'duration-desc',
                'sudden-stop': 'duration-desc',
                'stop': 'duration-desc',
                'run': 'production-desc',
                'idle': 'duration-desc',
                'wait': 'duration-desc',
                'custom': 'duration-desc'
            };
            
            static sort(equipments, laneId, options = {}) {
                if (!Array.isArray(equipments) || !equipments.length) return [];
                const rule = options.customRule || this.SORT_RULES[laneId] || 'duration-desc';
                
                switch (rule) {
                    case 'duration-desc':
                        return this.sortByDurationDesc(equipments);
                    case 'production-desc':
                        return this.sortByProductionDesc(equipments);
                    default:
                        return this.sortByDurationDesc(equipments);
                }
            }
            
            static sortByDurationDesc(equipments) {
                return [...equipments].sort((a, b) => 
                    (b.statusDuration || 0) - (a.statusDuration || 0)
                );
            }
            
            static sortByProductionDesc(equipments) {
                return [...equipments].sort((a, b) => {
                    const diff = (b.productionCount || 0) - (a.productionCount || 0);
                    return diff !== 0 ? diff : (b.statusDuration || 0) - (a.statusDuration || 0);
                });
            }
            
            static detectOrderChanges(previous, current, idField = 'equipmentId') {
                const changes = { moved: [], added: [], removed: [], unchanged: [] };
                const prevMap = new Map(previous.map((item, idx) => [item[idField], { item, index: idx }]));
                const currMap = new Map(current.map((item, idx) => [item[idField], { item, index: idx }]));
                
                for (const [id, { item, index }] of currMap) {
                    if (!prevMap.has(id)) {
                        changes.added.push({ item, newIndex: index });
                    } else {
                        const prevInfo = prevMap.get(id);
                        if (prevInfo.index !== index) {
                            changes.moved.push({ item, oldIndex: prevInfo.index, newIndex: index });
                        } else {
                            changes.unchanged.push({ item, index });
                        }
                    }
                }
                
                for (const [id, { item, index }] of prevMap) {
                    if (!currMap.has(id)) {
                        changes.removed.push({ item, oldIndex: index });
                    }
                }
                
                return changes;
            }
        }
        
        // =========================================================================
        // RankingDataManager ì¸ë¼ì¸ êµ¬í˜„ (í…ŒìŠ¤íŠ¸ìš©)
        // =========================================================================
        class RankingDataManager {
            static REMOTE_ALARM_CODES = new Set([61, 62, 86, 10047, 10048, 10051, 10052, 10055, 10056, 10057, 10058, 10077]);
            static LANE_IDS = { REMOTE: 'remote', SUDDEN_STOP: 'sudden-stop', STOP: 'stop', RUN: 'run', IDLE: 'idle', WAIT: 'wait', CUSTOM: 'custom' };
            static STATUS = { RUN: 'RUN', STOP: 'STOP', IDLE: 'IDLE', SUDDENSTOP: 'SUDDENSTOP' };
            
            constructor(options = {}) {
                this._equipments = new Map();
                this._laneEquipments = new Map();
                Object.values(RankingDataManager.LANE_IDS).forEach(id => this._laneEquipments.set(id, new Set()));
            }
            
            determineLane(equipment) {
                const { status, alarmCode, isProducing } = equipment;
                if (!isProducing) return RankingDataManager.LANE_IDS.WAIT;
                if (status === 'SUDDENSTOP') {
                    return RankingDataManager.REMOTE_ALARM_CODES.has(alarmCode) 
                        ? RankingDataManager.LANE_IDS.REMOTE 
                        : RankingDataManager.LANE_IDS.SUDDEN_STOP;
                }
                switch (status) {
                    case 'RUN': return RankingDataManager.LANE_IDS.RUN;
                    case 'STOP': return RankingDataManager.LANE_IDS.STOP;
                    case 'IDLE': return RankingDataManager.LANE_IDS.IDLE;
                    default: return RankingDataManager.LANE_IDS.WAIT;
                }
            }
            
            isProducing(equipment) {
                const { lotInfo } = equipment;
                if (!lotInfo) return false;
                const isStart = lotInfo.isStart ?? lotInfo.IsStart ?? 0;
                const isEnd = lotInfo.isEnd ?? lotInfo.IsEnd ?? 0;
                return isStart === 1 && isEnd !== 1;
            }
            
            isRemoteAlarm(alarmCode) {
                return alarmCode && RankingDataManager.REMOTE_ALARM_CODES.has(alarmCode);
            }
            
            processEquipmentData(rawData) {
                if (!rawData) return null;
                const equipmentId = rawData.equipmentId || rawData.EquipmentId;
                const status = (rawData.status || rawData.Status || 'UNKNOWN').toUpperCase();
                const alarmCode = rawData.alarmCode ? parseInt(rawData.alarmCode, 10) : null;
                const occurredAt = rawData.occurredAt || rawData.OccurredAt;
                const lotInfo = rawData.lotInfo || null;
                const isProducing = this.isProducing({ lotInfo });
                const productionCount = parseInt(rawData.productionCount || 0, 10);
                const statusDuration = occurredAt ? DurationCalculator.calculateStatusDuration(occurredAt) : 0;
                
                return { equipmentId, status, alarmCode, occurredAt, lotInfo, isProducing, productionCount, statusDuration, laneId: null };
            }
            
            loadEquipments(equipmentsData) {
                for (const laneId of this._laneEquipments.keys()) {
                    this._laneEquipments.set(laneId, new Set());
                }
                this._equipments.clear();
                
                for (const rawData of equipmentsData) {
                    const equipment = this.processEquipmentData(rawData);
                    if (equipment) {
                        const laneId = this.determineLane(equipment);
                        equipment.laneId = laneId;
                        this._equipments.set(equipment.equipmentId, equipment);
                        this._laneEquipments.get(laneId).add(equipment.equipmentId);
                    }
                }
                
                return this.getAllLanes();
            }
            
            getLaneEquipments(laneId) {
                const ids = this._laneEquipments.get(laneId) || new Set();
                const equipments = Array.from(ids).map(id => this._equipments.get(id)).filter(Boolean);
                return LaneSorter.sort(equipments, laneId);
            }
            
            getAllLanes() {
                const result = new Map();
                for (const laneId of this._laneEquipments.keys()) {
                    result.set(laneId, this.getLaneEquipments(laneId));
                }
                return result;
            }
        }
        
        // =========================================================================
        // í…ŒìŠ¤íŠ¸ ìœ í‹¸ë¦¬í‹°
        // =========================================================================
        let passCount = 0;
        let failCount = 0;
        
        function assert(condition, message) {
            if (condition) {
                passCount++;
                return { pass: true, message };
            } else {
                failCount++;
                return { pass: false, message };
            }
        }
        
        function assertEqual(actual, expected, message) {
            const condition = JSON.stringify(actual) === JSON.stringify(expected);
            return assert(condition, `${message}\n  Expected: ${JSON.stringify(expected)}\n  Actual: ${JSON.stringify(actual)}`);
        }
        
        function updateSummary() {
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
        }
        
        function displayResult(title, results, details = '') {
            const container = document.getElementById('testResults');
            const allPass = results.every(r => r.pass);
            
            let html = `
                <div class="test-group">
                    <div class="test-title">${allPass ? 'âœ…' : 'âŒ'} ${title}</div>
            `;
            
            for (const result of results) {
                html += `<div class="test-result ${result.pass ? 'pass' : 'fail'}">${result.pass ? 'âœ“' : 'âœ—'} ${result.message}</div>`;
            }
            
            if (details) {
                html += `<pre>${details}</pre>`;
            }
            
            html += '</div>';
            container.innerHTML += html;
            updateSummary();
        }
        
        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            passCount = 0;
            failCount = 0;
            updateSummary();
        }
        
        // =========================================================================
        // DurationCalculator í…ŒìŠ¤íŠ¸
        // =========================================================================
        window.runDurationTests = function() {
            clearResults();
            const results = [];
            
            // í…ŒìŠ¤íŠ¸ 1: ì§€ì† ì‹œê°„ ê³„ì‚°
            const now = new Date('2026-01-17T12:00:00Z');
            const oneHourAgo = new Date('2026-01-17T11:00:00Z');
            const duration = DurationCalculator.calculateStatusDuration(oneHourAgo, now);
            results.push(assertEqual(duration, 3600000, '1ì‹œê°„ ì „ ì‹œì‘ â†’ 3600000ms'));
            
            // í…ŒìŠ¤íŠ¸ 2: ì‹œê°„ í¬ë§·íŒ…
            const formatted = DurationCalculator.formatDuration(3661000);
            results.push(assertEqual(formatted, '01:01:01', '3661000ms â†’ 01:01:01'));
            
            // í…ŒìŠ¤íŠ¸ 3: ë¶„ ë³€í™˜
            const minutes = DurationCalculator.getDurationMinutes(300000);
            results.push(assertEqual(minutes, 5, '300000ms â†’ 5ë¶„'));
            
            // í…ŒìŠ¤íŠ¸ 4: ê¸´ê¸‰ë„ ë ˆë²¨ - Normal
            const normal = DurationCalculator.getUrgencyLevel(4 * 60000);
            results.push(assertEqual(normal, 'normal', '4ë¶„ â†’ normal'));
            
            // í…ŒìŠ¤íŠ¸ 5: ê¸´ê¸‰ë„ ë ˆë²¨ - Warning
            const warning = DurationCalculator.getUrgencyLevel(6 * 60000);
            results.push(assertEqual(warning, 'warning', '6ë¶„ â†’ warning'));
            
            // í…ŒìŠ¤íŠ¸ 6: ê¸´ê¸‰ë„ ë ˆë²¨ - Danger
            const danger = DurationCalculator.getUrgencyLevel(12 * 60000);
            results.push(assertEqual(danger, 'danger', '12ë¶„ â†’ danger'));
            
            // í…ŒìŠ¤íŠ¸ 7: ê¸´ê¸‰ë„ ë ˆë²¨ - Critical
            const critical = DurationCalculator.getUrgencyLevel(20 * 60000);
            results.push(assertEqual(critical, 'critical', '20ë¶„ â†’ critical'));
            
            // í…ŒìŠ¤íŠ¸ 8: í‰ê·  ê³„ì‚°
            const avg = DurationCalculator.calculateAverage([100, 200, 300]);
            results.push(assertEqual(avg, 200, 'í‰ê· (100,200,300) â†’ 200'));
            
            // í…ŒìŠ¤íŠ¸ 9: ìµœëŒ€ê°’ ê³„ì‚°
            const max = DurationCalculator.calculateMax([100, 300, 200]);
            results.push(assertEqual(max, 300, 'ìµœëŒ€(100,300,200) â†’ 300'));
            
            // í…ŒìŠ¤íŠ¸ 10: null ì²˜ë¦¬
            const nullDuration = DurationCalculator.calculateStatusDuration(null);
            results.push(assertEqual(nullDuration, 0, 'null occurredAt â†’ 0'));
            
            displayResult('DurationCalculator í…ŒìŠ¤íŠ¸', results);
        };
        
        // =========================================================================
        // LaneSorter í…ŒìŠ¤íŠ¸
        // =========================================================================
        window.runSorterTests = function() {
            clearResults();
            const results = [];
            
            // í…ŒìŠ¤íŠ¸ ë°ì´í„°
            const equipments = [
                { equipmentId: 'EQ-001', statusDuration: 100000, productionCount: 50 },
                { equipmentId: 'EQ-002', statusDuration: 300000, productionCount: 80 },
                { equipmentId: 'EQ-003', statusDuration: 200000, productionCount: 30 }
            ];
            
            // í…ŒìŠ¤íŠ¸ 1: Duration ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ì˜¤ë˜ëœ ìˆœ)
            const durationSorted = LaneSorter.sort(equipments, 'remote');
            results.push(assertEqual(
                durationSorted.map(e => e.equipmentId),
                ['EQ-002', 'EQ-003', 'EQ-001'],
                'Remote ë ˆì¸: ì§€ì† ì‹œê°„ ì˜¤ë˜ëœ ìˆœ ì •ë ¬'
            ));
            
            // í…ŒìŠ¤íŠ¸ 2: Production ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë§ì€ ìˆœ)
            const productionSorted = LaneSorter.sort(equipments, 'run');
            results.push(assertEqual(
                productionSorted.map(e => e.equipmentId),
                ['EQ-002', 'EQ-001', 'EQ-003'],
                'Run ë ˆì¸: ìƒì‚° ê°œìˆ˜ ë§ì€ ìˆœ ì •ë ¬'
            ));
            
            // í…ŒìŠ¤íŠ¸ 3: ë³€ê²½ ê°ì§€
            const previous = [
                { equipmentId: 'A', statusDuration: 100 },
                { equipmentId: 'B', statusDuration: 200 },
                { equipmentId: 'C', statusDuration: 300 }
            ];
            const current = [
                { equipmentId: 'B', statusDuration: 400 },
                { equipmentId: 'A', statusDuration: 100 },
                { equipmentId: 'D', statusDuration: 50 }
            ];
            const changes = LaneSorter.detectOrderChanges(previous, current);
            results.push(assertEqual(changes.moved.length, 2, 'ì´ë™ëœ í•­ëª© 2ê°œ (A, B)'));
            results.push(assertEqual(changes.added.length, 1, 'ì¶”ê°€ëœ í•­ëª© 1ê°œ (D)'));
            results.push(assertEqual(changes.removed.length, 1, 'ì œê±°ëœ í•­ëª© 1ê°œ (C)'));
            
            // í…ŒìŠ¤íŠ¸ 4: ë¹ˆ ë°°ì—´ ì²˜ë¦¬
            const empty = LaneSorter.sort([], 'run');
            results.push(assertEqual(empty, [], 'ë¹ˆ ë°°ì—´ â†’ ë¹ˆ ë°°ì—´'));
            
            // í…ŒìŠ¤íŠ¸ 5: ì •ë ¬ ê·œì¹™ í™•ì¸
            results.push(assertEqual(LaneSorter.SORT_RULES['remote'], 'duration-desc', 'Remote ì •ë ¬ ê·œì¹™'));
            results.push(assertEqual(LaneSorter.SORT_RULES['run'], 'production-desc', 'Run ì •ë ¬ ê·œì¹™'));
            
            displayResult('LaneSorter í…ŒìŠ¤íŠ¸', results);
        };
        
        // =========================================================================
        // RankingDataManager í…ŒìŠ¤íŠ¸
        // =========================================================================
        window.runDataManagerTests = function() {
            clearResults();
            const results = [];
            
            const manager = new RankingDataManager();
            
            // í…ŒìŠ¤íŠ¸ 1: SUDDENSTOP + Remote Alarm â†’ Remote ë ˆì¸
            const remoteEq = { status: 'SUDDENSTOP', alarmCode: 10047, isProducing: true };
            results.push(assertEqual(
                manager.determineLane(remoteEq), 
                'remote', 
                'SUDDENSTOP + AlarmCode 10047 â†’ Remote ë ˆì¸'
            ));
            
            // í…ŒìŠ¤íŠ¸ 2: SUDDENSTOP + ì¼ë°˜ Alarm â†’ Sudden Stop ë ˆì¸
            const suddenEq = { status: 'SUDDENSTOP', alarmCode: 9999, isProducing: true };
            results.push(assertEqual(
                manager.determineLane(suddenEq), 
                'sudden-stop', 
                'SUDDENSTOP + AlarmCode 9999 â†’ Sudden Stop ë ˆì¸'
            ));
            
            // í…ŒìŠ¤íŠ¸ 3: RUN + ìƒì‚°ì¤‘ â†’ Run ë ˆì¸
            const runEq = { status: 'RUN', alarmCode: null, isProducing: true };
            results.push(assertEqual(
                manager.determineLane(runEq), 
                'run', 
                'RUN + ìƒì‚°ì¤‘ â†’ Run ë ˆì¸'
            ));
            
            // í…ŒìŠ¤íŠ¸ 4: RUN + ë¹„ìƒì‚° â†’ Wait ë ˆì¸
            const waitEq = { status: 'RUN', alarmCode: null, isProducing: false };
            results.push(assertEqual(
                manager.determineLane(waitEq), 
                'wait', 
                'RUN + ë¹„ìƒì‚° â†’ Wait ë ˆì¸'
            ));
            
            // í…ŒìŠ¤íŠ¸ 5: STOP + ìƒì‚°ì¤‘ â†’ Stop ë ˆì¸
            const stopEq = { status: 'STOP', alarmCode: null, isProducing: true };
            results.push(assertEqual(
                manager.determineLane(stopEq), 
                'stop', 
                'STOP + ìƒì‚°ì¤‘ â†’ Stop ë ˆì¸'
            ));
            
            // í…ŒìŠ¤íŠ¸ 6: IDLE + ìƒì‚°ì¤‘ â†’ Idle ë ˆì¸
            const idleEq = { status: 'IDLE', alarmCode: null, isProducing: true };
            results.push(assertEqual(
                manager.determineLane(idleEq), 
                'idle', 
                'IDLE + ìƒì‚°ì¤‘ â†’ Idle ë ˆì¸'
            ));
            
            // í…ŒìŠ¤íŠ¸ 7: ìƒì‚°ì¤‘ íŒë‹¨ - Lot ì§„í–‰ ì¤‘
            const producingEq = { lotInfo: { isStart: 1, isEnd: 0 } };
            results.push(assert(
                manager.isProducing(producingEq) === true, 
                'IsStart=1, IsEnd=0 â†’ ìƒì‚°ì¤‘'
            ));
            
            // í…ŒìŠ¤íŠ¸ 8: ìƒì‚°ì¤‘ íŒë‹¨ - Lot ì™„ë£Œ
            const completedEq = { lotInfo: { isStart: 1, isEnd: 1 } };
            results.push(assert(
                manager.isProducing(completedEq) === false, 
                'IsStart=1, IsEnd=1 â†’ ë¹„ìƒì‚°'
            ));
            
            // í…ŒìŠ¤íŠ¸ 9: ìƒì‚°ì¤‘ íŒë‹¨ - Lot ì—†ìŒ
            const noLotEq = { lotInfo: null };
            results.push(assert(
                manager.isProducing(noLotEq) === false, 
                'Lot ì—†ìŒ â†’ ë¹„ìƒì‚°'
            ));
            
            // í…ŒìŠ¤íŠ¸ 10: Remote Alarm í™•ì¸
            results.push(assert(manager.isRemoteAlarm(10047), '10047 â†’ Remote Alarm'));
            results.push(assert(manager.isRemoteAlarm(61), '61 â†’ Remote Alarm'));
            results.push(assert(!manager.isRemoteAlarm(9999), '9999 â†’ ì¼ë°˜ Alarm'));
            
            displayResult('RankingDataManager í…ŒìŠ¤íŠ¸', results);
        };
        
        // =========================================================================
        // í†µí•© í…ŒìŠ¤íŠ¸
        // =========================================================================
        window.runIntegrationTest = function() {
            clearResults();
            const results = [];
            
            // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
            const now = new Date();
            const testEquipments = [
                // Remote ë ˆì¸ (SUDDENSTOP + Remote Alarm + ìƒì‚°ì¤‘)
                { equipmentId: 'EQ-001', status: 'SUDDENSTOP', alarmCode: 10047, 
                  occurredAt: new Date(now - 15 * 60000).toISOString(),
                  lotInfo: { isStart: 1, isEnd: 0 }, productionCount: 50 },
                { equipmentId: 'EQ-002', status: 'SUDDENSTOP', alarmCode: 10048, 
                  occurredAt: new Date(now - 25 * 60000).toISOString(),
                  lotInfo: { isStart: 1, isEnd: 0 }, productionCount: 30 },
                
                // Sudden Stop ë ˆì¸ (SUDDENSTOP + ì¼ë°˜ Alarm + ìƒì‚°ì¤‘)
                { equipmentId: 'EQ-003', status: 'SUDDENSTOP', alarmCode: 9999, 
                  occurredAt: new Date(now - 10 * 60000).toISOString(),
                  lotInfo: { isStart: 1, isEnd: 0 }, productionCount: 70 },
                
                // Run ë ˆì¸ (RUN + ìƒì‚°ì¤‘)
                { equipmentId: 'EQ-004', status: 'RUN', alarmCode: null, 
                  occurredAt: new Date(now - 30 * 60000).toISOString(),
                  lotInfo: { isStart: 1, isEnd: 0 }, productionCount: 95 },
                { equipmentId: 'EQ-005', status: 'RUN', alarmCode: null, 
                  occurredAt: new Date(now - 45 * 60000).toISOString(),
                  lotInfo: { isStart: 1, isEnd: 0 }, productionCount: 67 },
                { equipmentId: 'EQ-006', status: 'RUN', alarmCode: null, 
                  occurredAt: new Date(now - 20 * 60000).toISOString(),
                  lotInfo: { isStart: 1, isEnd: 0 }, productionCount: 82 },
                
                // Wait ë ˆì¸ (ë¹„ìƒì‚°)
                { equipmentId: 'EQ-007', status: 'RUN', alarmCode: null, 
                  occurredAt: new Date(now - 60 * 60000).toISOString(),
                  lotInfo: null, productionCount: 0 },
                { equipmentId: 'EQ-008', status: 'IDLE', alarmCode: null, 
                  occurredAt: new Date(now - 40 * 60000).toISOString(),
                  lotInfo: { isStart: 0, isEnd: 1 }, productionCount: 0 }
            ];
            
            // DataManagerë¡œ ë¡œë“œ
            const manager = new RankingDataManager();
            const lanes = manager.loadEquipments(testEquipments);
            
            // í…ŒìŠ¤íŠ¸ 1: ë ˆì¸ í• ë‹¹ í™•ì¸
            const remoteLane = lanes.get('remote');
            results.push(assertEqual(remoteLane.length, 2, 'Remote ë ˆì¸: 2ê°œ ì„¤ë¹„'));
            results.push(assert(
                remoteLane.map(e => e.equipmentId).includes('EQ-001') && 
                remoteLane.map(e => e.equipmentId).includes('EQ-002'),
                'Remote ë ˆì¸: EQ-001, EQ-002 í¬í•¨'
            ));
            
            // í…ŒìŠ¤íŠ¸ 2: Remote ë ˆì¸ ì •ë ¬ í™•ì¸ (ì˜¤ë˜ëœ ìˆœ)
            results.push(assertEqual(
                remoteLane[0].equipmentId, 
                'EQ-002', 
                'Remote ë ˆì¸ 1ìœ„: EQ-002 (25ë¶„ ì „ ë°œìƒ)'
            ));
            
            // í…ŒìŠ¤íŠ¸ 3: Sudden Stop ë ˆì¸ í™•ì¸
            const suddenStopLane = lanes.get('sudden-stop');
            results.push(assertEqual(suddenStopLane.length, 1, 'Sudden Stop ë ˆì¸: 1ê°œ ì„¤ë¹„'));
            
            // í…ŒìŠ¤íŠ¸ 4: Run ë ˆì¸ ì •ë ¬ í™•ì¸ (ìƒì‚° ë§ì€ ìˆœ)
            const runLane = lanes.get('run');
            results.push(assertEqual(runLane.length, 3, 'Run ë ˆì¸: 3ê°œ ì„¤ë¹„'));
            results.push(assertEqual(
                runLane[0].equipmentId, 
                'EQ-004', 
                'Run ë ˆì¸ 1ìœ„: EQ-004 (95ê°œ ìƒì‚°)'
            ));
            results.push(assertEqual(
                runLane[1].equipmentId, 
                'EQ-006', 
                'Run ë ˆì¸ 2ìœ„: EQ-006 (82ê°œ ìƒì‚°)'
            ));
            
            // í…ŒìŠ¤íŠ¸ 5: Wait ë ˆì¸ í™•ì¸ (ë¹„ìƒì‚°)
            const waitLane = lanes.get('wait');
            results.push(assertEqual(waitLane.length, 2, 'Wait ë ˆì¸: 2ê°œ ì„¤ë¹„'));
            
            // í…ŒìŠ¤íŠ¸ 6: Stop/Idle ë ˆì¸ ë¹„ì–´ìˆìŒ í™•ì¸
            results.push(assertEqual(lanes.get('stop').length, 0, 'Stop ë ˆì¸: ë¹ˆ ìƒíƒœ'));
            results.push(assertEqual(lanes.get('idle').length, 0, 'Idle ë ˆì¸: ë¹ˆ ìƒíƒœ'));
            
            displayResult('í†µí•© í…ŒìŠ¤íŠ¸', results);
            
            // ë ˆì¸ ì‹œê°í™”
            displayLaneVisualization(lanes);
        };
        
        // ë ˆì¸ ì‹œê°í™” í‘œì‹œ
        function displayLaneVisualization(lanes) {
            const container = document.getElementById('testResults');
            
            let html = '<h2>ğŸ“Š ë ˆì¸ í• ë‹¹ ê²°ê³¼ ì‹œê°í™”</h2><div class="lane-display">';
            
            const laneOrder = ['remote', 'sudden-stop', 'stop', 'run', 'idle', 'wait'];
            const laneNames = {
                'remote': 'Remote',
                'sudden-stop': 'Sudden Stop',
                'stop': 'Stop',
                'run': 'Run',
                'idle': 'Idle',
                'wait': 'Wait'
            };
            
            for (const laneId of laneOrder) {
                const equipments = lanes.get(laneId) || [];
                html += `
                    <div class="lane-column">
                        <div class="lane-header ${laneId}">${laneNames[laneId]} (${equipments.length})</div>
                `;
                
                for (const eq of equipments) {
                    const duration = DurationCalculator.formatDuration(eq.statusDuration || 0);
                    const info = laneId === 'run' 
                        ? `ìƒì‚°: ${eq.productionCount}ê°œ` 
                        : `ì§€ì†: ${duration}`;
                    
                    html += `
                        <div class="equipment-item">
                            <div class="id">${eq.equipmentId}</div>
                            <div class="info">${info}</div>
                        </div>
                    `;
                }
                
                if (equipments.length === 0) {
                    html += '<div class="equipment-item"><div class="info">ë¹ˆ ë ˆì¸</div></div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML += html;
        }
        
        // =========================================================================
        // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        // =========================================================================
        window.runAllTests = function() {
            clearResults();
            
            // DurationCalculator í…ŒìŠ¤íŠ¸
            const durationResults = [];
            const now = new Date('2026-01-17T12:00:00Z');
            const oneHourAgo = new Date('2026-01-17T11:00:00Z');
            
            durationResults.push(assertEqual(DurationCalculator.calculateStatusDuration(oneHourAgo, now), 3600000, 'ì§€ì† ì‹œê°„ ê³„ì‚°'));
            durationResults.push(assertEqual(DurationCalculator.formatDuration(3661000), '01:01:01', 'ì‹œê°„ í¬ë§·íŒ…'));
            durationResults.push(assertEqual(DurationCalculator.getDurationMinutes(300000), 5, 'ë¶„ ë³€í™˜'));
            durationResults.push(assertEqual(DurationCalculator.getUrgencyLevel(6 * 60000), 'warning', 'ê¸´ê¸‰ë„ ë ˆë²¨'));
            
            displayResult('DurationCalculator í…ŒìŠ¤íŠ¸', durationResults);
            
            // LaneSorter í…ŒìŠ¤íŠ¸
            const sorterResults = [];
            const equipments = [
                { equipmentId: 'EQ-001', statusDuration: 100000, productionCount: 50 },
                { equipmentId: 'EQ-002', statusDuration: 300000, productionCount: 80 },
                { equipmentId: 'EQ-003', statusDuration: 200000, productionCount: 30 }
            ];
            
            const durationSorted = LaneSorter.sort(equipments, 'remote');
            sorterResults.push(assertEqual(durationSorted.map(e => e.equipmentId), ['EQ-002', 'EQ-003', 'EQ-001'], 'Duration ì •ë ¬'));
            
            const productionSorted = LaneSorter.sort(equipments, 'run');
            sorterResults.push(assertEqual(productionSorted.map(e => e.equipmentId), ['EQ-002', 'EQ-001', 'EQ-003'], 'Production ì •ë ¬'));
            
            displayResult('LaneSorter í…ŒìŠ¤íŠ¸', sorterResults);
            
            // DataManager í…ŒìŠ¤íŠ¸
            const managerResults = [];
            const manager = new RankingDataManager();
            
            managerResults.push(assertEqual(manager.determineLane({ status: 'SUDDENSTOP', alarmCode: 10047, isProducing: true }), 'remote', 'Remote Alarm â†’ Remote ë ˆì¸'));
            managerResults.push(assertEqual(manager.determineLane({ status: 'SUDDENSTOP', alarmCode: 9999, isProducing: true }), 'sudden-stop', 'ì¼ë°˜ Alarm â†’ Sudden Stop ë ˆì¸'));
            managerResults.push(assertEqual(manager.determineLane({ status: 'RUN', alarmCode: null, isProducing: true }), 'run', 'RUN ìƒíƒœ â†’ Run ë ˆì¸'));
            managerResults.push(assertEqual(manager.determineLane({ status: 'RUN', alarmCode: null, isProducing: false }), 'wait', 'ë¹„ìƒì‚° â†’ Wait ë ˆì¸'));
            managerResults.push(assert(manager.isProducing({ lotInfo: { isStart: 1, isEnd: 0 } }) === true, 'Lot ì§„í–‰ ì¤‘ â†’ ìƒì‚°ì¤‘'));
            managerResults.push(assert(manager.isProducing({ lotInfo: null }) === false, 'Lot ì—†ìŒ â†’ ë¹„ìƒì‚°'));
            
            displayResult('RankingDataManager í…ŒìŠ¤íŠ¸', managerResults);
            
            console.log(`âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${passCount} í†µê³¼, ${failCount} ì‹¤íŒ¨`);
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€
        console.log('ğŸ§ª Phase 3 í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
        console.log('ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
    </script>
</body>
</html>