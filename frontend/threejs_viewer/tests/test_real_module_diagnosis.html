<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Real Module Diagnosis Test</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { color: #00d4ff; margin-bottom: 20px; font-size: 1.5rem; }
        h2 { color: #ffd700; margin: 20px 0 10px; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: #16213e; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .result-box {
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #00ff88; }
        .error { color: #ff4757; }
        .warning { color: #ffa502; }
        .info { color: #70a1ff; }
        button {
            background: #4a69bd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #6a89cc; }
        button.primary { background: #00d4ff; color: #000; }
        button.success { background: #2ed573; color: #000; }
        button.danger { background: #ff4757; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #0f0f23; color: #00d4ff; }
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .dot-green { background: #2ed573; }
        .dot-red { background: #ff4757; }
        .dot-yellow { background: #ffa502; }
        .mode-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .mode-main_viewer { background: #636e72; }
        .mode-monitoring { background: #00b894; }
        .mode-equipment_edit { background: #fdcb6e; color: #000; }
        #log-output { height: 500px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Real Module Diagnosis Test</h1>
        <p style="color: #888; margin-bottom: 20px;">
            ì´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œ í”„ë¡œì íŠ¸ ëª¨ë“ˆì„ importí•˜ì—¬ ë¬¸ì œë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.<br>
            <strong>ìœ„ì¹˜:</strong> frontend/threejs_viewer/tests/ í´ë”ì— ì €ì¥í•˜ê³  http-serverë¡œ ì‹¤í–‰í•˜ì„¸ìš”.
        </p>
        
        <div class="section">
            <h2>ğŸ“Š í˜„ì¬ ìƒíƒœ</h2>
            <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                <div>
                    <span class="status-dot dot-yellow" id="load-dot"></span>
                    ëª¨ë“ˆ ë¡œë“œ: <span id="load-status">ëŒ€ê¸°ì¤‘</span>
                </div>
                <div>
                    í˜„ì¬ ëª¨ë“œ: <span id="current-mode" class="mode-badge mode-main_viewer">-</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>ğŸ§ª ì§„ë‹¨ í…ŒìŠ¤íŠ¸</h2>
            <button onclick="runDiagnosis()" class="primary">ğŸ” ì „ì²´ ì§„ë‹¨ ì‹¤í–‰</button>
            <button onclick="testAppModeOnly()">APP_MODE í…ŒìŠ¤íŠ¸</button>
            <button onclick="testSidebarOnly()">Sidebar í…ŒìŠ¤íŠ¸</button>
            <button onclick="testModeHandlers()">ModeHandlers í…ŒìŠ¤íŠ¸</button>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
        
        <div class="section">
            <h2>ğŸ® ëª¨ë“œ ì „í™˜ í…ŒìŠ¤íŠ¸</h2>
            <button onclick="simulateMonitoringButton()" class="success">ğŸ“¡ Monitoring ë²„íŠ¼ ì‹œë®¬ë ˆì´ì…˜</button>
            <button onclick="directMonitoringMode()">ì§ì ‘ Monitoring ì „í™˜</button>
            <button onclick="directMainViewer()">Main Viewer ë³µê·€</button>
        </div>
        
        <div class="section">
            <h2>ğŸ“ ì§„ë‹¨ ê²°ê³¼</h2>
            <div id="diagnosis-result" class="result-box" style="min-height: 100px;"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
            <div id="log-output" class="result-box"></div>
        </div>
    </div>

    <script type="module">
        // ============================================
        // ë¡œê·¸ ìœ í‹¸ë¦¬í‹°
        // ============================================
        function log(message, type = 'info') {
            const output = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<span class="${type}">[${time}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }
        
        window.clearLog = function() {
            document.getElementById('log-output').innerHTML = '';
        };
        
        function setLoadStatus(status, isOk) {
            const dot = document.getElementById('load-dot');
            const text = document.getElementById('load-status');
            dot.className = `status-dot ${isOk ? 'dot-green' : 'dot-red'}`;
            text.textContent = status;
        }
        
        function updateModeDisplay(mode) {
            const el = document.getElementById('current-mode');
            el.textContent = mode || '-';
            el.className = `mode-badge mode-${mode || 'unknown'}`;
        }
        
        // ============================================
        // ëª¨ë“ˆ ë¡œë“œ
        // ============================================
        let APP_MODE, MODE_MAP, appModeManager, modeHandlers, Sidebar;
        let loadedModules = {};
        
        async function loadModules() {
            log('ğŸ“¦ ëª¨ë“ˆ ë¡œë“œ ì‹œì‘...', 'info');
            
            try {
                // 1. constants.jsì—ì„œ APP_MODE ë¡œë“œ
                try {
                    const constants = await import('../src/core/config/constants.js');
                    APP_MODE = constants.APP_MODE;
                    loadedModules.APP_MODE = APP_MODE;
                    log(`âœ… APP_MODE ë¡œë“œ ì„±ê³µ: ${Object.keys(APP_MODE).length}ê°œ ëª¨ë“œ`, 'success');
                } catch (e) {
                    log(`âŒ APP_MODE ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                }
                
                // 2. SidebarConfig.jsì—ì„œ MODE_MAP ë¡œë“œ
                try {
                    const sidebarConfig = await import('../src/ui/sidebar/SidebarConfig.js');
                    MODE_MAP = sidebarConfig.MODE_MAP;
                    loadedModules.MODE_MAP = MODE_MAP;
                    log(`âœ… MODE_MAP ë¡œë“œ ì„±ê³µ: ${Object.keys(MODE_MAP).length}ê°œ ë§¤í•‘`, 'success');
                } catch (e) {
                    log(`âŒ MODE_MAP ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                }
                
                // 3. AppModeManager ë¡œë“œ
                try {
                    const modeManager = await import('../src/core/managers/AppModeManager.js');
                    appModeManager = modeManager.appModeManager;
                    loadedModules.appModeManager = appModeManager;
                    log(`âœ… AppModeManager ë¡œë“œ ì„±ê³µ`, 'success');
                } catch (e) {
                    log(`âŒ AppModeManager ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                }
                
                // 4. ModeHandlers ë¡œë“œ
                try {
                    const handlers = await import('../src/core/managers/ModeHandlers.js');
                    modeHandlers = handlers.modeHandlers;
                    loadedModules.modeHandlers = modeHandlers;
                    log(`âœ… ModeHandlers ë¡œë“œ ì„±ê³µ: ${Object.keys(modeHandlers).length}ê°œ`, 'success');
                } catch (e) {
                    log(`âŒ ModeHandlers ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                }
                
                // 5. Sidebar ë¡œë“œ
                try {
                    const sidebarModule = await import('../src/ui/sidebar/Sidebar.js');
                    Sidebar = sidebarModule.Sidebar;
                    loadedModules.Sidebar = Sidebar;
                    log(`âœ… Sidebar ë¡œë“œ ì„±ê³µ`, 'success');
                } catch (e) {
                    log(`âŒ Sidebar ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                }
                
                setLoadStatus('ë¡œë“œ ì™„ë£Œ', true);
                log('ğŸ“¦ ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ!', 'success');
                
                // ì „ì—­ ë…¸ì¶œ
                window.loadedModules = loadedModules;
                window.APP_MODE = APP_MODE;
                window.MODE_MAP = MODE_MAP;
                window.appModeManager = appModeManager;
                
                if (appModeManager) {
                    updateModeDisplay(appModeManager.getCurrentMode());
                }
                
            } catch (error) {
                setLoadStatus('ë¡œë“œ ì‹¤íŒ¨', false);
                log(`âŒ ëª¨ë“ˆ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ============================================
        // ì§„ë‹¨ í•¨ìˆ˜ë“¤
        // ============================================
        window.runDiagnosis = function() {
            clearLog();
            log('ğŸ” ì „ì²´ ì§„ë‹¨ ì‹œì‘...', 'info');
            log('â•'.repeat(50), 'info');
            
            const results = [];
            
            // 1. APP_MODE ì²´í¬
            log('\nğŸ“ [1/5] APP_MODE ì²´í¬', 'info');
            if (!APP_MODE) {
                results.push({ type: 'error', msg: 'APP_MODEê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ' });
                log('âŒ APP_MODEê°€ undefinedì…ë‹ˆë‹¤!', 'error');
            } else {
                log(`âœ… APP_MODE ì¡´ì¬: ${Object.keys(APP_MODE).join(', ')}`, 'success');
                log(`   MONITORING = '${APP_MODE.MONITORING}'`, 'info');
            }
            
            // 2. MODE_MAP ì²´í¬
            log('\nğŸ“ [2/5] MODE_MAP ì²´í¬', 'info');
            if (!MODE_MAP) {
                results.push({ type: 'error', msg: 'MODE_MAPê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ' });
                log('âŒ MODE_MAPê°€ undefinedì…ë‹ˆë‹¤!', 'error');
            } else {
                log(`âœ… MODE_MAP ì¡´ì¬`, 'success');
                Object.entries(MODE_MAP).forEach(([k, v]) => {
                    const appModeVal = APP_MODE?.[v];
                    log(`   '${k}' â†’ '${v}' â†’ '${appModeVal}'`, appModeVal ? 'success' : 'error');
                    if (!appModeVal) {
                        results.push({ type: 'error', msg: `MODE_MAP['${k}'] â†’ APP_MODE['${v}']ê°€ undefined` });
                    }
                });
            }
            
            // 3. AppModeManager ì²´í¬
            log('\nğŸ“ [3/5] AppModeManager ì²´í¬', 'info');
            if (!appModeManager) {
                results.push({ type: 'error', msg: 'AppModeManagerê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ' });
                log('âŒ AppModeManagerê°€ undefinedì…ë‹ˆë‹¤!', 'error');
            } else {
                log(`âœ… AppModeManager ì¡´ì¬`, 'success');
                log(`   í˜„ì¬ ëª¨ë“œ: ${appModeManager.getCurrentMode()}`, 'info');
                log(`   Backend ì˜¨ë¼ì¸: ${appModeManager.isBackendOnline()}`, 'info');
            }
            
            // 4. ModeHandlers ì²´í¬
            log('\nğŸ“ [4/5] ModeHandlers ì²´í¬', 'info');
            if (!modeHandlers) {
                results.push({ type: 'error', msg: 'ModeHandlersê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ' });
                log('âŒ ModeHandlersê°€ undefinedì…ë‹ˆë‹¤!', 'error');
            } else {
                log(`âœ… ModeHandlers ì¡´ì¬`, 'success');
                
                const monitoringHandler = modeHandlers[APP_MODE?.MONITORING];
                if (!monitoringHandler) {
                    results.push({ type: 'error', msg: 'Monitoring í•¸ë“¤ëŸ¬ê°€ ë“±ë¡ë˜ì§€ ì•ŠìŒ' });
                    log(`âŒ modeHandlers['${APP_MODE?.MONITORING}'] ì—†ìŒ!`, 'error');
                } else {
                    log(`âœ… Monitoring í•¸ë“¤ëŸ¬ ì¡´ì¬`, 'success');
                    log(`   _monitoringService: ${monitoringHandler._monitoringService ? 'SET' : 'NULL'}`, 
                        monitoringHandler._monitoringService ? 'success' : 'warning');
                    
                    if (!monitoringHandler._monitoringService) {
                        results.push({ type: 'warning', msg: 'MonitoringServiceê°€ í•¸ë“¤ëŸ¬ì— ì—°ê²°ë˜ì§€ ì•ŠìŒ' });
                    }
                }
            }
            
            // 5. window.sidebarUI ì²´í¬
            log('\nğŸ“ [5/5] window.sidebarUI ì²´í¬', 'info');
            if (!window.sidebarUI?.sidebar) {
                results.push({ type: 'warning', msg: 'window.sidebarUI.sidebarê°€ ì—†ìŒ (ì•„ì§ ì´ˆê¸°í™” ì•ˆë¨?)' });
                log('âš ï¸ window.sidebarUI.sidebarê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            } else {
                const sidebar = window.sidebarUI.sidebar;
                log(`âœ… window.sidebarUI.sidebar ì¡´ì¬`, 'success');
                log(`   APP_MODE í‚¤ ê°œìˆ˜: ${Object.keys(sidebar.APP_MODE || {}).length}`, 'info');
                log(`   appModeManager: ${sidebar.appModeManager ? 'SET' : 'NULL'}`, 
                    sidebar.appModeManager ? 'success' : 'error');
                
                if (Object.keys(sidebar.APP_MODE || {}).length === 0) {
                    results.push({ type: 'error', msg: 'Sidebar.APP_MODEê°€ ë¹ˆ ê°ì²´ì„!' });
                    log('âŒ Sidebar.APP_MODEê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!', 'error');
                }
            }
            
            // ê²°ê³¼ ìš”ì•½
            log('\n' + 'â•'.repeat(50), 'info');
            log('ğŸ“‹ ì§„ë‹¨ ê²°ê³¼ ìš”ì•½', 'info');
            
            const errors = results.filter(r => r.type === 'error');
            const warnings = results.filter(r => r.type === 'warning');
            
            const diagnosisEl = document.getElementById('diagnosis-result');
            let html = '';
            
            if (errors.length === 0 && warnings.length === 0) {
                html = '<span class="success">âœ… ëª¨ë“  ì§„ë‹¨ í†µê³¼! ë¬¸ì œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span>';
                log('âœ… ëª¨ë“  ì§„ë‹¨ í†µê³¼!', 'success');
            } else {
                if (errors.length > 0) {
                    html += `<strong class="error">âŒ ì˜¤ë¥˜ ${errors.length}ê°œ:</strong>\n`;
                    errors.forEach(e => {
                        html += `  - ${e.msg}\n`;
                        log(`âŒ ${e.msg}`, 'error');
                    });
                }
                if (warnings.length > 0) {
                    html += `\n<strong class="warning">âš ï¸ ê²½ê³  ${warnings.length}ê°œ:</strong>\n`;
                    warnings.forEach(w => {
                        html += `  - ${w.msg}\n`;
                        log(`âš ï¸ ${w.msg}`, 'warning');
                    });
                }
            }
            
            diagnosisEl.innerHTML = html;
        };
        
        window.testAppModeOnly = function() {
            log('\nğŸ§ª APP_MODE ìƒì„¸ í…ŒìŠ¤íŠ¸', 'info');
            log(JSON.stringify(APP_MODE, null, 2), 'info');
        };
        
        window.testSidebarOnly = function() {
            log('\nğŸ§ª Sidebar ìƒì„¸ í…ŒìŠ¤íŠ¸', 'info');
            const sidebar = window.sidebarUI?.sidebar;
            if (!sidebar) {
                log('âŒ window.sidebarUI.sidebarê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
                return;
            }
            
            log(`APP_MODE: ${JSON.stringify(sidebar.APP_MODE, null, 2)}`, 'info');
            log(`appModeManager: ${sidebar.appModeManager ? 'SET' : 'NULL'}`, 'info');
            log(`isConnected: ${sidebar.isConnected}`, 'info');
            log(`currentMode: ${sidebar.currentMode}`, 'info');
        };
        
        window.testModeHandlers = function() {
            log('\nğŸ§ª ModeHandlers ìƒì„¸ í…ŒìŠ¤íŠ¸', 'info');
            if (!modeHandlers) {
                log('âŒ modeHandlersê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
                return;
            }
            
            Object.entries(modeHandlers).forEach(([mode, handler]) => {
                log(`\nğŸ“ ${mode}:`, 'info');
                log(`   name: ${handler.name}`, 'info');
                log(`   _monitoringService: ${handler._monitoringService ? 'SET' : 'NULL'}`, 'info');
                log(`   _signalTowerManager: ${handler._signalTowerManager ? 'SET' : 'NULL'}`, 'info');
            });
        };
        
        window.simulateMonitoringButton = function() {
            log('\nğŸ–±ï¸ Monitoring ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜', 'info');
            log('â•'.repeat(40), 'info');
            
            const sidebar = window.sidebarUI?.sidebar;
            if (!sidebar) {
                log('âŒ Sidebarë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', 'error');
                return;
            }
            
            log(`1. sidebar._setMode('monitoring') í˜¸ì¶œ`, 'info');
            log(`2. MODE_MAP['monitoring'] = '${MODE_MAP?.['monitoring']}'`, 'info');
            log(`3. sidebar.APP_MODE['${MODE_MAP?.['monitoring']}'] = '${sidebar.APP_MODE?.[MODE_MAP?.['monitoring']]}'`, 'info');
            
            // ì‹¤ì œ í˜¸ì¶œ
            try {
                sidebar._setMode('monitoring');
                
                setTimeout(() => {
                    const currentMode = appModeManager?.getCurrentMode();
                    log(`\nê²°ê³¼: í˜„ì¬ ëª¨ë“œ = '${currentMode}'`, currentMode === 'monitoring' ? 'success' : 'error');
                    updateModeDisplay(currentMode);
                }, 100);
            } catch (e) {
                log(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        };
        
        window.directMonitoringMode = function() {
            log('\nğŸ”€ ì§ì ‘ switchMode("monitoring") í˜¸ì¶œ', 'info');
            
            if (!appModeManager) {
                log('âŒ appModeManagerê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
                return;
            }
            
            appModeManager.switchMode('monitoring', { skipConnectionCheck: true })
                .then(result => {
                    log(`ê²°ê³¼: ${result ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`, result ? 'success' : 'error');
                    updateModeDisplay(appModeManager.getCurrentMode());
                });
        };
        
        window.directMainViewer = function() {
            log('\nğŸ  Main Viewer ë³µê·€', 'info');
            
            if (!appModeManager) {
                log('âŒ appModeManagerê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
                return;
            }
            
            appModeManager.switchMode('main_viewer', { skipConnectionCheck: true })
                .then(result => {
                    log(`ê²°ê³¼: ${result ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`, result ? 'success' : 'error');
                    updateModeDisplay(appModeManager.getCurrentMode());
                });
        };
        
        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        log('ğŸš€ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì‹œì‘', 'info');
        await loadModules();
        
    </script>
</body>
</html>