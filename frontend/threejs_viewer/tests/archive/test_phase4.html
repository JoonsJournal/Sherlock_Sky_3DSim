<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 í…ŒìŠ¤íŠ¸ - Layout2DTo3DConverter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        
        h1 {
            color: #4fc3f7;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #0f3460;
        }
        
        .test-section h2 {
            color: #e94560;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            background: #0f3460;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #e94560;
            transform: translateY(-2px);
        }
        
        button.success {
            background: #4caf50;
        }
        
        button.warning {
            background: #ff9800;
        }
        
        .output {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #333;
        }
        
        .output.success {
            border-color: #4caf50;
        }
        
        .output.error {
            border-color: #f44336;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f3460;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-indicator.loaded {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }
        
        .status-indicator.error {
            background: #f44336;
        }
        
        #console-output {
            min-height: 200px;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        
        .test-result.pass {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4caf50;
        }
        
        .test-result.fail {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid #f44336;
        }
        
        .summary {
            text-align: center;
            font-size: 18px;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .summary.pass {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }
        
        .summary.fail {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Phase 4 í…ŒìŠ¤íŠ¸ - Layout 2Dâ†’3D ë³€í™˜</h1>
        
        <!-- ìƒíƒœ ë°” -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="status-coordinator"></div>
                <span>CoordinateUtils</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="status-converter"></div>
                <span>Layout2DTo3DConverter</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="status-config"></div>
                <span>Config Dynamic</span>
            </div>
            <div class="status-item">
                <div class="status-indicator" id="status-scene"></div>
                <span>SceneManager</span>
            </div>
        </div>
        
        <!-- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="test-section">
            <h2>ğŸ“‹ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Unit Tests)</h2>
            <div class="btn-group">
                <button onclick="runAndDisplay('runCoordinateUtilsTests', 'unit-output')">
                    ğŸ§­ CoordinateUtils í…ŒìŠ¤íŠ¸
                </button>
                <button onclick="runAndDisplay('runLayoutConverterTests', 'unit-output')">
                    ğŸ”„ Layout Converter í…ŒìŠ¤íŠ¸
                </button>
                <button onclick="runAndDisplay('runConfigDynamicTests', 'unit-output')">
                    âš™ï¸ Config Dynamic í…ŒìŠ¤íŠ¸
                </button>
                <button onclick="runAllUnitTests()" class="success">
                    â–¶ï¸ ì „ì²´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                </button>
            </div>
            <div class="output" id="unit-output">í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
        
        <!-- í†µí•© í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="test-section">
            <h2>ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ (Integration Tests)</h2>
            <div class="btn-group">
                <button onclick="runAndDisplay('runIntegrationTests', 'integration-output')">
                    ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                </button>
            </div>
            <div class="output" id="integration-output">í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
        
        <!-- ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="test-section">
            <h2>ğŸ”§ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ (Manual Tests)</h2>
            <div class="btn-group">
                <button onclick="testConvertMockLayout()">
                    ğŸ“„ Mock Layout ë³€í™˜
                </button>
                <button onclick="testCoordinateConversion()">
                    ğŸ§­ ì¢Œí‘œ ë³€í™˜ í…ŒìŠ¤íŠ¸
                </button>
                <button onclick="testConfigUpdate()">
                    âš™ï¸ CONFIG ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸
                </button>
                <button onclick="showDebugInfo()" class="warning">
                    ğŸ” ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
                </button>
            </div>
            <div class="output" id="manual-output">ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
        
        <!-- ì½˜ì†” ì¶œë ¥ -->
        <div class="test-section">
            <h2>ğŸ“ ì½˜ì†” ì¶œë ¥</h2>
            <button onclick="clearConsoleOutput()">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
            <div class="output" id="console-output"></div>
        </div>
    </div>
    
    <!-- Three.js Import Map -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <!-- í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ëª¨ë“ˆ ë¡œë“œ -->
    <script type="module">
        // CoordinateUtils ë¡œë“œ
        import { CoordinateUtils, coordinateUtils } from '../src/services/converter/CoordinateUtils.js';
        window.CoordinateUtils = CoordinateUtils;
        window.coordinateUtils = coordinateUtils;
        
        // Layout2DTo3DConverter ë¡œë“œ
        import { Layout2DTo3DConverter, layout2DTo3DConverter } from '../src/services/converter/Layout2DTo3DConverter.js';
        window.Layout2DTo3DConverter = Layout2DTo3DConverter;
        window.layout2DTo3DConverter = layout2DTo3DConverter;
        
        // Config ë¡œë“œ
        import { CONFIG, updateEquipmentConfig, updateSceneConfig, resetConfig, debugConfig } from '../src/utils/Config.js';
        window.CONFIG = CONFIG;
        window.updateEquipmentConfig = updateEquipmentConfig;
        window.updateSceneConfig = updateSceneConfig;
        window.resetConfig = resetConfig;
        window.debugConfig = debugConfig;
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        document.getElementById('status-coordinator').classList.add('loaded');
        document.getElementById('status-converter').classList.add('loaded');
        document.getElementById('status-config').classList.add('loaded');
        
        console.log('âœ… Phase 4 ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ');
        
        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.modulesLoaded = true;
    </script>
    
    <!-- í…ŒìŠ¤íŠ¸ íŒŒì¼ ë¡œë“œ -->
    <script src="./unit/test_coordinate_utils.test.js"></script>
    <script src="./unit/test_layout_converter.test.js"></script>
    <script src="./unit/test_config_dynamic.test.js"></script>
    <!-- âœ¨ ê²½ë¡œ ìˆ˜ì •: integration í´ë” -->
<script src="./integration/test_integration_phase4.test.js"></script>
    
<!-- í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // ì½˜ì†” ì¶œë ¥ ìº¡ì²˜ - ê°œì„ ëœ ë²„ì „
    const consoleOutput = document.getElementById('console-output');
    let consoleBuffer = [];
    let indentLevel = 0;
    
    // ì›ë³¸ ì½˜ì†” í•¨ìˆ˜ ì €ì¥
    const originalConsole = {
        log: console.log.bind(console),
        error: console.error.bind(console),
        warn: console.warn.bind(console),
        group: console.group.bind(console),
        groupEnd: console.groupEnd.bind(console)
    };
    
    function setupConsoleCapture() {
        console.log = (...args) => {
            const indent = '  '.repeat(indentLevel);
            const msg = indent + args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
            consoleBuffer.push(msg);
            updateConsoleOutput();
            originalConsole.log(...args);
        };
        
        console.error = (...args) => {
            const indent = '  '.repeat(indentLevel);
            const msg = indent + 'âŒ ' + args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
            consoleBuffer.push(msg);
            updateConsoleOutput();
            originalConsole.error(...args);
        };
        
        console.warn = (...args) => {
            const indent = '  '.repeat(indentLevel);
            const msg = indent + 'âš ï¸ ' + args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
            consoleBuffer.push(msg);
            updateConsoleOutput();
            originalConsole.warn(...args);
        };
        
        console.group = (name) => {
            const indent = '  '.repeat(indentLevel);
            consoleBuffer.push(indent + 'ğŸ“ ' + name);
            indentLevel++;
            updateConsoleOutput();
            originalConsole.group(name);
        };
        
        console.groupEnd = () => {
            indentLevel = Math.max(0, indentLevel - 1);
            originalConsole.groupEnd();
        };
    }
    
    function updateConsoleOutput() {
        if (consoleOutput) {
            consoleOutput.textContent = consoleBuffer.slice(-100).join('\n');
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
    }
    
    function clearConsoleBuffer() {
        consoleBuffer = [];
        indentLevel = 0;
        updateConsoleOutput();
    }
    
    // í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° í‘œì‹œ í•¨ìˆ˜
    function runAndDisplay(testFnName, outputId) {
        const outputEl = document.getElementById(outputId);
        
        if (!window[testFnName]) {
            outputEl.textContent = `âŒ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${testFnName}\n\në¡œë“œëœ í•¨ìˆ˜ ëª©ë¡:\n` +
                Object.keys(window).filter(k => k.startsWith('run')).join('\n');
            outputEl.classList.add('error');
            return;
        }
        
        // ë²„í¼ ì´ˆê¸°í™”
        const beforeBuffer = [...consoleBuffer];
        
        try {
            const success = window[testFnName]();
            
            // ì´ì „ ë²„í¼ ì´í›„ì˜ ë‚´ìš©ë§Œ ì¶”ì¶œ
            const newLogs = consoleBuffer.slice(beforeBuffer.length);
            
            outputEl.textContent = newLogs.join('\n');
            outputEl.classList.remove('error', 'success');
            outputEl.classList.add(success ? 'success' : 'error');
        } catch (error) {
            outputEl.textContent = `âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜: ${error.message}\n\nStack:\n${error.stack}`;
            outputEl.classList.add('error');
        }
    }
    
    // ì „ì²´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    function runAllUnitTests() {
        const outputEl = document.getElementById('unit-output');
        const beforeBuffer = [...consoleBuffer];
        
        let allPassed = true;
        
        console.log('ğŸš€ ì „ì²´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹œì‘\n');
        console.log('='.repeat(60) + '\n');
        
        // CoordinateUtils í…ŒìŠ¤íŠ¸
        if (window.runCoordinateUtilsTests) {
            allPassed = window.runCoordinateUtilsTests() && allPassed;
        } else {
            console.error('runCoordinateUtilsTests í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        console.log('\n');
        
        // LayoutConverter í…ŒìŠ¤íŠ¸
        if (window.runLayoutConverterTests) {
            allPassed = window.runLayoutConverterTests() && allPassed;
        } else {
            console.error('runLayoutConverterTests í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        console.log('\n');
        
        // Config Dynamic í…ŒìŠ¤íŠ¸
        if (window.runConfigDynamicTests) {
            allPassed = window.runConfigDynamicTests() && allPassed;
        } else {
            console.error('runConfigDynamicTests í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        console.log('\n' + '='.repeat(60));
        console.log(allPassed ? 'ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!' : 'âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
        
        const newLogs = consoleBuffer.slice(beforeBuffer.length);
        outputEl.textContent = newLogs.join('\n');
        outputEl.classList.remove('error', 'success');
        outputEl.classList.add(allPassed ? 'success' : 'error');
    }
    
    // ìˆ˜ë™ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
    function testConvertMockLayout() {
        const outputEl = document.getElementById('manual-output');
        
        if (!window.layout2DTo3DConverter) {
            outputEl.textContent = 'âŒ layout2DTo3DConverterê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            return;
        }
        
        const testLayout = window.mockLayoutData || {
            version: "1.0",
            site_id: "manual_test",
            canvas: { width: 1200, height: 800, scale: 10 },
            room: { width: 40, depth: 60, wallHeight: 4 },
            equipmentArrays: [{ rows: 26, cols: 6 }]
        };
        
        const result = window.layout2DTo3DConverter.convert(testLayout);
        
        outputEl.textContent = 'ğŸ“„ Mock Layout ë³€í™˜ ê²°ê³¼:\n\n' + 
            JSON.stringify(result, null, 2);
        outputEl.classList.add('success');
    }
    
    function testCoordinateConversion() {
        const outputEl = document.getElementById('manual-output');
        
        if (!window.coordinateUtils) {
            outputEl.textContent = 'âŒ coordinateUtilsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            return;
        }
        
        const tests = [
            { name: 'Canvas ì¤‘ì‹¬ (600, 400)', input: [600, 400] },
            { name: 'Canvas ì¢Œìƒë‹¨ (0, 0)', input: [0, 0] },
            { name: 'Canvas ìš°í•˜ë‹¨ (1200, 800)', input: [1200, 800] },
            { name: 'ì„ì˜ ì  (300, 500)', input: [300, 500] }
        ];
        
        let output = 'ğŸ§­ ì¢Œí‘œ ë³€í™˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n\n';
        
        tests.forEach(test => {
            const result = window.coordinateUtils.canvas2DToWorld3D(...test.input);
            output += `${test.name}\n`;
            output += `  2D: (${test.input[0]}, ${test.input[1]}) px\n`;
            output += `  3D: (${result.x.toFixed(2)}, ${result.z.toFixed(2)}) m\n\n`;
        });
        
        outputEl.textContent = output;
        outputEl.classList.add('success');
    }
    
    function testConfigUpdate() {
        const outputEl = document.getElementById('manual-output');
        
        if (!window.updateEquipmentConfig || !window.resetConfig) {
            outputEl.textContent = 'âŒ CONFIG í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            return;
        }
        
        let output = 'âš™ï¸ CONFIG ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸:\n\n';
        
        window.resetConfig();
        output += `1. ì´ˆê¸°ê°’:\n`;
        output += `   ROWS: ${CONFIG.EQUIPMENT.ROWS}, COLS: ${CONFIG.EQUIPMENT.COLS}\n\n`;
        
        window.updateEquipmentConfig({ ROWS: 20, COLS: 8 });
        output += `2. ì—…ë°ì´íŠ¸ í›„ (ROWS: 20, COLS: 8):\n`;
        output += `   ROWS: ${CONFIG.EQUIPMENT.ROWS}, COLS: ${CONFIG.EQUIPMENT.COLS}\n\n`;
        
        window.resetConfig();
        output += `3. ë¦¬ì…‹ í›„:\n`;
        output += `   ROWS: ${CONFIG.EQUIPMENT.ROWS}, COLS: ${CONFIG.EQUIPMENT.COLS}\n`;
        
        outputEl.textContent = output;
        outputEl.classList.add('success');
    }
    
    function showDebugInfo() {
        const outputEl = document.getElementById('manual-output');
        
        let output = 'ğŸ” ë””ë²„ê·¸ ì •ë³´:\n\n';
        
        output += '=== ë¡œë“œëœ ëª¨ë“ˆ ===\n';
        output += `CoordinateUtils: ${!!window.CoordinateUtils}\n`;
        output += `coordinateUtils: ${!!window.coordinateUtils}\n`;
        output += `Layout2DTo3DConverter: ${!!window.Layout2DTo3DConverter}\n`;
        output += `layout2DTo3DConverter: ${!!window.layout2DTo3DConverter}\n`;
        output += `CONFIG: ${!!window.CONFIG}\n`;
        output += `updateEquipmentConfig: ${!!window.updateEquipmentConfig}\n`;
        output += `resetConfig: ${!!window.resetConfig}\n\n`;
        
        output += '=== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ===\n';
        output += `runCoordinateUtilsTests: ${!!window.runCoordinateUtilsTests}\n`;
        output += `runLayoutConverterTests: ${!!window.runLayoutConverterTests}\n`;
        output += `runConfigDynamicTests: ${!!window.runConfigDynamicTests}\n`;
        output += `runIntegrationTests: ${!!window.runIntegrationTests}\n\n`;
        
        output += '=== 3D Viewer ê°ì²´ ===\n';
        output += `sceneManager: ${!!window.sceneManager}\n`;
        output += `equipmentLoader: ${!!window.equipmentLoader}\n\n`;
        
        if (window.CONFIG) {
            output += '=== í˜„ì¬ CONFIG ===\n';
            output += `EQUIPMENT.ROWS: ${CONFIG.EQUIPMENT.ROWS}\n`;
            output += `EQUIPMENT.COLS: ${CONFIG.EQUIPMENT.COLS}\n`;
            output += `EQUIPMENT.SIZE: ${JSON.stringify(CONFIG.EQUIPMENT.SIZE)}\n`;
            output += `SCENE.FLOOR_SIZE: ${CONFIG.SCENE.FLOOR_SIZE}\n`;
        }
        
        outputEl.textContent = output;
    }
    
    function clearConsoleOutput() {
        clearConsoleBuffer();
        document.getElementById('console-output').textContent = '';
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', () => {
        setupConsoleCapture();
        console.log('ğŸ§ª Phase 4 í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        console.log('ğŸ’¡ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
    });
    
    // ëª¨ë“ˆ ë¡œë“œ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
    window.addEventListener('load', () => {
        setTimeout(() => {
            if (window.coordinateUtils) {
                document.getElementById('status-coordinator').classList.add('loaded');
            }
            if (window.layout2DTo3DConverter) {
                document.getElementById('status-converter').classList.add('loaded');
            }
            if (window.updateEquipmentConfig) {
                document.getElementById('status-config').classList.add('loaded');
            }
            if (window.sceneManager) {
                document.getElementById('status-scene').classList.add('loaded');
            }
            
            // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ í™•ì¸ ë¡œê·¸
            console.log('ğŸ“‹ ë¡œë“œëœ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜:');
            console.log(`  - runCoordinateUtilsTests: ${!!window.runCoordinateUtilsTests}`);
            console.log(`  - runLayoutConverterTests: ${!!window.runLayoutConverterTests}`);
            console.log(`  - runConfigDynamicTests: ${!!window.runConfigDynamicTests}`);
            console.log(`  - runIntegrationTests: ${!!window.runIntegrationTests}`);
        }, 1000);
    });
</script>
</body>
</html>
