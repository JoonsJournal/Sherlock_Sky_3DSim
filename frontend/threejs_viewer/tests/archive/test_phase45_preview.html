<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4.5 - 3D Preview ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .test-section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .test-card {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #444;
        }
        
        .test-card h3 {
            color: #4ecdc4;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .test-card p {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        button.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        button.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        button.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .result-box {
            background: #0f0f1a;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #333;
        }
        
        .result-box.success {
            border-color: #2ecc71;
        }
        
        .result-box.error {
            border-color: #e74c3c;
        }
        
        #canvas-container {
            width: 100%;
            height: 400px;
            background: #0a0a15;
            border-radius: 8px;
            border: 1px solid #333;
            position: relative;
        }
        
        #preview-canvas {
            width: 100%;
            height: 100%;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-badge.pending {
            background: #f39c12;
            color: #000;
        }
        
        .status-badge.pass {
            background: #2ecc71;
            color: #fff;
        }
        
        .status-badge.fail {
            background: #e74c3c;
            color: #fff;
        }
        
        .checklist {
            list-style: none;
            padding: 0;
        }
        
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
        }
        
        .checklist li:last-child {
            border-bottom: none;
        }
        
        .check-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .check-icon.pending {
            background: #444;
            color: #888;
        }
        
        .check-icon.pass {
            background: #2ecc71;
            color: #fff;
        }
        
        .check-icon.fail {
            background: #e74c3c;
            color: #fff;
        }
        
        /* Preview Modal Styles */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .preview-modal.show {
            display: flex;
        }
        
        .preview-modal-content {
            background: #1a1a2e;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
        }
        
        .preview-modal-header {
            padding: 15px 20px;
            background: #16213e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        .preview-modal-body {
            padding: 20px;
        }
        
        .preview-modal-footer {
            padding: 15px 20px;
            background: #16213e;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #333;
        }
        
        #modal-preview-canvas {
            width: 100%;
            height: 400px;
            background: #0a0a15;
            border-radius: 8px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª Phase 4.5 - 3D Preview ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h1>
        
        <!-- í…ŒìŠ¤íŠ¸ ìƒíƒœ ìš”ì•½ -->
        <div class="test-section">
            <h2>ğŸ“Š í…ŒìŠ¤íŠ¸ ìƒíƒœ ìš”ì•½</h2>
            <ul class="checklist" id="test-checklist">
                <li>
                    <span class="check-icon pending" id="check-1">?</span>
                    <span>Canvas2DEditor.exportLayoutData() í…ŒìŠ¤íŠ¸</span>
                </li>
                <li>
                    <span class="check-icon pending" id="check-2">?</span>
                    <span>PreviewGenerator ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</span>
                </li>
                <li>
                    <span class="check-icon pending" id="check-3">?</span>
                    <span>3D Preview ë Œë”ë§ í…ŒìŠ¤íŠ¸</span>
                </li>
                <li>
                    <span class="check-icon pending" id="check-4">?</span>
                    <span>LayoutEditorMain í†µí•© í…ŒìŠ¤íŠ¸</span>
                </li>
                <li>
                    <span class="check-icon pending" id="check-5">?</span>
                    <span>í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ í…ŒìŠ¤íŠ¸ (Pí‚¤)</span>
                </li>
            </ul>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ 1: Canvas2DEditor.exportLayoutData -->
        <div class="test-section">
            <h2>1ï¸âƒ£ Canvas2DEditor.exportLayoutData() í…ŒìŠ¤íŠ¸</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Layout ë°ì´í„° Export</h3>
                    <p>Canvas2DEditorì—ì„œ í˜„ì¬ Layout ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
                    <button onclick="testExportLayoutData()">Export í…ŒìŠ¤íŠ¸</button>
                    <button onclick="testExtractMethods()" class="warning">ê°œë³„ Extract í…ŒìŠ¤íŠ¸</button>
                </div>
                <div class="test-card">
                    <h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
                    <div class="result-box" id="export-result">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”...</div>
                </div>
            </div>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ 2: PreviewGenerator -->
        <div class="test-section">
            <h2>2ï¸âƒ£ PreviewGenerator ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Preview Generator</h3>
                    <p>Three.js ê¸°ë°˜ 3D Preview ìƒì„±ê¸°ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.</p>
                    <button onclick="testPreviewGeneratorInit()">ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸</button>
                    <button onclick="testPreviewGeneratorDispose()" class="danger">Dispose í…ŒìŠ¤íŠ¸</button>
                </div>
                <div class="test-card">
                    <h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
                    <div class="result-box" id="preview-init-result">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”...</div>
                </div>
            </div>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ 3: 3D Preview ë Œë”ë§ -->
        <div class="test-section">
            <h2>3ï¸âƒ£ 3D Preview ë Œë”ë§ í…ŒìŠ¤íŠ¸</h2>
            <div id="canvas-container">
                <canvas id="preview-canvas"></canvas>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="testRenderPreview()">Preview ë Œë”ë§</button>
                <button onclick="testRenderWithSampleData()" class="success">ìƒ˜í”Œ ë°ì´í„°ë¡œ ë Œë”ë§</button>
                <button onclick="clearPreview()" class="danger">Clear</button>
            </div>
            <div class="result-box" id="render-result" style="margin-top: 15px;">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”...</div>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ 4: LayoutEditorMain í†µí•© -->
        <div class="test-section">
            <h2>4ï¸âƒ£ LayoutEditorMain í†µí•© í…ŒìŠ¤íŠ¸</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Modal í†µí•©</h3>
                    <p>Preview Modal ì—´ê¸°/ë‹«ê¸° ë° ë²„íŠ¼ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
                    <button onclick="testShowPreviewModal()">Preview Modal ì—´ê¸°</button>
                    <button onclick="testSaveAndApply()" class="success">Save & Apply</button>
                    <button onclick="testBackToEdit()" class="warning">Back to Edit</button>
                </div>
                <div class="test-card">
                    <h3>í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
                    <div class="result-box" id="integration-result">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”...</div>
                </div>
            </div>
        </div>
        
        <!-- í…ŒìŠ¤íŠ¸ 5: í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ -->
        <div class="test-section">
            <h2>5ï¸âƒ£ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ í…ŒìŠ¤íŠ¸</h2>
            <div class="test-card">
                <h3>ë‹¨ì¶•í‚¤ ëª©ë¡</h3>
                <p>ì•„ë˜ í‚¤ë¥¼ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong>P</strong> - 3D Preview ì—´ê¸°</li>
                    <li><strong>ESC</strong> - Preview Modal ë‹«ê¸°</li>
                </ul>
                <button onclick="simulateKeyPress('p')">Pí‚¤ ì‹œë®¬ë ˆì´ì…˜</button>
                <button onclick="simulateKeyPress('Escape')" class="warning">ESCí‚¤ ì‹œë®¬ë ˆì´ì…˜</button>
            </div>
            <div class="result-box" id="keyboard-result">í‚¤ë³´ë“œë¥¼ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”...</div>
        </div>
        
        <!-- ì½˜ì†” ë¡œê·¸ -->
        <div class="test-section">
            <h2>ğŸ“ ì½˜ì†” ë¡œê·¸</h2>
            <div class="result-box" id="console-log" style="height: 200px;"></div>
            <button onclick="clearConsoleLog()" class="danger" style="margin-top: 10px;">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="preview-modal" id="preview-modal">
        <div class="preview-modal-content">
            <div class="preview-modal-header">
                <h3>ğŸ–¼ï¸ 3D Layout Preview</h3>
                <button class="close-btn" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="preview-modal-body">
                <canvas id="modal-preview-canvas"></canvas>
                <div id="preview-summary" style="margin-top: 15px; padding: 10px; background: #0a0a15; border-radius: 6px;">
                    <p>Equipment: <span id="summary-equipment">0</span>ê°œ</p>
                    <p>Walls: <span id="summary-walls">0</span>ê°œ</p>
                    <p>Room: <span id="summary-room">-</span></p>
                </div>
            </div>
            <div class="preview-modal-footer">
                <button onclick="closePreviewModal()" class="warning">â† Back to Edit</button>
                <button onclick="handleSaveAndApply()" class="success">Save & Apply to 3D â†’</button>
            </div>
        </div>
    </div>

    <!-- Three.js ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        // ============================================
        // Mock í´ë˜ìŠ¤ë“¤ (ì‹¤ì œ íŒŒì¼ ì—†ì´ í…ŒìŠ¤íŠ¸ìš©)
        // ============================================
        
        // ì½˜ì†” ë¡œê·¸ ìº¡ì²˜
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToUI(type, ...args) {
            const logDiv = document.getElementById('console-log');
            const time = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warn' ? 'âš ï¸' : 'âœ…';
            logDiv.innerHTML += `[${time}] ${prefix} ${args.join(' ')}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog.apply(console, args);
            logToUI('log', ...args);
        };
        
        console.error = (...args) => {
            originalError.apply(console, args);
            logToUI('error', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn.apply(console, args);
            logToUI('warn', ...args);
        };
        
        // Mock Canvas2DEditor
        class MockCanvas2DEditor {
            constructor() {
                this.config = { width: 1200, height: 800, scale: 10, gridSize: 10 };
                this.currentLayout = null;
                this.equipmentShapes = new Map();
                this.wallShapes = new Map();
                this.componentShapes = new Map();
                
                // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€
                for (let i = 0; i < 10; i++) {
                    this.equipmentShapes.set(`EQ-${i}`, { 
                        x: () => 100 + i * 50, 
                        y: () => 100,
                        width: () => 40,
                        height: () => 30,
                        rotation: () => 0,
                        findOne: () => null
                    });
                }
            }
            
            exportLayoutData() {
                console.log('[Canvas2DEditor] Exporting layout data...');
                
                const layoutData = {
                    version: '1.0',
                    site_id: 'test_site',
                    template_name: 'test_template',
                    canvas: this.config,
                    room: this.extractRoomData(),
                    equipmentArrays: this.extractEquipmentArrays(),
                    equipments: this.extractEquipments(),
                    walls: this.extractWalls(),
                    office: this.extractOffice(),
                    components: this.extractComponents(),
                    exported_at: new Date().toISOString()
                };
                
                console.log('[Canvas2DEditor] Layout exported:', {
                    equipmentCount: layoutData.equipments.length,
                    wallCount: layoutData.walls.length
                });
                
                return layoutData;
            }
            
            getCurrentLayoutData() {
                return this.exportLayoutData();
            }
            
            extractRoomData() {
                return {
                    width: this.config.width / this.config.scale,
                    depth: this.config.height / this.config.scale,
                    wallHeight: 4,
                    wallThickness: 0.2
                };
            }
            
            extractEquipmentArrays() {
                return [{
                    rows: 26,
                    cols: 6,
                    equipmentWidth: 1.5,
                    equipmentDepth: 3.0,
                    spacingX: 0.5,
                    spacingZ: 0.5
                }];
            }
            
            extractEquipments() {
                const equipments = [];
                this.equipmentShapes.forEach((shape, id) => {
                    equipments.push({
                        id: id,
                        x: shape.x(),
                        y: shape.y(),
                        width: shape.width(),
                        height: shape.height(),
                        rotation: shape.rotation()
                    });
                });
                return equipments;
            }
            
            extractWalls() {
                return [
                    { id: 'wall-1', start: { x: 0, z: 0 }, end: { x: 100, z: 0 } },
                    { id: 'wall-2', start: { x: 100, z: 0 }, end: { x: 100, z: 80 } }
                ];
            }
            
            extractOffice() {
                return {
                    enabled: true,
                    x: 80,
                    z: -30,
                    width: 15,
                    depth: 25
                };
            }
            
            extractComponents() {
                return [];
            }
        }
        
        // Mock PreviewGenerator
        class MockPreviewGenerator {
            constructor(options = {}) {
                this.container = options.container;
                this.width = options.width || 600;
                this.height = options.height || 400;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.isInitialized = false;
                
                console.log('[PreviewGenerator] Creating instance...');
            }
            
            init() {
                if (this.isInitialized) return true;
                
                try {
                    // Scene
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x1a1a2e);
                    
                    // Camera
                    this.camera = new THREE.PerspectiveCamera(60, this.width / this.height, 0.1, 1000);
                    this.camera.position.set(50, 50, 50);
                    this.camera.lookAt(0, 0, 0);
                    
                    // Renderer
                    this.renderer = new THREE.WebGLRenderer({ 
                        canvas: this.container,
                        antialias: true 
                    });
                    this.renderer.setSize(this.width, this.height);
                    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                    
                    // Controls
                    if (THREE.OrbitControls) {
                        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                        this.controls.enableDamping = true;
                    }
                    
                    // Lights
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                    this.scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(50, 100, 50);
                    this.scene.add(directionalLight);
                    
                    // Grid
                    const gridHelper = new THREE.GridHelper(100, 20, 0x444444, 0x333333);
                    this.scene.add(gridHelper);
                    
                    this.isInitialized = true;
                    console.log('[PreviewGenerator] âœ… Initialized successfully');
                    
                    return true;
                } catch (error) {
                    console.error('[PreviewGenerator] âŒ Initialization failed:', error);
                    return false;
                }
            }
            
            generatePreview(layoutData) {
                if (!this.isInitialized) {
                    this.init();
                }
                
                console.log('[PreviewGenerator] Generating preview...');
                
                // Clear existing objects
                this.clearScene();
                
                // Create room
                if (layoutData.room) {
                    this.createRoom(layoutData.room);
                }
                
                // Create equipment
                if (layoutData.equipments) {
                    layoutData.equipments.forEach(eq => {
                        this.createEquipment(eq);
                    });
                }
                
                // Create walls
                if (layoutData.walls) {
                    layoutData.walls.forEach(wall => {
                        this.createWall(wall);
                    });
                }
                
                // Render
                this.render();
                
                console.log('[PreviewGenerator] âœ… Preview generated');
                
                return {
                    equipmentCount: layoutData.equipments?.length || 0,
                    wallCount: layoutData.walls?.length || 0,
                    room: layoutData.room
                };
            }
            
            clearScene() {
                const objectsToRemove = [];
                this.scene.traverse((child) => {
                    if (child.isMesh && child.name !== 'grid') {
                        objectsToRemove.push(child);
                    }
                });
                objectsToRemove.forEach(obj => {
                    this.scene.remove(obj);
                });
            }
            
            createRoom(room) {
                const width = room.width || 40;
                const depth = room.depth || 60;
                
                // Floor
                const floorGeometry = new THREE.PlaneGeometry(width, depth);
                const floorMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x2a2a4a,
                    side: THREE.DoubleSide
                });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.name = 'floor';
                this.scene.add(floor);
            }
            
            createEquipment(eq) {
                const geometry = new THREE.BoxGeometry(1.5, 2, 3);
                const material = new THREE.MeshStandardMaterial({ color: 0x4a90e2 });
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.set(
                    (eq.x - 600) / 10,  // Canvas ì¢Œí‘œë¥¼ 3D ì¢Œí‘œë¡œ ë³€í™˜
                    1,
                    (eq.y - 400) / 10
                );
                mesh.name = eq.id;
                
                this.scene.add(mesh);
            }
            
            createWall(wall) {
                const start = wall.start;
                const end = wall.end;
                
                const length = Math.sqrt(
                    Math.pow(end.x - start.x, 2) + 
                    Math.pow(end.z - start.z, 2)
                );
                
                const geometry = new THREE.BoxGeometry(length, 4, 0.2);
                const material = new THREE.MeshStandardMaterial({ color: 0x888888 });
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.set(
                    (start.x + end.x) / 2,
                    2,
                    (start.z + end.z) / 2
                );
                
                this.scene.add(mesh);
            }
            
            render() {
                if (this.controls) {
                    this.controls.update();
                }
                this.renderer.render(this.scene, this.camera);
            }
            
            animate() {
                if (!this.isInitialized) return;
                
                requestAnimationFrame(() => this.animate());
                this.render();
            }
            
            dispose() {
                console.log('[PreviewGenerator] Disposing...');
                
                if (this.renderer) {
                    this.renderer.dispose();
                }
                if (this.controls) {
                    this.controls.dispose();
                }
                
                this.isInitialized = false;
                console.log('[PreviewGenerator] âœ… Disposed');
            }
        }
        
        // ============================================
        // ì „ì—­ ì¸ìŠ¤í„´ìŠ¤
        // ============================================
        let canvas2DEditor = null;
        let previewGenerator = null;
        let modalPreviewGenerator = null;
        
        // ============================================
        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        // ============================================
        
        // í…ŒìŠ¤íŠ¸ 1: exportLayoutData
        function testExportLayoutData() {
            const resultDiv = document.getElementById('export-result');
            
            try {
                if (!canvas2DEditor) {
                    canvas2DEditor = new MockCanvas2DEditor();
                }
                
                const layoutData = canvas2DEditor.exportLayoutData();
                
                resultDiv.className = 'result-box success';
                resultDiv.textContent = JSON.stringify(layoutData, null, 2);
                
                updateCheckStatus(1, 'pass');
                console.log('âœ… exportLayoutData() í…ŒìŠ¤íŠ¸ í†µê³¼');
                
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                updateCheckStatus(1, 'fail');
            }
        }
        
        function testExtractMethods() {
            const resultDiv = document.getElementById('export-result');
            
            try {
                if (!canvas2DEditor) {
                    canvas2DEditor = new MockCanvas2DEditor();
                }
                
                const results = {
                    room: canvas2DEditor.extractRoomData(),
                    equipmentArrays: canvas2DEditor.extractEquipmentArrays(),
                    equipments: canvas2DEditor.extractEquipments().length + ' items',
                    walls: canvas2DEditor.extractWalls().length + ' items',
                    office: canvas2DEditor.extractOffice(),
                    components: canvas2DEditor.extractComponents().length + ' items'
                };
                
                resultDiv.className = 'result-box success';
                resultDiv.textContent = JSON.stringify(results, null, 2);
                
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }
        
        // í…ŒìŠ¤íŠ¸ 2: PreviewGenerator ì´ˆê¸°í™”
        function testPreviewGeneratorInit() {
            const resultDiv = document.getElementById('preview-init-result');
            
            try {
                const canvas = document.getElementById('preview-canvas');
                
                previewGenerator = new MockPreviewGenerator({
                    container: canvas,
                    width: canvas.clientWidth || 600,
                    height: canvas.clientHeight || 400
                });
                
                const success = previewGenerator.init();
                
                if (success) {
                    resultDiv.className = 'result-box success';
                    resultDiv.textContent = `âœ… PreviewGenerator ì´ˆê¸°í™” ì„±ê³µ
                    
Scene: ${previewGenerator.scene ? 'ìƒì„±ë¨' : 'ì—†ìŒ'}
Camera: ${previewGenerator.camera ? 'ìƒì„±ë¨' : 'ì—†ìŒ'}
Renderer: ${previewGenerator.renderer ? 'ìƒì„±ë¨' : 'ì—†ìŒ'}
Controls: ${previewGenerator.controls ? 'ìƒì„±ë¨' : 'ì—†ìŒ'}`;
                    
                    updateCheckStatus(2, 'pass');
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                    previewGenerator.animate();
                } else {
                    throw new Error('ì´ˆê¸°í™” ì‹¤íŒ¨');
                }
                
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                updateCheckStatus(2, 'fail');
            }
        }
        
        function testPreviewGeneratorDispose() {
            const resultDiv = document.getElementById('preview-init-result');
            
            if (previewGenerator) {
                previewGenerator.dispose();
                previewGenerator = null;
                
                resultDiv.className = 'result-box success';
                resultDiv.textContent = 'âœ… PreviewGenerator disposed successfully';
            } else {
                resultDiv.textContent = 'âš ï¸ PreviewGeneratorê°€ ì—†ìŠµë‹ˆë‹¤';
            }
        }
        
        // í…ŒìŠ¤íŠ¸ 3: 3D Preview ë Œë”ë§
        function testRenderPreview() {
            const resultDiv = document.getElementById('render-result');
            
            try {
                if (!previewGenerator || !previewGenerator.isInitialized) {
                    testPreviewGeneratorInit();
                }
                
                if (!canvas2DEditor) {
                    canvas2DEditor = new MockCanvas2DEditor();
                }
                
                const layoutData = canvas2DEditor.exportLayoutData();
                const result = previewGenerator.generatePreview(layoutData);
                
                resultDiv.className = 'result-box success';
                resultDiv.textContent = `âœ… Preview ë Œë”ë§ ì™„ë£Œ

Equipment: ${result.equipmentCount}ê°œ
Walls: ${result.wallCount}ê°œ
Room: ${result.room?.width}m x ${result.room?.depth}m`;
                
                updateCheckStatus(3, 'pass');
                
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                updateCheckStatus(3, 'fail');
            }
        }
        
        function testRenderWithSampleData() {
            const resultDiv = document.getElementById('render-result');
            
            try {
                if (!previewGenerator || !previewGenerator.isInitialized) {
                    testPreviewGeneratorInit();
                }
                
                // ìƒ˜í”Œ Layout ë°ì´í„°
                const sampleData = {
                    room: { width: 50, depth: 70, wallHeight: 4 },
                    equipments: [
                        { id: 'EQ-01', x: 300, y: 200 },
                        { id: 'EQ-02', x: 400, y: 200 },
                        { id: 'EQ-03', x: 500, y: 200 },
                        { id: 'EQ-04', x: 300, y: 300 },
                        { id: 'EQ-05', x: 400, y: 300 },
                        { id: 'EQ-06', x: 500, y: 300 }
                    ],
                    walls: [
                        { id: 'wall-1', start: { x: -25, z: -35 }, end: { x: 25, z: -35 } },
                        { id: 'wall-2', start: { x: 25, z: -35 }, end: { x: 25, z: 35 } }
                    ]
                };
                
                const result = previewGenerator.generatePreview(sampleData);
                
                resultDiv.className = 'result-box success';
                resultDiv.textContent = `âœ… ìƒ˜í”Œ ë°ì´í„°ë¡œ ë Œë”ë§ ì™„ë£Œ

Equipment: ${result.equipmentCount}ê°œ
Walls: ${result.wallCount}ê°œ
Room: ${result.room?.width}m x ${result.room?.depth}m`;
                
                updateCheckStatus(3, 'pass');
                
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }
        
        function clearPreview() {
            if (previewGenerator) {
                previewGenerator.clearScene();
                previewGenerator.render();
            }
            document.getElementById('render-result').textContent = 'Preview cleared';
        }
        
        // í…ŒìŠ¤íŠ¸ 4: LayoutEditorMain í†µí•©
        function testShowPreviewModal() {
            const resultDiv = document.getElementById('integration-result');
            const modal = document.getElementById('preview-modal');
            
            try {
                modal.classList.add('show');
                
                // Modalìš© PreviewGenerator ì´ˆê¸°í™”
                const modalCanvas = document.getElementById('modal-preview-canvas');
                if (!modalPreviewGenerator) {
                    modalPreviewGenerator = new MockPreviewGenerator({
                        container: modalCanvas,
                        width: modalCanvas.clientWidth || 800,
                        height: 400
                    });
                    modalPreviewGenerator.init();
                    modalPreviewGenerator.animate();
                }
                
                // ìƒ˜í”Œ ë°ì´í„°ë¡œ ë Œë”ë§
                if (!canvas2DEditor) {
                    canvas2DEditor = new MockCanvas2DEditor();
                }
                
                const layoutData = canvas2DEditor.exportLayoutData();
                const result = modalPreviewGenerator.generatePreview(layoutData);
                
                // Summary ì—…ë°ì´íŠ¸
                document.getElementById('summary-equipment').textContent = result.equipmentCount;
                document.getElementById('summary-walls').textContent = result.wallCount;
                document.getElementById('summary-room').textContent = 
                    `${result.room?.width}m Ã— ${result.room?.depth}m`;
                
                resultDiv.className = 'result-box success';
                resultDiv.textContent = 'âœ… Preview Modal ì—´ê¸° ì„±ê³µ';
                
                updateCheckStatus(4, 'pass');
                
                // preview-modal-opened ì´ë²¤íŠ¸ ë°œìƒ
                window.dispatchEvent(new CustomEvent('preview-modal-opened'));
                
            } catch (error) {
                resultDiv.className = 'result-box error';
                resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                updateCheckStatus(4, 'fail');
            }
        }
        
        function closePreviewModal() {
            document.getElementById('preview-modal').classList.remove('show');
            console.log('[Test] Preview Modal ë‹«í˜');
        }
        
        function testSaveAndApply() {
            const resultDiv = document.getElementById('integration-result');
            
            console.log('[Test] Save & Apply í´ë¦­ë¨');
            resultDiv.textContent = 'âœ… Save & Apply ì‹¤í–‰ë¨ - 3D Viewerë¡œ ì „í™˜ (ì‹œë®¬ë ˆì´ì…˜)';
            
            closePreviewModal();
        }
        
        function testBackToEdit() {
            const resultDiv = document.getElementById('integration-result');
            
            console.log('[Test] Back to Edit í´ë¦­ë¨');
            resultDiv.textContent = 'âœ… Back to Edit ì‹¤í–‰ë¨ - í¸ì§‘ ëª¨ë“œë¡œ ë³µê·€ (ì‹œë®¬ë ˆì´ì…˜)';
            
            closePreviewModal();
        }
        
        function handleSaveAndApply() {
            testSaveAndApply();
        }
        
        // í…ŒìŠ¤íŠ¸ 5: í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        function simulateKeyPress(key) {
            const resultDiv = document.getElementById('keyboard-result');
            
            const event = new KeyboardEvent('keydown', {
                key: key,
                code: key === 'Escape' ? 'Escape' : `Key${key.toUpperCase()}`,
                bubbles: true
            });
            
            document.dispatchEvent(event);
            
            resultDiv.textContent = `âœ… '${key}' í‚¤ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ`;
            
            if (key.toLowerCase() === 'p') {
                testShowPreviewModal();
                updateCheckStatus(5, 'pass');
            } else if (key === 'Escape') {
                closePreviewModal();
            }
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('keydown', (e) => {
            const resultDiv = document.getElementById('keyboard-result');
            
            if (e.key.toLowerCase() === 'p' && !e.ctrlKey && !e.metaKey) {
                resultDiv.textContent = `âœ… Pí‚¤ ê°ì§€ë¨ - Preview Modal ì—´ê¸°`;
                testShowPreviewModal();
                updateCheckStatus(5, 'pass');
            } else if (e.key === 'Escape') {
                resultDiv.textContent = `âœ… ESCí‚¤ ê°ì§€ë¨ - Modal ë‹«ê¸°`;
                closePreviewModal();
            }
        });
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function updateCheckStatus(num, status) {
            const checkIcon = document.getElementById(`check-${num}`);
            checkIcon.className = `check-icon ${status}`;
            checkIcon.textContent = status === 'pass' ? 'âœ“' : status === 'fail' ? 'âœ—' : '?';
        }
        
        function clearConsoleLog() {
            document.getElementById('console-log').innerHTML = '';
        }
        
        // ì´ˆê¸°í™”
        console.log('ğŸ§ª Phase 4.5 í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
        console.log('ğŸ’¡ ê° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”');
    </script>
</body>
</html>