<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayoutValidator Test - Phase 3.2</title>
    
    <!-- Konva.js CDN -->
    <script src="https://unpkg.com/konva@8/konva.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .test-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .canvas-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
        }
        
        .canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .canvas-header h2 {
            color: #667eea;
        }
        
        #canvas-container {
            background: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .panel-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .panel-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd6;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-info {
            background: #3498db;
            color: white;
        }
        
        .btn-info:hover {
            background: #2980b9;
        }
        
        /* ÌÖåÏä§Ìä∏ Í≤∞Í≥º */
        .test-results {
            background: #0f0f23;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .test-results h3 {
            color: #27ae60;
            margin-bottom: 10px;
        }
        
        .result-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }
        
        .result-pass {
            background: rgba(39, 174, 96, 0.2);
            border-left: 4px solid #27ae60;
        }
        
        .result-fail {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
        }
        
        .result-info {
            background: rgba(52, 152, 219, 0.2);
            border-left: 4px solid #3498db;
        }
        
        /* ÏΩòÏÜî Î°úÍ∑∏ */
        #console-log {
            background: #0f0f23;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        
        .log-info { color: #3498db; }
        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        
        /* Property Panel ÏòÅÏó≠ */
        #property-panel {
            background: white;
            border-radius: 8px;
            min-height: 400px;
            color: #333;
        }
        
        /* CSS Î≥ÄÏàò (Canvas2DEditorÏö©) */
        :root {
            --canvas-equipment-default: #4a90e2;
            --canvas-equipment-selected: #FFD700;
            --canvas-equipment-hover: #3498db;
            --canvas-equipment-stroke: #2c3e50;
            --canvas-transformer-border: #667eea;
            --canvas-transformer-anchor-stroke: #667eea;
            --canvas-transformer-anchor-fill: #ffffff;
            --canvas-bg: #f5f5f5;
            --canvas-grid-minor: #d0d0d0;
            --canvas-grid-major: #a0a0a0;
            --canvas-grid-label: #999999;
            --canvas-selection-stroke: #667eea;
            --canvas-selection-fill: rgba(102, 126, 234, 0.1);
            --canvas-coord-bg: #667eea;
            --canvas-coord-text: #ffffff;
            --canvas-room-stroke: #666666;
            --canvas-wall-default: #888888;
            --canvas-office-fill: #d4e6f1;
            --canvas-office-stroke: #3498db;
            --canvas-partition: #aaaaaa;
            --canvas-text-primary: #212529;
            --canvas-text-secondary: #6c757d;
            --canvas-validation-error: #e74c3c;
            --canvas-validation-warning: #f39c12;
        }
        
        /* ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù */
        .scenario-select {
            margin-bottom: 20px;
        }
        
        .scenario-select label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .scenario-select select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #667eea;
            background: #0f0f23;
            color: white;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üß™ LayoutValidator Test - Phase 3.2</h1>
    
    <div class="test-container">
        <!-- Canvas ÏòÅÏó≠ -->
        <div class="canvas-section">
            <div class="canvas-header">
                <h2>üìê Canvas2DEditor</h2>
                <span id="canvas-status">Ready</span>
            </div>
            <div id="canvas-container"></div>
            
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="testValidation()">üîç Validate Layout</button>
                <button class="btn btn-success" onclick="testSaveWithValidation()">üíæ Save (with Validation)</button>
                <button class="btn btn-info" onclick="clearHighlights()">üßπ Clear Highlights</button>
            </div>
        </div>
        
        <!-- Property Panel ÏòÅÏó≠ -->
        <div class="panel-section">
            <h2>üìã Property Panel</h2>
            <div id="property-panel"></div>
            
            <div class="scenario-select">
                <label>üéØ Test Scenario</label>
                <select id="scenario-select" onchange="loadScenario(this.value)">
                    <option value="valid">‚úÖ Valid Layout (All Pass)</option>
                    <option value="room_small">‚ùå Room Too Small</option>
                    <option value="no_walls">‚ùå Missing Walls</option>
                    <option value="equipment_out">‚ùå Equipment Out of Bounds</option>
                    <option value="collision">‚ùå Equipment Collision</option>
                    <option value="corridor_narrow">‚ö†Ô∏è Narrow Corridor</option>
                    <option value="multiple_errors">‚ùå Multiple Errors</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="runAllTests()">üöÄ Run All Tests</button>
                <button class="btn btn-warning" onclick="clearConsole()">üóëÔ∏è Clear Console</button>
            </div>
            
            <div id="console-log">
                <div class="log-entry log-info">Console ready...</div>
            </div>
        </div>
    </div>
    
    <div class="test-results" id="test-results" style="max-width: 1600px; margin: 20px auto;">
        <h3>üìä Test Results</h3>
        <div id="results-container"></div>
    </div>

    <!-- Validation Î™®Îìà (Ïù∏ÎùºÏù∏) -->
    <script>
        // =====================================================
        // ValidationRules.js (Ïù∏ÎùºÏù∏)
        // =====================================================
        const ValidationRules = {
            ROOM: {
                MIN_WIDTH: 10,
                MIN_DEPTH: 10,
                MAX_WIDTH: 500,
                MAX_DEPTH: 500
            },
            WALL: {
                MIN_COUNT: 4,
                MIN_THICKNESS: 0.1,
                MAX_THICKNESS: 1.0,
                MIN_HEIGHT: 2.0,
                MAX_HEIGHT: 10.0
            },
            EQUIPMENT: {
                MIN_ARRAYS: 1,
                MIN_WIDTH: 0.1,
                MIN_DEPTH: 0.1,
                MAX_WIDTH: 20,
                MAX_DEPTH: 20,
                MIN_SPACING: 0.3
            },
            CORRIDOR: {
                MIN_WIDTH: 0.8,
                RECOMMENDED_WIDTH: 1.2
            },
            BOUNDARY: {
                MIN_MARGIN: 0.5,
                WALL_COLLISION_MARGIN: 0.1
            }
        };

        const ERROR_TYPES = {
            ROOM_MISSING: 'ROOM_MISSING',
            ROOM_SIZE_TOO_SMALL: 'ROOM_SIZE_TOO_SMALL',
            ROOM_SIZE_TOO_LARGE: 'ROOM_SIZE_TOO_LARGE',
            ROOM_INVALID_DIMENSIONS: 'ROOM_INVALID_DIMENSIONS',
            WALL_COUNT_INSUFFICIENT: 'WALL_COUNT_INSUFFICIENT',
            WALL_MISSING: 'WALL_MISSING',
            EQUIPMENT_ARRAY_MISSING: 'EQUIPMENT_ARRAY_MISSING',
            EQUIPMENT_ARRAY_EMPTY: 'EQUIPMENT_ARRAY_EMPTY',
            SITE_ID_MISSING: 'SITE_ID_MISSING',
            EQUIPMENT_OUT_OF_BOUNDS: 'EQUIPMENT_OUT_OF_BOUNDS',
            EQUIPMENT_COLLISION: 'EQUIPMENT_COLLISION',
            EQUIPMENT_WALL_COLLISION: 'EQUIPMENT_WALL_COLLISION',
            CORRIDOR_TOO_NARROW: 'CORRIDOR_TOO_NARROW',
            CORRIDOR_BELOW_RECOMMENDED: 'CORRIDOR_BELOW_RECOMMENDED',
            EQUIPMENT_WIDTH_INVALID: 'EQUIPMENT_WIDTH_INVALID',
            EQUIPMENT_DEPTH_INVALID: 'EQUIPMENT_DEPTH_INVALID'
        };

        const SEVERITY = {
            ERROR: 'error',
            WARNING: 'warning',
            INFO: 'info'
        };

        const ERROR_MESSAGES = {
            [ERROR_TYPES.ROOM_MISSING]: {
                message: 'Room Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§',
                fix: 'LayoutÏóê RoomÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî'
            },
            [ERROR_TYPES.ROOM_SIZE_TOO_SMALL]: {
                message: 'Room ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÏûëÏäµÎãàÎã§ (ÌòÑÏû¨: {width}√ó{depth}m)',
                fix: `Room ÌÅ¨Í∏∞Î•º ÏµúÏÜå ${ValidationRules.ROOM.MIN_WIDTH}√ó${ValidationRules.ROOM.MIN_DEPTH}mÎ°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî`
            },
            [ERROR_TYPES.WALL_COUNT_INSUFFICIENT]: {
                message: 'Ïô∏Î≤Ω Í∞úÏàòÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§ (ÌòÑÏû¨: {count}Í∞ú)',
                fix: `ÏµúÏÜå ${ValidationRules.WALL.MIN_COUNT}Í∞úÏùò Ïô∏Î≤ΩÏù¥ ÌïÑÏöîÌï©ÎãàÎã§`
            },
            [ERROR_TYPES.WALL_MISSING]: {
                message: 'Î≤Ω Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§',
                fix: 'LayoutÏóê Î≤ΩÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî'
            },
            [ERROR_TYPES.EQUIPMENT_ARRAY_MISSING]: {
                message: 'ÏÑ§ÎπÑ Î∞∞Ïó¥Ïù¥ ÏóÜÏäµÎãàÎã§',
                fix: 'ÏµúÏÜå 1Í∞úÏùò ÏÑ§ÎπÑ Î∞∞Ïó¥ÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî'
            },
            [ERROR_TYPES.EQUIPMENT_OUT_OF_BOUNDS]: {
                message: 'ÏÑ§ÎπÑ {equipmentId}Í∞Ä Room ÏòÅÏó≠ Î∞ñÏóê ÏûàÏäµÎãàÎã§',
                fix: 'ÏÑ§ÎπÑÎ•º Room ÎÇ¥Î∂ÄÎ°ú Ïù¥ÎèôÌïòÏÑ∏Ïöî'
            },
            [ERROR_TYPES.EQUIPMENT_COLLISION]: {
                message: 'ÏÑ§ÎπÑ {equipmentId1}Í≥º {equipmentId2}Ïù¥ Í≤πÏπ©ÎãàÎã§',
                fix: 'ÏÑ§ÎπÑ ÏúÑÏπòÎ•º Ï°∞Ï†ïÌïòÏó¨ Í≤πÏπ®ÏùÑ Ìï¥ÏÜåÌïòÏÑ∏Ïöî'
            },
            [ERROR_TYPES.CORRIDOR_TOO_NARROW]: {
                message: 'Î≥µÎèÑ Ìè≠Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§ ({location})',
                fix: `Î≥µÎèÑ Ìè≠ÏùÑ ÏµúÏÜå ${ValidationRules.CORRIDOR.MIN_WIDTH}mÎ°ú ÏÑ§Ï†ïÌïòÏÑ∏Ïöî`
            },
            [ERROR_TYPES.SITE_ID_MISSING]: {
                message: 'Site IDÍ∞Ä ÏóÜÏäµÎãàÎã§',
                fix: 'LayoutÏóê site_idÎ•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî'
            }
        };

        function getErrorMessage(errorType, params = {}) {
            const template = ERROR_MESSAGES[errorType];
            if (!template) {
                return { message: `Ïïå Ïàò ÏóÜÎäî ÏóêÎü¨: ${errorType}`, fix: 'Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî' };
            }
            
            let message = template.message;
            let fix = template.fix;
            
            Object.keys(params).forEach(key => {
                const regex = new RegExp(`\\{${key}\\}`, 'g');
                message = message.replace(regex, params[key]);
                fix = fix.replace(regex, params[key]);
            });
            
            return { message, fix };
        }

        // =====================================================
        // ErrorReporter.js (Ïù∏ÎùºÏù∏)
        // =====================================================
        class ErrorReporter {
            constructor() {
                this.errors = [];
                this.stats = { errorCount: 0, warningCount: 0, infoCount: 0 };
            }
            
            addError(type, details = {}) {
                const severity = details.severity || SEVERITY.ERROR;
                const params = { ...details.params };
                
                if (details.equipmentId) params.equipmentId = details.equipmentId;
                if (details.equipmentId1) params.equipmentId1 = details.equipmentId1;
                if (details.equipmentId2) params.equipmentId2 = details.equipmentId2;
                if (details.width !== undefined) params.width = details.width;
                if (details.depth !== undefined) params.depth = details.depth;
                if (details.count !== undefined) params.count = details.count;
                if (details.location) params.location = details.location;
                
                const { message, fix } = getErrorMessage(type, params);
                
                const error = {
                    id: `err-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    type,
                    severity,
                    message,
                    fix,
                    equipmentId: details.equipmentId || null,
                    position: details.position || null,
                    timestamp: new Date().toISOString()
                };
                
                this.errors.push(error);
                this.updateStats(severity);
                return error;
            }
            
            updateStats(severity) {
                if (severity === SEVERITY.ERROR) this.stats.errorCount++;
                else if (severity === SEVERITY.WARNING) this.stats.warningCount++;
                else this.stats.infoCount++;
            }
            
            getErrors() { return [...this.errors]; }
            hasErrors() { return this.stats.errorCount > 0; }
            hasWarnings() { return this.stats.warningCount > 0; }
            clear() {
                this.errors = [];
                this.stats = { errorCount: 0, warningCount: 0, infoCount: 0 };
            }
            
            getStats() { return { ...this.stats, total: this.errors.length }; }
            
            getSummary() {
                const { errorCount, warningCount } = this.stats;
                if (errorCount === 0 && warningCount === 0) return '‚úÖ Î™®Îì† Í≤ÄÏ¶ù ÌÜµÍ≥º';
                const parts = [];
                if (errorCount > 0) parts.push(`‚ùå ${errorCount}Í∞ú ÏóêÎü¨`);
                if (warningCount > 0) parts.push(`‚ö†Ô∏è ${warningCount}Í∞ú Í≤ΩÍ≥†`);
                return parts.join(', ');
            }
            
            toJSON() {
                return {
                    valid: !this.hasErrors(),
                    errors: this.errors,
                    stats: this.getStats(),
                    summary: this.getSummary()
                };
            }
        }

        // =====================================================
        // LayoutValidator.js (Ïù∏ÎùºÏù∏)
        // =====================================================
        class LayoutValidator {
            constructor() {
                this.reporter = null;
                this.layoutData = null;
                this.scale = 10;
            }
            
            validate(layoutData, canvas2DEditor = null) {
                logConsole('info', '[LayoutValidator] Í≤ÄÏ¶ù ÏãúÏûë...');
                
                this.reporter = new ErrorReporter();
                
                if (canvas2DEditor) {
                    this.layoutData = this.extractFromCanvas(canvas2DEditor);
                    this.scale = canvas2DEditor.config?.scale || 10;
                } else if (layoutData) {
                    this.layoutData = layoutData;
                } else {
                    this.reporter.addError(ERROR_TYPES.ROOM_MISSING, { severity: SEVERITY.ERROR });
                    return this.reporter.toJSON();
                }
                
                this.checkRequired();
                
                if (this.reporter.hasErrors()) {
                    logConsole('error', '[LayoutValidator] ÌïÑÏàò Ìï≠Î™© ÏóêÎü¨ Î∞úÍ≤¨');
                    return this.reporter.toJSON();
                }
                
                this.checkBounds();
                this.checkCollisions();
                this.checkCorridors();
                
                const result = this.reporter.toJSON();
                logConsole(result.valid ? 'success' : 'error', 
                    `[LayoutValidator] Í≤ÄÏ¶ù ÏôÑÎ£å: ${result.summary}`);
                
                return result;
            }
            
            extractFromCanvas(canvas) {
                const scale = canvas.config?.scale || 10;
                const data = {
                    site_id: canvas.currentLayout?.site_id || 'test_site',
                    room: this.extractRoomData(canvas),
                    walls: this.extractWallsData(canvas, scale),
                    equipmentArrays: this.extractEquipmentData(canvas, scale),
                    corridors: canvas.currentLayout?.corridors || []
                };
                return data;
            }
            
            extractRoomData(canvas) {
                if (canvas.currentLayout?.room) return canvas.currentLayout.room;
                const roomBoundary = canvas.layers?.room?.findOne('.room_boundary');
                if (roomBoundary) {
                    const scale = canvas.config?.scale || 10;
                    return {
                        width: roomBoundary.width() / scale,
                        depth: roomBoundary.height() / scale
                    };
                }
                return null;
            }
            
            extractWallsData(canvas, scale) {
                const walls = [];
                canvas.wallShapes?.forEach((wall, id) => {
                    const points = wall.points?.() || [];
                    walls.push({
                        id,
                        type: wall.getAttr('wallType') || 'partition',
                        points,
                        startX: points[0] / scale,
                        startY: points[1] / scale,
                        endX: points[2] / scale,
                        endY: points[3] / scale
                    });
                });
                return walls;
            }
            
            extractEquipmentData(canvas, scale) {
                const equipments = [];
                canvas.equipmentShapes?.forEach((eq, id) => {
                    equipments.push({
                        id,
                        x: eq.x() / scale,
                        y: eq.y() / scale,
                        width: eq.width() / scale,
                        depth: eq.height() / scale
                    });
                });
                return equipments.length > 0 ? [{ id: 'main-array', equipments }] : [];
            }
            
            checkRequired() {
                const data = this.layoutData;
                
                if (!data.site_id) {
                    this.reporter.addError(ERROR_TYPES.SITE_ID_MISSING, { severity: SEVERITY.ERROR });
                }
                
                if (!data.room) {
                    this.reporter.addError(ERROR_TYPES.ROOM_MISSING, { severity: SEVERITY.ERROR });
                } else {
                    const { width, depth } = data.room;
                    if (width < ValidationRules.ROOM.MIN_WIDTH || depth < ValidationRules.ROOM.MIN_DEPTH) {
                        this.reporter.addError(ERROR_TYPES.ROOM_SIZE_TOO_SMALL, {
                            severity: SEVERITY.ERROR,
                            params: { width, depth }
                        });
                    }
                }
                
                if (!data.walls || data.walls.length < ValidationRules.WALL.MIN_COUNT) {
                    this.reporter.addError(ERROR_TYPES.WALL_COUNT_INSUFFICIENT, {
                        severity: SEVERITY.ERROR,
                        params: { count: data.walls?.length || 0 }
                    });
                }
                
                if (!data.equipmentArrays || data.equipmentArrays.length === 0) {
                    this.reporter.addError(ERROR_TYPES.EQUIPMENT_ARRAY_MISSING, {
                        severity: SEVERITY.ERROR
                    });
                }
            }
            
            checkBounds() {
                const data = this.layoutData;
                if (!data.room || !data.equipmentArrays) return;
                
                const roomWidth = data.room.width;
                const roomDepth = data.room.depth;
                const margin = ValidationRules.BOUNDARY.MIN_MARGIN;
                
                data.equipmentArrays.forEach(array => {
                    (array.equipments || []).forEach(eq => {
                        const eqRight = eq.x + eq.width;
                        const eqBottom = eq.y + eq.depth;
                        
                        if (eq.x < margin || eq.y < margin || 
                            eqRight > roomWidth - margin || eqBottom > roomDepth - margin) {
                            this.reporter.addError(ERROR_TYPES.EQUIPMENT_OUT_OF_BOUNDS, {
                                severity: SEVERITY.ERROR,
                                equipmentId: eq.id,
                                position: { x: eq.x, y: eq.y }
                            });
                        }
                    });
                });
            }
            
            checkCollisions() {
                const data = this.layoutData;
                if (!data.equipmentArrays) return;
                
                const allEquipments = [];
                data.equipmentArrays.forEach(array => {
                    allEquipments.push(...(array.equipments || []));
                });
                
                for (let i = 0; i < allEquipments.length; i++) {
                    for (let j = i + 1; j < allEquipments.length; j++) {
                        if (this.checkRectCollision(allEquipments[i], allEquipments[j])) {
                            this.reporter.addError(ERROR_TYPES.EQUIPMENT_COLLISION, {
                                severity: SEVERITY.ERROR,
                                equipmentId1: allEquipments[i].id,
                                equipmentId2: allEquipments[j].id,
                                position: { x: allEquipments[i].x, y: allEquipments[i].y }
                            });
                        }
                    }
                }
            }
            
            checkRectCollision(rect1, rect2) {
                const gap = ValidationRules.EQUIPMENT.MIN_SPACING;
                return !(rect1.x + rect1.width + gap <= rect2.x ||
                         rect2.x + rect2.width + gap <= rect1.x ||
                         rect1.y + rect1.depth + gap <= rect2.y ||
                         rect2.y + rect2.depth + gap <= rect1.y);
            }
            
            checkCorridors() {
                const data = this.layoutData;
                if (!data.corridors) return;
                
                data.corridors.forEach(corridor => {
                    if (corridor.width < ValidationRules.CORRIDOR.MIN_WIDTH) {
                        this.reporter.addError(ERROR_TYPES.CORRIDOR_TOO_NARROW, {
                            severity: SEVERITY.ERROR,
                            location: corridor.location || 'unknown'
                        });
                    } else if (corridor.width < ValidationRules.CORRIDOR.RECOMMENDED_WIDTH) {
                        this.reporter.addError(ERROR_TYPES.CORRIDOR_BELOW_RECOMMENDED, {
                            severity: SEVERITY.WARNING,
                            location: corridor.location || 'unknown'
                        });
                    }
                });
            }
        }

        // =====================================================
        // Canvas2DEditor (Í∞ÑÏÜåÌôî Î≤ÑÏ†Ñ)
        // =====================================================
        class Canvas2DEditor {
            constructor(containerId, options = {}) {
                this.containerId = containerId;
                this.container = document.getElementById(containerId);
                
                this.config = {
                    width: options.width || 800,
                    height: options.height || 600,
                    scale: options.scale || 10,
                    gridSize: options.gridSize || 10
                };
                
                this.stage = null;
                this.layers = {};
                this.currentLayout = null;
                this.equipmentShapes = new Map();
                this.wallShapes = new Map();
                this.componentShapes = new Map();
                this.validationHighlights = new Map();
                this.propertyPanel = null;
                
                this.cssColors = {
                    equipmentDefault: '#4a90e2',
                    equipmentSelected: '#FFD700',
                    equipmentStroke: '#2c3e50',
                    roomStroke: '#666666',
                    wallDefault: '#888888',
                    validationError: '#e74c3c',
                    validationWarning: '#f39c12'
                };
                
                this.init();
            }
            
            init() {
                this.stage = new Konva.Stage({
                    container: this.containerId,
                    width: this.config.width,
                    height: this.config.height
                });
                
                this.layers.background = new Konva.Layer({ listening: false });
                this.layers.room = new Konva.Layer();
                this.layers.equipment = new Konva.Layer();
                this.layers.ui = new Konva.Layer();
                
                this.stage.add(this.layers.background);
                this.stage.add(this.layers.room);
                this.stage.add(this.layers.equipment);
                this.stage.add(this.layers.ui);
                
                this.drawGrid();
                
                logConsole('success', '[Canvas2DEditor] Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }
            
            drawGrid() {
                const { width, height, gridSize } = this.config;
                
                for (let i = 0; i <= width; i += gridSize) {
                    this.layers.background.add(new Konva.Line({
                        points: [i, 0, i, height],
                        stroke: '#d0d0d0',
                        strokeWidth: (i % 100 === 0) ? 1 : 0.5
                    }));
                }
                
                for (let j = 0; j <= height; j += gridSize) {
                    this.layers.background.add(new Konva.Line({
                        points: [0, j, width, j],
                        stroke: '#d0d0d0',
                        strokeWidth: (j % 100 === 0) ? 1 : 0.5
                    }));
                }
                
                this.layers.background.batchDraw();
            }
            
            loadLayout(layoutData) {
                this.currentLayout = layoutData;
                
                // Clear existing
                this.equipmentShapes.forEach(s => s.destroy());
                this.wallShapes.forEach(s => s.destroy());
                this.equipmentShapes.clear();
                this.wallShapes.clear();
                
                // Draw room
                if (layoutData.room) {
                    const scale = this.config.scale;
                    const rect = new Konva.Rect({
                        x: 0, y: 0,
                        width: layoutData.room.width * scale,
                        height: layoutData.room.depth * scale,
                        stroke: this.cssColors.roomStroke,
                        strokeWidth: 3,
                        fill: 'transparent',
                        name: 'room_boundary'
                    });
                    this.layers.room.add(rect);
                }
                
                // Draw walls
                if (layoutData.walls) {
                    layoutData.walls.forEach(wall => {
                        const scale = this.config.scale;
                        const line = new Konva.Line({
                            id: wall.id,
                            points: [
                                wall.startX * scale, wall.startY * scale,
                                wall.endX * scale, wall.endY * scale
                            ],
                            stroke: this.cssColors.wallDefault,
                            strokeWidth: 2,
                            name: 'wall'
                        });
                        line.setAttr('wallType', wall.type);
                        this.wallShapes.set(wall.id, line);
                        this.layers.room.add(line);
                    });
                }
                
                // Draw equipment
                if (layoutData.equipmentArrays) {
                    layoutData.equipmentArrays.forEach(array => {
                        (array.equipments || []).forEach(eq => {
                            const scale = this.config.scale;
                            const rect = new Konva.Rect({
                                id: eq.id,
                                x: eq.x * scale,
                                y: eq.y * scale,
                                width: eq.width * scale,
                                height: eq.depth * scale,
                                fill: this.cssColors.equipmentDefault,
                                stroke: this.cssColors.equipmentStroke,
                                strokeWidth: 2,
                                name: 'equipment'
                            });
                            rect.setAttr('originalStroke', this.cssColors.equipmentStroke);
                            this.equipmentShapes.set(eq.id, rect);
                            this.layers.equipment.add(rect);
                        });
                    });
                }
                
                this.stage.batchDraw();
                logConsole('success', `[Canvas2DEditor] Layout Î°úÎìú ÏôÑÎ£å: ${this.equipmentShapes.size}Í∞ú ÏÑ§ÎπÑ`);
            }
            
            highlightValidationErrors(errors) {
                this.clearValidationHighlights();
                
                errors.forEach(error => {
                    if (!error) return;
                    
                    const color = error.severity === 'error' 
                        ? this.cssColors.validationError 
                        : this.cssColors.validationWarning;
                    
                    if (error.equipmentId) {
                        this.highlightShapeById(error.equipmentId, color);
                    }
                    if (error.equipmentId1) {
                        this.highlightShapeById(error.equipmentId1, color);
                    }
                    if (error.equipmentId2) {
                        this.highlightShapeById(error.equipmentId2, color);
                    }
                });
                
                this.stage.batchDraw();
                logConsole('warning', `[Canvas2DEditor] ${errors.length}Í∞ú ÏóêÎü¨ ÌïòÏù¥ÎùºÏù¥Ìä∏`);
            }
            
            highlightShapeById(id, color) {
                const shape = this.equipmentShapes.get(id);
                if (!shape) return;
                
                this.validationHighlights.set(id, {
                    shape,
                    originalStroke: shape.stroke(),
                    originalStrokeWidth: shape.strokeWidth()
                });
                
                shape.stroke(color);
                shape.strokeWidth(4);
                shape.shadowColor(color);
                shape.shadowBlur(10);
                shape.shadowOpacity(0.5);
            }
            
            clearValidationHighlights() {
                this.validationHighlights.forEach((highlight, id) => {
                    if (highlight.shape) {
                        highlight.shape.stroke(highlight.originalStroke);
                        highlight.shape.strokeWidth(highlight.originalStrokeWidth);
                        highlight.shape.shadowBlur(0);
                    }
                });
                this.validationHighlights.clear();
                this.stage.batchDraw();
            }
            
            scrollToError(error) {
                if (!error) return;
                
                let targetX, targetY;
                
                if (error.equipmentId) {
                    const shape = this.equipmentShapes.get(error.equipmentId);
                    if (shape) {
                        targetX = shape.x() + shape.width() / 2;
                        targetY = shape.y() + shape.height() / 2;
                    }
                } else if (error.position) {
                    targetX = error.position.x * this.config.scale;
                    targetY = error.position.y * this.config.scale;
                }
                
                if (targetX !== undefined) {
                    const newX = this.stage.width() / 2 - targetX;
                    const newY = this.stage.height() / 2 - targetY;
                    this.stage.position({ x: newX, y: newY });
                    this.stage.batchDraw();
                    logConsole('info', `[Canvas2DEditor] Ïä§ÌÅ¨Î°§: (${targetX}, ${targetY})`);
                }
            }
            
            setPropertyPanel(panel) {
                this.propertyPanel = panel;
            }
        }

        // =====================================================
        // PropertyPanel (Í∞ÑÏÜåÌôî Î≤ÑÏ†Ñ)
        // =====================================================
        class PropertyPanel {
            constructor(containerId, canvas) {
                this.container = document.getElementById(containerId);
                this.canvas = canvas;
                this.currentValidationErrors = [];
                this.initPanel();
            }
            
            initPanel() {
                this.container.innerHTML = `
                    <div id="validation-errors-section" style="display: none; padding: 15px; background: #fff5f5;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #e74c3c;">üî¥ Validation Errors</h3>
                            <button onclick="propertyPanel.hideValidationErrors()" style="border: none; background: none; cursor: pointer; font-size: 16px;">‚úï</button>
                        </div>
                        <div id="validation-summary"></div>
                        <div id="validation-list"></div>
                    </div>
                    <div id="panel-empty" style="padding: 40px; text-align: center; color: #95a5a6;">
                        <p>üéØ ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                    </div>
                `;
            }
            
            showValidationErrors(errors) {
                if (!errors || errors.length === 0) {
                    this.hideValidationErrors();
                    return;
                }
                
                this.currentValidationErrors = errors;
                
                document.getElementById('validation-errors-section').style.display = 'block';
                document.getElementById('panel-empty').style.display = 'none';
                
                const errorCount = errors.filter(e => e.severity === 'error').length;
                const warningCount = errors.filter(e => e.severity === 'warning').length;
                
                document.getElementById('validation-summary').innerHTML = `
                    <div style="margin-bottom: 10px;">
                        ${errorCount > 0 ? `<span style="color: #e74c3c; font-weight: bold;">‚ùå ${errorCount} ÏóêÎü¨</span> ` : ''}
                        ${warningCount > 0 ? `<span style="color: #f39c12; font-weight: bold;">‚ö†Ô∏è ${warningCount} Í≤ΩÍ≥†</span>` : ''}
                    </div>
                `;
                
                document.getElementById('validation-list').innerHTML = errors.map((error, i) => `
                    <div style="padding: 12px; margin: 8px 0; background: white; border-radius: 6px; border-left: 4px solid ${error.severity === 'error' ? '#e74c3c' : '#f39c12'}; cursor: pointer;"
                         onclick="propertyPanel.onErrorClick(${i})">
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            ${error.severity === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${error.type}
                        </div>
                        <div style="color: #333; margin-bottom: 5px;">${error.message}</div>
                        <div style="color: #27ae60; font-size: 12px;">üí° ${error.fix}</div>
                    </div>
                `).join('');
            }
            
            hideValidationErrors() {
                this.currentValidationErrors = [];
                document.getElementById('validation-errors-section').style.display = 'none';
                document.getElementById('panel-empty').style.display = 'block';
                
                if (this.canvas) {
                    this.canvas.clearValidationHighlights();
                }
            }
            
            onErrorClick(index) {
                const error = this.currentValidationErrors[index];
                if (error && this.canvas) {
                    this.canvas.highlightValidationErrors([error]);
                    this.canvas.scrollToError(error);
                }
            }
        }

        // =====================================================
        // ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞
        // =====================================================
        const TEST_SCENARIOS = {
            valid: {
                name: 'Valid Layout',
                site_id: 'test_korea_line1',
                room: { width: 50, depth: 40 },
                walls: [
                    { id: 'wall-1', type: 'room_boundary', startX: 0, startY: 0, endX: 50, endY: 0 },
                    { id: 'wall-2', type: 'room_boundary', startX: 50, startY: 0, endX: 50, endY: 40 },
                    { id: 'wall-3', type: 'room_boundary', startX: 50, startY: 40, endX: 0, endY: 40 },
                    { id: 'wall-4', type: 'room_boundary', startX: 0, startY: 40, endX: 0, endY: 0 }
                ],
                equipmentArrays: [{
                    id: 'array-1',
                    equipments: [
                        { id: 'EQ-01-01', x: 5, y: 5, width: 2, depth: 3 },
                        { id: 'EQ-01-02', x: 10, y: 5, width: 2, depth: 3 },
                        { id: 'EQ-02-01', x: 5, y: 15, width: 2, depth: 3 },
                        { id: 'EQ-02-02', x: 10, y: 15, width: 2, depth: 3 }
                    ]
                }],
                corridors: [{ location: 'main', width: 1.5 }]
            },
            
            room_small: {
                name: 'Room Too Small',
                site_id: 'test_site',
                room: { width: 5, depth: 5 },  // ÎÑàÎ¨¥ ÏûëÏùå!
                walls: [
                    { id: 'wall-1', startX: 0, startY: 0, endX: 5, endY: 0 },
                    { id: 'wall-2', startX: 5, startY: 0, endX: 5, endY: 5 },
                    { id: 'wall-3', startX: 5, startY: 5, endX: 0, endY: 5 },
                    { id: 'wall-4', startX: 0, startY: 5, endX: 0, endY: 0 }
                ],
                equipmentArrays: [{
                    id: 'array-1',
                    equipments: [{ id: 'EQ-01', x: 1, y: 1, width: 2, depth: 2 }]
                }]
            },
            
            no_walls: {
                name: 'Missing Walls',
                site_id: 'test_site',
                room: { width: 30, depth: 20 },
                walls: [
                    { id: 'wall-1', startX: 0, startY: 0, endX: 30, endY: 0 },
                    { id: 'wall-2', startX: 30, startY: 0, endX: 30, endY: 20 }
                    // Î≤Ω 2Í∞ú Î∂ÄÏ°±!
                ],
                equipmentArrays: [{
                    id: 'array-1',
                    equipments: [{ id: 'EQ-01', x: 5, y: 5, width: 2, depth: 3 }]
                }]
            },
            
            equipment_out: {
                name: 'Equipment Out of Bounds',
                site_id: 'test_site',
                room: { width: 30, depth: 20 },
                walls: [
                    { id: 'wall-1', startX: 0, startY: 0, endX: 30, endY: 0 },
                    { id: 'wall-2', startX: 30, startY: 0, endX: 30, endY: 20 },
                    { id: 'wall-3', startX: 30, startY: 20, endX: 0, endY: 20 },
                    { id: 'wall-4', startX: 0, startY: 20, endX: 0, endY: 0 }
                ],
                equipmentArrays: [{
                    id: 'array-1',
                    equipments: [
                        { id: 'EQ-INSIDE', x: 5, y: 5, width: 2, depth: 3 },
                        { id: 'EQ-OUTSIDE', x: 28, y: 18, width: 3, depth: 3 }  // Î≤îÏúÑ Î∞ñ!
                    ]
                }]
            },
            
            collision: {
                name: 'Equipment Collision',
                site_id: 'test_site',
                room: { width: 30, depth: 20 },
                walls: [
                    { id: 'wall-1', startX: 0, startY: 0, endX: 30, endY: 0 },
                    { id: 'wall-2', startX: 30, startY: 0, endX: 30, endY: 20 },
                    { id: 'wall-3', startX: 30, startY: 20, endX: 0, endY: 20 },
                    { id: 'wall-4', startX: 0, startY: 20, endX: 0, endY: 0 }
                ],
                equipmentArrays: [{
                    id: 'array-1',
                    equipments: [
                        { id: 'EQ-A', x: 5, y: 5, width: 3, depth: 3 },
                        { id: 'EQ-B', x: 6, y: 6, width: 3, depth: 3 }  // Í≤πÏπ®!
                    ]
                }]
            },
            
            corridor_narrow: {
                name: 'Narrow Corridor',
                site_id: 'test_site',
                room: { width: 30, depth: 20 },
                walls: [
                    { id: 'wall-1', startX: 0, startY: 0, endX: 30, endY: 0 },
                    { id: 'wall-2', startX: 30, startY: 0, endX: 30, endY: 20 },
                    { id: 'wall-3', startX: 30, startY: 20, endX: 0, endY: 20 },
                    { id: 'wall-4', startX: 0, startY: 20, endX: 0, endY: 0 }
                ],
                equipmentArrays: [{
                    id: 'array-1',
                    equipments: [{ id: 'EQ-01', x: 5, y: 5, width: 2, depth: 3 }]
                }],
                corridors: [{ location: 'Row 1-2 ÏÇ¨Ïù¥', width: 0.5 }]  // ÎÑàÎ¨¥ Ï¢ÅÏùå!
            },
            
            multiple_errors: {
                name: 'Multiple Errors',
                site_id: '',  // Site ID ÏóÜÏùå!
                room: { width: 8, depth: 8 },  // ÎÑàÎ¨¥ ÏûëÏùå!
                walls: [
                    { id: 'wall-1', startX: 0, startY: 0, endX: 8, endY: 0 }
                    // Î≤Ω Î∂ÄÏ°±!
                ],
                equipmentArrays: [{
                    id: 'array-1',
                    equipments: [
                        { id: 'EQ-A', x: 1, y: 1, width: 2, depth: 2 },
                        { id: 'EQ-B', x: 1.5, y: 1.5, width: 2, depth: 2 }  // Í≤πÏπ®!
                    ]
                }]
            }
        };

        // =====================================================
        // Ï†ÑÏó≠ Î≥ÄÏàò & Ï¥àÍ∏∞Ìôî
        // =====================================================
        let canvas2DEditor;
        let propertyPanel;
        let validator;
        
        function init() {
            // Canvas Ï¥àÍ∏∞Ìôî
            canvas2DEditor = new Canvas2DEditor('canvas-container', {
                width: 800,
                height: 600,
                scale: 10
            });
            
            // PropertyPanel Ï¥àÍ∏∞Ìôî
            propertyPanel = new PropertyPanel('property-panel', canvas2DEditor);
            canvas2DEditor.setPropertyPanel(propertyPanel);
            
            // Validator Ï¥àÍ∏∞Ìôî
            validator = new LayoutValidator();
            
            // Ï†ÑÏó≠ Ï∞∏Ï°∞ (onclick Ïö©)
            window.propertyPanel = propertyPanel;
            
            // Í∏∞Î≥∏ ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú
            loadScenario('valid');
            
            logConsole('success', 'üöÄ ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }
        
        // =====================================================
        // ÌÖåÏä§Ìä∏ Ìï®ÏàòÎì§
        // =====================================================
        function loadScenario(scenarioKey) {
            const scenario = TEST_SCENARIOS[scenarioKey];
            if (!scenario) {
                logConsole('error', `ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå: ${scenarioKey}`);
                return;
            }
            
            logConsole('info', `üìÇ ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú: ${scenario.name}`);
            
            canvas2DEditor.loadLayout(scenario);
            propertyPanel.hideValidationErrors();
            
            document.getElementById('canvas-status').textContent = scenario.name;
        }
        
        function testValidation() {
            logConsole('info', 'üîç Í≤ÄÏ¶ù ÏãúÏûë...');
            
            const result = validator.validate(null, canvas2DEditor);
            
            if (result.valid) {
                logConsole('success', '‚úÖ Í≤ÄÏ¶ù ÌÜµÍ≥º!');
                propertyPanel.hideValidationErrors();
            } else {
                logConsole('error', `‚ùå Í≤ÄÏ¶ù Ïã§Ìå®: ${result.errors.length}Í∞ú Î¨∏Ï†ú`);
                propertyPanel.showValidationErrors(result.errors);
                canvas2DEditor.highlightValidationErrors(result.errors);
            }
            
            return result;
        }
        
        function testSaveWithValidation() {
            logConsole('info', 'üíæ Ï†ÄÏû• ÏãúÎèÑ (Í≤ÄÏ¶ù Ìè¨Ìï®)...');
            
            const result = testValidation();
            
            if (result.valid) {
                logConsole('success', '‚úÖ Ï†ÄÏû• ÏÑ±Í≥µ! (ÏãúÎÆ¨Î†àÏù¥ÏÖò)');
                addTestResult('Save with Validation', true, 'Ï†ÄÏû• ÏÑ±Í≥µ');
            } else {
                logConsole('error', '‚ùå Ï†ÄÏû• Ï∞®Îã®: Í≤ÄÏ¶ù Ïã§Ìå®');
                addTestResult('Save with Validation', false, `${result.errors.length}Í∞ú ÏóêÎü¨Î°ú Ï†ÄÏû• Ï∞®Îã®Îê®`);
            }
        }
        
        function clearHighlights() {
            canvas2DEditor.clearValidationHighlights();
            propertyPanel.hideValidationErrors();
            logConsole('info', 'üßπ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï†úÍ±∞Îê®');
        }
        
        function runAllTests() {
            logConsole('info', 'üöÄ Ï†ÑÏ≤¥ ÌÖåÏä§Ìä∏ ÏãúÏûë...');
            clearTestResults();
            
            const scenarios = Object.keys(TEST_SCENARIOS);
            let passed = 0;
            let failed = 0;
            
            scenarios.forEach(key => {
                const scenario = TEST_SCENARIOS[key];
                canvas2DEditor.loadLayout(scenario);
                
                const result = validator.validate(null, canvas2DEditor);
                
                // ÏòàÏÉÅ Í≤∞Í≥º ÌôïÏù∏
                const expectedValid = (key === 'valid');
                const testPassed = (result.valid === expectedValid);
                
                if (testPassed) {
                    passed++;
                    addTestResult(
                        `Scenario: ${scenario.name}`,
                        true,
                        expectedValid ? '‚úÖ Í≤ÄÏ¶ù ÌÜµÍ≥º (ÏòàÏÉÅÎåÄÎ°ú)' : `‚ùå ${result.errors.length}Í∞ú ÏóêÎü¨ (ÏòàÏÉÅÎåÄÎ°ú)`
                    );
                } else {
                    failed++;
                    addTestResult(
                        `Scenario: ${scenario.name}`,
                        false,
                        `ÏòàÏÉÅ: ${expectedValid ? 'Pass' : 'Fail'}, Ïã§Ï†ú: ${result.valid ? 'Pass' : 'Fail'}`
                    );
                }
            });
            
            // ÏµúÏ¢Ö Í≤∞Í≥º
            const allPassed = (failed === 0);
            logConsole(allPassed ? 'success' : 'error', 
                `üìä ÌÖåÏä§Ìä∏ ÏôÑÎ£å: ${passed}/${scenarios.length} ÌÜµÍ≥º`);
            
            addTestResult(
                'üìä TOTAL',
                allPassed,
                `${passed}/${scenarios.length} ÌÖåÏä§Ìä∏ ÌÜµÍ≥º`
            );
            
            // ÏõêÎûò ÏãúÎÇòÎ¶¨Ïò§Î°ú Î≥µÏõê
            loadScenario(document.getElementById('scenario-select').value);
        }
        
        // =====================================================
        // UI Ìó¨Ìçº Ìï®ÏàòÎì§
        // =====================================================
        function logConsole(type, message) {
            const logEl = document.getElementById('console-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('console-log').innerHTML = 
                '<div class="log-entry log-info">Console cleared...</div>';
        }
        
        function addTestResult(name, passed, message) {
            const container = document.getElementById('results-container');
            const item = document.createElement('div');
            item.className = `result-item ${passed ? 'result-pass' : 'result-fail'}`;
            item.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${name}</strong>
                <div style="margin-top: 5px; font-size: 12px;">${message}</div>
            `;
            container.appendChild(item);
        }
        
        function clearTestResults() {
            document.getElementById('results-container').innerHTML = '';
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.onload = init;
    </script>
</body>
</html>