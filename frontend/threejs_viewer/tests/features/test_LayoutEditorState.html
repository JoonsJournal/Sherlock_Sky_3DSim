<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayoutEditorState í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .state-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .state-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .state-item:last-child {
            border-bottom: none;
        }

        .state-key {
            color: #495057;
            font-weight: bold;
        }

        .state-value {
            color: #667eea;
        }

        .log-container {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.info {
            border-left-color: #06b6d4;
        }

        .log-entry.success {
            border-left-color: #10b981;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
        }

        .log-entry.error {
            border-left-color: #ef4444;
            color: #ef4444;
        }

        .timestamp {
            color: #64748b;
            font-size: 11px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input[type="text"],
        .input-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ LayoutEditorState í…ŒìŠ¤íŠ¸</h1>
            <p class="subtitle">Proxy ê¸°ë°˜ ë°˜ì‘í˜• ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ - ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ í™˜ê²½</p>
        </div>

        <div class="content">
            <!-- ì™¼ìª½ íŒ¨ë„: ìƒíƒœ ì œì–´ -->
            <div class="panel">
                <h2>ğŸ® ìƒíƒœ ì œì–´</h2>

                <div class="button-group">
                    <button class="btn-primary" onclick="testEnterEditorMode()">
                        ğŸ“ Editor ëª¨ë“œ ì§„ì…
                    </button>
                    <button class="btn-success" onclick="testEnterViewerMode()">
                        ğŸ‘ï¸ Viewer ëª¨ë“œ ì§„ì…
                    </button>
                    <button class="btn-danger" onclick="testReset()">
                        ğŸ”„ ìƒíƒœ ì´ˆê¸°í™”
                    </button>
                </div>

                <div class="button-group">
                    <button class="btn-info" onclick="testMarkAsSaved()">
                        ğŸ’¾ ì €ì¥ ì™„ë£Œ í‘œì‹œ
                    </button>
                    <button class="btn-warning" onclick="testMarkAsDirty()">
                        âœï¸ Dirty í‘œì‹œ
                    </button>
                </div>

                <h3 style="margin: 20px 0 10px 0; color: #495057;">íˆìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
                <div class="button-group">
                    <button class="btn-info" onclick="testAddToHistory()">
                        â• íˆìŠ¤í† ë¦¬ ì¶”ê°€
                    </button>
                    <button class="btn-secondary" onclick="testUndo()">
                        â¬…ï¸ Undo
                    </button>
                    <button class="btn-secondary" onclick="testRedo()">
                        â¡ï¸ Redo
                    </button>
                </div>

                <h3 style="margin: 20px 0 10px 0; color: #495057;">ì„ íƒ ê´€ë¦¬</h3>
                <div class="button-group">
                    <button class="btn-primary" onclick="testAddSelection()">
                        â• ê°ì²´ ì„ íƒ
                    </button>
                    <button class="btn-danger" onclick="testClearSelection()">
                        âŒ ì„ íƒ í•´ì œ
                    </button>
                </div>

                <h3 style="margin: 20px 0 10px 0; color: #495057;">ì„¤ì •</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="toggleGrid" checked onchange="toggleGrid()">
                    <label for="toggleGrid">ê·¸ë¦¬ë“œ í‘œì‹œ</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="toggleSnap" checked onchange="toggleSnap()">
                    <label for="toggleSnap">Snap to Grid</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="toggleAutoSave" checked onchange="toggleAutoSave()">
                    <label for="toggleAutoSave">ìë™ ì €ì¥</label>
                </div>

                <div class="input-group">
                    <label for="gridSize">ê·¸ë¦¬ë“œ í¬ê¸° (í”½ì…€)</label>
                    <input type="number" id="gridSize" value="10" min="1" onchange="updateGridSize()">
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„: í˜„ì¬ ìƒíƒœ -->
            <div class="panel">
                <h2>ğŸ“Š í˜„ì¬ ìƒíƒœ</h2>
                <div class="state-display" id="stateDisplay">
                    <!-- ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨ -->
                </div>

                <div class="button-group">
                    <button class="btn-info" onclick="exportState()">
                        ğŸ“¤ ìƒíƒœ ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button class="btn-warning" onclick="debugState()">
                        ğŸ› ë””ë²„ê·¸ ì •ë³´
                    </button>
                </div>
            </div>
        </div>

        <!-- ë¡œê·¸ íŒ¨ë„ -->
        <div class="panel">
            <h2>ğŸ“ ì´ë²¤íŠ¸ ë¡œê·¸</h2>
            <div class="log-container" id="logContainer">
                <!-- ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨ -->
            </div>
            <div style="margin-top: 15px;">
                <button class="btn-secondary" onclick="clearLogs()">
                    ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // LayoutEditorState ì„í¬íŠ¸
        // ê²½ë¡œ: tests/ â†’ src/stores/
        import layoutEditorState from '../src/stores/LayoutEditorState.js';

        // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì • (í…ŒìŠ¤íŠ¸ í¸ì˜ì„±)
        window.layoutEditorState = layoutEditorState;

        // ë¡œê·¸ í•¨ìˆ˜
        let logCounter = 0;
        window.addLog = function(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span> ${message}
            `;
            logContainer.insertBefore(entry, logContainer.firstChild);
            logCounter++;

            // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ìµœëŒ€ 50ê°œ)
            if (logCounter > 50) {
                logContainer.removeChild(logContainer.lastChild);
                logCounter--;
            }
        };

        window.clearLogs = function() {
            document.getElementById('logContainer').innerHTML = '';
            logCounter = 0;
            addLog('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        };

        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        window.updateStateDisplay = function() {
            const state = layoutEditorState.state;
            const display = document.getElementById('stateDisplay');
            
            display.innerHTML = `
                <div class="state-item">
                    <span class="state-key">Mode:</span>
                    <span class="state-value">
                        ${state.mode}
                        ${state.mode === 'editor' ? '<span class="badge badge-warning">EDIT</span>' : '<span class="badge badge-success">VIEW</span>'}
                    </span>
                </div>
                <div class="state-item">
                    <span class="state-key">Current Site ID:</span>
                    <span class="state-value">${state.currentSiteId || 'null'}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">Has Layout:</span>
                    <span class="state-value">${state.currentLayout ? 'Yes âœ“' : 'No âœ—'}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">Selected Objects:</span>
                    <span class="state-value">${state.selectedObjects.length}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">History Size:</span>
                    <span class="state-value">${state.editHistory.length}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">History Index:</span>
                    <span class="state-value">${state.historyIndex}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">Is Dirty:</span>
                    <span class="state-value">
                        ${state.isDirty ? '<span class="badge badge-danger">YES</span>' : '<span class="badge badge-success">NO</span>'}
                    </span>
                </div>
                <div class="state-item">
                    <span class="state-key">Last Saved:</span>
                    <span class="state-value">${state.lastSaved ? state.lastSaved.toLocaleString() : 'Never'}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">Auto-Save:</span>
                    <span class="state-value">${state.autoSaveEnabled ? 'Enabled âœ“' : 'Disabled âœ—'}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">Show Grid:</span>
                    <span class="state-value">${state.showGrid ? 'Yes âœ“' : 'No âœ—'}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">Snap to Grid:</span>
                    <span class="state-value">${state.snapToGrid ? 'Yes âœ“' : 'No âœ—'}</span>
                </div>
                <div class="state-item">
                    <span class="state-key">Grid Size:</span>
                    <span class="state-value">${state.gridSize}px</span>
                </div>
            `;
        };

        // ì „ì—­ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        layoutEditorState.subscribeGlobal((property, newValue, oldValue) => {
            addLog(`<strong>${property}</strong> ë³€ê²½: <em>${JSON.stringify(oldValue)}</em> â†’ <em>${JSON.stringify(newValue)}</em>`, 'success');
            updateStateDisplay();
        });

        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        window.testEnterEditorMode = function() {
            layoutEditorState.enterEditorMode('korea_site1_line1', { name: 'Test Layout' });
            addLog('Editor ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        };

        window.testEnterViewerMode = function() {
            layoutEditorState.enterViewerMode('korea_site1_line1', { name: 'Test Layout' });
            addLog('Viewer ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        };

        window.testReset = function() {
            layoutEditorState.reset();
            addLog('ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
        };

        window.testMarkAsSaved = function() {
            layoutEditorState.markAsSaved();
            addLog('ì €ì¥ ì™„ë£Œë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        };

        window.testMarkAsDirty = function() {
            layoutEditorState.markAsDirty();
            addLog('Dirty ìƒíƒœë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
        };

        window.testAddToHistory = function() {
            const snapshot = {
                timestamp: new Date(),
                data: { x: Math.random() * 100, y: Math.random() * 100 }
            };
            layoutEditorState.addToHistory(snapshot);
            addLog('íˆìŠ¤í† ë¦¬ì— í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        };

        window.testUndo = function() {
            const snapshot = layoutEditorState.undo();
            if (snapshot) {
                addLog('Undoê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            } else {
                addLog('Undoí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            }
        };

        window.testRedo = function() {
            const snapshot = layoutEditorState.redo();
            if (snapshot) {
                addLog('Redoê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            } else {
                addLog('Redoí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            }
        };

        window.testAddSelection = function() {
            const obj = { id: `obj_${Date.now()}`, type: 'equipment' };
            layoutEditorState.addSelectedObject(obj);
            addLog(`ê°ì²´ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤: ${obj.id}`, 'info');
        };

        window.testClearSelection = function() {
            layoutEditorState.clearSelection();
            addLog('ëª¨ë“  ì„ íƒì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        };

        window.toggleGrid = function() {
            const checked = document.getElementById('toggleGrid').checked;
            layoutEditorState.state.showGrid = checked;
        };

        window.toggleSnap = function() {
            const checked = document.getElementById('toggleSnap').checked;
            layoutEditorState.state.snapToGrid = checked;
        };

        window.toggleAutoSave = function() {
            const checked = document.getElementById('toggleAutoSave').checked;
            layoutEditorState.state.autoSaveEnabled = checked;
        };

        window.updateGridSize = function() {
            const value = parseInt(document.getElementById('gridSize').value);
            layoutEditorState.state.gridSize = value;
        };

        window.exportState = function() {
            const exported = layoutEditorState.exportState();
            console.log('Exported State:', exported);
            addLog('ìƒíƒœê°€ ì½˜ì†”ì— ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤. (F12 í™•ì¸)', 'success');
            alert(JSON.stringify(exported, null, 2));
        };

        window.debugState = function() {
            layoutEditorState.debug();
            addLog('ë””ë²„ê·¸ ì •ë³´ê°€ ì½˜ì†”ì— ì¶œë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. (F12 í™•ì¸)', 'info');
        };

        // ì´ˆê¸° ë¡œê·¸
        addLog('LayoutEditorState í…ŒìŠ¤íŠ¸ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        addLog('ëª¨ë“  ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!', 'info');
        
        // ì´ˆê¸° ìƒíƒœ í‘œì‹œ
        updateStateDisplay();

        // í…ŒìŠ¤íŠ¸ êµ¬ë… ì˜ˆì œ
        const unsubMode = layoutEditorState.subscribe('mode', (newVal, oldVal) => {
            console.log(`[Custom Listener] Mode: ${oldVal} â†’ ${newVal}`);
        });

        // ì½˜ì†”ì— í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ ì¶œë ¥
        console.log('%cğŸ¯ LayoutEditorState í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ', 'font-size: 20px; font-weight: bold; color: #667eea;');
        console.log('%cì½˜ì†”ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ë³´ì„¸ìš”:', 'font-size: 14px; color: #666;');
        console.log(`
1. ëª¨ë“œ ì „í™˜ í…ŒìŠ¤íŠ¸:
   layoutEditorState.enterEditorMode('korea_site1_line1', {});
   layoutEditorState.enterViewerMode('korea_site1_line1', {});

2. êµ¬ë… í…ŒìŠ¤íŠ¸:
   const unsub = layoutEditorState.subscribe('mode', (newVal) => {
       console.log('Mode changed:', newVal);
   });
   layoutEditorState.enterEditorMode('test_site', {});
   unsub(); // êµ¬ë… í•´ì œ

3. ìƒíƒœ í™•ì¸:
   layoutEditorState.debug();
   layoutEditorState.exportState();

4. íˆìŠ¤í† ë¦¬ í…ŒìŠ¤íŠ¸:
   layoutEditorState.addToHistory({ data: 'test' });
   layoutEditorState.undo();
   layoutEditorState.redo();
        `);
    </script>
</body>
</html>