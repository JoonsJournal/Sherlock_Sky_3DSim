<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Sidebar Mode Diagnosis Test</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        
        h1 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        h2 {
            color: #ffd700;
            margin: 20px 0 10px;
            font-size: 1.2rem;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 800px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .result-box {
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .success { color: #00ff88; }
        .error { color: #ff4757; }
        .warning { color: #ffa502; }
        .info { color: #70a1ff; }
        
        button {
            background: #4a69bd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #6a89cc;
            transform: translateY(-1px);
        }
        
        button.primary {
            background: #00d4ff;
            color: #000;
        }
        
        button.danger {
            background: #ff4757;
        }
        
        button.success {
            background: #2ed573;
            color: #000;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background: #2ed573; }
        .status-offline { background: #ff4757; }
        .status-unknown { background: #ffa502; }
        
        .mode-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        
        .mode-main_viewer { background: #636e72; }
        .mode-monitoring { background: #00b894; }
        .mode-equipment_edit { background: #fdcb6e; color: #000; }
        
        #log-output {
            height: 400px;
        }
        
        .step {
            padding: 8px 12px;
            margin: 5px 0;
            border-left: 3px solid #4a69bd;
            background: rgba(74, 105, 189, 0.1);
        }
        
        .step-number {
            font-weight: bold;
            color: #00d4ff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            background: #0f0f23;
            color: #00d4ff;
        }
        
        .check-mark::before { content: "âœ… "; }
        .cross-mark::before { content: "âŒ "; }
        .warning-mark::before { content: "âš ï¸ "; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Sidebar Mode ì „í™˜ ë¬¸ì œ ì§„ë‹¨ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="section">
            <h2>ğŸ“Š í˜„ì¬ ìƒíƒœ</h2>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <div>
                    <span class="status-indicator status-unknown" id="connection-dot"></span>
                    <span id="connection-status">Unknown</span>
                </div>
                <div>
                    í˜„ì¬ ëª¨ë“œ: <span id="current-mode" class="mode-badge mode-main_viewer">main_viewer</span>
                </div>
                <div>
                    Sub Mode: <span id="current-submode">ì—†ìŒ</span>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <div class="section">
                <h2>ğŸ§ª Step 1: APP_MODE ì „ë‹¬ í…ŒìŠ¤íŠ¸</h2>
                <p style="color: #888; margin-bottom: 10px;">Sidebarê°€ APP_MODE ìƒìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë°›ì•˜ëŠ”ì§€ í™•ì¸</p>
                <button onclick="testAppModeDelivery()" class="primary">APP_MODE ì „ë‹¬ í…ŒìŠ¤íŠ¸</button>
                <div id="step1-result" class="result-box" style="margin-top: 10px; min-height: 100px;"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ§ª Step 2: MODE_MAP ë§¤í•‘ í…ŒìŠ¤íŠ¸</h2>
                <p style="color: #888; margin-bottom: 10px;">MODE_MAPì´ ì˜¬ë°”ë¥´ê²Œ APP_MODEë¡œ ë³€í™˜í•˜ëŠ”ì§€ í™•ì¸</p>
                <button onclick="testModeMapping()" class="primary">MODE_MAP í…ŒìŠ¤íŠ¸</button>
                <div id="step2-result" class="result-box" style="margin-top: 10px; min-height: 100px;"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ§ª Step 3: _setMode() íë¦„ í…ŒìŠ¤íŠ¸</h2>
                <p style="color: #888; margin-bottom: 10px;">Sidebar._setMode('monitoring') í˜¸ì¶œ ì‹œ ì „ì²´ íë¦„ ì¶”ì </p>
                <button onclick="testSetModeFlow()" class="primary">_setMode íë¦„ í…ŒìŠ¤íŠ¸</button>
                <div id="step3-result" class="result-box" style="margin-top: 10px; min-height: 150px;"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ§ª Step 4: AppModeManager í•¸ë“¤ëŸ¬ í…ŒìŠ¤íŠ¸</h2>
                <p style="color: #888; margin-bottom: 10px;">ëª¨ë“œ í•¸ë“¤ëŸ¬ê°€ ë“±ë¡ë˜ì–´ ìˆê³  ì„œë¹„ìŠ¤ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸</p>
                <button onclick="testModeHandlers()" class="primary">í•¸ë“¤ëŸ¬ í…ŒìŠ¤íŠ¸</button>
                <div id="step4-result" class="result-box" style="margin-top: 10px; min-height: 150px;"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>ğŸ® ìˆ˜ë™ ëª¨ë“œ ì „í™˜ í…ŒìŠ¤íŠ¸</h2>
            <p style="color: #888; margin-bottom: 10px;">ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ëª¨ë“œ ì „í™˜ í…ŒìŠ¤íŠ¸ (Mock í™˜ê²½)</p>
            <div style="margin: 10px 0;">
                <button onclick="simulateMonitoringClick()">ğŸ“¡ Monitoring ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜</button>
                <button onclick="directModeSwitch('monitoring')">ğŸ”€ ì§ì ‘ switchMode('monitoring')</button>
                <button onclick="directModeSwitch('main_viewer')">ğŸ  Main Viewerë¡œ ë³µê·€</button>
            </div>
        </div>
        
        <div class="section">
            <h2>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <button onclick="runAllTests()" class="success">ğŸš€ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <div id="log-output" class="result-box" style="margin-top: 10px;"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ“‹ ë¬¸ì œ ì§„ë‹¨ ê²°ê³¼</h2>
            <div id="diagnosis-result"></div>
        </div>
    </div>

    <script type="module">
        // ============================================
        // Mock APP_MODE ìƒìˆ˜
        // ============================================
        const APP_MODE = {
            MAIN_VIEWER: 'main_viewer',
            MONITORING: 'monitoring',
            EQUIPMENT_EDIT: 'equipment_edit',
            LAYOUT_EDITOR: 'layout_editor',
            PLAYBACK: 'playback',
            ANALYTICS: 'analytics',
            SETTINGS: 'settings'
        };
        
        // ============================================
        // Mock MODE_MAP (SidebarConfig.jsì—ì„œ ê°€ì ¸ì˜¨ ê²ƒ)
        // ============================================
        const MODE_MAP = {
            'monitoring': 'MONITORING',
            'analysis': 'ANALYTICS',
            'simulation': 'SIMULATION',
            'layout': 'LAYOUT_EDITOR',
            'equipment_edit': 'EQUIPMENT_EDIT'
        };
        
        // ============================================
        // Mock EventBus
        // ============================================
        class MockEventBus {
            constructor() {
                this._listeners = new Map();
            }
            
            on(event, callback) {
                if (!this._listeners.has(event)) {
                    this._listeners.set(event, new Set());
                }
                this._listeners.get(event).add(callback);
                return () => this._listeners.get(event)?.delete(callback);
            }
            
            emit(event, data) {
                log(`ğŸ“¢ Event: ${event}`, 'info');
                this._listeners.get(event)?.forEach(cb => cb(data));
            }
        }
        
        const eventBus = new MockEventBus();
        
        // ============================================
        // Mock AppModeManager
        // ============================================
        class MockAppModeManager {
            constructor() {
                this._currentMode = APP_MODE.MAIN_VIEWER;
                this._previousMode = null;
                this._subMode = null;
                this._modeHandlers = new Map();
                this._connectionStatusService = null;
            }
            
            getCurrentMode() {
                return this._currentMode;
            }
            
            getSubMode() {
                return this._subMode;
            }
            
            setSubMode(subMode) {
                this._subMode = subMode;
                eventBus.emit('submode:change', { to: subMode });
            }
            
            registerMode(mode, handler) {
                this._modeHandlers.set(mode, handler);
                log(`ğŸ“ Mode registered: ${mode}`, 'info');
            }
            
            getModeHandler(mode) {
                return this._modeHandlers.get(mode);
            }
            
            setConnectionStatusService(service) {
                this._connectionStatusService = service;
            }
            
            isBackendOnline() {
                return this._connectionStatusService?.isOnline() ?? true;
            }
            
            async toggleMode(targetMode) {
                log(`ğŸ”„ toggleMode called with: ${targetMode}`, 'info');
                
                if (targetMode === undefined) {
                    log(`âŒ ERROR: targetMode is undefined!`, 'error');
                    return false;
                }
                
                const newMode = (this._currentMode === targetMode) 
                    ? APP_MODE.MAIN_VIEWER 
                    : targetMode;
                
                return this.switchMode(newMode);
            }
            
            async switchMode(newMode, options = {}) {
                log(`ğŸ”€ switchMode: ${this._currentMode} â†’ ${newMode}`, 'info');
                
                if (!Object.values(APP_MODE).includes(newMode)) {
                    log(`âŒ Invalid mode: ${newMode}`, 'error');
                    return false;
                }
                
                // ì—°ê²° ì²´í¬ (skipConnectionCheckê°€ ì•„ë‹Œ ê²½ìš°)
                if (!options.skipConnectionCheck && newMode === APP_MODE.MONITORING) {
                    if (!this.isBackendOnline()) {
                        log(`âš ï¸ Monitoring requires backend connection!`, 'warning');
                        eventBus.emit('mode:enter-blocked', { mode: newMode, reason: 'offline' });
                        return false;
                    }
                }
                
                // ì´ì „ ëª¨ë“œ ì¢…ë£Œ
                const oldHandler = this._modeHandlers.get(this._currentMode);
                if (oldHandler?.onExit) {
                    await oldHandler.onExit({ nextMode: newMode });
                }
                
                this._previousMode = this._currentMode;
                this._currentMode = newMode;
                this._subMode = null;
                
                // ìƒˆ ëª¨ë“œ ì§„ì…
                const newHandler = this._modeHandlers.get(newMode);
                if (newHandler?.onEnter) {
                    await newHandler.onEnter({ prevMode: this._previousMode });
                }
                
                eventBus.emit('mode:change', { from: this._previousMode, to: newMode });
                
                updateModeDisplay();
                return true;
            }
        }
        
        const appModeManager = new MockAppModeManager();
        
        // ============================================
        // Mock ConnectionStatusService
        // ============================================
        class MockConnectionStatusService {
            constructor() {
                this._isOnline = true;  // Mockì—ì„œëŠ” ê¸°ë³¸ online
            }
            
            isOnline() {
                return this._isOnline;
            }
            
            setOnline(value) {
                this._isOnline = value;
                updateConnectionDisplay();
            }
            
            onOnline(callback) {
                return eventBus.on('connection:online', callback);
            }
            
            onOffline(callback) {
                return eventBus.on('connection:offline', callback);
            }
        }
        
        const connectionStatusService = new MockConnectionStatusService();
        appModeManager.setConnectionStatusService(connectionStatusService);
        
        // ============================================
        // Mock MonitoringService
        // ============================================
        class MockMonitoringService {
            constructor() {
                this.isActive = false;
            }
            
            start() {
                log(`ğŸŸ¢ MonitoringService.start() called!`, 'success');
                this.isActive = true;
            }
            
            stop() {
                log(`ğŸ”´ MonitoringService.stop() called!`, 'warning');
                this.isActive = false;
            }
        }
        
        const monitoringService = new MockMonitoringService();
        
        // ============================================
        // Mock SignalTowerManager
        // ============================================
        class MockSignalTowerManager {
            initializeAllLights() {
                log(`ğŸ’¡ SignalTowerManager.initializeAllLights() called`, 'info');
            }
            
            turnOffAllLights() {
                log(`ğŸ’¡ SignalTowerManager.turnOffAllLights() called`, 'info');
            }
        }
        
        const signalTowerManager = new MockSignalTowerManager();
        
        // ============================================
        // Mock ModeHandlers ë“±ë¡
        // ============================================
        function registerModeHandlers() {
            // Main Viewer Handler
            appModeManager.registerMode(APP_MODE.MAIN_VIEWER, {
                name: 'Main Viewer',
                onEnter: () => log(`âœ… Main Viewer ëª¨ë“œ ì§„ì…`, 'success'),
                onExit: () => log(`ğŸ“¤ Main Viewer ëª¨ë“œ ì¢…ë£Œ`, 'info')
            });
            
            // Monitoring Handler
            appModeManager.registerMode(APP_MODE.MONITORING, {
                name: 'Monitoring',
                _monitoringService: monitoringService,
                _signalTowerManager: signalTowerManager,
                onEnter: function() {
                    log(`âœ… Monitoring ëª¨ë“œ ì§„ì…`, 'success');
                    if (this._monitoringService && !this._monitoringService.isActive) {
                        this._monitoringService.start();
                    }
                },
                onExit: function() {
                    log(`ğŸ“¤ Monitoring ëª¨ë“œ ì¢…ë£Œ`, 'info');
                    if (this._monitoringService?.isActive) {
                        this._monitoringService.stop();
                    }
                }
            });
            
            // Equipment Edit Handler
            appModeManager.registerMode(APP_MODE.EQUIPMENT_EDIT, {
                name: 'Equipment Edit',
                onEnter: () => log(`âœ… Equipment Edit ëª¨ë“œ ì§„ì…`, 'success'),
                onExit: () => log(`ğŸ“¤ Equipment Edit ëª¨ë“œ ì¢…ë£Œ`, 'info')
            });
        }
        
        // ============================================
        // Mock Sidebar (í•µì‹¬ ë¡œì§ë§Œ)
        // ============================================
        class MockSidebar {
            constructor(options = {}) {
                this.appModeManager = options.appModeManager || null;
                this.APP_MODE = options.APP_MODE || {};
                this.currentMode = null;
                this.currentSubMode = null;
                
                log(`ğŸ”§ Sidebar ìƒì„±ë¨`, 'info');
                log(`   - appModeManager: ${this.appModeManager ? 'SET' : 'NULL'}`, 
                    this.appModeManager ? 'success' : 'error');
                log(`   - APP_MODE keys: ${Object.keys(this.APP_MODE).length}ê°œ`, 
                    Object.keys(this.APP_MODE).length > 0 ? 'success' : 'error');
            }
            
            // ì‹¤ì œ Sidebar.jsì˜ _setMode ë©”ì„œë“œì™€ ë™ì¼
            _setMode(mode) {
                log(`\nğŸ“ _setMode('${mode}') í˜¸ì¶œë¨`, 'info');
                
                if (!this.appModeManager) {
                    log(`   âŒ AppModeManager not connected!`, 'error');
                    this.currentMode = mode;
                    return;
                }
                
                log(`   1. MODE_MAP['${mode}'] = '${MODE_MAP[mode]}'`, 'info');
                
                const mappedKey = MODE_MAP[mode];
                log(`   2. this.APP_MODE['${mappedKey}'] = '${this.APP_MODE[mappedKey]}'`, 
                    this.APP_MODE[mappedKey] ? 'success' : 'error');
                
                const appMode = this.APP_MODE[MODE_MAP[mode]] || this.APP_MODE.MAIN_VIEWER;
                log(`   3. appMode ìµœì¢…ê°’ = '${appMode}'`, appMode ? 'success' : 'error');
                
                if (!appMode || appMode === this.APP_MODE.MAIN_VIEWER && mode !== 'main_viewer') {
                    log(`   âš ï¸ WARNING: appModeê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤!`, 'warning');
                    log(`      - ì˜ˆìƒ: '${mode === 'monitoring' ? 'monitoring' : mode}'`, 'warning');
                    log(`      - ì‹¤ì œ: '${appMode}'`, 'warning');
                }
                
                this.appModeManager.toggleMode(appMode);
            }
            
            _setSubMode(submode) {
                this.currentSubMode = submode;
                if (this.appModeManager) {
                    this.appModeManager.setSubMode(submode);
                }
                log(`ğŸ“ _setSubMode('${submode}') í˜¸ì¶œë¨`, 'info');
            }
        }
        
        // ============================================
        // ê¸€ë¡œë²Œ ë³€ìˆ˜
        // ============================================
        let sidebar = null;
        
        // ============================================
        // ë¡œê·¸ ìœ í‹¸ë¦¬í‹°
        // ============================================
        function log(message, type = 'info') {
            const output = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const colorClass = type;
            output.innerHTML += `<span class="${colorClass}">[${time}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        window.clearLog = function() {
            document.getElementById('log-output').innerHTML = '';
        };
        
        // ============================================
        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        // ============================================
        function updateModeDisplay() {
            const modeEl = document.getElementById('current-mode');
            const submodeEl = document.getElementById('current-submode');
            const mode = appModeManager.getCurrentMode();
            const submode = appModeManager.getSubMode();
            
            modeEl.textContent = mode;
            modeEl.className = `mode-badge mode-${mode}`;
            submodeEl.textContent = submode || 'ì—†ìŒ';
        }
        
        function updateConnectionDisplay() {
            const dot = document.getElementById('connection-dot');
            const status = document.getElementById('connection-status');
            const isOnline = connectionStatusService.isOnline();
            
            dot.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
            status.textContent = isOnline ? 'Online (Mock)' : 'Offline (Mock)';
        }
        
        // ============================================
        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        // ============================================
        window.testAppModeDelivery = function() {
            const resultEl = document.getElementById('step1-result');
            let html = '';
            
            // ì‹œë‚˜ë¦¬ì˜¤ 1: APP_MODEê°€ ë¹ˆ ê°ì²´ì¸ ê²½ìš°
            const sidebar1 = new MockSidebar({
                appModeManager: appModeManager,
                APP_MODE: {}  // ë¹ˆ ê°ì²´
            });
            
            html += `<div class="step">`;
            html += `<span class="step-number">í…ŒìŠ¤íŠ¸ 1:</span> APP_MODE = {} (ë¹ˆ ê°ì²´)\n`;
            html += `ê²°ê³¼: ${Object.keys(sidebar1.APP_MODE).length === 0 ? 
                '<span class="error">âŒ APP_MODEê°€ ë¹„ì–´ìˆìŒ!</span>' : 
                '<span class="success">âœ… OK</span>'}\n`;
            html += `</div>`;
            
            // ì‹œë‚˜ë¦¬ì˜¤ 2: APP_MODEê°€ ì •ìƒ ì „ë‹¬ëœ ê²½ìš°
            const sidebar2 = new MockSidebar({
                appModeManager: appModeManager,
                APP_MODE: APP_MODE
            });
            
            html += `<div class="step">`;
            html += `<span class="step-number">í…ŒìŠ¤íŠ¸ 2:</span> APP_MODE = ì •ìƒ ê°ì²´\n`;
            html += `ì „ë‹¬ëœ í‚¤: ${Object.keys(sidebar2.APP_MODE).join(', ')}\n`;
            html += `MONITORING ê°’: ${sidebar2.APP_MODE.MONITORING}\n`;
            html += `ê²°ê³¼: ${sidebar2.APP_MODE.MONITORING === 'monitoring' ? 
                '<span class="success">âœ… ì •ìƒ</span>' : 
                '<span class="error">âŒ ë¹„ì •ìƒ</span>'}\n`;
            html += `</div>`;
            
            resultEl.innerHTML = html;
        };
        
        window.testModeMapping = function() {
            const resultEl = document.getElementById('step2-result');
            let html = '<table><tr><th>Sidebar ëª¨ë“œ</th><th>MODE_MAP í‚¤</th><th>APP_MODE ê°’</th><th>ê²°ê³¼</th></tr>';
            
            const testCases = ['monitoring', 'analysis', 'layout', 'equipment_edit'];
            
            testCases.forEach(mode => {
                const mapKey = MODE_MAP[mode];
                const appModeValue = APP_MODE[mapKey];
                const isOk = appModeValue !== undefined;
                
                html += `<tr>
                    <td>${mode}</td>
                    <td>${mapKey || 'undefined'}</td>
                    <td>${appModeValue || 'undefined'}</td>
                    <td>${isOk ? '<span class="success">âœ…</span>' : '<span class="error">âŒ</span>'}</td>
                </tr>`;
            });
            
            html += '</table>';
            resultEl.innerHTML = html;
        };
        
        window.testSetModeFlow = function() {
            const resultEl = document.getElementById('step3-result');
            log(`\n${'='.repeat(50)}`, 'info');
            log(`ğŸ§ª _setMode('monitoring') íë¦„ í…ŒìŠ¤íŠ¸ ì‹œì‘`, 'info');
            log(`${'='.repeat(50)}`, 'info');
            
            // ì •ìƒ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
            sidebar = new MockSidebar({
                appModeManager: appModeManager,
                APP_MODE: APP_MODE
            });
            
            sidebar._setMode('monitoring');
            
            const result = appModeManager.getCurrentMode();
            let html = `<div class="step">`;
            html += `<span class="step-number">ê²°ê³¼:</span>\n`;
            html += `í˜„ì¬ ëª¨ë“œ: ${result}\n`;
            html += `ê¸°ëŒ€ê°’: monitoring\n`;
            html += `${result === 'monitoring' ? 
                '<span class="success check-mark">í…ŒìŠ¤íŠ¸ í†µê³¼!</span>' : 
                '<span class="error cross-mark">í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!</span>'}\n`;
            html += `</div>`;
            
            resultEl.innerHTML = html;
        };
        
        window.testModeHandlers = function() {
            const resultEl = document.getElementById('step4-result');
            let html = '<table><tr><th>ëª¨ë“œ</th><th>í•¸ë“¤ëŸ¬ ë“±ë¡</th><th>ì„œë¹„ìŠ¤ ì—°ê²°</th></tr>';
            
            const modes = [APP_MODE.MAIN_VIEWER, APP_MODE.MONITORING, APP_MODE.EQUIPMENT_EDIT];
            
            modes.forEach(mode => {
                const handler = appModeManager.getModeHandler(mode);
                const hasHandler = handler !== undefined;
                const hasService = mode === APP_MODE.MONITORING ? 
                    handler?._monitoringService !== undefined : true;
                
                html += `<tr>
                    <td>${mode}</td>
                    <td>${hasHandler ? '<span class="success">âœ…</span>' : '<span class="error">âŒ</span>'}</td>
                    <td>${hasService ? '<span class="success">âœ…</span>' : '<span class="error">âŒ</span>'}</td>
                </tr>`;
            });
            
            html += '</table>';
            resultEl.innerHTML = html;
        };
        
        window.simulateMonitoringClick = function() {
            log(`\n${'='.repeat(50)}`, 'info');
            log(`ğŸ–±ï¸ Monitoring ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜`, 'info');
            log(`${'='.repeat(50)}`, 'info');
            
            if (!sidebar) {
                sidebar = new MockSidebar({
                    appModeManager: appModeManager,
                    APP_MODE: APP_MODE
                });
            }
            
            sidebar._setMode('monitoring');
            sidebar._setSubMode('3d-view');
        };
        
        window.directModeSwitch = function(mode) {
            log(`\nğŸ”€ ì§ì ‘ switchMode('${mode}') í˜¸ì¶œ`, 'info');
            appModeManager.switchMode(mode, { skipConnectionCheck: true });
        };
        
        window.runAllTests = function() {
            clearLog();
            log(`ğŸš€ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘`, 'info');
            log(`${'='.repeat(50)}`, 'info');
            
            testAppModeDelivery();
            testModeMapping();
            testSetModeFlow();
            testModeHandlers();
            
            generateDiagnosis();
        };
        
        function generateDiagnosis() {
            const diagnosisEl = document.getElementById('diagnosis-result');
            let issues = [];
            
            // ì²´í¬ 1: APP_MODE ì „ë‹¬
            if (sidebar && Object.keys(sidebar.APP_MODE).length === 0) {
                issues.push({
                    severity: 'error',
                    title: 'APP_MODEê°€ Sidebarì— ì „ë‹¬ë˜ì§€ ì•ŠìŒ',
                    description: 'createSidebarUI() í˜¸ì¶œ ì‹œ APP_MODEê°€ ë¹ˆ ê°ì²´ë¡œ ì „ë‹¬ë¨',
                    solution: 'main.jsì—ì„œ createSidebarUI({ APP_MODE, ... }) í™•ì¸ í•„ìš”'
                });
            }
            
            // ì²´í¬ 2: ëª¨ë“œ í•¸ë“¤ëŸ¬ ë“±ë¡
            const monitoringHandler = appModeManager.getModeHandler(APP_MODE.MONITORING);
            if (!monitoringHandler) {
                issues.push({
                    severity: 'error',
                    title: 'Monitoring ëª¨ë“œ í•¸ë“¤ëŸ¬ ë¯¸ë“±ë¡',
                    description: 'AppModeManagerì— Monitoring í•¸ë“¤ëŸ¬ê°€ ë“±ë¡ë˜ì§€ ì•ŠìŒ',
                    solution: 'registerAllModeHandlers()ê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸'
                });
            }
            
            // ì²´í¬ 3: MonitoringService ì—°ê²°
            if (monitoringHandler && !monitoringHandler._monitoringService) {
                issues.push({
                    severity: 'error',
                    title: 'MonitoringService ë¯¸ì—°ê²°',
                    description: 'Monitoring í•¸ë“¤ëŸ¬ì— MonitoringServiceê°€ ì—°ê²°ë˜ì§€ ì•ŠìŒ',
                    solution: 'connectServicesToModeHandlers()ê°€ í˜¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸'
                });
            }
            
            // ê²°ê³¼ í‘œì‹œ
            let html = '';
            if (issues.length === 0) {
                html = '<div class="step" style="border-color: #2ed573;"><span class="success check-mark">ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼! Mock í™˜ê²½ì—ì„œëŠ” ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.</span></div>';
            } else {
                html = '<h3 style="color: #ff4757;">ë°œê²¬ëœ ë¬¸ì œ:</h3>';
                issues.forEach((issue, i) => {
                    html += `
                        <div class="step" style="border-color: ${issue.severity === 'error' ? '#ff4757' : '#ffa502'};">
                            <strong>${issue.severity === 'error' ? 'âŒ' : 'âš ï¸'} ${issue.title}</strong><br>
                            <span style="color: #888;">${issue.description}</span><br>
                            <span style="color: #00d4ff;">ğŸ’¡ í•´ê²°: ${issue.solution}</span>
                        </div>
                    `;
                });
            }
            
            diagnosisEl.innerHTML = html;
        }
        
        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            log(`ğŸ”§ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì´ˆê¸°í™” ì‹œì‘`, 'info');
            
            // ëª¨ë“œ í•¸ë“¤ëŸ¬ ë“±ë¡
            registerModeHandlers();
            
            // ê¸°ë³¸ Sidebar ìƒì„±
            sidebar = new MockSidebar({
                appModeManager: appModeManager,
                APP_MODE: APP_MODE
            });
            
            updateModeDisplay();
            updateConnectionDisplay();
            
            log(`âœ… í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ`, 'success');
            log(`\nğŸ’¡ ìœ„ì˜ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤ì„ í´ë¦­í•˜ì—¬ ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ì„¸ìš”.`, 'info');
        });
        
        // ì „ì—­ ë…¸ì¶œ
        window.APP_MODE = APP_MODE;
        window.MODE_MAP = MODE_MAP;
        window.appModeManager = appModeManager;
        window.sidebar = () => sidebar;
        window.connectionStatusService = connectionStatusService;
    </script>
</body>
</html>