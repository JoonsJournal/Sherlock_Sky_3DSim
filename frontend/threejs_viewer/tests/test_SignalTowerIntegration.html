<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalTowerIntegration Test - Phase 6</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b35;
            text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel h2 {
            color: #ff6b35;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #ff6b35;
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #cc5529 100%);
            color: #fff;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #cc3847 100%);
            color: #fff;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffa502 0%, #cc8402 100%);
            color: #000;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-run { background: #00ff00; color: #000; }
        .btn-idle { background: #ffff00; color: #000; }
        .btn-stop { background: #ff8800; color: #000; }
        .btn-sudden { background: #ff0000; color: #fff; }
        .btn-disc { background: #666666; color: #fff; }
        
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .equipment-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .equipment-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .equipment-item.selected {
            border-color: #ff6b35;
        }
        
        .equipment-item.mapped {
            border-left: 3px solid #00ff88;
        }
        
        .equipment-item.unmapped {
            opacity: 0.5;
            border-left: 3px solid #666;
        }
        
        .equipment-lamp {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin: 0 auto 5px;
            transition: all 0.3s;
        }
        
        .lamp-off { background: #333; }
        .lamp-run { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .lamp-idle { background: #ffff00; box-shadow: 0 0 10px #ffff00; }
        .lamp-stop { background: #ff8800; box-shadow: 0 0 8px #ff8800; }
        .lamp-sudden { background: #ff0000; box-shadow: 0 0 12px #ff0000; animation: blink 0.5s infinite; }
        .lamp-disc { background: #666; }
        .lamp-disabled { background: #222; border: 1px dashed #444; }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .equipment-id {
            font-size: 10px;
            color: #888;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #ff6b35;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 3px;
        }
        
        .signal-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .signal-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        .signal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .log-container {
            height: 180px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
        }
        
        .log-entry {
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .log-entry.info { background: rgba(255, 107, 53, 0.1); }
        .log-entry.success { background: rgba(0, 255, 136, 0.1); color: #00ff88; }
        .log-entry.error { background: rgba(255, 71, 87, 0.1); color: #ff4757; }
        .log-entry.warning { background: rgba(255, 165, 2, 0.1); color: #ffa502; }
        
        .log-time {
            color: #666;
            margin-right: 8px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .two-col {
            grid-column: span 2;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-ready { background: #00ff88; color: #000; }
        .status-not-ready { background: #ff4757; color: #fff; }
    </style>
</head>
<body>
    <h1>üö® SignalTowerIntegration Test - Phase 6</h1>
    
    <div class="container">
        <!-- Initialization Panel -->
        <div class="panel">
            <h2>Initialization</h2>
            
            <div class="btn-group">
                <button class="btn-primary" onclick="initializeAllLights()">üí° Initialize All Lights</button>
                <button class="btn-warning" onclick="applyUnmappedStyle()">üå´Ô∏è Apply Unmapped Style</button>
            </div>
            
            <div class="btn-group">
                <button class="btn-success" onclick="resetAllStyles()">‚ôªÔ∏è Reset All Styles</button>
                <button class="btn-danger" onclick="disposeIntegration()">üóëÔ∏è Dispose</button>
            </div>
            
            <div style="margin-top: 15px;">
                <strong>Status:</strong>
                <span id="readyStatus" class="status-badge status-not-ready">Not Ready</span>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="mappedCount">0</div>
                    <div class="stat-label">Mapped</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unmappedCount">0</div>
                    <div class="stat-label">Unmapped</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="rateValue">0%</div>
                    <div class="stat-label">Rate</div>
                </div>
            </div>
        </div>
        
        <!-- Status Update Panel -->
        <div class="panel">
            <h2>Status Update</h2>
            
            <div class="form-group">
                <label>Equipment ID</label>
                <input type="text" id="updateEquipmentId" value="EQ-01-01" placeholder="EQ-XX-XX">
            </div>
            
            <div class="btn-group">
                <button class="btn-run" onclick="updateStatus('RUN')">RUN</button>
                <button class="btn-idle" onclick="updateStatus('IDLE')">IDLE</button>
                <button class="btn-stop" onclick="updateStatus('STOP')">STOP</button>
                <button class="btn-sudden" onclick="updateStatus('SUDDENSTOP')">SUDDEN</button>
                <button class="btn-disc" onclick="updateStatus('DISCONNECTED')">DISC</button>
            </div>
            
            <div class="form-group">
                <label>Or Select from Grid</label>
            </div>
            
            <div class="btn-group">
                <button class="btn-secondary" onclick="restoreStyle()">üîß Restore Style</button>
                <button class="btn-secondary" onclick="clearDisabled()">‚úÖ Clear Disabled</button>
            </div>
        </div>
        
        <!-- SignalTower Statistics -->
        <div class="panel">
            <h2>SignalTower Statistics</h2>
            
            <div class="signal-stats">
                <div class="signal-stat">
                    <div class="signal-dot lamp-run"></div>
                    <span>RUN: <strong id="statRun">0</strong></span>
                </div>
                <div class="signal-stat">
                    <div class="signal-dot lamp-idle"></div>
                    <span>IDLE: <strong id="statIdle">0</strong></span>
                </div>
                <div class="signal-stat">
                    <div class="signal-dot lamp-stop"></div>
                    <span>STOP: <strong id="statStop">0</strong></span>
                </div>
                <div class="signal-stat">
                    <div class="signal-dot lamp-sudden"></div>
                    <span>SUDDEN: <strong id="statSudden">0</strong></span>
                </div>
                <div class="signal-stat">
                    <div class="signal-dot lamp-disc"></div>
                    <span>DISC: <strong id="statDisc">0</strong></span>
                </div>
                <div class="signal-stat">
                    <div class="signal-dot lamp-off"></div>
                    <span>OFF: <strong id="statOff">0</strong></span>
                </div>
                <div class="signal-stat">
                    <div class="signal-dot lamp-disabled"></div>
                    <span>DISABLED: <strong id="statDisabled">0</strong></span>
                </div>
            </div>
            
            <button class="btn-secondary" style="width: 100%; margin-top: 15px;" onclick="refreshStats()">üîÑ Refresh Stats</button>
        </div>
        
        <!-- Equipment Grid -->
        <div class="panel two-col">
            <h2>Equipment Grid (4x6 = 24 Mock Equipment)</h2>
            <div class="equipment-grid" id="equipmentGrid"></div>
        </div>
        
        <!-- Normalize Status Test -->
        <div class="panel">
            <h2>Normalize Status</h2>
            
            <div class="form-group">
                <label>Input Status</label>
                <input type="text" id="normalizeInput" placeholder="RUN, RUNNING, idle, STOP...">
            </div>
            
            <button class="btn-primary" onclick="testNormalize()">Normalize</button>
            
            <div style="margin-top: 15px;">
                <strong>Result:</strong> <code id="normalizeResult">-</code>
            </div>
        </div>
        
        <!-- Log Panel -->
        <div class="panel full-width">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin-bottom: 0;">Live Log</h2>
                <button class="btn-secondary" onclick="clearLog()">üóëÔ∏è Clear</button>
            </div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>
    
    <script>
        // =========================================
        // Mock Objects
        // =========================================
        
        // Mock SignalTowerManager
        const mockSignalTowerManager = {
            statuses: {},
            disabledIds: new Set(),
            
            initializeAllLights() {
                this.statuses = {};
                this.disabledIds.clear();
                addLog('success', 'üí° All lights initialized (OFF)');
                return 24;
            },
            
            updateStatus(frontendId, status) {
                this.statuses[frontendId] = status;
                updateEquipmentUI(frontendId, status);
                addLog('info', `üö¶ ${frontendId} ‚Üí ${status}`);
            },
            
            updateSignalTower(frontendId, status) {
                this.updateStatus(frontendId, status);
            },
            
            disableUnmappedEquipment(ids) {
                ids.forEach(id => {
                    this.disabledIds.add(id);
                    this.statuses[id] = 'DISABLED';
                    updateEquipmentUI(id, 'DISABLED');
                });
                addLog('warning', `üå´Ô∏è Disabled ${ids.length} equipment`);
            },
            
            clearDisabledState(frontendId) {
                this.disabledIds.delete(frontendId);
                this.statuses[frontendId] = 'OFF';
                updateEquipmentUI(frontendId, 'OFF');
                addLog('success', `‚úÖ ${frontendId} enabled`);
            },
            
            getStatusStatistics() {
                const stats = {
                    RUN: 0, IDLE: 0, STOP: 0, SUDDENSTOP: 0,
                    DISCONNECTED: 0, OFF: 0, DISABLED: 0
                };
                
                Object.values(this.statuses).forEach(status => {
                    const upperStatus = (status || 'OFF').toUpperCase();
                    if (upperStatus === 'RUNNING') stats.RUN++;
                    else if (stats.hasOwnProperty(upperStatus)) stats[upperStatus]++;
                    else stats.OFF++;
                });
                
                return stats;
            }
        };
        
        // Mock EquipmentLoader
        const mockEquipmentLoader = {
            equipment: [],
            
            init() {
                this.equipment = [];
                for (let row = 1; row <= 4; row++) {
                    for (let col = 1; col <= 6; col++) {
                        const id = `EQ-${String(row).padStart(2, '0')}-${String(col).padStart(2, '0')}`;
                        this.equipment.push({
                            userData: { id }
                        });
                    }
                }
            },
            
            getAllEquipment() {
                return this.equipment;
            },
            
            applyMonitoringModeVisibility(mappings, options) {
                let mapped = 0, unmapped = 0;
                
                this.equipment.forEach(eq => {
                    const id = eq.userData.id;
                    if (mappings[id]) {
                        mapped++;
                        setEquipmentMappedUI(id, true);
                    } else {
                        unmapped++;
                        setEquipmentMappedUI(id, false);
                    }
                });
                
                addLog('info', `üå´Ô∏è Model visibility: ${mapped} mapped, ${unmapped} unmapped`);
                return { mapped, unmapped };
            },
            
            restoreEquipmentStyle(frontendId) {
                setEquipmentMappedUI(frontendId, true);
                addLog('success', `‚úÖ ${frontendId} style restored`);
            },
            
            resetAllEquipmentVisibility() {
                this.equipment.forEach(eq => {
                    setEquipmentMappedUI(eq.userData.id, true);
                });
                addLog('success', '‚ôªÔ∏è All equipment visibility reset');
            }
        };
        
        // Mock EquipmentEditState
        const mockEquipmentEditState = {
            mappings: {},
            
            init() {
                // ÎûúÎç§ÌïòÍ≤å ÏùºÎ∂Ä ÏÑ§ÎπÑÎßå Îß§ÌïëÎê® Ï≤òÎ¶¨ (ÏïΩ 60%)
                mockEquipmentLoader.equipment.forEach(eq => {
                    if (Math.random() > 0.4) {
                        this.mappings[eq.userData.id] = {
                            equipmentId: Math.floor(Math.random() * 1000) + 1
                        };
                    }
                });
            },
            
            getAllMappings() {
                return { ...this.mappings };
            },
            
            isComplete(frontendId) {
                return !!this.mappings[frontendId];
            },
            
            getMappingCount() {
                return Object.keys(this.mappings).length;
            }
        };
        
        // =========================================
        // SignalTowerIntegration (Inline)
        // =========================================
        
        const STATUS_MAP = {
            'RUN': 'running',
            'RUNNING': 'running',
            'IDLE': 'idle',
            'STOP': 'stop',
            'ALARM': 'alarm',
            'DOWN': 'down',
            'DISCONNECTED': 'disconnected',
            'SUDDENSTOP': 'suddenstop'
        };
        
        class SignalTowerIntegration {
            constructor(signalTowerManager, equipmentLoader, equipmentEditState, options = {}) {
                this.signalTowerManager = signalTowerManager;
                this.equipmentLoader = equipmentLoader;
                this.equipmentEditState = equipmentEditState;
                this.debug = options.debug || true;
                this.disabledOptions = { grayColor: 0x444444 };
                this._lastApplyResult = { mapped: 0, unmapped: 0, total: 0, rate: 0 };
            }
            
            _log(...args) {
                if (this.debug) console.log('[SignalTowerIntegration]', ...args);
            }
            
            initializeAllLights() {
                if (!this.signalTowerManager) return 0;
                const count = this.signalTowerManager.initializeAllLights();
                return count;
            }
            
            applyUnmappedStyle() {
                const result = { mapped: 0, unmapped: 0, total: 0, rate: 0 };
                
                // Model
                if (this.equipmentLoader && this.equipmentEditState) {
                    const mappings = this.equipmentEditState.getAllMappings();
                    const modelResult = this.equipmentLoader.applyMonitoringModeVisibility(mappings, this.disabledOptions);
                    result.mapped = modelResult.mapped;
                    result.unmapped = modelResult.unmapped;
                    result.total = result.mapped + result.unmapped;
                    result.rate = result.total > 0 ? Math.round((result.mapped / result.total) * 100) : 0;
                }
                
                // SignalTower
                if (this.signalTowerManager && this.equipmentLoader && this.equipmentEditState) {
                    const equipmentArray = this.equipmentLoader.getAllEquipment();
                    const unmappedIds = [];
                    
                    equipmentArray.forEach(eq => {
                        const frontendId = eq.userData?.id;
                        if (frontendId && !this.equipmentEditState.isComplete(frontendId)) {
                            unmappedIds.push(frontendId);
                        }
                    });
                    
                    if (unmappedIds.length > 0) {
                        this.signalTowerManager.disableUnmappedEquipment(unmappedIds);
                    }
                }
                
                this._lastApplyResult = { ...result };
                return result;
            }
            
            applyUnmappedEquipmentStyle() {
                if (!this.equipmentLoader || !this.equipmentEditState) return { mapped: 0, unmapped: 0 };
                const mappings = this.equipmentEditState.getAllMappings();
                return this.equipmentLoader.applyMonitoringModeVisibility(mappings, this.disabledOptions);
            }
            
            applyUnmappedSignalTowerStyle() {
                if (!this.signalTowerManager || !this.equipmentLoader || !this.equipmentEditState) return;
                const equipmentArray = this.equipmentLoader.getAllEquipment();
                const unmappedIds = equipmentArray
                    .filter(eq => !this.equipmentEditState.isComplete(eq.userData?.id))
                    .map(eq => eq.userData?.id)
                    .filter(Boolean);
                
                if (unmappedIds.length > 0) {
                    this.signalTowerManager.disableUnmappedEquipment(unmappedIds);
                }
            }
            
            updateStatus(frontendId, status, normalize = true) {
                if (!this.signalTowerManager) return;
                const finalStatus = normalize ? this.normalizeStatus(status) : status;
                this.signalTowerManager.updateStatus(frontendId, finalStatus);
            }
            
            normalizeStatus(status) {
                if (!status) return 'disconnected';
                const upperStatus = status.toUpperCase();
                return STATUS_MAP[upperStatus] || status.toLowerCase();
            }
            
            clearDisabledState(frontendId) {
                if (this.signalTowerManager?.clearDisabledState) {
                    this.signalTowerManager.clearDisabledState(frontendId);
                }
            }
            
            restoreEquipmentStyle(frontendId) {
                if (this.equipmentLoader?.restoreEquipmentStyle) {
                    this.equipmentLoader.restoreEquipmentStyle(frontendId);
                }
            }
            
            restoreEquipmentFullStyle(frontendId) {
                this.restoreEquipmentStyle(frontendId);
                this.clearDisabledState(frontendId);
            }
            
            resetAllStyles() {
                if (this.equipmentLoader?.resetAllEquipmentVisibility) {
                    this.equipmentLoader.resetAllEquipmentVisibility();
                }
            }
            
            getStatusStatistics() {
                if (this.signalTowerManager?.getStatusStatistics) {
                    return this.signalTowerManager.getStatusStatistics();
                }
                return { RUN: 0, IDLE: 0, STOP: 0, SUDDENSTOP: 0, DISCONNECTED: 0, OFF: 0, DISABLED: 0 };
            }
            
            getLastApplyResult() {
                return { ...this._lastApplyResult };
            }
            
            isEquipmentMapped(frontendId) {
                if (!this.equipmentEditState) return true;
                return this.equipmentEditState.isComplete(frontendId);
            }
            
            isReady() {
                return !!(this.signalTowerManager && this.equipmentLoader && this.equipmentEditState);
            }
            
            getStatus() {
                return {
                    isReady: this.isReady(),
                    lastApplyResult: this.getLastApplyResult(),
                    statistics: this.getStatusStatistics()
                };
            }
            
            dispose() {
                this.signalTowerManager = null;
                this.equipmentLoader = null;
                this.equipmentEditState = null;
                addLog('error', 'üóëÔ∏è SignalTowerIntegration disposed');
            }
        }
        
        // =========================================
        // Global Instance
        // =========================================
        
        let signalIntegration = null;
        let selectedEquipmentId = 'EQ-01-01';
        
        // =========================================
        // UI Functions
        // =========================================
        
        function initMocks() {
            mockEquipmentLoader.init();
            mockEquipmentEditState.init();
            
            signalIntegration = new SignalTowerIntegration(
                mockSignalTowerManager,
                mockEquipmentLoader,
                mockEquipmentEditState,
                { debug: true }
            );
            
            updateReadyStatus();
            addLog('success', '‚úÖ Mock objects and SignalTowerIntegration initialized');
        }
        
        function createEquipmentGrid() {
            const grid = document.getElementById('equipmentGrid');
            grid.innerHTML = '';
            
            mockEquipmentLoader.equipment.forEach(eq => {
                const id = eq.userData.id;
                const isMapped = mockEquipmentEditState.isComplete(id);
                
                const item = document.createElement('div');
                item.className = `equipment-item ${isMapped ? 'mapped' : 'unmapped'}`;
                item.id = `eq-${id}`;
                item.onclick = () => selectEquipment(id);
                
                item.innerHTML = `
                    <div class="equipment-lamp lamp-off" id="lamp-${id}"></div>
                    <div class="equipment-id">${id}</div>
                `;
                
                grid.appendChild(item);
            });
        }
        
        function selectEquipment(id) {
            // Remove previous selection
            document.querySelectorAll('.equipment-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add new selection
            const item = document.getElementById(`eq-${id}`);
            if (item) item.classList.add('selected');
            
            selectedEquipmentId = id;
            document.getElementById('updateEquipmentId').value = id;
            
            addLog('info', `üìå Selected: ${id}`);
        }
        
        function updateEquipmentUI(frontendId, status) {
            const lamp = document.getElementById(`lamp-${frontendId}`);
            if (!lamp) return;
            
            // Remove all lamp classes
            lamp.className = 'equipment-lamp';
            
            // Add appropriate class
            const statusLower = (status || 'off').toLowerCase();
            if (statusLower === 'running' || statusLower === 'run') {
                lamp.classList.add('lamp-run');
            } else if (statusLower === 'idle') {
                lamp.classList.add('lamp-idle');
            } else if (statusLower === 'stop') {
                lamp.classList.add('lamp-stop');
            } else if (statusLower === 'suddenstop') {
                lamp.classList.add('lamp-sudden');
            } else if (statusLower === 'disconnected') {
                lamp.classList.add('lamp-disc');
            } else if (statusLower === 'disabled') {
                lamp.classList.add('lamp-disabled');
            } else {
                lamp.classList.add('lamp-off');
            }
        }
        
        function setEquipmentMappedUI(frontendId, isMapped) {
            const item = document.getElementById(`eq-${frontendId}`);
            if (!item) return;
            
            item.classList.remove('mapped', 'unmapped');
            item.classList.add(isMapped ? 'mapped' : 'unmapped');
        }
        
        function updateReadyStatus() {
            const badge = document.getElementById('readyStatus');
            const isReady = signalIntegration?.isReady();
            
            badge.textContent = isReady ? 'Ready' : 'Not Ready';
            badge.className = `status-badge ${isReady ? 'status-ready' : 'status-not-ready'}`;
        }
        
        function updateStatsDisplay() {
            const result = signalIntegration?.getLastApplyResult() || { mapped: 0, unmapped: 0, total: 0, rate: 0 };
            
            document.getElementById('mappedCount').textContent = result.mapped;
            document.getElementById('unmappedCount').textContent = result.unmapped;
            document.getElementById('totalCount').textContent = result.total;
            document.getElementById('rateValue').textContent = result.rate + '%';
        }
        
        function refreshStats() {
            const stats = signalIntegration?.getStatusStatistics() || {};
            
            document.getElementById('statRun').textContent = stats.RUN || 0;
            document.getElementById('statIdle').textContent = stats.IDLE || 0;
            document.getElementById('statStop').textContent = stats.STOP || 0;
            document.getElementById('statSudden').textContent = stats.SUDDENSTOP || 0;
            document.getElementById('statDisc').textContent = stats.DISCONNECTED || 0;
            document.getElementById('statOff').textContent = stats.OFF || 0;
            document.getElementById('statDisabled').textContent = stats.DISABLED || 0;
            
            addLog('info', 'üîÑ Stats refreshed');
        }
        
        // =========================================
        // Action Functions
        // =========================================
        
        function initializeAllLights() {
            if (!signalIntegration) {
                addLog('error', '‚ùå SignalTowerIntegration not initialized');
                return;
            }
            
            signalIntegration.initializeAllLights();
            refreshStats();
        }
        
        function applyUnmappedStyle() {
            if (!signalIntegration) {
                addLog('error', '‚ùå SignalTowerIntegration not initialized');
                return;
            }
            
            const result = signalIntegration.applyUnmappedStyle();
            updateStatsDisplay();
            refreshStats();
            addLog('success', `‚úÖ Unmapped style applied: ${result.mapped}/${result.total} (${result.rate}%)`);
        }
        
        function resetAllStyles() {
            if (!signalIntegration) {
                addLog('error', '‚ùå SignalTowerIntegration not initialized');
                return;
            }
            
            signalIntegration.resetAllStyles();
            signalIntegration.initializeAllLights();
            refreshStats();
        }
        
        function disposeIntegration() {
            if (signalIntegration) {
                signalIntegration.dispose();
                signalIntegration = null;
            }
            updateReadyStatus();
        }
        
        function updateStatus(status) {
            if (!signalIntegration) {
                addLog('error', '‚ùå SignalTowerIntegration not initialized');
                return;
            }
            
            const id = document.getElementById('updateEquipmentId').value || selectedEquipmentId;
            signalIntegration.updateStatus(id, status);
            refreshStats();
        }
        
        function restoreStyle() {
            if (!signalIntegration) return;
            const id = document.getElementById('updateEquipmentId').value || selectedEquipmentId;
            signalIntegration.restoreEquipmentStyle(id);
        }
        
        function clearDisabled() {
            if (!signalIntegration) return;
            const id = document.getElementById('updateEquipmentId').value || selectedEquipmentId;
            signalIntegration.clearDisabledState(id);
            refreshStats();
        }
        
        function testNormalize() {
            const input = document.getElementById('normalizeInput').value;
            const result = signalIntegration?.normalizeStatus(input) || '-';
            document.getElementById('normalizeResult').textContent = result;
            addLog('info', `üìù Normalize: "${input}" ‚Üí "${result}"`);
        }
        
        // =========================================
        // Log Functions
        // =========================================
        
        function addLog(type, message) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        // =========================================
        // Initialize
        // =========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initMocks();
            createEquipmentGrid();
            selectEquipment('EQ-01-01');
            addLog('info', 'üöÄ SignalTowerIntegration Test Page Ready');
        });
    </script>
</body>
</html>