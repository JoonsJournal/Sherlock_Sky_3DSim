<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Editor - SHERLOCK_SKY_3DSIM (Phase 4)</title>
    
    <!-- Konva.js CDN -->
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    
    <!-- âœ… ì „ì—­ ê°ì²´ ë°©ì‹ìœ¼ë¡œ ë¡œë“œ (ì˜ì¡´ì„± ìˆœì„œ ì¤‘ìš”) -->
    <script src="../src/layout-editor/canvas/LayerManager.js"></script>
    <script src="../src/layout-editor/canvas/CanvasRenderer.js"></script>
    <script src="../src/layout-editor/canvas/CanvasEventHandler.js"></script>
    
    <!-- âœ… Handle ëª¨ë“ˆ (PowerPoint ìŠ¤íƒ€ì¼ 8ê°œ í•¸ë“¤ + íšŒì „) -->
    <script src="../src/layout-editor/handles/ResizeHandle.js"></script>
    <script src="../src/layout-editor/handles/RotateHandle.js"></script>
    <script src="../src/layout-editor/handles/HandleManager.js"></script>
    
    <!-- âœ… Smart Guides ëª¨ë“ˆ (ì •ë ¬ ê°€ì´ë“œë¼ì¸) -->
    <script src="../src/layout-editor/guides/AlignmentGuide.js"></script>
    <script src="../src/layout-editor/guides/DistributionGuide.js"></script>
    <script src="../src/layout-editor/guides/SmartGuideManager.js"></script>
    
    <!-- âœ… Snap ëª¨ë“ˆ (MICE ìŠ¤ëƒ… í¬ì¸íŠ¸) -->
    <script src="../src/layout-editor/snap/GridSnap.js"></script>
    <script src="../src/layout-editor/snap/MICESnapPoints.js"></script>
    <script src="../src/layout-editor/snap/SnapManager.js"></script>
    
    <!-- âœ… Selection ëª¨ë“ˆ (Window/Crossing ë°•ìŠ¤ ì„ íƒ) -->
    <script src="../src/layout-editor/selection/SelectionRenderer.js"></script>
    <script src="../src/layout-editor/selection/Selection2DManager.js"></script>
    <script src="../src/layout-editor/selection/FenceSelection.js"></script>
    
    <!-- âœ… Phase 1: Command ëª¨ë“ˆ (ES6 export ì œê±°ë¨, script íƒœê·¸ ë¡œë“œ ê°€ëŠ¥) -->
    <script src="../src/layout-editor/commands/Command.js"></script>
    <script src="../src/layout-editor/commands/CommandManager.js"></script>
    
    <!-- âœ… Export ëª¨ë“ˆ ì¶”ê°€ -->
    <script src="../src/layout-editor/export/LayoutExporter.js"></script>

    <script src="../src/layout-editor/components/Canvas2DEditor.js"></script>
    <script src="../src/layout-editor/controllers/ZoomController.js"></script>
    <script src="../src/layout-editor/tools/ObjectSelectionTool.js"></script>
    <script src="../src/layout-editor/tools/AlignmentTool.js"></script>
    <script src="../src/layout-editor/tools/WallDrawTool.js"></script>
    <script src="../src/layout-editor/tools/EquipmentArrayTool.js"></script>
    <script src="../src/layout-editor/managers/RoomSizeManager.js"></script>
    <script src="../src/layout-editor/components/PropertyPanel.js"></script>
    
    <!-- âœ… Phase 3: GroupingTool ì¶”ê°€ -->
    <script src="../src/layout-editor/tools/GroupingTool.js"></script>
    
    <style>
        :root {
            /* âœ… íˆ´ë°” í¬ê¸° ìë™ ì¡°ì ˆ */
            --toolbar-width: 60px;
            --toolbar-expanded-width: 270px;
            --submenu-width: 210px;
            --property-panel-width: 260px;
            --header-height: 48px;
            --status-height: 30px;
            --btn-size: 44px;
            
            /* Canvas Colors */
            --canvas-equipment-default: #4a90e2;
            --canvas-equipment-selected: #FF6600;
            --canvas-equipment-hover: #00BFFF;
            --canvas-equipment-stroke: #2c3e50;
            --canvas-transformer-border: #667eea;
            --canvas-bg: #f0f0f0;
            --canvas-grid-minor: #d8d8d8;
            --canvas-grid-major: #b0b0b0;
            --canvas-grid-label: #888888;
            --canvas-selection-stroke: #FF6600;
            
            /* Theme Colors */
            --primary-color: #667eea;
            --primary-dark: #764ba2;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--canvas-bg); overflow: hidden; }
        
        /* ============================================
           Header
           ============================================ */
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 200;
        }
        .header h1 { font-size: 16px; margin: 0; }
        .header-actions { display: flex; gap: 6px; }
        .header-btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .header-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--success-color); color: white; }
        .btn-primary:hover:not(:disabled) { background: #229954; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        .btn-secondary:hover:not(:disabled) { background: rgba(255,255,255,0.3); }
        
        /* ============================================
           Layout
           ============================================ */
        .layout-container { display: flex; position: fixed; top: var(--header-height); left: 0; right: 0; bottom: var(--status-height); }
        
        /* ============================================
           Toolbar - ìë™ í¬ê¸° ì¡°ì ˆ
           ============================================ */
        .toolbar-container {
            width: var(--toolbar-width);
            display: flex;
            flex-shrink: 0;
            transition: width 0.3s ease;
            z-index: 10;
        }
        .toolbar-container.expanded { width: var(--toolbar-expanded-width); }
        
        .toolbar {
            width: var(--toolbar-width);
            min-width: var(--toolbar-width);
            background: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            gap: 2px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* âœ… ë²„íŠ¼ í¬ê¸° ì¡°ì ˆ */
        .toolbar-btn {
            width: var(--btn-size);
            height: var(--btn-size);
            background: #34495e;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .toolbar-btn:hover { background: var(--primary-color); transform: scale(1.05); }
        .toolbar-btn.active { background: var(--primary-color); box-shadow: 0 0 10px rgba(102, 126, 234, 0.6); }
        .toolbar-btn.zoom { background: var(--success-color); font-size: 18px; }
        .toolbar-btn.zoom:hover { background: #229954; }
        .toolbar-btn.zoom.reset { background: var(--info-color); }
        .toolbar-btn.danger { background: #c0392b; }
        .toolbar-btn.danger:hover { background: var(--danger-color); }
        /* âœ… Phase 3: ê·¸ë£¹í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .toolbar-btn.group { background: #16a085; }
        .toolbar-btn.group:hover { background: #1abc9c; }
        
        /* Tooltip */
        .toolbar-btn::after {
            content: attr(title);
            position: absolute; left: calc(var(--btn-size) + 8px); top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.9); color: white; padding: 6px 10px; border-radius: 5px;
            font-size: 11px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 1000;
        }
        .toolbar-btn:hover::after { opacity: 1; }
        /* .toolbar-container.expanded .toolbar-btn::after { display: none; } */
        
        .toolbar-divider { width: 32px; height: 2px; background: #4a5c6a; margin: 4px 0; flex-shrink: 0; }
        
        /* ============================================
           Align Popup
           ============================================ */
        .align-popup { display: none; position: fixed; left: 70px; top: 0; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); padding: 8px; z-index: 1000; min-width: 180px; }
        .align-popup.show { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .align-popup-header { font-size: 11px; font-weight: 600; color: var(--primary-color); padding: 4px 8px; border-bottom: 1px solid #eee; margin-bottom: 6px; }
        .align-popup-section { margin-bottom: 8px; }
        .align-popup-section-title { font-size: 10px; color: #999; padding: 4px 8px; text-transform: uppercase; }
        .align-popup-btn { display: flex; align-items: center; gap: 6px; width: 100%; padding: 6px 10px; border: none; background: transparent; cursor: pointer; border-radius: 5px; font-size: 12px; color: #333; transition: all 0.2s; }
        .align-popup-btn:hover { background: #f0f4ff; color: var(--primary-color); }
        .align-popup-btn .icon { font-size: 14px; width: 20px; text-align: center; }
        .align-popup-btn .shortcut { margin-left: auto; font-size: 9px; color: #aaa; background: #f0f0f0; padding: 2px 5px; border-radius: 3px; }
        
        /* ============================================
           Component Submenu
           ============================================ */
        .component-submenu { width: 0; background: white; overflow: hidden; transition: width 0.3s ease; box-shadow: 2px 0 15px rgba(0,0,0,0.15); }
        .toolbar-container.expanded .component-submenu { width: var(--submenu-width); }
        .submenu-content { width: var(--submenu-width); min-width: var(--submenu-width); }
        .submenu-header { padding: 12px 14px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; font-weight: 600; font-size: 13px; }
        .submenu-item { padding: 10px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .submenu-item:hover { background: #f0f4ff; }
        .submenu-item:active { background: var(--primary-color); color: white; }
        .submenu-item-icon { font-size: 18px; width: 26px; text-align: center; }
        .submenu-item-info { flex: 1; }
        .submenu-item-name { font-weight: 600; font-size: 12px; color: #2c3e50; }
        .submenu-item-size { font-size: 10px; color: #999; margin-top: 1px; }
        .submenu-item:active .submenu-item-name, .submenu-item:active .submenu-item-size { color: white; }
        
        /* ============================================
           Canvas Area - Gridê°€ í•­ìƒ ì±„ìš°ë„ë¡
           ============================================ */
        .canvas-area { flex: 1; display: flex; flex-direction: column; background: var(--canvas-bg); position: relative; min-width: 0; overflow: hidden; }
        #canvas-container { flex: 1; position: relative; overflow: hidden; background: var(--canvas-bg); }
        
        .drop-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(52, 152, 219, 0.95); color: white; padding: 16px 32px; border-radius: 10px; font-size: 16px; font-weight: bold; pointer-events: none; z-index: 1000; display: none; }
        .drop-guide.visible { display: block; }
        
        /* ============================================
           Property Panel
           ============================================ */
        .property-panel { width: var(--property-panel-width); flex-shrink: 0; background: white; border-left: 2px solid #e0e0e0; overflow-y: auto; }
        .property-panel-content { padding: 14px; }
        .property-panel-header { font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid var(--primary-color); }
        .property-panel-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 120px; color: #999; }
        .property-panel-empty-icon { font-size: 36px; margin-bottom: 6px; }
        
        /* ============================================
           Status Bar
           ============================================ */
        .status-bar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--status-height); background: #34495e; color: white; display: flex; align-items: center; padding: 0 16px; font-size: 12px; gap: 16px; z-index: 100; }
        .status-item { display: flex; align-items: center; gap: 4px; }
        .status-item.zoom-display { background: var(--success-color); padding: 3px 10px; border-radius: 4px; font-weight: 600; }
        /* âœ… Phase 1: Undo/Redo ìƒíƒœ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .status-item.history { background: #9b59b6; padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        /* âœ… Phase 2: MICE ìƒíƒœ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .status-item.mice { background: #e67e22; padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        /* âœ… Phase 3: ê·¸ë£¹ ìƒíƒœ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .status-item.groups { background: #16a085; padding: 3px 8px; border-radius: 4px; font-size: 11px; }
        
        /* ============================================
           Modal
           ============================================ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); min-width: 320px; }
        .modal-content h2 { margin: 0 0 16px 0; color: #2c3e50; font-size: 16px; }
        .form-group { margin: 12px 0; }
        .form-group label { display: block; margin-bottom: 4px; color: #555; font-weight: 600; font-size: 13px; }
        .form-group input { width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 5px; font-size: 13px; }
        .form-group input:focus { outline: none; border-color: var(--primary-color); }
        .modal-actions { display: flex; gap: 8px; margin-top: 16px; }
        .modal-actions button { flex: 1; padding: 10px; border: none; border-radius: 5px; font-size: 13px; cursor: pointer; }
        
        /* ============================================
           Toast
           ============================================ */
        .toast { position: fixed; bottom: 45px; right: 16px; background: #2c3e50; color: white; padding: 10px 16px; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; animation: slideIn 0.3s ease-out; font-size: 12px; }
        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--danger-color); }
        .toast.info { background: var(--info-color); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* ============================================
           Shortcuts Help - âœ… Phase 3: ì „ì²´ ì—…ë°ì´íŠ¸
           ============================================ */
        .shortcuts-help { position: fixed; bottom: 45px; left: 16px; background: rgba(0,0,0,0.85); color: white; padding: 12px 16px; border-radius: 6px; font-size: 11px; z-index: 100; display: none; max-width: 280px; }
        .shortcuts-help.show { display: block; }
        .shortcuts-help h4 { margin: 0 0 8px 0; color: var(--primary-color); font-size: 12px; }
        .shortcuts-help ul { list-style: none; margin: 0; padding: 0; columns: 2; column-gap: 20px; }
        .shortcuts-help li { margin: 3px 0; break-inside: avoid; }
        .shortcuts-help kbd { background: #444; padding: 1px 5px; border-radius: 3px; margin-right: 6px; font-size: 10px; }
        .shortcuts-help .section-title { color: #9b59b6; font-weight: 600; margin-top: 8px; margin-bottom: 4px; column-span: all; }
        
        /* ============================================
           Loading
           ============================================ */
        #loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px 40px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 9999; text-align: center; }
        #loading-indicator .spinner { width: 36px; height: 36px; border: 3px solid #e0e0e0; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ============================================
           Scrollbar
           ============================================ */
        .toolbar::-webkit-scrollbar { width: 3px; }
        .toolbar::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 2px; }
        .property-panel::-webkit-scrollbar { width: 5px; }
        .property-panel::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>

<body>
    <div id="loading-indicator"><div class="spinner"></div><div>Layout Editor ë¡œë”© ì¤‘...</div></div>

    <div class="header">
        <h1>ğŸ—ï¸ Layout Editor - Phase 4 (Smart Guides + Layer Order + Export)</h1>
        <div class="header-actions">
            <button class="header-btn btn-secondary" id="btn-undo" disabled>â†¶ Undo</button>
            <button class="header-btn btn-secondary" id="btn-redo" disabled>â†· Redo</button>
            <button class="header-btn btn-secondary" id="btn-help">â“</button>
            <button class="header-btn btn-secondary" id="btn-export-png">ğŸ–¼ï¸ PNG</button>
            <button class="header-btn btn-primary" id="btn-save">ğŸ’¾ Save</button>
        </div>
    </div>

    <div class="layout-container">
        <div class="toolbar-container" id="toolbar-container">
            <div class="toolbar">
                <button class="toolbar-btn active" id="tool-select" title="ì„ íƒ (V)">ğŸ‘†</button>
                <button class="toolbar-btn" id="tool-room" title="Room Size">ğŸ“</button>
                <button class="toolbar-btn" id="tool-wall" title="ë²½ ê·¸ë¦¬ê¸° (W)">ğŸ§±</button>
                <button class="toolbar-btn" id="component-btn" title="ì»´í¬ë„ŒíŠ¸ (C)">ğŸ¨</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" id="tool-grid" title="Grid (G)">ğŸ”²</button>
                <button class="toolbar-btn" id="tool-snap" title="Snap (S)">ğŸ§²</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn zoom" id="tool-zoom-in" title="Zoom In (+)">â•</button>
                <button class="toolbar-btn zoom" id="tool-zoom-out" title="Zoom Out (-)">â–</button>
                <button class="toolbar-btn zoom reset" id="tool-zoom-reset" title="Reset (0)">ğŸ¯</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" id="tool-select-all" title="ì „ì²´ì„ íƒ (âŒ˜A)">âœ…</button>
                <button class="toolbar-btn danger" id="tool-delete" title="ì‚­ì œ (Del)">ğŸ—‘ï¸</button>
                <button class="toolbar-btn" id="tool-deselect" title="í•´ì œ (Esc)">âŒ</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" id="align-btn" title="ì •ë ¬ (L)">ğŸ“</button>
                <button class="toolbar-btn" id="tool-rotate" title="íšŒì „ (R)">ğŸ”„</button>
                <div class="toolbar-divider"></div>
                <!-- âœ… Phase 3: Equipment Array + ê·¸ë£¹í™” ë²„íŠ¼ -->
                <button class="toolbar-btn" id="tool-eq-array" title="Equipment Array (A)">ğŸ­</button>
                <button class="toolbar-btn group" id="tool-group" title="ê·¸ë£¹í™” (âŒ˜G)">ğŸ“¦</button>
                <button class="toolbar-btn group" id="tool-ungroup" title="ê·¸ë£¹í•´ì œ (â‡§âŒ˜G)">ğŸ“¤</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" id="tool-sample" title="ìƒ˜í”Œ ë¡œë“œ">ğŸ“</button>
            </div>
            <div class="component-submenu" id="component-submenu">
                <div class="submenu-content">
                    <div class="submenu-header">ğŸ¨ Components</div>
                    <div class="submenu-item" draggable="true" data-component="equipment"><span class="submenu-item-icon">âš™ï¸</span><div class="submenu-item-info"><div class="submenu-item-name">Equipment</div><div class="submenu-item-size">1.5 Ã— 3.0m</div></div></div>
                    <div class="submenu-item" draggable="true" data-component="partition"><span class="submenu-item-icon">ğŸšª</span><div class="submenu-item-info"><div class="submenu-item-name">Partition</div><div class="submenu-item-size">3.0 Ã— 2.5m</div></div></div>
                    <div class="submenu-item" draggable="true" data-component="desk"><span class="submenu-item-icon">ğŸª‘</span><div class="submenu-item-info"><div class="submenu-item-name">Desk</div><div class="submenu-item-size">1.6 Ã— 0.8m</div></div></div>
                    <div class="submenu-item" draggable="true" data-component="pillar"><span class="submenu-item-icon">ğŸ›ï¸</span><div class="submenu-item-info"><div class="submenu-item-name">Pillar</div><div class="submenu-item-size">0.3 Ã— 0.3m</div></div></div>
                    <div class="submenu-item" draggable="true" data-component="office"><span class="submenu-item-icon">ğŸ¢</span><div class="submenu-item-info"><div class="submenu-item-name">Office</div><div class="submenu-item-size">12 Ã— 20m</div></div></div>
                </div>
            </div>
        </div>
        <div class="canvas-area">
            <div id="canvas-container"></div>
            <div class="drop-guide" id="drop-guide">ğŸ“¦ ë“œë¡­í•˜ì—¬ ìƒì„±!</div>
        </div>
        <div class="property-panel" id="property-panel">
            <div class="property-panel-content">
                <div class="property-panel-header">ğŸ“‹ ì†ì„±</div>
                <div class="property-panel-empty"><div class="property-panel-empty-icon">ğŸ‘†</div><div>ê°ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div>
            </div>
        </div>
    </div>

    <div class="align-popup" id="align-popup">
        <div class="align-popup-header">ğŸ“ ì •ë ¬ & íšŒì „</div>
        <div class="align-popup-section">
            <div class="align-popup-section-title">ì •ë ¬</div>
            <button class="align-popup-btn" id="align-left"><span class="icon">â¬…ï¸</span> ì¢Œì¸¡</button>
            <button class="align-popup-btn" id="align-right"><span class="icon">â¡ï¸</span> ìš°ì¸¡</button>
            <button class="align-popup-btn" id="align-top"><span class="icon">â¬†ï¸</span> ìƒë‹¨</button>
            <button class="align-popup-btn" id="align-bottom"><span class="icon">â¬‡ï¸</span> í•˜ë‹¨</button>
            <button class="align-popup-btn" id="align-center-h"><span class="icon">â†”ï¸</span> ìˆ˜í‰ì¤‘ì•™</button>
            <button class="align-popup-btn" id="align-center-v"><span class="icon">â†•ï¸</span> ìˆ˜ì§ì¤‘ì•™</button>
        </div>
        <div class="align-popup-section">
            <div class="align-popup-section-title">ë¶„ë°°</div>
            <button class="align-popup-btn" id="distribute-h"><span class="icon">â‡”</span> ìˆ˜í‰ë¶„ë°°</button>
            <button class="align-popup-btn" id="distribute-v"><span class="icon">â‡•</span> ìˆ˜ì§ë¶„ë°°</button>
        </div>
        <div class="align-popup-section">
            <div class="align-popup-section-title">íšŒì „</div>
            <button class="align-popup-btn" id="rotate-cw"><span class="icon">ğŸ”ƒ</span> 90Â° CW<span class="shortcut">R</span></button>
            <button class="align-popup-btn" id="rotate-ccw"><span class="icon">ğŸ”„</span> 90Â° CCW<span class="shortcut">â‡§R</span></button>
            <button class="align-popup-btn" id="rotate-reset"><span class="icon">â†©ï¸</span> ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- âœ… Phase 3: ìƒíƒœë°” ì „ì²´ ì—…ë°ì´íŠ¸ -->
    <div class="status-bar">
        <span class="status-item">ğŸ”§ <span id="status-tool">ì„ íƒ</span></span>
        <span class="status-item zoom-display">ğŸ” <span id="status-zoom">100%</span></span>
        <span class="status-item history">â†¶ <span id="status-undo">0</span> / â†· <span id="status-redo">0</span></span>
        <span class="status-item">Grid: <span id="status-grid">ON</span></span>
        <span class="status-item">Snap: <span id="status-snap">ON</span></span>
        <span class="status-item mice">ğŸª MICE: <span id="status-mice-snap">OFF</span></span>
        <span class="status-item guides">ğŸ“ Guides: <span id="status-smart-guides">ON</span></span>
        <span class="status-item">ğŸ“¦ <span id="status-objects">0</span></span>
        <span class="status-item">âš™ï¸ Eq: <span id="status-equipment">0</span></span>
        <span class="status-item groups">ğŸ“ Groups: <span id="status-groups">0</span></span>
        <span class="status-item">âœ… <span id="status-selected">0</span></span>
    </div>

    <!-- âœ… Phase 3: ë‹¨ì¶•í‚¤ ë„ì›€ë§ ì „ì²´ ì—…ë°ì´íŠ¸ -->
    <div class="shortcuts-help" id="shortcuts-help">
        <h4>âŒ¨ï¸ ë‹¨ì¶•í‚¤</h4>
        <ul>
            <li><kbd>V</kbd> ì„ íƒ</li>
            <li><kbd>W</kbd> ë²½</li>
            <li><kbd>C</kbd> ì»´í¬ë„ŒíŠ¸</li>
            <li><kbd>G</kbd> Grid</li>
            <li><kbd>S</kbd> Snap</li>
            <li><kbd>M</kbd> MICE Snap</li>
            <li><kbd>R</kbd> íšŒì „</li>
            <li><kbd>L</kbd> ì •ë ¬</li>
            <li><kbd>Del</kbd> ì‚­ì œ</li>
            <li><kbd>âŒ˜A</kbd> ì „ì²´ì„ íƒ</li>
            <li><kbd>âŒ˜Z</kbd> Undo</li>
            <li><kbd>âŒ˜Y</kbd> Redo</li>
            <li><kbd>âŒ˜D</kbd> ë³µì œ</li>
            <li><kbd>Esc</kbd> í•´ì œ</li>
        </ul>
        <div class="section-title">ğŸ¯ ì´ë™ (Phase 1)</div>
        <ul>
            <li><kbd>â†‘â†“â†â†’</kbd> 1px ì´ë™</li>
            <li><kbd>â‡§+ë°©í–¥</kbd> 10px ì´ë™</li>
        </ul>
        <div class="section-title">ğŸ“‹ Phase 2</div>
        <ul>
            <li><kbd>âŒ˜D</kbd> ë³µì œ (+20px)</li>
            <li><kbd>M</kbd> MICE Snap</li>
        </ul>
        <div class="section-title">ğŸ­ Phase 3</div>
        <ul>
            <li><kbd>A</kbd> Equipment Array</li>
            <li><kbd>âŒ˜G</kbd> ê·¸ë£¹í™”</li>
            <li><kbd>â‡§âŒ˜G</kbd> ê·¸ë£¹ í•´ì œ</li>
        </ul>
        <div class="section-title">âœ¨ Phase 4</div>
        <ul>
            <li><kbd>H</kbd> Smart Guides</li>
            <li><kbd>[</kbd> ë’¤ë¡œ ë³´ë‚´ê¸°</li>
            <li><kbd>]</kbd> ì•ìœ¼ë¡œ ë³´ë‚´ê¸°</li>
            <li><kbd>â‡§[</kbd> ë§¨ ë’¤ë¡œ</li>
            <li><kbd>â‡§]</kbd> ë§¨ ì•ìœ¼ë¡œ</li>
        </ul>
    </div>

    <div class="modal" id="room-size-modal">
        <div class="modal-content">
            <h2>ğŸ“ Room Size ì„¤ì •</h2>
            <div class="form-group"><label>Width (m)</label><input type="number" id="room-width" value="130" min="10" step="1"></div>
            <div class="form-group"><label>Depth (m)</label><input type="number" id="room-depth" value="90" min="10" step="1"></div>
            <div class="form-group"><label>Height (m)</label><input type="number" id="room-height" value="3" min="2" step="0.1"></div>
            <div class="modal-actions"><button class="btn-secondary" id="room-cancel">ì·¨ì†Œ</button><button class="btn-primary" id="room-apply">ì ìš©</button></div>
        </div>
    </div>

    <!-- âœ… Phase 3: Equipment Array ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal" id="eq-array-modal">
        <div class="modal-content" style="min-width: 400px;">
            <h2>ğŸ­ Equipment Array ì„¤ì •</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group">
                    <label>Rows (í–‰)</label>
                    <input type="number" id="eq-array-rows" value="6" min="1" max="20" step="1">
                </div>
                <div class="form-group">
                    <label>Cols (ì—´)</label>
                    <input type="number" id="eq-array-cols" value="26" min="1" max="50" step="1">
                </div>
                <div class="form-group">
                    <label>ì¥ë¹„ í­ (m)</label>
                    <input type="number" id="eq-array-width" value="1.5" min="0.5" max="5" step="0.1">
                </div>
                <div class="form-group">
                    <label>ì¥ë¹„ ê¹Šì´ (m)</label>
                    <input type="number" id="eq-array-depth" value="3.0" min="0.5" max="10" step="0.1">
                </div>
                <div class="form-group">
                    <label>ì¥ë¹„ ê°„ê²© (m)</label>
                    <input type="number" id="eq-array-spacing" value="0.3" min="0" max="2" step="0.1">
                </div>
                <div class="form-group">
                    <label>ë³µë„ ì—´ ìœ„ì¹˜</label>
                    <input type="text" id="eq-array-corridor-cols" value="13" placeholder="ì˜ˆ: 13 ë˜ëŠ” 10,20">
                </div>
                <div class="form-group">
                    <label>ë³µë„ ì—´ í­ (m)</label>
                    <input type="number" id="eq-array-corridor-col-width" value="3.0" min="1" max="10" step="0.5">
                </div>
                <div class="form-group">
                    <label>ë³µë„ í–‰ ìœ„ì¹˜</label>
                    <input type="text" id="eq-array-corridor-rows" value="3" placeholder="ì˜ˆ: 3 ë˜ëŠ” 2,4">
                </div>
                <div class="form-group">
                    <label>ë³µë„ í–‰ í­ (m)</label>
                    <input type="number" id="eq-array-corridor-row-width" value="2.0" min="1" max="10" step="0.5">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="eq-array-cancel">ì·¨ì†Œ</button>
                <button class="btn-primary" id="eq-array-apply">ìƒì„±</button>
            </div>
        </div>
    </div>

    <script>
        const COMPONENTS = {
            partition: { id: 'partition', name: 'Partition', width: 3.0, depth: 2.5, color: '#888888' },
            desk: { id: 'desk', name: 'Desk', width: 1.6, depth: 0.8, color: '#8B4513' },
            pillar: { id: 'pillar', name: 'Pillar', width: 0.3, depth: 0.3, color: '#333333' },
            office: { id: 'office', name: 'Office', width: 12.0, depth: 20.0, color: '#87CEEB' },
            equipment: { id: 'equipment', name: 'Equipment', width: 1.5, depth: 3.0, color: '#FF8C00' }
        };
        
        const rootStyles = getComputedStyle(document.documentElement);
        const TOOLBAR_WIDTH = parseInt(rootStyles.getPropertyValue('--toolbar-width')) || 60;
        const TOOLBAR_EXPANDED_WIDTH = parseInt(rootStyles.getPropertyValue('--toolbar-expanded-width')) || 270;
        const PROPERTY_PANEL_WIDTH = parseInt(rootStyles.getPropertyValue('--property-panel-width')) || 260;
        const HEADER_HEIGHT = parseInt(rootStyles.getPropertyValue('--header-height')) || 48;
        const STATUS_HEIGHT = parseInt(rootStyles.getPropertyValue('--status-height')) || 30;
        
        // =====================================================
        // âœ… ë¡œì»¬ Command í´ë˜ìŠ¤ë“¤ (ì™¸ë¶€ Command.jsì™€ ë¶„ë¦¬)
        // =====================================================
        
        // LocalCreateCommand: ê°ì²´ ìƒì„± ì‹œ ì‚¬ìš©
        class LocalCreateCommand {
            constructor(canvas, shape, layer) {
                this.canvas = canvas;
                this.shape = shape;
                this.layer = layer || canvas.layers.equipment;
                this.executed = false;
            }
            
            execute() {
                if (!this.executed) {
                    this.layer.add(this.shape);
                    this.layer.batchDraw();
                    this.executed = true;
                } else {
                    // Redo: ë‹¤ì‹œ ì¶”ê°€
                    this.layer.add(this.shape);
                    this.layer.batchDraw();
                }
            }
            
            undo() {
                this.shape.remove();
                this.layer.batchDraw();
                // ì„ íƒ í•´ì œ
                if (this.canvas.selectedObjects) {
                    const idx = this.canvas.selectedObjects.indexOf(this.shape);
                    if (idx > -1) this.canvas.selectedObjects.splice(idx, 1);
                }
            }
        }
        
        // LocalDeleteCommand: ê°ì²´ ì‚­ì œ ì‹œ ì‚¬ìš©
        class LocalDeleteCommand {
            constructor(canvas, shapes) {
                this.canvas = canvas;
                this.shapes = Array.isArray(shapes) ? [...shapes] : [shapes];
                this.shapeData = this.shapes.map(s => ({
                    shape: s,
                    layer: s.getLayer(),
                    parent: s.getParent()
                }));
            }
            
            execute() {
                this.shapes.forEach(shape => {
                    shape.remove();
                });
                if (this.canvas.selectedObjects) {
                    this.canvas.selectedObjects = [];
                }
                this.canvas.stage.batchDraw();
            }
            
            undo() {
                this.shapeData.forEach(data => {
                    if (data.layer) {
                        data.layer.add(data.shape);
                    }
                });
                this.canvas.stage.batchDraw();
            }
        }
        
        // LocalMoveCommand: ê°ì²´ ì´ë™ ì‹œ ì‚¬ìš©
        class LocalMoveCommand {
            constructor(shapes, dx, dy) {
                this.shapes = Array.isArray(shapes) ? shapes : [shapes];
                this.dx = dx;
                this.dy = dy;
            }
            
            execute() {
                this.shapes.forEach(shape => {
                    shape.x(shape.x() + this.dx);
                    shape.y(shape.y() + this.dy);
                });
                if (this.shapes[0]?.getLayer()) {
                    this.shapes[0].getLayer().batchDraw();
                }
            }
            
            undo() {
                this.shapes.forEach(shape => {
                    shape.x(shape.x() - this.dx);
                    shape.y(shape.y() - this.dy);
                });
                if (this.shapes[0]?.getLayer()) {
                    this.shapes[0].getLayer().batchDraw();
                }
            }
        }
        
        console.log('âœ… LocalCommand í´ë˜ìŠ¤ë“¤ ì •ì˜ ì™„ë£Œ (LocalCreateCommand, LocalDeleteCommand, LocalMoveCommand)');
        
        // =====================================================
        // âœ… ë¬´í•œ ê·¸ë¦¬ë“œë¥¼ ìœ„í•œ í™•ì¥ ZoomController
        // =====================================================
        class InfiniteGridZoomController extends ZoomController {
            constructor(editor, options = {}) {
                super(editor, options);
            }
            
            // âœ… ê·¸ë¦¬ë“œê°€ í•­ìƒ ë·°í¬íŠ¸ ì „ì²´ë¥¼ ì±„ìš°ë„ë¡ ì˜¤ë²„ë¼ì´ë“œ
            updateGrid() {
                if (!this.editor.layers?.background) return;
                
                this.editor.layers.background.destroyChildren();
                
                const stage = this.editor.stage;
                const stagePos = stage.position();
                const zoom = this.currentZoom;
                
                // ë·°í¬íŠ¸ í¬ê¸° ê³„ì‚° (ì—¬ìœ  ê³µê°„ ì¶”ê°€)
                const padding = 2000 / zoom;
                const viewWidth = (this.editor.config.width / zoom) + padding * 2;
                const viewHeight = (this.editor.config.height / zoom) + padding * 2;
                const startX = (-stagePos.x / zoom) - padding;
                const startY = (-stagePos.y / zoom) - padding;
                
                // ë°°ê²½
                const background = new Konva.Rect({
                    x: startX,
                    y: startY,
                    width: viewWidth,
                    height: viewHeight,
                    fill: '#f0f0f0',
                    listening: false
                });
                this.editor.layers.background.add(background);
                
                // ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸°
                if (this.editor.config.showGrid) {
                    const gridSize = this.editor.config.gridSize;
                    const majorInterval = 100;
                    
                    // ì‹œì‘ì ì„ ê·¸ë¦¬ë“œì— ë§ì¶¤
                    const gridStartX = Math.floor(startX / gridSize) * gridSize;
                    const gridStartY = Math.floor(startY / gridSize) * gridSize;
                    const gridEndX = startX + viewWidth;
                    const gridEndY = startY + viewHeight;
                    
                    // Minor grid lines
                    for (let x = gridStartX; x <= gridEndX; x += gridSize) {
                        const isMajor = Math.abs(x % majorInterval) < 0.1;
                        const line = new Konva.Line({
                            points: [x, startY, x, startY + viewHeight],
                            stroke: isMajor ? '#b0b0b0' : '#d8d8d8',
                            strokeWidth: isMajor ? 1 : 0.5,
                            listening: false
                        });
                        this.editor.layers.background.add(line);
                    }
                    
                    for (let y = gridStartY; y <= gridEndY; y += gridSize) {
                        const isMajor = Math.abs(y % majorInterval) < 0.1;
                        const line = new Konva.Line({
                            points: [startX, y, startX + viewWidth, y],
                            stroke: isMajor ? '#b0b0b0' : '#d8d8d8',
                            strokeWidth: isMajor ? 1 : 0.5,
                            listening: false
                        });
                        this.editor.layers.background.add(line);
                    }
                    
                    // ë¼ë²¨ (ì¤Œ ë ˆë²¨ì´ 0.3 ì´ìƒì¼ ë•Œë§Œ)
                    if (zoom >= 0.3) {
                        for (let x = gridStartX; x <= gridEndX; x += majorInterval) {
                            if (x === 0) continue;
                            const label = new Konva.Text({
                                x: x + 2,
                                y: startY + 5,
                                text: (x / 10).toFixed(0) + 'm',
                                fontSize: 10 / zoom,
                                fill: '#888888',
                                listening: false
                            });
                            this.editor.layers.background.add(label);
                        }
                        
                        for (let y = gridStartY; y <= gridEndY; y += majorInterval) {
                            if (y === 0) continue;
                            const label = new Konva.Text({
                                x: startX + 5,
                                y: y + 2,
                                text: (y / 10).toFixed(0) + 'm',
                                fontSize: 10 / zoom,
                                fill: '#888888',
                                listening: false
                            });
                            this.editor.layers.background.add(label);
                        }
                    }
                }
                
                this.editor.layers.background.batchDraw();
            }
            
            // âœ… Pan í›„ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
            handleWheel(e) {
                super.handleWheel(e);
                this.updateGrid();
            }
            
            setZoom(newZoom) {
                super.setZoom(newZoom);
                this.updateGrid();
            }
            
            zoomIn() {
                const oldZoom = this.currentZoom;
                const newZoom = Math.min(this.options.maxZoom, oldZoom + this.options.zoomStep);
                
                const pointer = this.editor.stage.getPointerPosition();
                if (!pointer) return;
                
                const mousePointTo = {
                    x: pointer.x / oldZoom - this.editor.stage.x() / oldZoom,
                    y: pointer.y / oldZoom - this.editor.stage.y() / oldZoom
                };
                
                this.setZoom(newZoom);
                
                this.editor.stage.position({
                    x: -(mousePointTo.x - pointer.x / newZoom) * newZoom,
                    y: -(mousePointTo.y - pointer.y / newZoom) * newZoom
                });
                
                this.updateGrid();
                this.editor.stage.batchDraw();
            }
            
            zoomOut() {
                const oldZoom = this.currentZoom;
                const newZoom = Math.max(this.options.minZoom, oldZoom - this.options.zoomStep);
                
                const pointer = this.editor.stage.getPointerPosition();
                if (!pointer) return;
                
                const mousePointTo = {
                    x: pointer.x / oldZoom - this.editor.stage.x() / oldZoom,
                    y: pointer.y / oldZoom - this.editor.stage.y() / oldZoom
                };
                
                this.setZoom(newZoom);
                
                this.editor.stage.position({
                    x: -(mousePointTo.x - pointer.x / newZoom) * newZoom,
                    y: -(mousePointTo.y - pointer.y / newZoom) * newZoom
                });
                
                this.updateGrid();
                this.editor.stage.batchDraw();
            }
        }
        
        // =====================================================
        // Main App - âœ… Phase 3: Equipment Array + ê·¸ë£¹í™”
        // =====================================================
        class LayoutEditorApp {
            constructor() {
                console.log('âœ… LayoutEditorApp ì´ˆê¸°í™” ì‹œì‘...');
                this.componentSubmenuVisible = false;
                this.alignPopupVisible = false;
                this.shortcutsHelpVisible = false;
                
                const canvasSize = this.calculateCanvasSize();
                
                if (typeof Canvas2DEditor === 'undefined') throw new Error('Canvas2DEditorê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                
                this.canvas = new Canvas2DEditor('canvas-container', { 
                    width: canvasSize.width, 
                    height: canvasSize.height, 
                    showGrid: true, 
                    snapToGrid: true, 
                    gridSize: 10 
                });
                
                // âœ… ë¬´í•œ ê·¸ë¦¬ë“œ ZoomController ì‚¬ìš©
                this.zoomController = new InfiniteGridZoomController(this.canvas, { 
                    minZoom: 0.1, 
                    maxZoom: 5.0, 
                    zoomStep: 0.1, 
                    wheelSensitivity: 0.001 
                });
                this.canvas.setZoomController(this.zoomController);
                this.zoomController.activate();
                
                // ì´ˆê¸° ê·¸ë¦¬ë“œ ë Œë”ë§
                this.zoomController.updateGrid();
                
                if (typeof ObjectSelectionTool !== 'undefined') { this.selectionTool = new ObjectSelectionTool(this.canvas); this.selectionTool.activate(); }
                if (typeof RoomSizeManager !== 'undefined') { this.roomSizeManager = new RoomSizeManager(this.canvas); }
                if (typeof WallDrawTool !== 'undefined') { 
                    this.wallDrawTool = new WallDrawTool(this.canvas); 
                    this.canvas.setWallDrawTool(this.wallDrawTool);
                }
                if (typeof EquipmentArrayTool !== 'undefined') { 
                    this.equipmentArrayTool = new EquipmentArrayTool(this.canvas);
                    this.canvas.equipmentArrayTool = this.equipmentArrayTool;
                }
                if (typeof PropertyPanel !== 'undefined') { this.propertyPanel = new PropertyPanel('property-panel', this.canvas); this.canvas.setPropertyPanel(this.propertyPanel); }
                if (typeof AlignmentTool !== 'undefined') { this.alignmentTool = new AlignmentTool(this.canvas); }
                
                // âœ… Phase 3: GroupingTool ì´ˆê¸°í™”
                if (typeof GroupingTool !== 'undefined') { 
                    this.groupingTool = new GroupingTool(this.canvas); 
                }
                
                // âœ… Phase 1: CommandManager ì´ˆê¸°í™”
                this.initCommandManager();
                
                this.enableDropZone();
                this.setupComponentSubmenu();
                this.setupEventListeners();
                this.bindToolbarButtons();
                this.currentTool = 'select';
                setInterval(() => this.updateStatus(), 500);
                
                document.getElementById('loading-indicator').style.display = 'none';
                console.log('âœ… Layout Editor ì´ˆê¸°í™” ì™„ë£Œ (Phase 4)');
                this.showToast('Layout Editor ì¤€ë¹„ ì™„ë£Œ! (Phase 4)', 'success');
            }
            
            // =====================================================
            // âœ… Phase 1: CommandManager ì´ˆê¸°í™”
            // =====================================================
            initCommandManager() {
                if (typeof CommandManager !== 'undefined') {
                    this.commandManager = new CommandManager({
                        maxHistory: 50,
                        onHistoryChange: (state) => {
                            // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
                            document.getElementById('btn-undo').disabled = !state.canUndo;
                            document.getElementById('btn-redo').disabled = !state.canRedo;
                            
                            // ìƒíƒœë°” ì—…ë°ì´íŠ¸
                            document.getElementById('status-undo').textContent = state.undoCount;
                            document.getElementById('status-redo').textContent = state.redoCount;
                        }
                    });
                    
                    // Canvas2DEditorì— CommandManager ì—°ê²°
                    this.canvas.commandManager = this.commandManager;
                    
                    console.log('âœ… CommandManager ì´ˆê¸°í™” ì™„ë£Œ');
                } else {
                    console.warn('âš ï¸ CommandManagerê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ - Undo/Redo ë¹„í™œì„±í™”');
                }
            }
            
            calculateCanvasSize() {
                const toolbarWidth = this.componentSubmenuVisible ? TOOLBAR_EXPANDED_WIDTH : TOOLBAR_WIDTH;
                return { 
                    width: window.innerWidth - toolbarWidth - PROPERTY_PANEL_WIDTH, 
                    height: window.innerHeight - HEADER_HEIGHT - STATUS_HEIGHT 
                };
            }
            
            // âœ… Phase 2 ë²„ê·¸ ìˆ˜ì •: resize() â†’ stage ì§ì ‘ ìˆ˜ì •
            updateCanvasSize() { 
                const size = this.calculateCanvasSize(); 
                if (this.canvas.stage) {
                    this.canvas.stage.width(size.width);
                    this.canvas.stage.height(size.height);
                    this.canvas.config.width = size.width;
                    this.canvas.config.height = size.height;
                }
                this.zoomController?.updateGrid?.(); 
            }
            
            bindToolbarButtons() {
                document.getElementById('btn-undo').addEventListener('click', () => this.undo());
                document.getElementById('btn-redo').addEventListener('click', () => this.redo());
                document.getElementById('btn-help').addEventListener('click', () => this.toggleShortcutsHelp());
                document.getElementById('btn-save').addEventListener('click', () => this.saveLayout());
                document.getElementById('btn-export-png').addEventListener('click', () => this.exportPNG());
                document.getElementById('tool-select').addEventListener('click', () => this.activateTool('select'));
                document.getElementById('tool-room').addEventListener('click', () => this.showRoomSizeModal());
                document.getElementById('tool-wall').addEventListener('click', () => this.activateTool('wall'));
                document.getElementById('component-btn').addEventListener('click', () => this.toggleComponentSubmenu());
                document.getElementById('tool-grid').addEventListener('click', () => this.toggleGrid());
                document.getElementById('tool-snap').addEventListener('click', () => this.toggleSnap());
                document.getElementById('tool-zoom-in').addEventListener('click', () => this.zoomIn());
                document.getElementById('tool-zoom-out').addEventListener('click', () => this.zoomOut());
                document.getElementById('tool-zoom-reset').addEventListener('click', () => this.resetZoom());
                document.getElementById('tool-select-all').addEventListener('click', () => this.selectAll());
                document.getElementById('tool-delete').addEventListener('click', () => this.deleteSelected());
                document.getElementById('tool-deselect').addEventListener('click', () => this.deselectAll());
                document.getElementById('align-btn').addEventListener('click', () => this.toggleAlignPopup());
                document.getElementById('tool-rotate').addEventListener('click', () => this.rotateCW());
                document.getElementById('tool-sample').addEventListener('click', () => this.loadSampleLayout());
                document.getElementById('align-left').addEventListener('click', () => this.alignLeft());
                document.getElementById('align-right').addEventListener('click', () => this.alignRight());
                document.getElementById('align-top').addEventListener('click', () => this.alignTop());
                document.getElementById('align-bottom').addEventListener('click', () => this.alignBottom());
                document.getElementById('align-center-h').addEventListener('click', () => this.alignCenterH());
                document.getElementById('align-center-v').addEventListener('click', () => this.alignCenterV());
                document.getElementById('distribute-h').addEventListener('click', () => this.distributeH());
                document.getElementById('distribute-v').addEventListener('click', () => this.distributeV());
                document.getElementById('rotate-cw').addEventListener('click', () => this.rotateCW());
                document.getElementById('rotate-ccw').addEventListener('click', () => this.rotateCCW());
                document.getElementById('rotate-reset').addEventListener('click', () => this.resetRotation());
                document.getElementById('room-cancel').addEventListener('click', () => this.closeRoomSizeModal());
                document.getElementById('room-apply').addEventListener('click', () => this.applyRoomSize());
                
                // âœ… Phase 3: Equipment Array + ê·¸ë£¹í™” ë²„íŠ¼
                document.getElementById('tool-eq-array').addEventListener('click', () => this.showEquipmentArrayModal());
                document.getElementById('tool-group').addEventListener('click', () => this.groupSelected());
                document.getElementById('tool-ungroup').addEventListener('click', () => this.ungroupSelected());
                document.getElementById('eq-array-cancel').addEventListener('click', () => this.closeEquipmentArrayModal());
                document.getElementById('eq-array-apply').addEventListener('click', () => this.applyEquipmentArray());
            }
            
            enableDropZone() {
                const container = this.canvas.stage.container();
                const dropGuide = document.getElementById('drop-guide');
                container.addEventListener('dragover', e => { e.preventDefault(); dropGuide.classList.add('visible'); });
                container.addEventListener('dragleave', () => dropGuide.classList.remove('visible'));
                container.addEventListener('drop', e => { e.preventDefault(); dropGuide.classList.remove('visible'); this.handleDrop(e); });
            }
            
            handleDrop(event) {
                const componentType = event.dataTransfer.getData('text/plain');
                const component = COMPONENTS[componentType];
                if (!component) return;
                const stage = this.canvas.stage;
                const rect = stage.container().getBoundingClientRect();
                const transform = stage.getAbsoluteTransform().copy();
                transform.invert();
                const pos = transform.point({ x: event.clientX - rect.left, y: event.clientY - rect.top });
                const shape = this.createComponent(component, pos.x, pos.y);
                if (shape) { this.canvas.selectObject(shape, false); this.selectionTool?.attachShapeEvents?.(shape); this.updateObjectCount(); this.showToast(`${component.name} ìƒì„±ë¨`, 'success'); }
            }
            
            createComponent(component, x, y) {
                const scale = this.canvas.config.scale || 10;
                const width = component.width * scale;
                const height = component.depth * scale;
                if (this.canvas.config.snapToGrid) { const gridSize = this.canvas.config.gridSize; x = Math.round(x / gridSize) * gridSize; y = Math.round(y / gridSize) * gridSize; }
                const id = `${component.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const group = new Konva.Group({ id, x, y, draggable: true, name: component.id + ' component' });
                const rect = new Konva.Rect({ x: -width / 2, y: -height / 2, width, height, fill: component.color, stroke: '#333', strokeWidth: 2, name: 'componentRect' });
                const arrowLength = Math.min(width, height) * 0.5;
                const arrow = new Konva.Arrow({ points: [0, height / 2 - 4, 0, height / 2 - 4 - arrowLength], pointerLength: 6, pointerWidth: 6, fill: '#ff4444', stroke: '#ff4444', strokeWidth: 2, name: 'directionArrow' });
                const dirLabel = new Konva.Text({ x: -12, y: height / 2 - arrowLength - 18, text: 'Front', fontSize: 9, fill: '#ff4444', fontStyle: 'bold', name: 'directionLabel' });
                group.add(rect); group.add(arrow); group.add(dirLabel);
                group.setAttr('componentType', component.id); group.setAttr('componentData', component); group.setAttr('currentRotation', 0);
                
                // âœ… Undo/Redo: ë“œë˜ê·¸ ì‹œì‘ ì‹œ ì´ˆê¸° ìœ„ì¹˜ ì €ì¥
                group.on('dragstart', () => { 
                    group._dragStartPos = { x: group.x(), y: group.y() }; 
                    console.log('ğŸ“ Drag Start:', group._dragStartPos);
                });
                
                // âœ… Undo/Redo: ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ LocalMoveCommand ë“±ë¡
                group.on('dragend', () => { 
                    const startPos = group._dragStartPos;
                    // Snap to grid
                    if (this.canvas.config.snapToGrid) { 
                        const gridSize = this.canvas.config.gridSize; 
                        group.x(Math.round(group.x() / gridSize) * gridSize); 
                        group.y(Math.round(group.y() / gridSize) * gridSize); 
                        group.getLayer()?.batchDraw(); 
                    }
                    // âœ… LocalMoveCommand ë“±ë¡ (Undo/Redo ì§€ì›)
                    if (startPos && this.commandManager) {
                        const dx = group.x() - startPos.x;
                        const dy = group.y() - startPos.y;
                        if (dx !== 0 || dy !== 0) {
                            // ì´ë¯¸ ì´ë™ëœ ìƒíƒœ -> ë˜ëŒë¦° í›„ Commandë¡œ ì¬ì‹¤í–‰
                            group.x(startPos.x);
                            group.y(startPos.y);
                            const moveCommand = new LocalMoveCommand([group], dx, dy);
                            this.commandManager.execute(moveCommand);
                            console.log('âœ… LocalMoveCommand ë“±ë¡:', { dx, dy });
                            this.updateStatus();
                        }
                    }
                    delete group._dragStartPos;
                });
                
                group.on('click tap', e => { e.cancelBubble = true; this.canvas.selectObject(group, e.evt.ctrlKey || e.evt.metaKey); });
                const layer = component.id === 'equipment' ? this.canvas.layers.equipment : this.canvas.layers.room;
                
                // âœ… LocalCreateCommandë¥¼ í†µí•´ ìƒì„± (Undo ê°€ëŠ¥)
                if (this.commandManager) {
                    const createCmd = new LocalCreateCommand(this.canvas, group, layer);
                    this.commandManager.execute(createCmd);
                    console.log('âœ… LocalCreateCommand ë“±ë¡:', id);
                } else {
                    // CommandManager ì—†ìœ¼ë©´ ì§ì ‘ ì¶”ê°€
                    layer.add(group); 
                    layer.batchDraw();
                }
                
                this.canvas.componentShapes?.set(id, group);
                return group;
            }
            
            setupComponentSubmenu() {
                document.querySelectorAll('.submenu-item').forEach(item => {
                    const componentType = item.dataset.component;
                    item.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', componentType); item.style.opacity = '0.5'; });
                    item.addEventListener('dragend', () => item.style.opacity = '1');
                    item.addEventListener('click', () => {
                        const component = COMPONENTS[componentType];
                        if (component) {
                            const stage = this.canvas.stage;
                            const centerX = (this.canvas.config.width / 2 - stage.x()) / stage.scaleX();
                            const centerY = (this.canvas.config.height / 2 - stage.y()) / stage.scaleY();
                            const shape = this.createComponent(component, centerX, centerY);
                            if (shape) { this.canvas.selectObject(shape, false); this.selectionTool?.attachShapeEvents?.(shape); this.updateObjectCount(); this.showToast(`${component.name} ìƒì„±ë¨`, 'success'); }
                        }
                    });
                });
            }
            
            toggleComponentSubmenu() {
                this.componentSubmenuVisible = !this.componentSubmenuVisible;
                document.getElementById('toolbar-container').classList.toggle('expanded', this.componentSubmenuVisible);
                document.getElementById('component-btn').classList.toggle('active', this.componentSubmenuVisible);
                if (this.componentSubmenuVisible && this.alignPopupVisible) this.hideAlignPopup();
                setTimeout(() => this.updateCanvasSize(), 350);
            }
            
            // =====================================================
            // âœ… Phase 3: í‚¤ë³´ë“œ ì´ë²¤íŠ¸ - ëª¨ë“  ë‹¨ì¶•í‚¤ í†µí•©
            // =====================================================
            setupEventListeners() {
                document.addEventListener('keydown', e => {
                    // Ctrl/Cmd í‚¤ ì¡°í•©
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); this.undo(); }
                        else if (e.key === 'y') { e.preventDefault(); this.redo(); }
                        else if (e.key === 'a') { e.preventDefault(); this.selectAll(); }
                        else if (e.key === 's') { e.preventDefault(); this.saveLayout(); }
                        // âœ… Phase 2: ë³µì œ (Ctrl+D)
                        else if (e.key === 'd') { e.preventDefault(); this.duplicateSelected(); }
                        // âœ… Phase 3: ê·¸ë£¹í™” (Ctrl+G / Ctrl+Shift+G)
                        else if (e.key === 'g' && e.shiftKey) { e.preventDefault(); this.ungroupSelected(); }
                        else if (e.key === 'g') { e.preventDefault(); this.groupSelected(); }
                        return;
                    }
                    
                    // âœ… Phase 1: Arrow Keys ì²˜ë¦¬
                    if (['arrowleft', 'arrowright', 'arrowup', 'arrowdown'].includes(e.key.toLowerCase())) {
                        e.preventDefault();
                        const step = e.shiftKey ? 10 : 1;  // Shift = 10px, ê¸°ë³¸ = 1px
                        this.moveSelected(e.key.toLowerCase(), step);
                        return;
                    }
                    
                    // ì¼ë°˜ ë‹¨ì¶•í‚¤
                    switch (e.key.toLowerCase()) {
                        case 'v': this.activateTool('select'); break;
                        case 'w': this.activateTool('wall'); break;
                        case 'c': this.toggleComponentSubmenu(); break;
                        case 'g': this.toggleGrid(); break;
                        case 's': this.toggleSnap(); break;
                        // âœ… Phase 2: MICE Snap í† ê¸€ (M)
                        case 'm': this.toggleMICESnap(); break;
                        // âœ… Phase 4: Smart Guides í† ê¸€ (H)
                        case 'h': this.toggleSmartGuides(); break;
                        case 'l': this.toggleAlignPopup(); break;
                        case 'r': e.preventDefault(); if (e.shiftKey) this.rotateCCW(); else this.rotateCW(); break;
                        case '=': case '+': this.zoomIn(); break;
                        case '-': case '_': this.zoomOut(); break;
                        case '0': this.resetZoom(); break;
                        case 'delete': case 'backspace': this.deleteSelected(); break;
                        // âœ… Phase 3: Equipment Array ë‹¨ì¶•í‚¤ (A)
                        case 'a': if (!e.ctrlKey && !e.metaKey) this.showEquipmentArrayModal(); break;
                        // âœ… Phase 4: ë ˆì´ì–´ ìˆœì„œ ([ / ])
                        case '[': e.shiftKey ? this.sendToBack() : this.sendBackward(); break;
                        case ']': e.shiftKey ? this.bringToFront() : this.bringForward(); break;
                        case 'escape': 
                            this.deselectAll(); 
                            if (this.componentSubmenuVisible) this.toggleComponentSubmenu(); 
                            if (this.alignPopupVisible) this.hideAlignPopup(); 
                            if (this.shortcutsHelpVisible) this.toggleShortcutsHelp(); 
                            break;
                        case '?': this.toggleShortcutsHelp(); break;
                    }
                });
                
                document.addEventListener('click', e => {
                    const toolbarContainer = document.getElementById('toolbar-container');
                    const alignPopup = document.getElementById('align-popup');
                    const alignBtn = document.getElementById('align-btn');
                    if (this.componentSubmenuVisible && !toolbarContainer.contains(e.target)) this.toggleComponentSubmenu();
                    if (this.alignPopupVisible && !alignPopup.contains(e.target) && !alignBtn.contains(e.target)) this.hideAlignPopup();
                });
                
                window.addEventListener('resize', () => this.updateCanvasSize());
            }
            
            // =====================================================
            // âœ… Phase 1: Arrow Keysë¡œ ì„ íƒ ê°ì²´ ì´ë™
            // =====================================================
            moveSelected(direction, step) {
                const selected = this.canvas.selectedObjects;
                if (!selected || selected.length === 0) {
                    return;  // ì„ íƒëœ ê°ì²´ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ
                }
                
                let dx = 0, dy = 0;
                switch(direction) {
                    case 'arrowleft':  dx = -step; break;
                    case 'arrowright': dx = step; break;
                    case 'arrowup':    dy = -step; break;
                    case 'arrowdown':  dy = step; break;
                }
                
                // âœ… LocalMoveCommand ì‚¬ìš© (Undo/Redo ì§€ì›)
                if (this.commandManager) {
                    const moveCommand = new LocalMoveCommand(selected, dx, dy);
                    this.commandManager.execute(moveCommand);
                    console.log('âœ… LocalMoveCommand (Arrow):', { dx, dy });
                    
                    // Transformer ìœ„ì¹˜ ê°±ì‹ 
                    if (this.canvas.transformer) {
                        this.canvas.transformer.forceUpdate();
                    }
                } else {
                    // CommandManager ì—†ìœ¼ë©´ ì§ì ‘ ì´ë™
                    selected.forEach(shape => {
                        shape.x(shape.x() + dx);
                        shape.y(shape.y() + dy);
                    });
                    this.canvas.stage.batchDraw();
                    
                    if (this.canvas.transformer) {
                        this.canvas.transformer.forceUpdate();
                    }
                }
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                this.updateStatus();
            }
            
            activateTool(toolName) {
                this.currentTool = toolName;
                if (toolName === 'select') this.wallDrawTool?.deactivate();
                else if (toolName === 'wall') this.wallDrawTool?.activate();
                document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
                if (toolName === 'select') document.getElementById('tool-select').classList.add('active');
                else if (toolName === 'wall') document.getElementById('tool-wall').classList.add('active');
                document.getElementById('status-tool').textContent = toolName === 'select' ? 'ì„ íƒ' : toolName === 'wall' ? 'ë²½ ê·¸ë¦¬ê¸°' : toolName;
                if (toolName === 'wall') this.showToast('ë²½ ê·¸ë¦¬ê¸° ëª¨ë“œ', 'info');
            }
            
            showRoomSizeModal() { document.getElementById('room-size-modal').classList.add('active'); }
            closeRoomSizeModal() { document.getElementById('room-size-modal').classList.remove('active'); }
            applyRoomSize() {
                const width = parseFloat(document.getElementById('room-width').value);
                const depth = parseFloat(document.getElementById('room-depth').value);
                const height = parseFloat(document.getElementById('room-height').value);
                if (width < 10 || depth < 10) { this.showToast('ìµœì†Œ 10m ì´ìƒ', 'error'); return; }
                this.roomSizeManager?.updateRoomSize(width, depth, height);
                this.closeRoomSizeModal();
                this.showToast(`Room: ${width}m Ã— ${depth}m`, 'success');
            }
            
            toggleGrid() { 
                this.canvas.toggleGrid(); 
                document.getElementById('status-grid').textContent = this.canvas.config.showGrid ? 'ON' : 'OFF'; 
                this.zoomController?.updateGrid?.();
            }
            toggleSnap() { const isOn = this.canvas.toggleSnapToGrid(); document.getElementById('status-snap').textContent = isOn ? 'ON' : 'OFF'; }
            
            // =====================================================
            // âœ… Phase 2: MICE Snap í† ê¸€
            // =====================================================
            toggleMICESnap() {
                if (this.canvas.snapManager?.miceSnapPoints) {
                    const miceSnap = this.canvas.snapManager.miceSnapPoints;
                    const isEnabled = miceSnap.toggle ? miceSnap.toggle() : !miceSnap.isEnabled;
                    if (!miceSnap.toggle) miceSnap.isEnabled = isEnabled;
                    document.getElementById('status-mice-snap').textContent = isEnabled ? 'ON' : 'OFF';
                    this.showToast(`ğŸª MICE Snap: ${isEnabled ? 'ON' : 'OFF'}`, 'info');
                } else {
                    this.showToast('MICESnapPoints ëª¨ë“ˆ ë¡œë“œ ì•ˆë¨', 'error');
                }
            }
            
            // =====================================================
            // âœ… Phase 4: Smart Guides í† ê¸€
            // =====================================================
            toggleSmartGuides() {
                const sgm = this.canvas.smartGuideManager;
                if (sgm) {
                    if (sgm.isEnabled()) {
                        sgm.disable();
                        document.getElementById('status-smart-guides').textContent = 'OFF';
                        this.showToast('ğŸ“ Smart Guides: OFF', 'info');
                    } else {
                        sgm.enable();
                        document.getElementById('status-smart-guides').textContent = 'ON';
                        this.showToast('ğŸ“ Smart Guides: ON', 'info');
                    }
                } else {
                    this.showToast('SmartGuideManager ë¡œë“œ ì•ˆë¨', 'error');
                }
            }
            
            // =====================================================
            // âœ… Phase 4: ë ˆì´ì–´ ìˆœì„œ ì¡°ì ˆ
            // =====================================================
            bringForward() {
                const selected = this.canvas.selectedObjects;
                if (!selected || selected.length === 0) { this.showToast('ì„ íƒëœ ê°ì²´ ì—†ìŒ', 'info'); return; }
                selected.forEach(shape => shape.moveUp());
                this.canvas.stage.batchDraw();
                this.showToast('â†‘ ì•ìœ¼ë¡œ', 'success');
            }
            
            sendBackward() {
                const selected = this.canvas.selectedObjects;
                if (!selected || selected.length === 0) { this.showToast('ì„ íƒëœ ê°ì²´ ì—†ìŒ', 'info'); return; }
                selected.forEach(shape => shape.moveDown());
                this.canvas.stage.batchDraw();
                this.showToast('â†“ ë’¤ë¡œ', 'success');
            }
            
            bringToFront() {
                const selected = this.canvas.selectedObjects;
                if (!selected || selected.length === 0) { this.showToast('ì„ íƒëœ ê°ì²´ ì—†ìŒ', 'info'); return; }
                selected.forEach(shape => shape.moveToTop());
                this.canvas.stage.batchDraw();
                this.showToast('â¬†ï¸ ë§¨ ì•ìœ¼ë¡œ', 'success');
            }
            
            sendToBack() {
                const selected = this.canvas.selectedObjects;
                if (!selected || selected.length === 0) { this.showToast('ì„ íƒëœ ê°ì²´ ì—†ìŒ', 'info'); return; }
                selected.forEach(shape => shape.moveToBottom());
                this.canvas.stage.batchDraw();
                this.showToast('â¬‡ï¸ ë§¨ ë’¤ë¡œ', 'success');
            }
            
            // =====================================================
            // âœ… Phase 4: Export PNG/SVG (Konva ë‚´ì¥ ê¸°ëŠ¥ í™œìš©)
            // =====================================================
            exportPNG() {
                try {
                    const dataURL = this.canvas.stage.toDataURL({ pixelRatio: 2, mimeType: 'image/png' });
                    const link = document.createElement('a');
                    link.href = dataURL;
                    link.download = `layout_${Date.now()}.png`;
                    link.click();
                    this.showToast('ğŸ–¼ï¸ PNG ì €ì¥ ì™„ë£Œ!', 'success');
                } catch (error) {
                    console.error('[Export PNG Error]', error);
                    this.showToast('PNG ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }
            
            exportSVG() {
                try {
                    // SVGëŠ” toDataURLë¡œ ì§ì ‘ ì§€ì›ë˜ì§€ ì•Šì•„ ê°„ë‹¨í•œ workaround
                    const dataURL = this.canvas.stage.toDataURL({ mimeType: 'image/png' });
                    // ì‹¤ì œ SVG ë³€í™˜ì€ canvg ë“± ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìš”
                    // ì—¬ê¸°ì„œëŠ” PNGë¡œ ëŒ€ì²´í•˜ê³  ì•ˆë‚´
                    const link = document.createElement('a');
                    link.href = dataURL;
                    link.download = `layout_${Date.now()}.png`;
                    link.click();
                    this.showToast('ğŸ“ ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ (SVGëŠ” ë³„ë„ ë³€í™˜ í•„ìš”)', 'info');
                } catch (error) {
                    console.error('[Export SVG Error]', error);
                    this.showToast('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
                }
            }
            
            zoomIn() { 
                this.zoomController?.zoomIn(); 
                this.zoomController?.updateGrid?.();
                this.updateZoomDisplay(); 
            }
            zoomOut() { 
                this.zoomController?.zoomOut(); 
                this.zoomController?.updateGrid?.();
                this.updateZoomDisplay(); 
            }
            resetZoom() { 
                this.zoomController?.resetZoom(); 
                this.zoomController?.updateGrid?.();
                this.updateZoomDisplay(); 
            }
            updateZoomDisplay() { const zoom = this.zoomController?.getZoom?.() || 1; document.getElementById('status-zoom').textContent = (zoom * 100).toFixed(0) + '%'; }
            
            deleteSelected() { 
                if (this.canvas.selectedObjects.length === 0) { 
                    this.showToast('ì„ íƒëœ ê°ì²´ ì—†ìŒ', 'info'); 
                    return; 
                } 
                const count = this.canvas.selectedObjects.length;
                const shapesToDelete = [...this.canvas.selectedObjects];
                
                // âœ… LocalDeleteCommandë¥¼ í†µí•´ ì‚­ì œ (Undo ê°€ëŠ¥)
                if (this.commandManager) {
                    const deleteCmd = new LocalDeleteCommand(this.canvas, shapesToDelete);
                    this.commandManager.execute(deleteCmd);
                    console.log('âœ… LocalDeleteCommand ë“±ë¡:', count, 'ê°œ');
                } else {
                    // CommandManager ì—†ìœ¼ë©´ ì§ì ‘ ì‚­ì œ
                    this.canvas.deleteSelected(); 
                }
                
                this.updateObjectCount();
                this.updateStatus();
                this.showToast(`${count}ê°œ ì‚­ì œë¨`); 
            }
            deselectAll() { this.canvas.deselectAll(); this.propertyPanel?.hide(); this.updateStatus(); }
            selectAll() { this.selectionTool?.selectAll(); this.updateStatus(); this.showToast(`${this.canvas.selectedObjects.length}ê°œ ì„ íƒë¨`, 'success'); }
            updateObjectCount() { setTimeout(() => { document.getElementById('status-objects').textContent = this.canvas.getObjectCount().total; }, 100); }
            
            // =====================================================
            // âœ… Phase 3: ìƒíƒœ ì—…ë°ì´íŠ¸ (ì „ì²´ í†µí•©)
            // =====================================================
            updateStatus() { 
                const objectCount = this.canvas.getObjectCount();
                document.getElementById('status-objects').textContent = objectCount.total; 
                document.getElementById('status-selected').textContent = this.canvas.selectedObjects.length; 
                this.updateZoomDisplay(); 
                document.getElementById('status-grid').textContent = this.canvas.config.showGrid ? 'ON' : 'OFF'; 
                document.getElementById('status-snap').textContent = this.canvas.config.snapToGrid ? 'ON' : 'OFF';
                
                // âœ… Phase 2: Equipment ì¹´ìš´íŠ¸
                document.getElementById('status-equipment').textContent = objectCount.equipment || objectCount.equipments || 0;
                
                // âœ… Phase 2: MICE Snap ìƒíƒœ
                if (this.canvas.snapManager?.miceSnapPoints) {
                    document.getElementById('status-mice-snap').textContent = this.canvas.snapManager.miceSnapPoints.isEnabled ? 'ON' : 'OFF';
                }
                
                // âœ… Phase 3: ê·¸ë£¹ ìˆ˜ í‘œì‹œ
                const groupCount = this.groupingTool?.getGroupCount?.() || 0;
                document.getElementById('status-groups').textContent = groupCount;
                
                // âœ… Phase 4: Smart Guides ìƒíƒœ
                if (this.canvas.smartGuideManager) {
                    document.getElementById('status-smart-guides').textContent = this.canvas.smartGuideManager.isEnabled?.() ? 'ON' : 'OFF';
                }
                
                // âœ… Phase 1: Undo/Redo ìƒíƒœ ì—…ë°ì´íŠ¸
                if (this.commandManager) {
                    const historySize = this.commandManager.getHistorySize();
                    document.getElementById('status-undo').textContent = historySize.undo;
                    document.getElementById('status-redo').textContent = historySize.redo;
                    // âœ… ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
                    document.getElementById('btn-undo').disabled = !this.commandManager.canUndo();
                    document.getElementById('btn-redo').disabled = !this.commandManager.canRedo();
                }
            }
            
            // =====================================================
            // âœ… Phase 1: Undo/Redo ì‹¤ì œ ì—°ë™
            // =====================================================
            undo() { 
                if (this.commandManager) {
                    if (this.commandManager.canUndo()) {
                        this.commandManager.undo();
                        this.updateStatus();
                        this.canvas.stage.batchDraw();
                        this.showToast('â†¶ Undo', 'info');
                    } else {
                        this.showToast('Undoí•  í•­ëª© ì—†ìŒ', 'info');
                    }
                } else {
                    this.showToast('CommandManager ë¡œë“œ ì•ˆë¨', 'error');
                }
            }
            
            redo() { 
                if (this.commandManager) {
                    if (this.commandManager.canRedo()) {
                        this.commandManager.redo();
                        this.updateStatus();
                        this.canvas.stage.batchDraw();
                        this.showToast('â†· Redo', 'info');
                    } else {
                        this.showToast('Redoí•  í•­ëª© ì—†ìŒ', 'info');
                    }
                } else {
                    this.showToast('CommandManager ë¡œë“œ ì•ˆë¨', 'error');
                }
            }
            
            // =====================================================
            // âœ… Phase 2: ë³µì œ ê¸°ëŠ¥ (Ctrl+D)
            // =====================================================
            duplicateSelected() {
                const selected = this.canvas.selectedObjects;
                if (!selected || selected.length === 0) {
                    this.showToast('ì„ íƒëœ ê°ì²´ ì—†ìŒ', 'info');
                    return;
                }
                
                const offset = 20;  // ë³µì œ ì‹œ ì˜¤í”„ì…‹ (px)
                const newShapes = [];
                
                selected.forEach(shape => {
                    const componentData = shape.getAttr('componentData');
                    const rotation = shape.rotation() || 0;
                    
                    if (componentData) {
                        const newShape = this.createComponent(componentData, shape.x() + offset, shape.y() + offset);
                        if (newShape) { newShape.rotation(rotation); newShapes.push(newShape); }
                    } else {
                        const clone = shape.clone({ x: shape.x() + offset, y: shape.y() + offset });
                        clone.id(`clone-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`);
                        const layer = shape.getLayer();
                        if (layer) { layer.add(clone); newShapes.push(clone); }
                    }
                });
                
                if (newShapes.length > 0) {
                    this.canvas.deselectAll();
                    newShapes.forEach((shape, i) => {
                        this.canvas.selectObject(shape, i > 0);
                        this.selectionTool?.attachShapeEvents?.(shape);
                    });
                    this.canvas.stage.batchDraw();
                    this.updateObjectCount();
                    this.showToast(`ğŸ“‹ ${newShapes.length}ê°œ ë³µì œë¨ (+${offset}px)`, 'success');
                }
            }
            
            // =====================================================
            // âœ… Phase 3: Equipment Array ëª¨ë‹¬
            // =====================================================
            showEquipmentArrayModal() { 
                document.getElementById('eq-array-modal').classList.add('active'); 
            }
            
            closeEquipmentArrayModal() { 
                document.getElementById('eq-array-modal').classList.remove('active'); 
            }
            
            applyEquipmentArray() {
                const rows = parseInt(document.getElementById('eq-array-rows').value) || 6;
                const cols = parseInt(document.getElementById('eq-array-cols').value) || 26;
                const width = parseFloat(document.getElementById('eq-array-width').value) || 1.5;
                const depth = parseFloat(document.getElementById('eq-array-depth').value) || 3.0;
                const spacing = parseFloat(document.getElementById('eq-array-spacing').value) || 0.3;
                
                // ë³µë„ ìœ„ì¹˜ íŒŒì‹± (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ìˆ«ìë“¤)
                const corridorColsStr = document.getElementById('eq-array-corridor-cols').value || '13';
                const corridorCols = corridorColsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                const corridorColWidth = parseFloat(document.getElementById('eq-array-corridor-col-width').value) || 3.0;
                
                const corridorRowsStr = document.getElementById('eq-array-corridor-rows').value || '3';
                const corridorRows = corridorRowsStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                const corridorRowWidth = parseFloat(document.getElementById('eq-array-corridor-row-width').value) || 2.0;
                
                const config = {
                    rows: rows,
                    cols: cols,
                    equipmentSize: { width: width, depth: depth },
                    spacing: spacing,
                    corridorCols: corridorCols,
                    corridorColWidth: corridorColWidth,
                    corridorRows: corridorRows,
                    corridorRowWidth: corridorRowWidth,
                    excludedPositions: []
                };
                
                console.log('[Phase 3] Equipment Array Config:', config);
                
                if (this.equipmentArrayTool) {
                    this.closeEquipmentArrayModal();
                    this.equipmentArrayTool.activate(config);
                    this.showToast(`í´ë¦­í•˜ì—¬ ${rows}Ã—${cols} ë°°ì—´ ì‹œì‘ì  ì§€ì •`, 'info');
                } else {
                    this.showToast('EquipmentArrayTool ë¡œë“œ ì•ˆë¨', 'error');
                }
            }
            
            // =====================================================
            // âœ… Phase 3: ê·¸ë£¹í™” ê¸°ëŠ¥
            // =====================================================
            groupSelected() {
                if (!this.groupingTool) {
                    this.showToast('GroupingTool ë¡œë“œ ì•ˆë¨', 'error');
                    return;
                }
                
                const group = this.groupingTool.groupSelected();
                if (group) {
                    this.showToast(`ğŸ“¦ ${group.getChildren().length}ê°œ ê°ì²´ ê·¸ë£¹í™”ë¨`, 'success');
                    this.updateStatus();
                } else {
                    this.showToast('2ê°œ ì´ìƒ ì„ íƒ í•„ìš”', 'info');
                }
            }
            
            ungroupSelected() {
                if (!this.groupingTool) {
                    this.showToast('GroupingTool ë¡œë“œ ì•ˆë¨', 'error');
                    return;
                }
                
                const objects = this.groupingTool.ungroupSelected();
                if (objects && objects.length > 0) {
                    this.showToast(`ğŸ“¤ ${objects.length}ê°œ ê°ì²´ ê·¸ë£¹ í•´ì œë¨`, 'success');
                    this.updateStatus();
                } else {
                    this.showToast('ê·¸ë£¹ì„ ì„ íƒí•˜ì„¸ìš”', 'info');
                }
            }
            
            saveLayout() { 
                const layout = this.canvas.getCurrentLayout(); 
                const blob = new Blob([JSON.stringify(layout, null, 2)], { type: 'application/json' }); 
                const link = document.createElement('a'); 
                link.href = URL.createObjectURL(blob); 
                link.download = 'layout_' + Date.now() + '.json'; 
                link.click(); 
                this.showToast('ì €ì¥ ì™„ë£Œ!', 'success'); 
            }
            
            loadSampleLayout() {
                this.canvas.loadLayout({ room: { width: 30, height: 20, walls: [], offices: [] }, equipment: [
                    { id: 'eq_1', x: 2, y: 5, width: 2, depth: 1.5, name: 'Equipment 1', rotation: 0 },
                    { id: 'eq_2', x: 5, y: 5, width: 2, depth: 1.5, name: 'Equipment 2', rotation: 0 },
                    { id: 'eq_3', x: 8, y: 5, width: 2, depth: 1.5, name: 'Equipment 3', rotation: 0 }
                ]});
                this.selectionTool?.attachEventListeners?.();
                this.updateObjectCount();
                this.showToast('ìƒ˜í”Œ ë¡œë“œ ì™„ë£Œ!', 'success');
            }
            
            toggleAlignPopup() {
                this.alignPopupVisible = !this.alignPopupVisible;
                const popup = document.getElementById('align-popup');
                const btn = document.getElementById('align-btn');
                if (this.alignPopupVisible) {
                    const btnRect = btn.getBoundingClientRect();
                    popup.style.top = `${btnRect.top}px`;
                    popup.style.left = `${btnRect.right + 5}px`;
                    if (this.componentSubmenuVisible) this.toggleComponentSubmenu();
                }
                popup.classList.toggle('show', this.alignPopupVisible);
                btn.classList.toggle('active', this.alignPopupVisible);
            }
            hideAlignPopup() { if (this.alignPopupVisible) { this.alignPopupVisible = false; document.getElementById('align-popup').classList.remove('show'); document.getElementById('align-btn').classList.remove('active'); } }
            
            alignLeft() { this.alignmentTool?.alignLeft(); this.hideAlignPopup(); }
            alignRight() { this.alignmentTool?.alignRight(); this.hideAlignPopup(); }
            alignTop() { this.alignmentTool?.alignTop(); this.hideAlignPopup(); }
            alignBottom() { this.alignmentTool?.alignBottom(); this.hideAlignPopup(); }
            alignCenterH() { this.alignmentTool?.alignCenterHorizontal(); this.hideAlignPopup(); }
            alignCenterV() { this.alignmentTool?.alignCenterVertical(); this.hideAlignPopup(); }
            distributeH() { this.alignmentTool?.distributeHorizontal(); this.hideAlignPopup(); }
            distributeV() { this.alignmentTool?.distributeVertical(); this.hideAlignPopup(); }
            rotateCW() { if (!this.alignmentTool) { this.showToast('AlignmentTool ì˜¤ë¥˜', 'error'); return; } this.alignmentTool.rotateCW(); }
            rotateCCW() { if (!this.alignmentTool) { this.showToast('AlignmentTool ì˜¤ë¥˜', 'error'); return; } this.alignmentTool.rotateCCW(); }
            resetRotation() { this.alignmentTool?.resetRotation(); this.hideAlignPopup(); }
            toggleShortcutsHelp() { this.shortcutsHelpVisible = !this.shortcutsHelpVisible; document.getElementById('shortcuts-help').classList.toggle('show', this.shortcutsHelpVisible); }
            showToast(message, type = 'info') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.style.animation = 'slideIn 0.3s reverse'; setTimeout(() => toast.remove(), 300); }, 2000); }
        }
        
        // âœ… Phase 3: ëª¨ë“  ëª¨ë“ˆ ë¡œë“œë¨ (GitHub)
        // - Command.js (MoveCommand, GroupCommand ë“±)
        // - CommandManager.js
        // - EquipmentArrayTool.js
        // - GroupingTool.js
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… DOM ë¡œë“œ ì™„ë£Œ');
            try { window.editorApp = new LayoutEditorApp(); }
            catch (error) { console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error); document.getElementById('loading-indicator').innerHTML = `<div style="color: red;">âŒ ë¡œë“œ ì‹¤íŒ¨</div><div style="margin-top: 10px; font-size: 12px;">${error.message}</div>`; }
        });
    </script>
</body>
</html>