<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Editor - SHERLOCK_SKY_3DSIM</title>
    
    <!-- Konva.js CDN -->
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    
    <!-- ‚úÖ Canvas2DEditor Î®ºÏ†Ä Î°úÎìú (Ï†ÑÏó≠ Í∞ùÏ≤¥) -->
    <script src="../src/layout_editor/components/Canvas2DEditor.js"></script>
    
    <!-- ‚úÖ ZoomController Î°úÎìú (Ï†ÑÏó≠ Í∞ùÏ≤¥) -->
    <script src="../src/layout_editor/controllers/ZoomController.js"></script>
    
    <!-- ‚úÖ ObjectSelectionTool Î°úÎìú (Ï†ÑÏó≠ Í∞ùÏ≤¥) -->
    <script src="../src/layout_editor/tools/ObjectSelectionTool.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../src/styles/layout_editor.css">
    <link rel="stylesheet" href="../src/styles/component-palette.css">
    
    <style>
        :root {
            --toolbar-width: 70px;
            --toolbar-expanded-width: 280px;
            --submenu-width: 210px;
            --property-panel-width: 280px;
            --header-height: 50px;
            --status-height: 32px;
            
            --canvas-equipment-default: #4a90e2;
            --canvas-equipment-selected: #FFD700;
            --canvas-equipment-hover: #3498db;
            --canvas-equipment-stroke: #2c3e50;
            --canvas-transformer-border: #667eea;
            --canvas-transformer-anchor-stroke: #667eea;
            --canvas-transformer-anchor-fill: #ffffff;
            --canvas-bg: #f5f5f5;
            --canvas-grid-minor: #d0d0d0;
            --canvas-grid-major: #a0a0a0;
            --canvas-grid-label: #999999;
            --canvas-selection-stroke: #667eea;
            --canvas-selection-fill: rgba(102, 126, 234, 0.1);
            --canvas-coord-bg: #667eea;
            --canvas-coord-text: #ffffff;
            --canvas-room-stroke: #666666;
            --canvas-wall-default: #888888;
            --canvas-office-fill: #d4e6f1;
            --canvas-office-stroke: #3498db;
            --canvas-partition: #aaaaaa;
            --canvas-text-primary: #212529;
            --canvas-text-secondary: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }
        
        /* Ìó§Îçî */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 200;
        }
        
        .header h1 {
            font-size: 18px;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #27ae60;
            color: white;
        }
        
        .btn-primary:hover {
            background: #229954;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Î©îÏù∏ Î†àÏù¥ÏïÑÏõÉ */
        .layout-container {
            display: flex;
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: var(--status-height);
        }
        
        /* ‚ú® Ìà¥Î∞î Ïª®ÌÖåÏù¥ÎÑà - ÏÑúÎ∏åÎ©îÎâ¥ Ìè¨Ìï® */
        .toolbar-container {
            width: var(--toolbar-width);
            display: flex;
            flex-shrink: 0;
            transition: width 0.3s ease;
            position: relative;
            z-index: 10;
        }
        
        .toolbar-container.expanded {
            width: var(--toolbar-expanded-width);
        }
        
        /* Ìà¥Î∞î */
        .toolbar {
            width: var(--toolbar-width);
            min-width: var(--toolbar-width);
            background: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Ìà¥Î∞î Î≤ÑÌäº */
        .toolbar-btn {
            width: 52px;
            height: 52px;
            margin: 4px 0;
            background: #34495e;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toolbar-btn:hover {
            background: #667eea;
            transform: scale(1.05);
        }
        
        .toolbar-btn.active {
            background: #667eea;
            box-shadow: 0 0 12px rgba(102, 126, 234, 0.6);
        }
        
        .toolbar-btn.zoom {
            background: #27ae60;
            font-size: 20px;
        }
        
        .toolbar-btn.zoom:hover {
            background: #229954;
        }
        
        .toolbar-btn.zoom.reset {
            background: #3498db;
        }
        
        .toolbar-btn.zoom.reset:hover {
            background: #2980b9;
        }
        
        .toolbar-btn.danger {
            background: #c0392b;
        }
        
        .toolbar-btn.danger:hover {
            background: #e74c3c;
        }
        
        /* Ìà¥ÌåÅ - ÏÑúÎ∏åÎ©îÎâ¥Í∞Ä Ïó¥Î†∏ÏùÑ ÎïåÎäî Ïà®ÍπÄ */
        .toolbar-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .toolbar-btn:hover::after {
            opacity: 1;
        }
        
        /* ÏÑúÎ∏åÎ©îÎâ¥ Ïó¥Î†∏ÏùÑ Îïå Ìà¥ÌåÅ Ïà®ÍπÄ */
        .toolbar-container.expanded .toolbar-btn::after {
            display: none;
        }
        
        .toolbar-divider {
            width: 40px;
            height: 2px;
            background: #4a5c6a;
            margin: 6px 0;
            flex-shrink: 0;
        }
        
        /* ‚ú® Component ÏÑúÎ∏åÎ©îÎâ¥ - Ìà¥Î∞î ÏòÜÏóê Î∂ôÏùå */
        .component-submenu {
            width: 0;
            background: white;
            overflow: hidden;
            transition: width 0.3s ease;
            box-shadow: 2px 0 15px rgba(0,0,0,0.15);
        }
        
        .toolbar-container.expanded .component-submenu {
            width: var(--submenu-width);
        }
        
        .submenu-content {
            width: var(--submenu-width);
            min-width: var(--submenu-width);
        }
        
        .submenu-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .submenu-item {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
            white-space: nowrap;
        }
        
        .submenu-item:hover {
            background: #f0f4ff;
        }
        
        .submenu-item:active {
            background: #667eea;
            color: white;
        }
        
        .submenu-item-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .submenu-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .submenu-item-name {
            font-weight: 600;
            font-size: 13px;
            color: #2c3e50;
        }
        
        .submenu-item-size {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        
        .submenu-item:active .submenu-item-name,
        .submenu-item:active .submenu-item-size {
            color: white;
        }
        
        /* Canvas ÏòÅÏó≠ */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
            min-width: 0;
        }
        
        #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* Drop Í∞ÄÏù¥Îìú */
        .drop-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1000;
            display: none;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .drop-guide.visible {
            display: block;
        }
        
        /* PropertyPanel ÏòÅÏó≠ */
        .property-panel {
            width: var(--property-panel-width);
            flex-shrink: 0;
            background: white;
            border-left: 2px solid #e0e0e0;
            overflow-y: auto;
        }
        
        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--status-height);
            background: #34495e;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 13px;
            gap: 20px;
            z-index: 100;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-item.zoom-display {
            background: #27ae60;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            min-width: 360px;
        }
        
        .modal-content h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .form-group {
            margin: 14px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 50px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            font-size: 13px;
        }
        
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        .toast.info { background: #3498db; }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Ïä§ÌÅ¨Î°§Î∞î */
        .toolbar::-webkit-scrollbar { width: 4px; }
        .toolbar::-webkit-scrollbar-track { background: #34495e; }
        .toolbar::-webkit-scrollbar-thumb { background: #667eea; border-radius: 2px; }
        
        .property-panel::-webkit-scrollbar,
        .component-submenu::-webkit-scrollbar { width: 6px; }
        .property-panel::-webkit-scrollbar-track,
        .component-submenu::-webkit-scrollbar-track { background: #f0f0f0; }
        .property-panel::-webkit-scrollbar-thumb,
        .component-submenu::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        
        /* Property Panel Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
        .property-panel-content { padding: 16px; }
        .property-panel-header {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        .property-panel-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: #999;
        }
        .property-panel-empty-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <!-- Ìó§Îçî -->
    <div class="header">
        <h1>üèóÔ∏è Layout Editor - SHERLOCK_SKY_3DSIM</h1>
        <div class="header-actions">
            <button class="header-btn btn-secondary" onclick="editorApp.undo()">‚Ü∂ Undo</button>
            <button class="header-btn btn-secondary" onclick="editorApp.redo()">‚Ü∑ Redo</button>
            <button class="header-btn btn-primary" onclick="editorApp.saveLayout()">üíæ Save</button>
        </div>
    </div>

    <div class="layout-container">
        <!-- ‚ú® Ìà¥Î∞î Ïª®ÌÖåÏù¥ÎÑà (Ìà¥Î∞î + ÏÑúÎ∏åÎ©îÎâ¥) -->
        <div class="toolbar-container" id="toolbar-container">
            <!-- Ìà¥Î∞î -->
            <div class="toolbar">
                <button class="toolbar-btn active" data-tooltip="ÏÑ†ÌÉù ÎèÑÍµ¨ (V)" onclick="editorApp.activateTool('select')">üëÜ</button>
                <button class="toolbar-btn" data-tooltip="Room Size ÏÑ§Ï†ï" onclick="editorApp.showRoomSizeModal()">üìê</button>
                <button class="toolbar-btn" data-tooltip="Î≤Ω Í∑∏Î¶¨Í∏∞ (W)" onclick="editorApp.activateTool('wall')">üß±</button>
                <button class="toolbar-btn" id="component-btn" data-tooltip="Ïª¥Ìè¨ÎÑåÌä∏ ÏÇΩÏûÖ (C)" onclick="editorApp.toggleComponentSubmenu()">üé®</button>
                
                <div class="toolbar-divider"></div>
                
                <button class="toolbar-btn" data-tooltip="Grid ÌÜ†Í∏Ä (G)" onclick="editorApp.toggleGrid()">üî≤</button>
                <button class="toolbar-btn" data-tooltip="Snap to Grid (S)" onclick="editorApp.toggleSnap()">üß≤</button>
                
                <div class="toolbar-divider"></div>
                
                <button class="toolbar-btn zoom" data-tooltip="Zoom In (+)" onclick="editorApp.zoomIn()">‚ûï</button>
                <button class="toolbar-btn zoom" data-tooltip="Zoom Out (-)" onclick="editorApp.zoomOut()">‚ûñ</button>
                <button class="toolbar-btn zoom reset" data-tooltip="Reset Zoom (R)" onclick="editorApp.resetZoom()">üéØ</button>
                
                <div class="toolbar-divider"></div>
                
                <button class="toolbar-btn" data-tooltip="Ï†ÑÏ≤¥ ÏÑ†ÌÉù (Ctrl+A)" onclick="editorApp.selectAll()">‚úÖ</button>
                <button class="toolbar-btn danger" data-tooltip="ÏÇ≠Ï†ú (Del)" onclick="editorApp.deleteSelected()">üóëÔ∏è</button>
                <button class="toolbar-btn" data-tooltip="ÏÑ†ÌÉù Ìï¥Ï†ú (Esc)" onclick="editorApp.deselectAll()">‚ùå</button>
                
                <div class="toolbar-divider"></div>
                
                <button class="toolbar-btn" data-tooltip="ÏÉòÌîå Î†àÏù¥ÏïÑÏõÉ" onclick="editorApp.loadSampleLayout()">üìÅ</button>
            </div>
            
            <!-- ‚ú® Component ÏÑúÎ∏åÎ©îÎâ¥ -->
            <div class="component-submenu" id="component-submenu">
                <div class="submenu-content">
                    <div class="submenu-header">üé® Components</div>
                    <div class="submenu-item" draggable="true" data-component="partition">
                        <span class="submenu-item-icon">üö™</span>
                        <div class="submenu-item-info">
                            <div class="submenu-item-name">Partition</div>
                            <div class="submenu-item-size">3.0 √ó 2.5m</div>
                        </div>
                    </div>
                    <div class="submenu-item" draggable="true" data-component="desk">
                        <span class="submenu-item-icon">ü™ë</span>
                        <div class="submenu-item-info">
                            <div class="submenu-item-name">Desk</div>
                            <div class="submenu-item-size">1.6 √ó 0.8m</div>
                        </div>
                    </div>
                    <div class="submenu-item" draggable="true" data-component="pillar">
                        <span class="submenu-item-icon">üèõÔ∏è</span>
                        <div class="submenu-item-info">
                            <div class="submenu-item-name">Pillar</div>
                            <div class="submenu-item-size">0.3 √ó 0.3m</div>
                        </div>
                    </div>
                    <div class="submenu-item" draggable="true" data-component="office">
                        <span class="submenu-item-icon">üè¢</span>
                        <div class="submenu-item-info">
                            <div class="submenu-item-name">Office</div>
                            <div class="submenu-item-size">12 √ó 20m</div>
                        </div>
                    </div>
                    <div class="submenu-item" draggable="true" data-component="equipment">
                        <span class="submenu-item-icon">‚öôÔ∏è</span>
                        <div class="submenu-item-info">
                            <div class="submenu-item-name">Equipment</div>
                            <div class="submenu-item-size">1.5 √ó 3.0m</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas ÏòÅÏó≠ -->
        <div class="canvas-area">
            <div id="canvas-container"></div>
            <div class="drop-guide" id="drop-guide">üì¶ Drop here to create!</div>
        </div>
        
        <!-- PropertyPanel -->
        <div class="property-panel" id="property-panel">
            <div class="property-panel-content">
                <div class="property-panel-header">ÏÜçÏÑ±</div>
                <div class="property-panel-empty">
                    <div class="property-panel-empty-icon">üëÜ</div>
                    <div>Í∞ùÏ≤¥Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
                    <div style="font-size: 11px; margin-top: 5px;">üí° CanvasÏóêÏÑú Í∞ùÏ≤¥Î•º ÌÅ¥Î¶≠</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span class="status-item">ÎèÑÍµ¨: <span id="status-tool">ÏÑ†ÌÉù</span></span>
        <span class="status-item zoom-display">Zoom: <span id="status-zoom">100%</span></span>
        <span class="status-item">Grid: <span id="status-grid">ON</span></span>
        <span class="status-item">Snap: <span id="status-snap">ON</span></span>
        <span class="status-item">Í∞ùÏ≤¥: <span id="status-objects">0</span></span>
        <span class="status-item">ÏÑ†ÌÉùÎê®: <span id="status-selected">0</span></span>
    </div>

    <!-- Room Size Modal -->
    <div class="modal" id="room-size-modal">
        <div class="modal-content">
            <h2>üìê Room Size ÏÑ§Ï†ï</h2>
            <div class="form-group">
                <label>Width (m)</label>
                <input type="number" id="room-width" value="130" min="10" step="1">
            </div>
            <div class="form-group">
                <label>Depth (m)</label>
                <input type="number" id="room-depth" value="90" min="10" step="1">
            </div>
            <div class="form-group">
                <label>Wall Height (m)</label>
                <input type="number" id="room-height" value="3" min="2" step="0.1">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="editorApp.closeRoomSizeModal()">Ï∑®ÏÜå</button>
                <button class="btn-primary" onclick="editorApp.applyRoomSize()">Ï†ÅÏö©</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { RoomSizeManager } from '../src/layout_editor/managers/RoomSizeManager.js';
        import { WallDrawTool } from '../src/layout_editor/tools/WallDrawTool.js';
        import { PropertyPanel } from '../src/layout_editor/components/PropertyPanel.js';
        
        const COMPONENTS = {
            partition: { id: 'partition', name: 'Partition', icon: 'üö™', width: 3.0, depth: 2.5, color: '#888888' },
            desk: { id: 'desk', name: 'Desk', icon: 'ü™ë', width: 1.6, depth: 0.8, color: '#8B4513' },
            pillar: { id: 'pillar', name: 'Pillar', icon: 'üèõÔ∏è', width: 0.3, depth: 0.3, color: '#333333' },
            office: { id: 'office', name: 'Office', icon: 'üè¢', width: 12.0, depth: 20.0, color: '#87CEEB' },
            equipment: { id: 'equipment', name: 'Equipment', icon: '‚öôÔ∏è', width: 1.5, depth: 3.0, color: '#FF8C00' }
        };
        
        // CSS Î≥ÄÏàòÏóêÏÑú Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
        const rootStyles = getComputedStyle(document.documentElement);
        const TOOLBAR_WIDTH = parseInt(rootStyles.getPropertyValue('--toolbar-width')) || 70;
        const TOOLBAR_EXPANDED_WIDTH = parseInt(rootStyles.getPropertyValue('--toolbar-expanded-width')) || 280;
        const PROPERTY_PANEL_WIDTH = parseInt(rootStyles.getPropertyValue('--property-panel-width')) || 280;
        const HEADER_HEIGHT = parseInt(rootStyles.getPropertyValue('--header-height')) || 50;
        const STATUS_HEIGHT = parseInt(rootStyles.getPropertyValue('--status-height')) || 32;
        
        class ZoomControllerExtended extends ZoomController {
            constructor(canvas2DEditor, options = {}) {
                super(canvas2DEditor, options);
            }
            
            updateGrid() {
                this.editor.layers.background.destroyChildren();
                
                const stage = this.editor.stage;
                const stagePos = stage.position();
                const zoom = this.currentZoom;
                
                const padding = 1000;
                const visibleWidth = (this.editor.config.width / zoom) + (padding * 2);
                const visibleHeight = (this.editor.config.height / zoom) + (padding * 2);
                const startX = (-stagePos.x / zoom) - padding;
                const startY = (-stagePos.y / zoom) - padding;
                
                const gridSize = this.getCurrentGridSize();
                const majorInterval = this.gridConfig.majorInterval;
                
                const background = new Konva.Rect({
                    x: startX, y: startY,
                    width: visibleWidth, height: visibleHeight,
                    fill: this.editor.config.backgroundColor
                });
                this.editor.layers.background.add(background);
                
                if (gridSize < 2) {
                    this.editor.layers.background.batchDraw();
                    return;
                }
                
                const gridStartX = Math.floor(startX / gridSize) * gridSize;
                const gridStartY = Math.floor(startY / gridSize) * gridSize;
                const gridEndX = startX + visibleWidth;
                const gridEndY = startY + visibleHeight;
                
                for (let i = gridStartX; i <= gridEndX; i += gridSize) {
                    const gridIndex = Math.round(i / gridSize);
                    const isMajor = (gridIndex % majorInterval) === 0;
                    this.editor.layers.background.add(new Konva.Line({
                        points: [i, gridStartY, i, gridEndY],
                        stroke: isMajor ? this.editor.config.gridMajorColor : this.editor.config.gridColor,
                        strokeWidth: isMajor ? 1 / zoom : 0.5 / zoom
                    }));
                    if (isMajor && i !== 0) {
                        const meters = Math.round((i / this.baseScale) * 10) / 10;
                        this.editor.layers.background.add(new Konva.Text({
                            x: i + 3 / zoom, y: gridStartY + 5 / zoom,
                            text: `${meters}m`, fontSize: 10 / zoom,
                            fill: this.editor.cssColors.gridLabel
                        }));
                    }
                }
                
                for (let i = gridStartY; i <= gridEndY; i += gridSize) {
                    const gridIndex = Math.round(i / gridSize);
                    const isMajor = (gridIndex % majorInterval) === 0;
                    this.editor.layers.background.add(new Konva.Line({
                        points: [gridStartX, i, gridEndX, i],
                        stroke: isMajor ? this.editor.config.gridMajorColor : this.editor.config.gridColor,
                        strokeWidth: isMajor ? 1 / zoom : 0.5 / zoom
                    }));
                    if (isMajor && i !== 0) {
                        const meters = Math.round((i / this.baseScale) * 10) / 10;
                        this.editor.layers.background.add(new Konva.Text({
                            x: gridStartX + 5 / zoom, y: i + 3 / zoom,
                            text: `${meters}m`, fontSize: 10 / zoom,
                            fill: this.editor.cssColors.gridLabel
                        }));
                    }
                }
                
                this.editor.layers.background.batchDraw();
            }
            
            onWheel(e) {
                e.preventDefault();
                const oldZoom = this.currentZoom;
                const delta = -e.deltaY * this.config.wheelSensitivity;
                let newZoom = Math.max(this.config.minZoom, Math.min(this.config.maxZoom, oldZoom + delta));
                if (newZoom === oldZoom) return;
                
                const pointer = this.editor.stage.getPointerPosition();
                const mousePointTo = {
                    x: pointer.x / oldZoom - this.editor.stage.x() / oldZoom,
                    y: pointer.y / oldZoom - this.editor.stage.y() / oldZoom
                };
                this.setZoom(newZoom);
                this.editor.stage.position({
                    x: -(mousePointTo.x - pointer.x / newZoom) * newZoom,
                    y: -(mousePointTo.y - pointer.y / newZoom) * newZoom
                });
                this.updateGrid();
                this.editor.stage.batchDraw();
            }
        }
        
        class WallDrawToolFixed extends WallDrawTool {
            constructor(canvas2DEditor) { super(canvas2DEditor); }
            
            // ‚úÖ Shift ÌÇ§Í∞Ä ÎàåÎ†∏ÏùÑ Îïå Î≤Ω Í∑∏Î¶¨Í∏∞ ÏãúÏûëÌïòÏßÄ ÏïäÏùå (Î∞ïÏä§ ÏÑ†ÌÉùÍ≥º Ï∂©Îèå Î∞©ÏßÄ)
            onMouseDown(e) {
                if (!this.isActive) return;
                
                // ‚úÖ Shift ÌÇ§Í∞Ä ÎàåÎ†∏ÏúºÎ©¥ Î≤Ω Í∑∏Î¶¨Í∏∞ ÏãúÏûëÌïòÏßÄ ÏïäÏùå (Î∞ïÏä§ ÏÑ†ÌÉùÍ≥º Ï∂©Îèå Î∞©ÏßÄ)
                if (e.evt && e.evt.shiftKey) {
                    console.log('[WallDrawToolFixed] Shift ÌÇ§ Í∞êÏßÄ - Î≤Ω Í∑∏Î¶¨Í∏∞ Í±¥ÎÑàÎúÄ (Î∞ïÏä§ ÏÑ†ÌÉù Î™®Îìú)');
                    return;
                }
                
                // Stage ÌÅ¥Î¶≠Ïù∏ÏßÄ ÌôïÏù∏ (Í∞ùÏ≤¥ ÌÅ¥Î¶≠ Ï†úÏô∏)
                if (e.target !== this.canvas.stage) {
                    return;
                }
                
                // ÏãúÏûëÏ†ê Í∏∞Î°ù
                const pos = this.getMousePos(e);
                this.startPoint = pos;
                this.isDrawing = true;
                
                console.log('[WallDrawToolFixed] Í∑∏Î¶¨Í∏∞ ÏãúÏûë:', pos);
                
                // ÏûÑÏãú ÎùºÏù∏ ÏÉùÏÑ± (Ï†êÏÑ†)
                this.tempLine = new Konva.Line({
                    points: [pos.x, pos.y, pos.x, pos.y],
                    stroke: '#667eea',
                    strokeWidth: 3,
                    dash: [10, 5],
                    lineCap: 'round',
                    listening: false
                });
                
                this.canvas.layers.ui.add(this.tempLine);
                this.canvas.layers.ui.batchDraw();
            }
            
            getMousePos(e) {
                const stage = this.canvas.stage;
                const pointer = stage.getPointerPosition();
                if (!pointer) return { x: 0, y: 0 };
                const transform = stage.getAbsoluteTransform().copy();
                transform.invert();
                return transform.point(pointer);
            }
        }
        
        class ObjectSelectionToolExtended extends ObjectSelectionTool {
            constructor(canvas2DEditor) { super(canvas2DEditor); }
            
            attachEventListeners() {
                const layers = [this.editor.layers.equipment, this.editor.layers.room];
                layers.forEach(layer => {
                    if (!layer) return;
                    layer.find('.equipment, .wall, .office, .partition, .desk, .pillar, .component').forEach(shape => {
                        if (shape.draggable()) this.attachShapeEvents(shape);
                    });
                });
            }
            
            onMouseUp(e) {
                if (!this.isSelecting) return;
                this.isSelecting = false;
                const box = this.selectionBox.getClientRect();
                if (!this.ctrlKeyPressed) this.editor.deselectAll();
                
                [this.editor.layers.equipment, this.editor.layers.room].forEach(layer => {
                    if (!layer) return;
                    layer.getChildren().forEach(shape => {
                        const name = shape.name();
                        if (['equipment', 'wall', 'office', 'partition', 'desk', 'pillar', 'component'].some(t => name?.includes(t))) {
                            if (this.haveIntersection(box, shape.getClientRect())) {
                                this.editor.selectObject(shape, true);
                            }
                        }
                    });
                });
                
                if (this.selectionBox) { this.selectionBox.destroy(); this.selectionBox = null; }
                if (this.selectionCountLabel) { this.selectionCountLabel.destroy(); this.selectionCountLabel = null; }
                this.editor.layers.ui.batchDraw();
                this.justFinishedBoxSelect = true;
                setTimeout(() => { this.editor._isBoxSelecting = false; this.justFinishedBoxSelect = false; }, 100);
            }
        }
        
        class LayoutEditorApp {
            constructor() {
                this.componentSubmenuVisible = false;
                
                // Ï¥àÍ∏∞ Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
                const canvasSize = this.calculateCanvasSize();
                
                this.canvas = new Canvas2DEditor('canvas-container', {
                    width: canvasSize.width,
                    height: canvasSize.height,
                    showGrid: true,
                    snapToGrid: true,
                    gridSize: 10
                });
                
                this.zoomController = new ZoomControllerExtended(this.canvas, {
                    minZoom: 0.2, maxZoom: 5.0, zoomStep: 0.1, wheelSensitivity: 0.001
                });
                this.canvas.setZoomController(this.zoomController);
                this.zoomController.activate();
                
                this.selectionTool = new ObjectSelectionToolExtended(this.canvas);
                this.selectionTool.activate();
                
                this.enableDropZone();
                
                this.roomSizeManager = new RoomSizeManager(this.canvas);
                this.wallDrawTool = new WallDrawToolFixed(this.canvas);
                this.propertyPanel = new PropertyPanel('property-panel', this.canvas);
                this.canvas.setPropertyPanel(this.propertyPanel);
                
                this.setupComponentSubmenu();
                this.currentTool = 'select';
                this.setupEventListeners();
                setInterval(() => this.updateStatus(), 500);
                this.showToast('Layout Editor Ï§ÄÎπÑ ÏôÑÎ£å!', 'success');
            }
            
            // ‚ú® Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Í≥ÑÏÇ∞ (ÏÑúÎ∏åÎ©îÎâ¥ ÏÉÅÌÉú Í≥†Î†§)
            calculateCanvasSize() {
                const toolbarWidth = this.componentSubmenuVisible ? TOOLBAR_EXPANDED_WIDTH : TOOLBAR_WIDTH;
                return {
                    width: window.innerWidth - toolbarWidth - PROPERTY_PANEL_WIDTH,
                    height: window.innerHeight - HEADER_HEIGHT - STATUS_HEIGHT
                };
            }
            
            // ‚ú® Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            updateCanvasSize() {
                const size = this.calculateCanvasSize();
                this.canvas.resize(size.width, size.height);
                this.zoomController?.updateGrid();
            }
            
            enableDropZone() {
                const container = this.canvas.stage.container();
                const dropGuide = document.getElementById('drop-guide');
                container.addEventListener('dragover', e => { e.preventDefault(); dropGuide.classList.add('visible'); });
                container.addEventListener('dragleave', () => dropGuide.classList.remove('visible'));
                container.addEventListener('drop', e => { e.preventDefault(); dropGuide.classList.remove('visible'); this.handleDrop(e); });
            }
            
            handleDrop(event) {
                const componentType = event.dataTransfer.getData('text/plain');
                const component = COMPONENTS[componentType];
                if (!component) return;
                
                const stage = this.canvas.stage;
                const rect = stage.container().getBoundingClientRect();
                const transform = stage.getAbsoluteTransform().copy();
                transform.invert();
                const pos = transform.point({ x: event.clientX - rect.left, y: event.clientY - rect.top });
                
                const shape = this.createComponent(component, pos.x, pos.y);
                if (shape) {
                    this.canvas.selectObject(shape, false);
                    this.selectionTool.attachShapeEvents(shape);
                    this.updateObjectCount();
                    this.showToast(`${component.name} ÏÉùÏÑ±Îê®`, 'success');
                }
            }
            
            createComponent(component, x, y) {
                const scale = this.canvas.config.scale;
                const width = component.width * scale;
                const height = component.depth * scale;
                
                if (this.canvas.config.snapToGrid) {
                    const gridSize = this.canvas.config.gridSize;
                    x = Math.round(x / gridSize) * gridSize;
                    y = Math.round(y / gridSize) * gridSize;
                }
                
                const id = `${component.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const rect = new Konva.Rect({
                    id, x: x - width / 2, y: y - height / 2,
                    width, height, fill: component.color,
                    stroke: '#333', strokeWidth: 2, draggable: true,
                    name: component.id + ' component'
                });
                
                rect.setAttr('componentType', component.id);
                rect.setAttr('componentData', component);
                rect.on('dragend', () => { if (this.canvas.config.snapToGrid) this.canvas.snapToGrid(rect); });
                rect.on('click tap', e => { e.cancelBubble = true; this.canvas.selectObject(rect, e.evt.ctrlKey || e.evt.metaKey); });
                
                const layer = component.id === 'equipment' ? this.canvas.layers.equipment : this.canvas.layers.room;
                layer.add(rect);
                layer.batchDraw();
                this.canvas.componentShapes.set(id, rect);
                return rect;
            }
            
            setupComponentSubmenu() {
                document.querySelectorAll('.submenu-item').forEach(item => {
                    const componentType = item.dataset.component;
                    item.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', componentType); item.style.opacity = '0.5'; });
                    item.addEventListener('dragend', () => item.style.opacity = '1');
                    item.addEventListener('click', () => {
                        const component = COMPONENTS[componentType];
                        if (component) {
                            const stage = this.canvas.stage;
                            const centerX = (this.canvas.config.width / 2 - stage.x()) / stage.scaleX();
                            const centerY = (this.canvas.config.height / 2 - stage.y()) / stage.scaleY();
                            const shape = this.createComponent(component, centerX, centerY);
                            if (shape) {
                                this.canvas.selectObject(shape, false);
                                this.selectionTool.attachShapeEvents(shape);
                                this.updateObjectCount();
                                this.showToast(`${component.name} ÏÉùÏÑ±Îê®`, 'success');
                            }
                        }
                    });
                });
            }
            
            // ‚ú® ÏÑúÎ∏åÎ©îÎâ¥ ÌÜ†Í∏Ä (Ìà¥Î∞î Ïª®ÌÖåÏù¥ÎÑà ÌôïÏû•/Ï∂ïÏÜå)
            toggleComponentSubmenu() {
                this.componentSubmenuVisible = !this.componentSubmenuVisible;
                const toolbarContainer = document.getElementById('toolbar-container');
                const btn = document.getElementById('component-btn');
                
                toolbarContainer.classList.toggle('expanded', this.componentSubmenuVisible);
                btn.classList.toggle('active', this.componentSubmenuVisible);
                
                // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ (transition ÌõÑ)
                setTimeout(() => this.updateCanvasSize(), 350);
            }
            
            setupEventListeners() {
                document.addEventListener('keydown', e => {
                    if (e.ctrlKey && e.key === 'z') { e.preventDefault(); this.undo(); }
                    else if (e.ctrlKey && e.key === 'y') { e.preventDefault(); this.redo(); }
                    else if (e.ctrlKey && e.key === 'a') { e.preventDefault(); this.selectAll(); }
                    else if ((e.key === 'v' || e.key === 'V') && !e.ctrlKey) this.activateTool('select');
                    else if (e.key === 'w' || e.key === 'W') this.activateTool('wall');
                    else if ((e.key === 'c' || e.key === 'C') && !e.ctrlKey) this.toggleComponentSubmenu();
                    else if (e.key === 'g' || e.key === 'G') this.toggleGrid();
                    else if ((e.key === 's' || e.key === 'S') && !e.ctrlKey) this.toggleSnap();
                    else if (e.key === '+' || e.key === '=') this.zoomIn();
                    else if (e.key === '-' || e.key === '_') this.zoomOut();
                    else if (e.key === 'r' || e.key === 'R') this.resetZoom();
                    else if (e.key === 'Delete' || e.key === 'Backspace') this.deleteSelected();
                    else if (e.key === 'Escape') { this.deselectAll(); if (this.componentSubmenuVisible) this.toggleComponentSubmenu(); }
                });
                
                window.addEventListener('resize', () => this.updateCanvasSize());
                
                // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú ÏÑúÎ∏åÎ©îÎâ¥ Îã´Í∏∞
                document.addEventListener('click', e => {
                    const toolbarContainer = document.getElementById('toolbar-container');
                    const btn = document.getElementById('component-btn');
                    if (this.componentSubmenuVisible && !toolbarContainer.contains(e.target)) {
                        this.toggleComponentSubmenu();
                    }
                });
            }
            
            activateTool(toolName) {
                this.currentTool = toolName;
                if (toolName === 'select') this.wallDrawTool.deactivate();
                else if (toolName === 'wall') this.wallDrawTool.activate();
                
                document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
                const toolButtons = { 'select': 0, 'wall': 2 };
                if (toolButtons[toolName] !== undefined) {
                    document.querySelectorAll('.toolbar-btn')[toolButtons[toolName]].classList.add('active');
                }
                document.getElementById('status-tool').textContent = toolName === 'select' ? 'ÏÑ†ÌÉù' : toolName === 'wall' ? 'Î≤Ω Í∑∏Î¶¨Í∏∞' : toolName;
                if (toolName === 'wall') this.showToast('Î≤Ω Í∑∏Î¶¨Í∏∞ Î™®Îìú', 'info');
            }
            
            showRoomSizeModal() { document.getElementById('room-size-modal').classList.add('active'); }
            closeRoomSizeModal() { document.getElementById('room-size-modal').classList.remove('active'); }
            applyRoomSize() {
                const width = parseFloat(document.getElementById('room-width').value);
                const depth = parseFloat(document.getElementById('room-depth').value);
                const height = parseFloat(document.getElementById('room-height').value);
                if (width < 10 || depth < 10) { this.showToast('ÏµúÏÜå 10m Ïù¥ÏÉÅ', 'error'); return; }
                this.roomSizeManager.updateRoomSize(width, depth, height);
                this.closeRoomSizeModal();
                this.showToast(`Room: ${width}m √ó ${depth}m`, 'success');
            }
            
            toggleGrid() {
                this.canvas.toggleGrid();
                document.getElementById('status-grid').textContent = this.canvas.config.showGrid ? 'ON' : 'OFF';
            }
            toggleSnap() {
                const isOn = this.canvas.toggleSnapToGrid();
                document.getElementById('status-snap').textContent = isOn ? 'ON' : 'OFF';
            }
            
            zoomIn() { this.zoomController.zoomIn(); this.updateZoomDisplay(); }
            zoomOut() { this.zoomController.zoomOut(); this.updateZoomDisplay(); }
            resetZoom() { this.zoomController.resetZoom(); this.updateZoomDisplay(); }
            updateZoomDisplay() { document.getElementById('status-zoom').textContent = (this.zoomController.getZoom() * 100).toFixed(0) + '%'; }
            
            deleteSelected() {
                if (this.canvas.selectedObjects.length === 0) { this.showToast('ÏÑ†ÌÉùÎêú Í∞ùÏ≤¥ ÏóÜÏùå', 'info'); return; }
                const count = this.canvas.selectedObjects.length;
                this.canvas.deleteSelected();
                this.updateObjectCount();
                this.showToast(`${count}Í∞ú ÏÇ≠Ï†úÎê®`);
            }
            
            deselectAll() { this.canvas.deselectAll(); this.propertyPanel.hide(); this.updateStatus(); }
            selectAll() { this.selectionTool?.selectAll(); this.updateStatus(); this.showToast(`${this.canvas.selectedObjects.length}Í∞ú ÏÑ†ÌÉùÎê®`, 'success'); }
            updateObjectCount() { setTimeout(() => document.getElementById('status-objects').textContent = this.canvas.getObjectCount().total, 100); }
            updateStatus() {
                document.getElementById('status-objects').textContent = this.canvas.getObjectCount().total;
                document.getElementById('status-selected').textContent = this.canvas.selectedObjects.length;
                this.updateZoomDisplay();
                document.getElementById('status-grid').textContent = this.canvas.config.showGrid ? 'ON' : 'OFF';
                document.getElementById('status-snap').textContent = this.canvas.config.snapToGrid ? 'ON' : 'OFF';
            }
            
            undo() { this.showToast('Undo Ï§ÄÎπÑ Ï§ë'); }
            redo() { this.showToast('Redo Ï§ÄÎπÑ Ï§ë'); }
            
            saveLayout() {
                const layout = this.canvas.getCurrentLayout();
                const blob = new Blob([JSON.stringify(layout, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'layout_' + Date.now() + '.json';
                link.click();
                this.showToast('Ï†ÄÏû• ÏôÑÎ£å!', 'success');
            }
            
            loadSampleLayout() {
                this.canvas.loadLayout({
                    room: { width: 30, height: 20, walls: [], offices: [] },
                    equipment: [
                        { id: 'eq_1', x: 2, y: 5, width: 2, depth: 1.5, name: 'Equipment 1', rotation: 0 },
                        { id: 'eq_2', x: 5, y: 5, width: 2, depth: 1.5, name: 'Equipment 2', rotation: 0 },
                        { id: 'eq_3', x: 8, y: 5, width: 2, depth: 1.5, name: 'Equipment 3', rotation: 0 },
                        { id: 'eq_4', x: 2, y: 8, width: 2, depth: 1.5, name: 'Equipment 4', rotation: 0 },
                        { id: 'eq_5', x: 5, y: 8, width: 2, depth: 1.5, name: 'Equipment 5', rotation: 0 },
                        { id: 'eq_6', x: 8, y: 8, width: 2, depth: 1.5, name: 'Equipment 6', rotation: 0 }
                    ]
                });
                this.selectionTool?.attachEventListeners();
                this.updateObjectCount();
                this.showToast('ÏÉòÌîå Î°úÎìú ÏôÑÎ£å!', 'success');
            }
            
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => { toast.style.animation = 'slideIn 0.3s reverse'; setTimeout(() => toast.remove(), 300); }, 2500);
            }
        }
        
        window.editorApp = new LayoutEditorApp();
    </script>
</body>
</html>