<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EquipmentEditButton í…ŒìŠ¤íŠ¸ - Step 1-3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e5e5e5;
            padding: 20px;
        }

        .test-container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #60a5fa;
        }

        .subtitle {
            text-align: center;
            color: #9ca3af;
            margin-bottom: 30px;
        }

        /* í…ŒìŠ¤íŠ¸ ì„¹ì…˜ */
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-section h2 {
            font-size: 16px;
            color: #60a5fa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ìƒíƒœ í‘œì‹œ íŒ¨ë„ */
        .status-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .status-card .label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .status-card .value.online {
            color: #22c55e;
        }

        .status-card .value.offline {
            color: #ef4444;
        }

        .status-card .value.checking {
            color: #f59e0b;
        }

        .status-card .value.enabled {
            color: #22c55e;
        }

        .status-card .value.disabled {
            color: #ef4444;
        }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            transform: translateY(-2px);
        }

        .control-btn.online {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .control-btn.offline {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .control-btn.toggle {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .control-btn.shortcut {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .control-btn.reset {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        /* ì‹¤ì œ Edit ë²„íŠ¼ (index.html ì‹œë®¬ë ˆì´ì…˜) */
        .edit-button-container {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-size: 20px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .floating-btn:hover:not(.eeb-disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .floating-btn.active {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .floating-btn.eeb-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .floating-btn .eeb-status-indicator {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }

        .floating-btn .eeb-status-indicator--online {
            background: #22c55e;
        }

        .floating-btn .eeb-status-indicator--offline {
            background: #ef4444;
        }

        .floating-btn .eeb-status-indicator--checking {
            background: #f59e0b;
        }

        @keyframes eeb-pulse-warning {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
        }

        .floating-btn.eeb-offline-warning {
            animation: eeb-pulse-warning 2s ease-in-out infinite;
        }

        .button-label {
            font-size: 14px;
            color: #9ca3af;
        }

        /* ë¡œê·¸ íŒ¨ë„ */
        .log-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .log-entry .time {
            color: #6b7280;
            white-space: nowrap;
        }

        .log-entry .message {
            flex: 1;
        }

        .log-entry.info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }

        .log-entry.success {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
        }

        .log-entry.warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid #f59e0b;
        }

        .log-entry.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }

        .clear-log-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #9ca3af;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-log-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: toast-in 0.3s ease;
            max-width: 350px;
        }

        @keyframes toast-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .toast.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        /* í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ */
        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checklist li .check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .checklist li.passed .check {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
        }

        .checklist li.failed .check {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }

        /* í‚¤ë³´ë“œ íŒíŠ¸ */
        .keyboard-hint {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 12px;
            color: #9ca3af;
        }

        .keyboard-hint kbd {
            padding: 2px 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            font-family: monospace;
            color: #60a5fa;
        }

        /* ìë™ í…ŒìŠ¤íŠ¸ ì§„í–‰ ë°” */
        .auto-test-progress {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 15px;
        }

        .auto-test-progress .bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª EquipmentEditButton í…ŒìŠ¤íŠ¸</h1>
        <p class="subtitle">Step 1-3: ConnectionStatusService ì—°ë™ í…ŒìŠ¤íŠ¸</p>

        <!-- ìƒíƒœ í‘œì‹œ -->
        <div class="test-section">
            <h2>ğŸ“Š í˜„ì¬ ìƒíƒœ</h2>
            <div class="status-panel">
                <div class="status-card">
                    <div class="label">Connection Status</div>
                    <div class="value" id="connectionStatus">--</div>
                </div>
                <div class="status-card">
                    <div class="label">Button Enabled</div>
                    <div class="value" id="buttonEnabled">--</div>
                </div>
                <div class="status-card">
                    <div class="label">Edit Mode Active</div>
                    <div class="value" id="editModeActive">--</div>
                </div>
            </div>
        </div>

        <!-- Mock ì»¨íŠ¸ë¡¤ -->
        <div class="test-section">
            <h2>ğŸ® Mock ì»¨íŠ¸ë¡¤</h2>
            <div class="control-panel">
                <button class="control-btn online" onclick="setMockOnline()">
                    ğŸŸ¢ Set Online
                </button>
                <button class="control-btn offline" onclick="setMockOffline()">
                    ğŸ”´ Set Offline
                </button>
                <button class="control-btn toggle" onclick="toggleMockStatus()">
                    ğŸ”„ Toggle Status
                </button>
                <button class="control-btn shortcut" onclick="simulateEKey()">
                    âŒ¨ï¸ Simulate 'E' Key
                </button>
                <button class="control-btn reset" onclick="resetTest()">
                    â†º Reset
                </button>
            </div>
            <div class="keyboard-hint">
                ğŸ’¡ ì‹¤ì œ <kbd>E</kbd> í‚¤ë¥¼ ëˆŒëŸ¬ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•©ë‹ˆë‹¤
            </div>
        </div>

        <!-- Edit ë²„íŠ¼ ì‹œë®¬ë ˆì´ì…˜ -->
        <div class="test-section">
            <h2>ğŸ–±ï¸ Edit ë²„íŠ¼ (index.html ì‹œë®¬ë ˆì´ì…˜)</h2>
            <div class="edit-button-container">
                <button id="editBtn" class="floating-btn" title="Equipment Edit Mode (E)">
                    âœï¸
                </button>
                <div class="button-label">
                    <strong>#editBtn</strong> - í´ë¦­í•˜ê±°ë‚˜ E í‚¤ë¥¼ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸
                </div>
            </div>
        </div>

        <!-- ìë™ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h2>ğŸ¤– ìë™ í…ŒìŠ¤íŠ¸</h2>
            <div class="control-panel">
                <button class="control-btn toggle" onclick="runAutoTest()">
                    â–¶ï¸ ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                </button>
            </div>
            <ul class="checklist" id="testChecklist">
                <li id="test1">
                    <span class="check"></span>
                    <span>Mock Online â†’ ë²„íŠ¼ í™œì„±í™”</span>
                </li>
                <li id="test2">
                    <span class="check"></span>
                    <span>Online ìƒíƒœì—ì„œ ë²„íŠ¼ í´ë¦­ â†’ Edit ëª¨ë“œ í† ê¸€</span>
                </li>
                <li id="test3">
                    <span class="check"></span>
                    <span>Mock Offline â†’ ë²„íŠ¼ ë¹„í™œì„±í™”</span>
                </li>
                <li id="test4">
                    <span class="check"></span>
                    <span>Offline ìƒíƒœì—ì„œ ë²„íŠ¼ í´ë¦­ â†’ ê²½ê³  ë©”ì‹œì§€</span>
                </li>
                <li id="test5">
                    <span class="check"></span>
                    <span>Offline ìƒíƒœì—ì„œ 'E' í‚¤ â†’ ê²½ê³  ë©”ì‹œì§€</span>
                </li>
                <li id="test6">
                    <span class="check"></span>
                    <span>ì‹¤ì‹œê°„ ìƒíƒœ ì „í™˜ (Online â†” Offline)</span>
                </li>
            </ul>
            <div class="auto-test-progress">
                <div class="bar" id="testProgressBar"></div>
            </div>
        </div>

        <!-- ë¡œê·¸ íŒ¨ë„ -->
        <div class="test-section">
            <h2>ğŸ“œ ì´ë²¤íŠ¸ ë¡œê·¸</h2>
            <div class="log-panel" id="logPanel">
                <!-- ë¡œê·¸ ì—”íŠ¸ë¦¬ë“¤ -->
            </div>
            <button class="clear-log-btn" onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        // =========================================================
        // Mock êµ¬í˜„ (ì‹¤ì œ ëª¨ë“ˆì„ ë¡œë“œí•˜ì§€ ì•Šê³  ë…ë¦½ í…ŒìŠ¤íŠ¸)
        // =========================================================

        // ê°„ë‹¨í•œ EventBus Mock
        class MockEventBus {
            constructor() {
                this._listeners = {};
            }

            on(event, callback) {
                if (!this._listeners[event]) {
                    this._listeners[event] = [];
                }
                this._listeners[event].push(callback);
                return () => this.off(event, callback);
            }

            off(event, callback) {
                if (this._listeners[event]) {
                    this._listeners[event] = this._listeners[event].filter(cb => cb !== callback);
                }
            }

            emit(event, data) {
                if (this._listeners[event]) {
                    this._listeners[event].forEach(cb => cb(data));
                }
            }
        }

        const eventBus = new MockEventBus();
        window.eventBus = eventBus;

        // ConnectionStatusService Mock
        class MockConnectionStatusService {
            constructor() {
                this._isOnline = true;
                this._state = 'online';
                this._listeners = {
                    online: [],
                    offline: [],
                    statusChanged: []
                };
            }

            static _instance = null;
            static getInstance() {
                if (!MockConnectionStatusService._instance) {
                    MockConnectionStatusService._instance = new MockConnectionStatusService();
                }
                return MockConnectionStatusService._instance;
            }

            isOnline() {
                return this._isOnline;
            }

            getState() {
                return this._state;
            }

            setOnline(online) {
                const wasOnline = this._isOnline;
                this._isOnline = online;
                this._state = online ? 'online' : 'offline';

                if (wasOnline !== online) {
                    const data = { isOnline: online, wasOnline, recoveredAfter: wasOnline ? 0 : 1 };
                    
                    if (online) {
                        this._listeners.online.forEach(cb => cb(data));
                    } else {
                        this._listeners.offline.forEach(cb => cb(data));
                    }
                    
                    this._listeners.statusChanged.forEach(cb => cb(data));
                }
            }

            onOnline(callback) {
                this._listeners.online.push(callback);
                return () => {
                    this._listeners.online = this._listeners.online.filter(cb => cb !== callback);
                };
            }

            onOffline(callback) {
                this._listeners.offline.push(callback);
                return () => {
                    this._listeners.offline = this._listeners.offline.filter(cb => cb !== callback);
                };
            }

            onStatusChanged(callback) {
                this._listeners.statusChanged.push(callback);
                return () => {
                    this._listeners.statusChanged = this._listeners.statusChanged.filter(cb => cb !== callback);
                };
            }

            configure() {}
            start() {}
            stop() {}
        }

        window.MockConnectionStatusService = MockConnectionStatusService;

        // Toast Mock
        const toast = {
            show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toastEl = document.createElement('div');
                toastEl.className = `toast ${type}`;
                toastEl.textContent = message;
                container.appendChild(toastEl);

                addLog(`Toast [${type}]: ${message}`, type);

                setTimeout(() => {
                    toastEl.style.animation = 'toast-in 0.3s ease reverse';
                    setTimeout(() => toastEl.remove(), 300);
                }, duration);
            },
            success(msg, duration) { this.show(msg, 'success', duration); },
            warning(msg, duration) { this.show(msg, 'warning', duration); },
            error(msg, duration) { this.show(msg, 'error', duration); },
            info(msg, duration) { this.show(msg, 'info', duration); }
        };

        window.toast = toast;

        // =========================================================
        // EquipmentEditButton (ì‹¤ì œ ì½”ë“œì™€ ë™ì¼í•œ ë¡œì§)
        // =========================================================

        class EquipmentEditButton {
            constructor(options = {}) {
                this._options = {
                    createButton: options.createButton ?? true,
                    buttonId: options.buttonId || 'editBtn',
                    onEditRequest: options.onEditRequest || null
                };

                this._element = null;
                this._statusIndicator = null;
                this._connectionService = MockConnectionStatusService.getInstance();
                this._isEnabled = false;
                this._isEditModeActive = false;
                this._unsubscribers = [];

                this._init();
            }

            _init() {
                this._injectStyles();
                
                if (!this._options.createButton) {
                    this._takeoverExistingButton();
                }

                this._bindEvents();
                this._updateButtonState();
            }

            _injectStyles() {
                // ìŠ¤íƒ€ì¼ì€ HTMLì— ì´ë¯¸ í¬í•¨ë¨
            }

            _takeoverExistingButton() {
                this._element = document.getElementById(this._options.buttonId);
                
                if (!this._element) {
                    addLog(`ê¸°ì¡´ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: #${this._options.buttonId}`, 'error');
                    return;
                }

                addLog(`ê¸°ì¡´ ë²„íŠ¼ ì¸ê³„: #${this._options.buttonId}`, 'info');
                this._addStatusIndicator();
                
                const computedStyle = window.getComputedStyle(this._element);
                if (computedStyle.position === 'static') {
                    this._element.style.position = 'relative';
                }
            }

            _addStatusIndicator() {
                if (!this._element) return;

                this._statusIndicator = this._element.querySelector('.eeb-status-indicator');
                
                if (!this._statusIndicator) {
                    this._statusIndicator = document.createElement('span');
                    this._statusIndicator.className = 'eeb-status-indicator';
                    this._element.appendChild(this._statusIndicator);
                }
            }

            _bindEvents() {
                const unsubOnline = this._connectionService.onOnline(() => {
                    this._onConnectionOnline();
                });
                this._unsubscribers.push(unsubOnline);

                const unsubOffline = this._connectionService.onOffline(() => {
                    this._onConnectionOffline();
                });
                this._unsubscribers.push(unsubOffline);

                const unsubStatusChanged = this._connectionService.onStatusChanged(() => {
                    this._updateButtonState();
                });
                this._unsubscribers.push(unsubStatusChanged);

                if (this._element) {
                    this._boundClickHandler = (e) => this._handleClick(e);
                    this._element.addEventListener('click', this._boundClickHandler, true);
                }

                const shortcutHandler = () => this._handleShortcut();
                eventBus.on('shortcut:equipmentEdit', shortcutHandler);
                this._unsubscribers.push(() => eventBus.off('shortcut:equipmentEdit', shortcutHandler));
            }

            _onConnectionOnline() {
                addLog('Backend ì—°ê²°ë¨ - ë²„íŠ¼ í™œì„±í™”', 'success');
                this._setEnabled(true);
                toast.success('Backend ì—°ê²°ë¨ - Equipment Edit ì‚¬ìš© ê°€ëŠ¥');
            }

            _onConnectionOffline() {
                addLog('Backend ì—°ê²° ëŠê¹€ - ë²„íŠ¼ ë¹„í™œì„±í™”', 'warning');
                this._setEnabled(false);
                
                if (this._isEditModeActive) {
                    toast.warning('âš ï¸ Backend ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
            }

            _handleClick(e) {
                addLog('ë²„íŠ¼ í´ë¦­ ê°ì§€', 'info');

                if (!this._isEnabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    this._showOfflineMessage();
                    return;
                }

                if (this._options.onEditRequest) {
                    e.preventDefault();
                    e.stopPropagation();
                    this._options.onEditRequest();
                }
            }

            _handleShortcut() {
                addLog("'E' í‚¤ ë‹¨ì¶•í‚¤ ê°ì§€", 'info');

                if (!this._isEnabled) {
                    this._showOfflineMessage();
                    return;
                }

                if (this._options.onEditRequest) {
                    this._options.onEditRequest();
                } else {
                    eventBus.emit('equipment:edit:toggle', {});
                }
            }

            _showOfflineMessage() {
                addLog('ì˜¤í”„ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ', 'warning');
                toast.warning('ğŸ”Œ Backend ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nEquipment Edit ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì„œë²„ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 4000);
                
                if (this._element) {
                    this._element.classList.add('eeb-offline-warning');
                    setTimeout(() => {
                        this._element.classList.remove('eeb-offline-warning');
                    }, 2000);
                }
            }

            _setEnabled(enabled) {
                this._isEnabled = enabled;
                this._updateButtonState();
            }

            _updateButtonState() {
                if (!this._element) return;

                const isOnline = this._connectionService.isOnline();
                this._isEnabled = isOnline;

                this._element.classList.toggle('eeb-disabled', !isOnline);

                if (this._statusIndicator) {
                    this._statusIndicator.className = 'eeb-status-indicator';
                    
                    const state = this._connectionService.getState();
                    if (state === 'checking') {
                        this._statusIndicator.classList.add('eeb-status-indicator--checking');
                    } else if (isOnline) {
                        this._statusIndicator.classList.add('eeb-status-indicator--online');
                    } else {
                        this._statusIndicator.classList.add('eeb-status-indicator--offline');
                    }
                }

                if (isOnline) {
                    this._element.title = 'Equipment Edit Mode (E)';
                } else {
                    this._element.title = 'âš ï¸ Backend ì—°ê²° í•„ìš” - Equipment Edit Mode (E)';
                }

                updateStatusDisplay();
            }

            setEditModeActive(active) {
                this._isEditModeActive = active;
                
                if (this._element) {
                    this._element.classList.toggle('active', active);
                }

                updateStatusDisplay();
            }

            isEnabled() {
                return this._isEnabled;
            }

            isEditModeActive() {
                return this._isEditModeActive;
            }

            triggerEdit() {
                if (this._isEnabled) {
                    if (this._options.onEditRequest) {
                        this._options.onEditRequest();
                    }
                    return true;
                } else {
                    this._showOfflineMessage();
                    return false;
                }
            }
        }

        // =========================================================
        // í…ŒìŠ¤íŠ¸ ë¡œì§
        // =========================================================

        let equipmentEditButton = null;
        let isEditModeActive = false;

        // Edit Mode í† ê¸€ í•¨ìˆ˜
        function toggleEditMode() {
            isEditModeActive = !isEditModeActive;
            equipmentEditButton.setEditModeActive(isEditModeActive);
            addLog(`Edit Mode ${isEditModeActive ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`, isEditModeActive ? 'success' : 'info');
            updateStatusDisplay();
        }

        // ì´ˆê¸°í™”
        function initialize() {
            addLog('í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹œì‘...', 'info');

            // EquipmentEditButton ìƒì„± (ê¸°ì¡´ ë²„íŠ¼ ì¸ê³„)
            equipmentEditButton = new EquipmentEditButton({
                createButton: false,
                buttonId: 'editBtn',
                onEditRequest: toggleEditMode
            });

            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'e' && 
                    e.target.tagName !== 'INPUT' && 
                    e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    eventBus.emit('shortcut:equipmentEdit', { key: 'e' });
                }
            });

            addLog('í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            updateStatusDisplay();
        }

        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatusDisplay() {
            const connectionService = MockConnectionStatusService.getInstance();
            
            // Connection Status
            const statusEl = document.getElementById('connectionStatus');
            const isOnline = connectionService.isOnline();
            statusEl.textContent = isOnline ? 'ONLINE' : 'OFFLINE';
            statusEl.className = `value ${isOnline ? 'online' : 'offline'}`;

            // Button Enabled
            const enabledEl = document.getElementById('buttonEnabled');
            const isEnabled = equipmentEditButton?.isEnabled() ?? false;
            enabledEl.textContent = isEnabled ? 'YES' : 'NO';
            enabledEl.className = `value ${isEnabled ? 'enabled' : 'disabled'}`;

            // Edit Mode Active
            const editModeEl = document.getElementById('editModeActive');
            editModeEl.textContent = isEditModeActive ? 'YES' : 'NO';
            editModeEl.className = `value ${isEditModeActive ? 'enabled' : 'disabled'}`;
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <span class="time">${time}</span>
                <span class="message">${message}</span>
            `;
            
            logPanel.insertBefore(entry, logPanel.firstChild);

            // ìµœëŒ€ 50ê°œ ë¡œê·¸ ìœ ì§€
            while (logPanel.children.length > 50) {
                logPanel.removeChild(logPanel.lastChild);
            }
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        window.clearLog = function() {
            document.getElementById('logPanel').innerHTML = '';
            addLog('ë¡œê·¸ ì´ˆê¸°í™”ë¨', 'info');
        };

        // Mock ìƒíƒœ ì„¤ì •
        window.setMockOnline = function() {
            addLog('Mock ìƒíƒœë¥¼ Onlineìœ¼ë¡œ ì„¤ì •', 'info');
            MockConnectionStatusService.getInstance().setOnline(true);
        };

        window.setMockOffline = function() {
            addLog('Mock ìƒíƒœë¥¼ Offlineìœ¼ë¡œ ì„¤ì •', 'info');
            MockConnectionStatusService.getInstance().setOnline(false);
        };

        window.toggleMockStatus = function() {
            const service = MockConnectionStatusService.getInstance();
            const newStatus = !service.isOnline();
            addLog(`Mock ìƒíƒœ í† ê¸€: ${newStatus ? 'Online' : 'Offline'}`, 'info');
            service.setOnline(newStatus);
        };

        window.simulateEKey = function() {
            addLog("'E' í‚¤ ì‹œë®¬ë ˆì´ì…˜", 'info');
            eventBus.emit('shortcut:equipmentEdit', { key: 'e' });
        };

        window.resetTest = function() {
            addLog('í…ŒìŠ¤íŠ¸ ë¦¬ì…‹', 'info');
            isEditModeActive = false;
            MockConnectionStatusService.getInstance().setOnline(true);
            equipmentEditButton.setEditModeActive(false);
            
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¦¬ì…‹
            document.querySelectorAll('.checklist li').forEach(li => {
                li.classList.remove('passed', 'failed');
            });
            document.getElementById('testProgressBar').style.width = '0%';
            
            updateStatusDisplay();
        };

        // ìë™ í…ŒìŠ¤íŠ¸
        window.runAutoTest = async function() {
            addLog('ğŸ¤– ìë™ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
            
            const tests = [
                { id: 'test1', name: 'Mock Online â†’ ë²„íŠ¼ í™œì„±í™”', fn: testOnlineEnabled },
                { id: 'test2', name: 'Online í´ë¦­ â†’ Edit ëª¨ë“œ í† ê¸€', fn: testOnlineClick },
                { id: 'test3', name: 'Mock Offline â†’ ë²„íŠ¼ ë¹„í™œì„±í™”', fn: testOfflineDisabled },
                { id: 'test4', name: 'Offline í´ë¦­ â†’ ê²½ê³ ', fn: testOfflineClick },
                { id: 'test5', name: "Offline 'E' í‚¤ â†’ ê²½ê³ ", fn: testOfflineEKey },
                { id: 'test6', name: 'ì‹¤ì‹œê°„ ìƒíƒœ ì „í™˜', fn: testRealTimeToggle }
            ];

            let passed = 0;
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                const progress = ((i + 1) / tests.length) * 100;
                document.getElementById('testProgressBar').style.width = `${progress}%`;
                
                await delay(500);
                
                try {
                    const result = await test.fn();
                    const li = document.getElementById(test.id);
                    
                    if (result) {
                        li.classList.add('passed');
                        li.querySelector('.check').textContent = 'âœ“';
                        addLog(`âœ… ${test.name} - PASSED`, 'success');
                        passed++;
                    } else {
                        li.classList.add('failed');
                        li.querySelector('.check').textContent = 'âœ—';
                        addLog(`âŒ ${test.name} - FAILED`, 'error');
                    }
                } catch (error) {
                    const li = document.getElementById(test.id);
                    li.classList.add('failed');
                    li.querySelector('.check').textContent = 'âœ—';
                    addLog(`âŒ ${test.name} - ERROR: ${error.message}`, 'error');
                }
                
                await delay(300);
            }

            addLog(`ğŸ ìë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${passed}/${tests.length} í†µê³¼`, passed === tests.length ? 'success' : 'warning');
        };

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë“¤
        async function testOnlineEnabled() {
            MockConnectionStatusService.getInstance().setOnline(true);
            await delay(100);
            return equipmentEditButton.isEnabled() === true;
        }

        async function testOnlineClick() {
            MockConnectionStatusService.getInstance().setOnline(true);
            isEditModeActive = false;
            equipmentEditButton.setEditModeActive(false);
            await delay(100);
            
            // ë²„íŠ¼ í´ë¦­ ì‹œë®¬ë ˆì´ì…˜
            document.getElementById('editBtn').click();
            await delay(100);
            
            return isEditModeActive === true;
        }

        async function testOfflineDisabled() {
            MockConnectionStatusService.getInstance().setOnline(false);
            await delay(100);
            return equipmentEditButton.isEnabled() === false;
        }

        async function testOfflineClick() {
            MockConnectionStatusService.getInstance().setOnline(false);
            await delay(100);
            
            const beforeActive = isEditModeActive;
            document.getElementById('editBtn').click();
            await delay(100);
            
            // ì˜¤í”„ë¼ì¸ì—ì„œëŠ” Edit ëª¨ë“œê°€ ë³€ê²½ë˜ì§€ ì•Šì•„ì•¼ í•¨
            return isEditModeActive === beforeActive;
        }

        async function testOfflineEKey() {
            MockConnectionStatusService.getInstance().setOnline(false);
            isEditModeActive = false;
            equipmentEditButton.setEditModeActive(false);
            await delay(100);
            
            eventBus.emit('shortcut:equipmentEdit', { key: 'e' });
            await delay(100);
            
            // ì˜¤í”„ë¼ì¸ì—ì„œëŠ” Edit ëª¨ë“œê°€ ë³€ê²½ë˜ì§€ ì•Šì•„ì•¼ í•¨
            return isEditModeActive === false;
        }

        async function testRealTimeToggle() {
            // Online â†’ Offline â†’ Online ì „í™˜ í…ŒìŠ¤íŠ¸
            MockConnectionStatusService.getInstance().setOnline(true);
            await delay(200);
            const step1 = equipmentEditButton.isEnabled() === true;
            
            MockConnectionStatusService.getInstance().setOnline(false);
            await delay(200);
            const step2 = equipmentEditButton.isEnabled() === false;
            
            MockConnectionStatusService.getInstance().setOnline(true);
            await delay(200);
            const step3 = equipmentEditButton.isEnabled() === true;
            
            return step1 && step2 && step3;
        }

        // ì´ˆê¸°í™” ì‹¤í–‰
        initialize();
    </script>
</body>
</html>