<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoSave System Test - Sherlock Sky 3DSim</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e5e5e5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #ffffff;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #9ca3af;
            margin-bottom: 30px;
        }

        /* Status Panel */
        .status-panel {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-panel h2 {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
        }

        .status-item-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .status-item-value {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .status-item-value.success { color: #22c55e; }
        .status-item-value.warning { color: #f59e0b; }
        .status-item-value.error { color: #ef4444; }
        .status-item-value.info { color: #3b82f6; }

        /* Control Panel */
        .control-panel {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-panel h2 {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group h3 {
            font-size: 14px;
            color: #d4d4d4;
            margin-bottom: 10px;
        }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #d4d4d4;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Event Log */
        .event-log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .event-log h2 {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-log-content {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #6b7280;
            flex-shrink: 0;
        }

        .log-type {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .log-type.started { background: #22c55e33; color: #86efac; }
        .log-type.stopped { background: #ef444433; color: #fca5a5; }
        .log-type.dirty { background: #f59e0b33; color: #fcd34d; }
        .log-type.saving { background: #3b82f633; color: #93c5fd; }
        .log-type.complete { background: #22c55e33; color: #86efac; }
        .log-type.error { background: #ef444433; color: #fca5a5; }
        .log-type.recovery { background: #8b5cf633; color: #c4b5fd; }

        .log-message {
            color: #d4d4d4;
            word-break: break-all;
        }

        /* Data Editor */
        .data-editor {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .data-editor h2 {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .editor-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .editor-field label {
            font-size: 12px;
            color: #9ca3af;
        }

        .editor-field input,
        .editor-field textarea {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            color: #ffffff;
            font-size: 14px;
        }

        .editor-field input:focus,
        .editor-field textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .editor-field textarea {
            min-height: 100px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-success {
            background: rgba(34, 197, 94, 0.9);
            color: white;
        }

        .toast-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
        }

        .toast-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        .toast-info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
        }

        /* Indicator Placeholder */
        .indicator-placeholder {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 9998;
        }

        /* Instructions */
        .instructions {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .instructions h2 {
            font-size: 16px;
            color: #93c5fd;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #d4d4d4;
            line-height: 1.8;
        }

        .instructions code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Timer Display */
        .timer-display {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            color: #3b82f6;
            font-family: monospace;
            margin: 20px 0;
        }

        /* Storage Info */
        .storage-info {
            font-size: 12px;
            color: #6b7280;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª AutoSave System Test</h1>
        <p class="subtitle">AutoSaveManager, AutoSaveIndicator, RecoveryDialog í†µí•© í…ŒìŠ¤íŠ¸</p>

        <!-- Instructions -->
        <div class="instructions">
            <h2>ğŸ“‹ í…ŒìŠ¤íŠ¸ ë°©ë²•</h2>
            <ol>
                <li><strong>ìë™ ì €ì¥ í…ŒìŠ¤íŠ¸:</strong> ë°ì´í„°ë¥¼ ë³€ê²½í•˜ê³  30ì´ˆ ëŒ€ê¸° ë˜ëŠ” 5íšŒ ë³€ê²½ í›„ ìë™ ì €ì¥ í™•ì¸</li>
                <li><strong>ìˆ˜ë™ ì €ì¥:</strong> ìš°ì¸¡ í•˜ë‹¨ AutoSave Indicatorì˜ "Save" ë²„íŠ¼ í´ë¦­</li>
                <li><strong>ë³µêµ¬ í…ŒìŠ¤íŠ¸:</strong> ë°ì´í„° ë³€ê²½ í›„ <code>Ctrl+Shift+R</code>ë¡œ ìƒˆë¡œê³ ì¹¨ â†’ ë³µêµ¬ ë‹¤ì´ì–¼ë¡œê·¸ í™•ì¸</li>
                <li><strong>ë¸Œë¼ìš°ì € ë‹«ê¸° í…ŒìŠ¤íŠ¸:</strong> ë°ì´í„° ë³€ê²½ í›„ íƒ­ ë‹«ê¸° â†’ ë‹¤ì‹œ ì—´ê¸° â†’ ë³µêµ¬ ë‹¤ì´ì–¼ë¡œê·¸ í™•ì¸</li>
            </ol>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <h2>ğŸ“Š í˜„ì¬ ìƒíƒœ</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-item-label">AutoSave ìƒíƒœ</div>
                    <div class="status-item-value" id="status-autosave">ëŒ€ê¸° ì¤‘</div>
                </div>
                <div class="status-item">
                    <div class="status-item-label">Dirty ìƒíƒœ</div>
                    <div class="status-item-value" id="status-dirty">Clean</div>
                </div>
                <div class="status-item">
                    <div class="status-item-label">ë³€ê²½ íšŸìˆ˜</div>
                    <div class="status-item-value info" id="status-changes">0</div>
                </div>
                <div class="status-item">
                    <div class="status-item-label">ë§ˆì§€ë§‰ ì €ì¥</div>
                    <div class="status-item-value" id="status-last-save">-</div>
                </div>
                <div class="status-item">
                    <div class="status-item-label">ë‹¤ìŒ ì €ì¥ê¹Œì§€</div>
                    <div class="status-item-value info" id="status-next-save">-</div>
                </div>
                <div class="status-item">
                    <div class="status-item-label">LocalStorage</div>
                    <div class="status-item-value" id="status-storage">-</div>
                </div>
            </div>
        </div>

        <!-- Timer Display -->
        <div class="timer-display" id="countdown-timer">30</div>

        <!-- Data Editor -->
        <div class="data-editor">
            <h2>âœï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° (í¸ì§‘í•˜ë©´ Dirty ìƒíƒœë¡œ ë³€ê²½)</h2>
            <div class="editor-grid">
                <div class="editor-field">
                    <label>ë£¸ ë„ˆë¹„</label>
                    <input type="number" id="room-width" value="3000" data-field="roomWidth">
                </div>
                <div class="editor-field">
                    <label>ë£¸ ë†’ì´</label>
                    <input type="number" id="room-height" value="1500" data-field="roomHeight">
                </div>
                <div class="editor-field">
                    <label>ì„¤ë¹„ ê°œìˆ˜</label>
                    <input type="number" id="equipment-count" value="117" data-field="equipmentCount">
                </div>
                <div class="editor-field">
                    <label>ì‚¬ì´íŠ¸ ID</label>
                    <input type="text" id="site-id" value="korea_site1" data-field="siteId">
                </div>
                <div class="editor-field" style="grid-column: span 2;">
                    <label>ë©”ëª¨ (ì—¬ëŸ¬ ì¤„)</label>
                    <textarea id="memo" data-field="memo">í…ŒìŠ¤íŠ¸ ë©”ëª¨ì…ë‹ˆë‹¤.
ìë™ ì €ì¥ì´ ì˜ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.</textarea>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h2>ğŸ® ì»¨íŠ¸ë¡¤</h2>
            
            <div class="control-group">
                <h3>AutoSave ê´€ë¦¬</h3>
                <div class="button-row">
                    <button class="btn btn-success" onclick="startAutoSave()">â–¶ï¸ ì‹œì‘</button>
                    <button class="btn btn-danger" onclick="stopAutoSave()">â¹ï¸ ì¤‘ì§€</button>
                    <button class="btn btn-primary" onclick="saveNow()">ğŸ’¾ ì¦‰ì‹œ ì €ì¥</button>
                    <button class="btn btn-warning" onclick="markDirty()">ğŸ“ Dirty í‘œì‹œ</button>
                </div>
            </div>

            <div class="control-group">
                <h3>ë³µêµ¬ í…ŒìŠ¤íŠ¸</h3>
                <div class="button-row">
                    <button class="btn btn-primary" onclick="showRecoveryDialog()">ğŸ”„ ë³µêµ¬ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ</button>
                    <button class="btn btn-secondary" onclick="checkRecoveryData()">ğŸ” ë³µêµ¬ ë°ì´í„° í™•ì¸</button>
                    <button class="btn btn-danger" onclick="clearAllAutoSave()">ğŸ—‘ï¸ ëª¨ë“  AutoSave ì‚­ì œ</button>
                </div>
            </div>

            <div class="control-group">
                <h3>ë””ë²„ê·¸</h3>
                <div class="button-row">
                    <button class="btn btn-secondary" onclick="printStorageStatus()">ğŸ“‹ Storage ìƒíƒœ ì¶œë ¥</button>
                    <button class="btn btn-secondary" onclick="printAutoSaveStatus()">ğŸ“‹ AutoSave ìƒíƒœ ì¶œë ¥</button>
                    <button class="btn btn-secondary" onclick="clearEventLog()">ğŸ§¹ ë¡œê·¸ ì§€ìš°ê¸°</button>
                </div>
            </div>
        </div>

        <!-- Event Log -->
        <div class="event-log">
            <h2>
                ğŸ“œ ì´ë²¤íŠ¸ ë¡œê·¸
                <span class="storage-info" id="log-count">0 entries</span>
            </h2>
            <div class="event-log-content" id="event-log">
                <div class="log-entry">
                    <span class="log-time">--:--:--</span>
                    <span class="log-type started">INIT</span>
                    <span class="log-message">ì´ë²¤íŠ¸ ë¡œê·¸ ì‹œì‘...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Indicator Placeholder -->
    <div class="indicator-placeholder" id="indicator-container"></div>

    <!-- ES6 Module Script -->
    <script type="module">
        // =================================================================
        // Imports
        // =================================================================
        import { eventBus } from '../src/core/managers/EventBus.js';
        import { storageService } from '../src/core/storage/index.js';
        import AutoSaveIndicator from '../src/ui/AutoSaveIndicator.js';
        import RecoveryDialog from '../src/ui/RecoveryDialog.js';

        // =================================================================
        // ì „ì—­ ë³€ìˆ˜
        // =================================================================
        let autoSaveInstance = null;
        let countdownInterval = null;
        let lastSaveTime = null;
        const NAMESPACE = 'layout';
        const SITE_ID = 'test_site';
        const AUTOSAVE_INTERVAL = 30000; // 30ì´ˆ
        const CHANGE_THRESHOLD = 5;

        // =================================================================
        // í…ŒìŠ¤íŠ¸ ë°ì´í„°
        // =================================================================
        const testData = {
            roomConfig: {
                width: 3000,
                height: 1500
            },
            equipmentCount: 117,
            siteId: 'korea_site1',
            memo: 'í…ŒìŠ¤íŠ¸ ë©”ëª¨ì…ë‹ˆë‹¤.\nìë™ ì €ì¥ì´ ì˜ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.',
            objects: [],
            walls: []
        };

        // =================================================================
        // ë°ì´í„° Getter
        // =================================================================
        function getData() {
            return {
                roomConfig: {
                    width: parseInt(document.getElementById('room-width').value) || 3000,
                    height: parseInt(document.getElementById('room-height').value) || 1500
                },
                equipmentCount: parseInt(document.getElementById('equipment-count').value) || 117,
                siteId: document.getElementById('site-id').value || 'test_site',
                memo: document.getElementById('memo').value || '',
                savedTimestamp: new Date().toISOString()
            };
        }

        // =================================================================
        // AutoSave ì´ˆê¸°í™”
        // =================================================================
        function initAutoSave() {
            // AutoSave ë“±ë¡
            autoSaveInstance = storageService.autoSave.register(NAMESPACE, SITE_ID, {
                getData: getData,
                intervalMs: AUTOSAVE_INTERVAL,
                changeThreshold: CHANGE_THRESHOLD,
                onSave: (data) => {
                    lastSaveTime = new Date();
                    showToast('ğŸ’¾ ìë™ ì €ì¥ ì™„ë£Œ!', 'success');
                    updateStatus();
                },
                onError: (error) => {
                    showToast('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
                }
            });

            log('started', `AutoSave ë“±ë¡ ì™„ë£Œ - interval: ${AUTOSAVE_INTERVAL/1000}ì´ˆ, threshold: ${CHANGE_THRESHOLD}íšŒ`);
        }

        // =================================================================
        // AutoSave Indicator ì´ˆê¸°í™”
        // =================================================================
        function initIndicator() {
            const indicator = new AutoSaveIndicator({
                container: '#indicator-container',
                position: 'custom',
                namespace: NAMESPACE,
                showSaveButton: true,
                showTooltip: true,
                onManualSave: () => {
                    saveNow();
                }
            });

            log('started', 'AutoSaveIndicator ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // =================================================================
        // ì´ë²¤íŠ¸ êµ¬ë…
        // =================================================================
        function setupEventListeners() {
            // AutoSave ì´ë²¤íŠ¸ êµ¬ë…
            eventBus.on('autosave:started', (data) => {
                log('started', `AutoSave ì‹œì‘ - ${data.namespace}/${data.identifier}`);
                updateStatus();
                startCountdown();
            });

            eventBus.on('autosave:stopped', (data) => {
                log('stopped', `AutoSave ì¤‘ì§€ - ${data.namespace}/${data.identifier}`);
                updateStatus();
                stopCountdown();
            });

            eventBus.on('autosave:dirty', (data) => {
                log('dirty', `Dirty ìƒíƒœ ë³€ê²½ - isDirty: ${data.isDirty}, count: ${data.changeCount}`);
                updateStatus();
            });

            eventBus.on('autosave:saving', (data) => {
                log('saving', `ì €ì¥ ì‹œì‘ - trigger: ${data.trigger}`);
                updateStatus();
            });

            eventBus.on('autosave:complete', (data) => {
                log('complete', `ì €ì¥ ì™„ë£Œ - ${data.timestamp}`);
                lastSaveTime = new Date(data.timestamp);
                updateStatus();
                resetCountdown();
            });

            eventBus.on('autosave:error', (data) => {
                log('error', `ì €ì¥ ì‹¤íŒ¨ - ${data.error}`);
                updateStatus();
            });

            eventBus.on('autosave:recovery', (data) => {
                log('recovery', `ë³µêµ¬ ë°ì´í„° ë°œê²¬ - ${data.namespace}/${data.identifier}`);
            });

            // ìˆ˜ë™ ì €ì¥ ìš”ì²­ ì´ë²¤íŠ¸
            eventBus.on('autosave:manual-save-requested', (data) => {
                log('saving', `ìˆ˜ë™ ì €ì¥ ìš”ì²­ - ${data.namespace}`);
                if (autoSaveInstance) {
                    autoSaveInstance.saveNow('manual');
                }
            });

            // Recovery ì´ë²¤íŠ¸
            eventBus.on('recovery:recover-requested', (data) => {
                log('recovery', `ë³µêµ¬ ìš”ì²­ - ${data.items.length}ê°œ í•­ëª©`);
                data.items.forEach(item => {
                    applyRecoveryData(item);
                });
            });

            eventBus.on('recovery:discard-completed', (data) => {
                log('stopped', `ë³µêµ¬ ë°ì´í„° ì‚­ì œ - ${data.items.length}ê°œ í•­ëª©`);
            });

            // ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
            document.querySelectorAll('[data-field]').forEach(input => {
                input.addEventListener('input', () => {
                    if (autoSaveInstance) {
                        autoSaveInstance.markDirty();
                    }
                });
            });

            log('started', 'ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
        }

        // =================================================================
        // ë³µêµ¬ ë°ì´í„° ì ìš©
        // =================================================================
        function applyRecoveryData(item) {
            const data = item.data;
            if (!data) return;

            if (data.roomConfig) {
                document.getElementById('room-width').value = data.roomConfig.width || 3000;
                document.getElementById('room-height').value = data.roomConfig.height || 1500;
            }
            if (data.equipmentCount !== undefined) {
                document.getElementById('equipment-count').value = data.equipmentCount;
            }
            if (data.siteId) {
                document.getElementById('site-id').value = data.siteId;
            }
            if (data.memo) {
                document.getElementById('memo').value = data.memo;
            }

            showToast('âœ… ë°ì´í„° ë³µêµ¬ ì™„ë£Œ!', 'success');
            log('recovery', 'ë³µêµ¬ ë°ì´í„° UIì— ì ìš© ì™„ë£Œ');
        }

        // =================================================================
        // ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
        // =================================================================
        let countdownSeconds = AUTOSAVE_INTERVAL / 1000;

        function startCountdown() {
            countdownSeconds = AUTOSAVE_INTERVAL / 1000;
            updateCountdownDisplay();

            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                if (countdownSeconds < 0) countdownSeconds = AUTOSAVE_INTERVAL / 1000;
                updateCountdownDisplay();
            }, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            document.getElementById('countdown-timer').textContent = '--';
        }

        function resetCountdown() {
            countdownSeconds = AUTOSAVE_INTERVAL / 1000;
            updateCountdownDisplay();
        }

        function updateCountdownDisplay() {
            document.getElementById('countdown-timer').textContent = countdownSeconds;
            document.getElementById('status-next-save').textContent = `${countdownSeconds}ì´ˆ`;
        }

        // =================================================================
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        // =================================================================
        function updateStatus() {
            const status = autoSaveInstance?.getStatus();
            
            // AutoSave ìƒíƒœ
            const autoSaveStatus = document.getElementById('status-autosave');
            if (status?.isRunning) {
                autoSaveStatus.textContent = 'ì‹¤í–‰ ì¤‘';
                autoSaveStatus.className = 'status-item-value success';
            } else {
                autoSaveStatus.textContent = 'ì¤‘ì§€ë¨';
                autoSaveStatus.className = 'status-item-value error';
            }

            // Dirty ìƒíƒœ
            const dirtyStatus = document.getElementById('status-dirty');
            if (status?.isDirty) {
                dirtyStatus.textContent = 'Dirty';
                dirtyStatus.className = 'status-item-value warning';
            } else {
                dirtyStatus.textContent = 'Clean';
                dirtyStatus.className = 'status-item-value success';
            }

            // ë³€ê²½ íšŸìˆ˜
            document.getElementById('status-changes').textContent = 
                `${status?.changeCount || 0} / ${CHANGE_THRESHOLD}`;

            // ë§ˆì§€ë§‰ ì €ì¥
            if (lastSaveTime) {
                const ago = Math.floor((Date.now() - lastSaveTime.getTime()) / 1000);
                document.getElementById('status-last-save').textContent = 
                    ago < 60 ? `${ago}ì´ˆ ì „` : `${Math.floor(ago/60)}ë¶„ ì „`;
            }

            // Storage ì‚¬ìš©ëŸ‰
            const storageInfo = storageService.getUsageInfo();
            document.getElementById('status-storage').textContent = 
                `${storageInfo.itemCount}ê°œ / ${(storageInfo.usedBytes / 1024).toFixed(1)}KB`;
        }

        // =================================================================
        // ë¡œê¹…
        // =================================================================
        function log(type, message) {
            const logContainer = document.getElementById('event-log');
            const now = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">${now}</span>
                <span class="log-type ${type}">${type.toUpperCase()}</span>
                <span class="log-message">${message}</span>
            `;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // ë¡œê·¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const count = logContainer.querySelectorAll('.log-entry').length;
            document.getElementById('log-count').textContent = `${count} entries`;
        }

        // =================================================================
        // Toast
        // =================================================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // =================================================================
        // ì „ì—­ í•¨ìˆ˜ (ë²„íŠ¼ onclickìš©)
        // =================================================================
        window.startAutoSave = function() {
            if (autoSaveInstance) {
                autoSaveInstance.start();
                showToast('â–¶ï¸ AutoSave ì‹œì‘ë¨', 'success');
            }
        };

        window.stopAutoSave = function() {
            if (autoSaveInstance) {
                autoSaveInstance.stop();
                showToast('â¹ï¸ AutoSave ì¤‘ì§€ë¨', 'warning');
            }
        };

        window.saveNow = function() {
            if (autoSaveInstance) {
                autoSaveInstance.saveNow('manual');
            }
        };

        window.markDirty = function() {
            if (autoSaveInstance) {
                autoSaveInstance.markDirty();
                showToast('ğŸ“ Dirty ìƒíƒœë¡œ í‘œì‹œë¨', 'info');
            }
        };

        window.showRecoveryDialog = function() {
            const dialog = new RecoveryDialog({
                autoCheck: false,
                showPreview: true,
                namespaces: ['layout', 'equipment'],
                onRecover: (items) => {
                    items.forEach(item => applyRecoveryData(item));
                }
            });
            dialog.checkAndShow();
        };

        window.checkRecoveryData = function() {
            const data = storageService.autoSave.checkRecovery(NAMESPACE, SITE_ID);
            if (data) {
                console.log('ë³µêµ¬ ë°ì´í„°:', data);
                showToast('ğŸ” ë³µêµ¬ ë°ì´í„° ë°œê²¬! ì½˜ì†” í™•ì¸', 'info');
                log('recovery', `ë³µêµ¬ ë°ì´í„° ë°œê²¬: ${JSON.stringify(data._autoSave)}`);
            } else {
                showToast('ë³µêµ¬ ë°ì´í„° ì—†ìŒ', 'warning');
                log('recovery', 'ë³µêµ¬ ë°ì´í„° ì—†ìŒ');
            }
        };

        window.clearAllAutoSave = function() {
            if (confirm('ëª¨ë“  AutoSave ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                storageService.autoSave.clearRecovery(NAMESPACE, SITE_ID);
                // equipmentë„ ì‚­ì œ
                storageService.autoSave.clearRecovery('equipment', SITE_ID);
                showToast('ğŸ—‘ï¸ AutoSave ë°ì´í„° ì‚­ì œë¨', 'warning');
                log('stopped', 'ëª¨ë“  AutoSave ë°ì´í„° ì‚­ì œë¨');
            }
        };

        window.printStorageStatus = function() {
            const status = storageService.getStatusReport();
            console.log('ğŸ“‹ Storage Status:', status);
            log('started', `Storage: ${status.storage.itemCount}ê°œ, ${(status.storage.usedBytes/1024).toFixed(1)}KB`);
        };

        window.printAutoSaveStatus = function() {
            const status = autoSaveInstance?.getStatus();
            console.log('ğŸ“‹ AutoSave Status:', status);
            if (status) {
                log('started', `AutoSave: running=${status.isRunning}, dirty=${status.isDirty}, changes=${status.changeCount}`);
            }
        };

        window.clearEventLog = function() {
            const logContainer = document.getElementById('event-log');
            logContainer.innerHTML = '';
            document.getElementById('log-count').textContent = '0 entries';
            log('started', 'ë¡œê·¸ ì´ˆê¸°í™”ë¨');
        };

        // =================================================================
        // ì „ì—­ ë…¸ì¶œ (ë””ë²„ê¹…ìš©)
        // =================================================================
        window.testAutoSave = {
            instance: () => autoSaveInstance,
            storageService,
            eventBus,
            getData,
            NAMESPACE,
            SITE_ID
        };

        // =================================================================
        // ì´ˆê¸°í™”
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            log('started', 'í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ì´ˆê¸°í™”
            initAutoSave();
            initIndicator();
            setupEventListeners();
            
            // ë³µêµ¬ ë‹¤ì´ì–¼ë¡œê·¸ ìë™ í™•ì¸ (500ms í›„)
            setTimeout(() => {
                const recoveryDialog = new RecoveryDialog({
                    autoCheck: true,
                    showPreview: true,
                    namespaces: ['layout', 'equipment'],
                    onRecover: (items) => {
                        items.forEach(item => applyRecoveryData(item));
                    }
                });
            }, 500);
            
            // ìƒíƒœ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
            setInterval(updateStatus, 1000);
            
            // AutoSave ì‹œì‘
            autoSaveInstance.start();
            
            console.log('âœ… AutoSave Test ì´ˆê¸°í™” ì™„ë£Œ');
            console.log('ğŸ’¡ ë””ë²„ê·¸: window.testAutoSave ì‚¬ìš© ê°€ëŠ¥');
        });
    </script>
</body>
</html>