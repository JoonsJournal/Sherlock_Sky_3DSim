<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection API í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button.info {
            background: #2196F3;
        }
        button.info:hover {
            background: #0b7dda;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        #results {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            max-height: 600px;
            min-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 2px solid #333;
        }
        h1 { color: #333; }
        h2 { 
            color: #555; 
            margin-top: 0;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
        }
        .status-connected {
            background: #4CAF50;
            color: white;
        }
        .status-disconnected {
            background: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Œ Connection API í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
    <div id="api-status"></div>

    <div class="test-section">
        <h2>1. ì‚¬ì´íŠ¸ ëª©ë¡ ì¡°íšŒ</h2>
        <button onclick="testGetSites()">GET /sites</button>
    </div>

    <div class="test-section">
        <h2>2. í”„ë¡œí•„ ëª©ë¡ ì¡°íšŒ</h2>
        <button onclick="testGetProfiles()">GET /profiles</button>
    </div>

    <div class="test-section">
        <h2>3. ë‹¨ì¼ ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testSingleConnection('korea_site1', 'line1')">Test: korea_site1.line1</button>
        <button onclick="testSingleConnection('vietnam_site', 'production')">Test: vietnam_site.production</button>
        <button onclick="testSingleConnection('usa_site', 'plant')">Test: usa_site.plant</button>
    </div>

    <div class="test-section">
        <h2>3-1. í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ</h2>
        <button class="info" onclick="testGetTables('korea_site1', 'line1')">ğŸ“‹ Tables: korea_site1.line1</button>
        <button class="info" onclick="testGetTables('vietnam_site', 'production')">ğŸ“‹ Tables: vietnam_site.production</button>
        <button class="info" onclick="testGetTables('usa_site', 'plant')">ğŸ“‹ Tables: usa_site.plant</button>
    </div>

    <div class="test-section">
        <h2>4. í”„ë¡œí•„ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testProfile('korea_only')">Test Profile: korea_only</button>
        <button onclick="testProfile('production_only')">Test Profile: production_only</button>
        <button onclick="testProfile('all')">Test Profile: all</button>
    </div>

    <div class="test-section">
        <h2>5. ì „ì²´ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testAllConnections()">POST /test-all</button>
    </div>

    <div class="test-section">
        <h2>6. ìƒíƒœ ì¡°íšŒ</h2>
        <button onclick="testGetStatus()">GET /status</button>
    </div>

    <div class="test-section">
        <h2>7. ê²°ê³¼</h2>
        <button onclick="clearResults()" class="danger">ğŸ—‘ï¸ Clear</button>
        <button onclick="testAllQuick()" class="info">âš¡ Quick Test</button>
        <div id="results">ëŒ€ê¸° ì¤‘... ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
    </div>

    <script type="module">
        import { ApiClient } from './src/api/ApiClient.js';

        // ============================================
        // ë””ë²„ê¹… ë¡œê·¸
        // ============================================
        
        function debugLog(category, message, data = null) {
            const timestamp = new Date().toISOString().substr(11, 12);
            const prefix = `[${timestamp}] [${category}]`;
            
            if (data) {
                console.log(prefix, message, data);
            } else {
                console.log(prefix, message);
            }
        }

        console.clear();
        debugLog('INIT', '='.repeat(60));
        debugLog('INIT', 'ğŸš€ API í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì‹œì‘');
        debugLog('INIT', '='.repeat(60));

        // ì „ì—­ ë³€ìˆ˜ë¡œ ApiClient ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        window.apiClient = new ApiClient();
        debugLog('INIT', 'ApiClient ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ');

        // API ì—°ê²° ìƒíƒœ í™•ì¸
        async function checkApiStatus() {
            try {
                const response = await fetch('http://localhost:8000/health');
                const statusDiv = document.getElementById('api-status');
                
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = '<span class="status-indicator status-connected">âœ… Backend API ì—°ê²°ë¨</span>';
                    debugLog('STATUS', 'API ì •ìƒ', data);
                } else {
                    statusDiv.innerHTML = '<span class="status-indicator status-disconnected">âŒ Backend API ì‘ë‹µ ì—†ìŒ</span>';
                    debugLog('STATUS', 'API ì‘ë‹µ ì—†ìŒ', { status: response.status });
                }
            } catch (error) {
                const statusDiv = document.getElementById('api-status');
                statusDiv.innerHTML = '<span class="status-indicator status-disconnected">âŒ Backend API ì—°ê²° ì‹¤íŒ¨</span>';
                debugLog('STATUS', 'API ì—°ê²° ì‹¤íŒ¨', { error: error.message });
            }
        }

        checkApiStatus();
        setInterval(checkApiStatus, 5000);

        // ===== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ =====

        window.testGetSites = async function() {
            debugLog('TEST', 'â–¶ testGetSites ì‹œì‘');
            logTest('GET /connections/sites');
            try {
                const result = await apiClient.get('/connections/sites');
                debugLog('TEST', 'âœ“ testGetSites ì„±ê³µ', result);
                logResult('SUCCESS', result);
            } catch (error) {
                debugLog('TEST', 'âœ— testGetSites ì‹¤íŒ¨', error);
                logResult('ERROR', error);
            }
        };

        window.testGetProfiles = async function() {
            debugLog('TEST', 'â–¶ testGetProfiles ì‹œì‘');
            logTest('GET /connections/profiles');
            try {
                const result = await apiClient.get('/connections/profiles');
                debugLog('TEST', 'âœ“ testGetProfiles ì„±ê³µ', result);
                logResult('SUCCESS', result);
            } catch (error) {
                debugLog('TEST', 'âœ— testGetProfiles ì‹¤íŒ¨', error);
                logResult('ERROR', error);
            }
        };

        window.testSingleConnection = async function(siteName, dbName) {
            debugLog('TEST', 'â–¶ testSingleConnection ì‹œì‘', { siteName, dbName });
            logTest(`POST /connections/test-connection - ${siteName}.${dbName}`);
            try {
                const result = await apiClient.post('/connections/test-connection', {
                    site_name: siteName,
                    db_name: dbName
                });
                debugLog('TEST', 'âœ“ testSingleConnection ì„±ê³µ', result);
                logResult('SUCCESS', result);
            } catch (error) {
                debugLog('TEST', 'âœ— testSingleConnection ì‹¤íŒ¨', error);
                logResult('ERROR', error);
            }
        };

        window.testGetTables = async function(siteName, dbName) {
            debugLog('TEST', 'â–¶ testGetTables ì‹œì‘', { siteName, dbName });
            logTest(`POST /connections/get-tables - ${siteName}.${dbName}`);
            try {
                const result = await apiClient.getDatabaseTables(siteName, dbName);
                debugLog('TEST', 'âœ“ testGetTables ì„±ê³µ', result);
                
                if (result.success) {
                    logResult('SUCCESS', {
                        message: result.message,
                        total_tables: result.total_tables,
                        site_name: result.site_name,
                        db_name: result.db_name,
                        db_type: result.db_type,
                        database: result.database
                    });
                    
                    // í…Œì´ë¸” ëª©ë¡ í‘œì‹œ
                    const results = document.getElementById('results');
                    results.innerHTML += '\nğŸ“‹ í…Œì´ë¸” ëª©ë¡:\n';
                    results.innerHTML += 'â”'.repeat(60) + '\n';
                    
                    if (result.tables && result.tables.length > 0) {
                        result.tables.forEach((table, index) => {
                            results.innerHTML += `  ${(index + 1).toString().padStart(3, ' ')}. ${table.full_name}\n`;
                        });
                        debugLog('TEST', `í…Œì´ë¸” ${result.tables.length}ê°œ í‘œì‹œ ì™„ë£Œ`);
                    } else {
                        results.innerHTML += '  (í…Œì´ë¸” ì—†ìŒ)\n';
                    }
                    results.innerHTML += 'â”'.repeat(60) + '\n';
                    results.scrollTop = results.scrollHeight;
                } else {
                    logResult('ERROR', result);
                }
            } catch (error) {
                debugLog('TEST', 'âœ— testGetTables ì‹¤íŒ¨', error);
                logResult('ERROR', error);
            }
        };

        window.testProfile = async function(profileName) {
            debugLog('TEST', 'â–¶ testProfile ì‹œì‘', { profileName });
            logTest(`POST /connections/test-profile - ${profileName}`);
            try {
                const result = await apiClient.post('/connections/test-profile', {
                    profile_name: profileName
                });
                debugLog('TEST', 'âœ“ testProfile ì„±ê³µ', result);
                logResult('SUCCESS', result);
            } catch (error) {
                debugLog('TEST', 'âœ— testProfile ì‹¤íŒ¨', error);
                logResult('ERROR', error);
            }
        };

        window.testAllConnections = async function() {
            debugLog('TEST', 'â–¶ testAllConnections ì‹œì‘');
            logTest('POST /connections/test-all');
            try {
                const result = await apiClient.post('/connections/test-all');
                debugLog('TEST', 'âœ“ testAllConnections ì„±ê³µ', result);
                logResult('SUCCESS', result);
            } catch (error) {
                debugLog('TEST', 'âœ— testAllConnections ì‹¤íŒ¨', error);
                logResult('ERROR', error);
            }
        };

        window.testGetStatus = async function() {
            debugLog('TEST', 'â–¶ testGetStatus ì‹œì‘');
            logTest('GET /connections/status');
            try {
                const result = await apiClient.get('/connections/status');
                debugLog('TEST', 'âœ“ testGetStatus ì„±ê³µ', result);
                logResult('SUCCESS', result);
            } catch (error) {
                debugLog('TEST', 'âœ— testGetStatus ì‹¤íŒ¨', error);
                logResult('ERROR', error);
            }
        };

        window.testAllQuick = async function() {
            debugLog('TEST', 'â–¶ Quick Test ì‹œì‘');
            clearResults();
            logInfo('âš¡ Quick Test ì‹œì‘...\n');
            
            await testGetSites();
            await new Promise(r => setTimeout(r, 500));
            
            await testGetProfiles();
            await new Promise(r => setTimeout(r, 500));
            
            await testGetStatus();
            
            logInfo('\nâœ… Quick Test ì™„ë£Œ!');
            debugLog('TEST', 'âœ“ Quick Test ì™„ë£Œ');
        };

        window.clearResults = function() {
            debugLog('UI', 'clearResults í˜¸ì¶œ');
            document.getElementById('results').innerHTML = '';
        };

        function logTest(message) {
            const results = document.getElementById('results');
            results.innerHTML += `\n${'='.repeat(60)}\n`;
            results.innerHTML += `ğŸ§ª ${message}\n`;
            results.innerHTML += `${'='.repeat(60)}\n`;
            results.scrollTop = results.scrollHeight;
        }

        function logResult(status, data) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();

            if (status === 'SUCCESS') {
                results.innerHTML += `âœ… [${timestamp}] SUCCESS\n`;
                results.innerHTML += JSON.stringify(data, null, 2) + '\n';
            } else {
                results.innerHTML += `âŒ [${timestamp}] ERROR\n`;
                if (data instanceof Error) {
                    results.innerHTML += `${data.message}\n`;
                } else {
                    results.innerHTML += (data.message || JSON.stringify(data)) + '\n';
                }
            }
            results.scrollTop = results.scrollHeight;
        }

        function logInfo(message) {
            const results = document.getElementById('results');
            results.innerHTML += `â„¹ï¸  ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }

        debugLog('INIT', '='.repeat(60));
        debugLog('INIT', 'âœ… í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        debugLog('INIT', '='.repeat(60));
        
        console.log('\nğŸ’¡ ì‚¬ìš© ë°©ë²•:');
        console.log('  - ë²„íŠ¼ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸');
        console.log('  - F12 ì½˜ì†”ì—ì„œ ì§„í–‰ ìƒí™© í™•ì¸');
        console.log('  - ì§ì ‘ ì‹¤í–‰: await apiClient.getDatabaseTables("korea_site1", "line1")');
        console.log('');
    </script>
</body>
</html>