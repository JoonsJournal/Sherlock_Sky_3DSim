<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayoutFileManager ê°„ë‹¨ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .output.success {
            background: #e8f5e9;
            border-color: #4CAF50;
        }
        
        .output.error {
            background: #ffebee;
            border-color: #f44336;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .status.ok {
            background: #4CAF50;
            color: white;
        }
        
        .status.fail {
            background: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª LayoutFileManager ê°„ë‹¨ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h3>ğŸ“Š ì´ˆê¸°í™” ìƒíƒœ</h3>
        <div id="initStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>1ï¸âƒ£ checkLayout() í…ŒìŠ¤íŠ¸</h3>
        <p>íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸</p>
        <button onclick="runTest1()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <div id="test1" class="output"></div>
    </div>
    
    <div class="test-section">
        <h3>2ï¸âƒ£ loadTemplate() í…ŒìŠ¤íŠ¸</h3>
        <p>Template íŒŒì¼ ë¡œë“œ</p>
        <button onclick="runTest2()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <div id="test2" class="output"></div>
    </div>
    
    <div class="test-section">
        <h3>3ï¸âƒ£ listTemplates() í…ŒìŠ¤íŠ¸</h3>
        <p>ì‚¬ìš© ê°€ëŠ¥í•œ Templates ëª©ë¡</p>
        <button onclick="runTest3()">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <div id="test3" class="output"></div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ“ ë¸Œë¼ìš°ì € ì½˜ì†” ëª…ë ¹ì–´</h3>
        <div style="background: #263238; color: #aed581; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;">
// ì§ì ‘ í…ŒìŠ¤íŠ¸í•´ë³´ê¸°
const manager = new LayoutFileManager();

// íŒŒì¼ í™•ì¸
await manager.checkLayout('korea_site1_line1');

// Template ë¡œë“œ
const template = await manager.loadTemplate('standard_26x6');
console.log(template);

// Templates ëª©ë¡
await manager.listTemplates();
        </div>
    </div>

    <!-- LayoutFileManager ì¸ë¼ì¸ í¬í•¨ -->
    <script>
        (function() {
            'use strict';
            
            class LayoutFileManager {
                constructor() {
                    this.basePath = '/layouts/';
                    this.templatePath = '/layouts/templates/';
                    this.backupSuffix = '.backup';
                    this.autoSaveSuffix = '.autosave';
                    
                    console.log('[LayoutFileManager] Instance created');
                }

                async checkLayout(siteId) {
                    try {
                        console.log(`[LayoutFileManager] Checking: ${siteId}`);
                        const filePath = `${this.basePath}${siteId}.json`;
                        const response = await fetch(filePath);
                        
                        if (response.ok) {
                            console.log(`âœ… File exists: ${filePath}`);
                            return true;
                        } else {
                            console.log(`âŒ File not found: ${filePath}`);
                            return false;
                        }
                    } catch (error) {
                        console.error(`Error checking layout:`, error);
                        return false;
                    }
                }

                async loadLayout(siteId) {
                    try {
                        console.log(`[LayoutFileManager] Loading: ${siteId}`);
                        
                        const mainPath = `${this.basePath}${siteId}.json`;
                        let response = await fetch(mainPath);
                        
                        if (response.ok) {
                            const layoutData = await response.json();
                            console.log(`âœ… Layout loaded from: ${mainPath}`);
                            return layoutData;
                        }
                        
                        const backupPath = `${this.basePath}${siteId}${this.backupSuffix}.json`;
                        response = await fetch(backupPath);
                        
                        if (response.ok) {
                            const layoutData = await response.json();
                            console.log(`âš ï¸ Loaded from backup: ${backupPath}`);
                            return layoutData;
                        }
                        
                        console.error(`âŒ Failed to load: ${siteId}`);
                        return null;
                        
                    } catch (error) {
                        console.error(`Error loading layout:`, error);
                        return null;
                    }
                }

                async saveLayout(siteId, layoutData) {
                    try {
                        console.log(`[LayoutFileManager] Saving: ${siteId}`);
                        
                        const dataToSave = {
                            ...layoutData,
                            site_id: siteId,
                            last_modified: new Date().toISOString(),
                            version: (layoutData.version || 0) + 1
                        };
                        
                        const jsonString = JSON.stringify(dataToSave, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${siteId}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        console.log(`âœ… Download triggered: ${siteId}.json`);
                        return true;
                        
                    } catch (error) {
                        console.error(`Error saving layout:`, error);
                        return false;
                    }
                }

                async loadTemplate(templateName) {
                    try {
                        console.log(`[LayoutFileManager] Loading template: ${templateName}`);
                        
                        const filePath = `${this.templatePath}${templateName}.json`;
                        const response = await fetch(filePath);
                        
                        if (!response.ok) {
                            console.error(`âŒ Template not found: ${filePath}`);
                            return null;
                        }
                        
                        const templateData = await response.json();
                        console.log(`âœ… Template loaded: ${templateName}`);
                        return templateData;
                        
                    } catch (error) {
                        console.error(`Error loading template:`, error);
                        return null;
                    }
                }

                async checkAutoSave(siteId) {
                    try {
                        const filePath = `${this.basePath}${siteId}${this.autoSaveSuffix}.json`;
                        const response = await fetch(filePath);
                        return response.ok;
                    } catch (error) {
                        return false;
                    }
                }

                async loadAutoSave(siteId) {
                    try {
                        const filePath = `${this.basePath}${siteId}${this.autoSaveSuffix}.json`;
                        const response = await fetch(filePath);
                        
                        if (!response.ok) {
                            return null;
                        }
                        
                        const layoutData = await response.json();
                        console.log(`âœ… Auto-save loaded: ${filePath}`);
                        return layoutData;
                        
                    } catch (error) {
                        console.error(`Error loading auto-save:`, error);
                        return null;
                    }
                }

                async listTemplates() {
                    const knownTemplates = [
                        'standard_26x6',
                        'compact_13x4',
                        'default_template'
                    ];
                    
                    console.log(`Available templates:`, knownTemplates);
                    return knownTemplates;
                }

                validateLayout(layoutData) {
                    try {
                        const requiredFields = ['version', 'site_id', 'room', 'equipmentArrays'];
                        
                        for (const field of requiredFields) {
                            if (!(field in layoutData)) {
                                console.error(`âŒ Missing required field: ${field}`);
                                return false;
                            }
                        }
                        
                        if (!layoutData.room.width || !layoutData.room.depth) {
                            console.error(`âŒ Invalid room dimensions`);
                            return false;
                        }
                        
                        if (!Array.isArray(layoutData.equipmentArrays)) {
                            console.error(`âŒ equipmentArrays is not an array`);
                            return false;
                        }
                        
                        console.log(`âœ… Layout validation passed`);
                        return true;
                        
                    } catch (error) {
                        console.error(`âŒ Validation error:`, error);
                        return false;
                    }
                }
            }

            // Global export
            window.LayoutFileManager = LayoutFileManager;
            console.log('âœ… LayoutFileManager loaded');
            
        })();
    </script>
    
    <!-- í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ì´ˆê¸°í™” í™•ì¸
        window.addEventListener('DOMContentLoaded', function() {
            const initDiv = document.getElementById('initStatus');
            
            if (typeof LayoutFileManager !== 'undefined') {
                try {
                    window.testManager = new LayoutFileManager();
                    initDiv.innerHTML = '<span class="status ok">âœ… ì´ˆê¸°í™” ì„±ê³µ</span><br>LayoutFileManager ì‚¬ìš© ê°€ëŠ¥';
                } catch (error) {
                    initDiv.innerHTML = '<span class="status fail">âŒ ì´ˆê¸°í™” ì‹¤íŒ¨</span><br>' + error.message;
                }
            } else {
                initDiv.innerHTML = '<span class="status fail">âŒ ë¡œë“œ ì‹¤íŒ¨</span><br>LayoutFileManager í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        });
        
        // Test 1: checkLayout()
        async function runTest1() {
            const outputDiv = document.getElementById('test1');
            outputDiv.innerHTML = 'ğŸ”„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...';
            
            try {
                const exists = await testManager.checkLayout('korea_site1_line1');
                
                if (exists) {
                    outputDiv.className = 'output success';
                    outputDiv.textContent = 'âœ… íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤!\nSite ID: korea_site1_line1\níŒŒì¼ ê²½ë¡œ: /layouts/korea_site1_line1.json';
                } else {
                    outputDiv.className = 'output error';
                    outputDiv.textContent = 'âŒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nSite ID: korea_site1_line1\níŒŒì¼ ê²½ë¡œ: /layouts/korea_site1_line1.json\n\nâ†’ íŒŒì¼ì„ ìƒì„±í•˜ê±°ë‚˜ Templateì„ ì‚¬ìš©í•˜ì„¸ìš”.';
                }
            } catch (error) {
                outputDiv.className = 'output error';
                outputDiv.textContent = 'âŒ ì—ëŸ¬ ë°œìƒ:\n' + error.message;
            }
        }
        
        // Test 2: loadTemplate()
        async function runTest2() {
            const outputDiv = document.getElementById('test2');
            outputDiv.innerHTML = 'ğŸ”„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...';
            
            try {
                const template = await testManager.loadTemplate('standard_26x6');
                
                if (template) {
                    outputDiv.className = 'output success';
                    outputDiv.textContent = `âœ… Template ë¡œë“œ ì„±ê³µ!\n\n` +
                        `Template: ${template.template_name}\n` +
                        `Room í¬ê¸°: ${template.room.width}m Ã— ${template.room.depth}m\n` +
                        `ì„¤ë¹„ ë°°ì—´: ${template.equipmentArrays.length}ê°œ\n` +
                        `Version: ${template.version}`;
                } else {
                    outputDiv.className = 'output error';
                    outputDiv.textContent = 'âŒ Template ë¡œë“œ ì‹¤íŒ¨\n\níŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: /layouts/templates/standard_26x6.json';
                }
            } catch (error) {
                outputDiv.className = 'output error';
                outputDiv.textContent = 'âŒ ì—ëŸ¬ ë°œìƒ:\n' + error.message;
            }
        }
        
        // Test 3: listTemplates()
        async function runTest3() {
            const outputDiv = document.getElementById('test3');
            outputDiv.innerHTML = 'ğŸ”„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...';
            
            try {
                const templates = await testManager.listTemplates();
                
                outputDiv.className = 'output success';
                outputDiv.textContent = `âœ… ì‚¬ìš© ê°€ëŠ¥í•œ Templates:\n\n` +
                    templates.map((t, i) => `${i + 1}. ${t}`).join('\n') +
                    `\n\nì´ ${templates.length}ê°œ Template`;
            } catch (error) {
                outputDiv.className = 'output error';
                outputDiv.textContent = 'âŒ ì—ëŸ¬ ë°œìƒ:\n' + error.message;
            }
        }
    </script>
</body>
</html>