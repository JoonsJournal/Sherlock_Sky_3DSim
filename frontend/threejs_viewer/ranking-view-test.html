<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<!--
 * ranking-view-test.html v3.1
 * ===========================
 * ê¸°ì¡´ ëª¨ë“ˆë“¤ì„ ëª¨ë‘ Importí•˜ì—¬ ê²€ì¦í•˜ëŠ” í…ŒìŠ¤íŠ¸ í˜ì´ì§€
 * 
 * ğŸ”§ v3.1 í•µì‹¬ ìˆ˜ì •:
 *    - RankingLane._findInsertIndex() ë©”ì„œë“œ ì‚¬ìš©ìœ¼ë¡œ ì •ë ¬ ë¬¸ì œ í•´ê²°
 *    - AnimationManager, PositionCalculator, BatchAnimator ì „ì²´ í™œìš©
 *    - ê¸°ì¡´ CSS í´ë˜ìŠ¤ ìƒìˆ˜ (AnimationManager.CSS) í™œìš©
 *    - ê¸°ì¡´ TIMING/EASING ìƒìˆ˜ í™œìš©
 * 
 * ğŸ“¦ Import ëª¨ë“ˆ ëª©ë¡:
 *    - EventBus
 *    - RankingView, RankingLane, EquipmentCard
 *    - AnimationManager, PositionCalculator, BatchAnimator
 * 
 * ì‘ì„±ì¼: 2026-01-23
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Ranking View Test v3.1 - Full Module Integration</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { display: flex; flex-direction: column; height: 100vh; overflow: hidden; font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg-main, #0a0a0f); color: #fff; }
        .test-header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .test-header h1 { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .test-header .version { font-size: 11px; background: #8b5cf6; padding: 2px 6px; border-radius: 4px; }
        .test-header .badge { font-size: 10px; background: #22c55e; padding: 2px 6px; border-radius: 4px; }
        .test-content { flex: 1; display: flex; overflow: hidden; }
        .ranking-container { flex: 1; position: relative; overflow: hidden; }
        .test-panel { width: 300px; background: #111; border-left: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .panel-section { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .panel-section-header { padding: 10px 12px; background: rgba(255,255,255,0.03); font-weight: 600; font-size: 12px; color: #888; text-transform: uppercase; }
        .panel-section-content { padding: 10px 12px; }
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .control-btn { padding: 10px 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .control-btn .icon { font-size: 18px; }
        .control-btn .label { font-size: 10px; }
        .control-btn .key { font-size: 9px; opacity: 0.6; background: rgba(0,0,0,0.2); padding: 1px 4px; border-radius: 3px; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-cyan { background: #06b6d4; color: white; }
        .btn-gray { background: #4b5563; color: white; }
        .btn-wide { grid-column: span 2; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; }
        .toggle-row label { font-size: 11px; color: #ccc; }
        .toggle-switch { position: relative; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: 0.3s; border-radius: 22px; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: #888; transition: 0.3s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background-color: #8b5cf6; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); background-color: white; }
        .auto-row { display: flex; gap: 6px; align-items: center; margin: 6px 0; }
        .auto-row label { font-size: 11px; color: #aaa; min-width: 40px; }
        .auto-row input[type="range"] { flex: 1; height: 6px; border-radius: 3px; background: #333; appearance: none; }
        .auto-row input[type="range"]::-webkit-slider-thumb { appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #8b5cf6; cursor: pointer; }
        .auto-row .value { font-size: 11px; font-weight: 600; min-width: 35px; text-align: right; color: #8b5cf6; }
        .status-box { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 11px; margin-top: 6px; }
        .status-box .dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
        .status-box.active .dot { background: #22c55e; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px; text-align: center; }
        .stat-box .val { font-size: 18px; font-weight: 700; }
        .stat-box .lbl { font-size: 9px; color: #888; }
        .stat-box.run .val { color: #22c55e; }
        .stat-box.idle .val { color: #f59e0b; }
        .stat-box.stop .val { color: #ef4444; }
        .module-list { font-size: 10px; color: #666; }
        .module-list .item { padding: 3px 0; display: flex; justify-content: space-between; }
        .module-list .ok { color: #22c55e; }
        .module-list .fail { color: #ef4444; }
        .test-log { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .test-log-header { padding: 8px 12px; background: rgba(255,255,255,0.03); font-size: 12px; display: flex; justify-content: space-between; }
        .test-log-header button { font-size: 10px; padding: 2px 6px; background: #333; border: none; border-radius: 3px; color: #aaa; cursor: pointer; }
        .test-log-content { flex: 1; overflow-y: auto; padding: 8px; font-family: monospace; font-size: 10px; line-height: 1.5; background: #0a0a0a; }
        .log-entry { padding: 2px 0; }
        .log-entry.success { color: #22c55e; }
        .log-entry.error { color: #ef4444; }
        .log-entry.warning { color: #f59e0b; }
        .log-entry.info { color: #60a5fa; }
        .log-entry.move { color: #c084fc; }
        .log-entry.anim { color: #f472b6; }
        .log-entry.sort { color: #34d399; }
        .log-entry.divider { color: #444; }
        .ranking-view { position: relative !important; left: 0 !important; width: 100% !important; }
    </style>
</head>
<body>
    <header class="test-header">
        <h1>ğŸ§ª Ranking View Module Test <span class="version">v3.1</span> <span class="badge">ğŸ”Œ Full Import</span></h1>
        <div style="font-size: 11px; color: #888;">Press <kbd style="background:#333;padding:2px 6px;border-radius:3px;">H</kbd> for help</div>
    </header>
    <div class="test-content">
        <div class="ranking-container" id="ranking-container"></div>
        <div class="test-panel">
            <div class="panel-section">
                <div class="panel-section-header">ğŸ”Œ Imported Modules</div>
                <div class="panel-section-content"><div class="module-list" id="module-status"></div></div>
            </div>
            <div class="panel-section">
                <div class="panel-section-header">ğŸ“¦ Data</div>
                <div class="panel-section-content">
                    <div class="control-grid">
                        <button class="control-btn btn-primary btn-wide" onclick="loadTestData()"><span class="icon">ğŸ“¦</span><span class="label">í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ</span><span class="key">D</span></button>
                        <button class="control-btn btn-gray" onclick="clearAllData()"><span class="icon">ğŸ—‘ï¸</span><span class="label">ì´ˆê¸°í™”</span><span class="key">C</span></button>
                        <button class="control-btn btn-cyan" onclick="debugSnapshot()"><span class="icon">ğŸ“Š</span><span class="label">ìŠ¤ëƒ…ìƒ·</span><span class="key">S</span></button>
                    </div>
                </div>
            </div>
            <div class="panel-section">
                <div class="panel-section-header">ğŸ¬ Animation</div>
                <div class="panel-section-content">
                    <div class="toggle-row"><label>4-Phase ì• ë‹ˆë©”ì´ì…˜</label><label class="toggle-switch"><input type="checkbox" id="use-animation" checked><span class="toggle-slider"></span></label></div>
                    <div class="toggle-row"><label>ì •ë ¬ ìœ„ì¹˜ ê³„ì‚°</label><label class="toggle-switch"><input type="checkbox" id="use-sorting" checked><span class="toggle-slider"></span></label></div>
                    <div class="status-box" id="anim-status"><span class="dot"></span><span id="anim-status-text">ëŒ€ê¸° ì¤‘</span></div>
                </div>
            </div>
            <div class="panel-section">
                <div class="panel-section-header">ğŸ¯ Manual Move</div>
                <div class="panel-section-content">
                    <div class="control-grid">
                        <button class="control-btn btn-success" onclick="testMoveToRun()"><span class="icon">ğŸŸ¢</span><span class="label">RUN</span><span class="key">1</span></button>
                        <button class="control-btn btn-warning" onclick="testMoveToIdle()"><span class="icon">ğŸŸ¡</span><span class="label">IDLE</span><span class="key">2</span></button>
                        <button class="control-btn btn-danger" onclick="testMoveToStop()"><span class="icon">ğŸ›‘</span><span class="label">STOP</span><span class="key">3</span></button>
                        <button class="control-btn btn-purple" onclick="testMoveToSuddenStop()"><span class="icon">âš ï¸</span><span class="label">SUDDEN</span><span class="key">4</span></button>
                    </div>
                </div>
            </div>
            <div class="panel-section">
                <div class="panel-section-header">ğŸ”„ Auto Random</div>
                <div class="panel-section-content">
                    <div class="auto-row"><label>ê°„ê²©</label><input type="range" id="auto-interval" min="1000" max="5000" value="2500" step="100"><span class="value" id="interval-value">2.5s</span></div>
                    <div class="control-grid">
                        <button class="control-btn btn-success" onclick="startAutoMove()" id="btn-start"><span class="icon">â–¶ï¸</span><span class="label">ì‹œì‘</span><span class="key">Space</span></button>
                        <button class="control-btn btn-danger" onclick="stopAutoMove()" id="btn-stop" disabled><span class="icon">â¹ï¸</span><span class="label">ì¤‘ì§€</span></button>
                    </div>
                    <div class="status-box" id="auto-status"><span class="dot"></span><span>ìë™: <strong id="auto-status-text">ì¤‘ì§€</strong></span><span id="auto-count" style="margin-left:auto;color:#888;">0íšŒ</span></div>
                </div>
            </div>
            <div class="panel-section">
                <div class="panel-section-header">ğŸ“ˆ Stats</div>
                <div class="panel-section-content">
                    <div class="stats-grid">
                        <div class="stat-box run"><div class="val" id="stat-run">0</div><div class="lbl">RUN</div></div>
                        <div class="stat-box idle"><div class="val" id="stat-idle">0</div><div class="lbl">IDLE</div></div>
                        <div class="stat-box stop"><div class="val" id="stat-stop">0</div><div class="lbl">STOP</div></div>
                    </div>
                </div>
            </div>
            <div class="panel-section test-log">
                <div class="test-log-header"><span>ğŸ“‹ Log</span><button onclick="clearLog()">Clear</button></div>
                <div class="test-log-content" id="test-log"></div>
            </div>
        </div>
    </div>
    <script type="importmap">{"imports":{"three":"./node_modules/three/build/three.module.js","three/addons/":"./node_modules/three/examples/jsm/"}}</script>
    <script type="module">
        // ========================================
        // ğŸ“¦ IMPORTS - ê¸°ì¡´ ëª¨ë“ˆ ì „ì²´ í™œìš©
        // ========================================
        import { eventBus } from './src/core/managers/EventBus.js';
        import { RankingView } from './src/ui/ranking-view/RankingView.js';
        import { RankingLane } from './src/ui/ranking-view/components/RankingLane.js';
        import { EquipmentCard } from './src/ui/ranking-view/components/EquipmentCard.js';
        import { AnimationManager } from './src/ui/ranking-view/managers/AnimationManager.js';
        import { PositionCalculator } from './src/ui/ranking-view/utils/PositionCalculator.js';
        import { BatchAnimator } from './src/ui/ranking-view/utils/BatchAnimator.js';
        
        // Module Status Check
        const modules = { EventBus: eventBus, RankingView, RankingLane, EquipmentCard, AnimationManager, PositionCalculator, BatchAnimator };
        function checkModules() {
            const el = document.getElementById('module-status');
            el.innerHTML = Object.entries(modules).map(([n, m]) => `<div class="item"><span>${n}</span><span class="${m ? 'ok' : 'fail'}">${m ? 'âœ“' : 'âœ—'}</span></div>`).join('');
        }
        
        // Globals
        let rankingView = null, animationManager = null, positionCalculator = null;
        let testEquipments = [], autoMoveInterval = null, autoMoveCount = 0, isAnimating = false;
        
        // Logger
        function log(msg, type = 'info') {
            const el = document.getElementById('test-log'), entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}] ${msg}`;
            el.appendChild(entry); el.scrollTop = el.scrollHeight;
            while (el.children.length > 100) el.removeChild(el.firstChild);
        }
        window.log = log;
        window.clearLog = () => { document.getElementById('test-log').innerHTML = ''; log('ğŸ“‹ ë¡œê·¸ ì´ˆê¸°í™”'); };
        
        function setAnimStatus(text, active = false) {
            document.getElementById('anim-status-text').textContent = text;
            document.getElementById('anim-status').classList.toggle('active', active);
        }
        
        // Initialize
        function init() {
            log('ğŸš€ ì´ˆê¸°í™” ì‹œì‘...', 'info');
            checkModules();
            
            const container = document.getElementById('ranking-container');
            rankingView = new RankingView({ container, webSocketClient: null, useUDS: false });
            rankingView.show();
            
            animationManager = rankingView._animationManager || new AnimationManager({
                container: rankingView._lanesContainer, lanesMap: rankingView._lanes, cardsMap: rankingView._cardsMap
            });
            positionCalculator = animationManager._positionCalculator || new PositionCalculator({
                container: rankingView._lanesContainer, lanesMap: rankingView._lanes
            });
            
            window.rankingView = rankingView;
            window.animationManager = animationManager;
            window.positionCalculator = positionCalculator;
            window.eventBus = eventBus;
            
            log('âœ… ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            log(`   AnimationManager.TIMING: LIFT=${AnimationManager.TIMING.LIFT}ms, LANE_CHANGE=${AnimationManager.TIMING.LANE_CHANGE}ms`, 'info');
            log(`   AnimationManager.CSS í´ë˜ìŠ¤: ${Object.keys(AnimationManager.CSS).join(', ')}`, 'info');
        }
        
        // Test Data
        window.loadTestData = function() {
            log('ğŸ“¦ í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ...', 'info');
            rankingView.clearAllData();
            rankingView._cardsMap.clear();
            
            testEquipments = [
                { equipmentId: '1001', frontendId: 'EQ-17-01', status: 'RUN', productionCount: 85, targetCount: 100 },
                { equipmentId: '1002', frontendId: 'EQ-17-02', status: 'RUN', productionCount: 67, targetCount: 100 },
                { equipmentId: '1003', frontendId: 'EQ-17-03', status: 'RUN', productionCount: 92, targetCount: 100 },
                { equipmentId: '1004', frontendId: 'EQ-17-04', status: 'RUN', productionCount: 78, targetCount: 100 },
                { equipmentId: '1005', frontendId: 'EQ-18-01', status: 'IDLE', productionCount: 50, targetCount: 100 },
                { equipmentId: '1006', frontendId: 'EQ-18-02', status: 'IDLE', productionCount: 45, targetCount: 100 },
                { equipmentId: '1007', frontendId: 'EQ-18-03', status: 'IDLE', productionCount: 62, targetCount: 100 },
                { equipmentId: '1008', frontendId: 'EQ-19-01', status: 'STOP', productionCount: 33, targetCount: 100 },
                { equipmentId: '1009', frontendId: 'EQ-19-02', status: 'STOP', productionCount: 28, targetCount: 100 },
                { equipmentId: '1010', frontendId: 'EQ-17-05', status: 'STOP', productionCount: 41, targetCount: 100 },
                { equipmentId: '1011', frontendId: 'EQ-20-01', status: 'SUDDENSTOP', alarmCode: 1234, alarmMessage: 'SENSOR ERROR', productionCount: 72, targetCount: 100 },
                { equipmentId: '1012', frontendId: 'EQ-20-02', status: 'SUDDENSTOP', alarmCode: 5678, alarmMessage: 'MOTOR OVERHEAT', productionCount: 55, targetCount: 100 }
            ];
            
            testEquipments.forEach(eq => {
                eq.occurredAt = new Date(Date.now() - Math.random() * 3600000).toISOString();
                eq.equipmentName = `ì„¤ë¹„ ${eq.frontendId.split('-').slice(1).join('-')}`;
            });
            
            testEquipments.forEach(eq => {
                const laneId = getLaneId(eq.status);
                const card = rankingView.addEquipment(laneId, eq);
                if (card) rankingView._cardsMap.set(eq.frontendId, card);
            });
            
            if (animationManager) animationManager.setCardsMap(rankingView._cardsMap);
            log(`âœ… ${testEquipments.length}ê°œ ì„¤ë¹„ ë¡œë“œ ì™„ë£Œ`, 'success');
            updateStats();
        };
        
        window.clearAllData = function() {
            stopAutoMove();
            rankingView.clearAllData();
            rankingView._cardsMap.clear();
            testEquipments = [];
            log('ğŸ—‘ï¸ ì´ˆê¸°í™” ì™„ë£Œ', 'warning');
            updateStats();
        };
        
        function getLaneId(status) { return { 'RUN': 'run', 'IDLE': 'idle', 'STOP': 'stop', 'SUDDENSTOP': 'sudden-stop' }[status] || 'idle'; }
        function getStatus(laneId) { return { 'run': 'RUN', 'idle': 'IDLE', 'stop': 'STOP', 'sudden-stop': 'SUDDENSTOP' }[laneId] || 'IDLE'; }
        
        // Move Functions
        window.testMoveToRun = () => moveRandomTo('run');
        window.testMoveToIdle = () => moveRandomTo('idle');
        window.testMoveToStop = () => moveRandomTo('stop');
        window.testMoveToSuddenStop = () => moveRandomTo('sudden-stop');
        
        function moveRandomTo(targetLane) {
            if (isAnimating) { log('â³ ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ ì¤‘...', 'warning'); return; }
            const candidates = [];
            rankingView._lanes.forEach((lane, laneId) => {
                if (laneId !== targetLane) lane._cards.forEach((card, fid) => candidates.push({ fid, fromLane: laneId, card }));
            });
            if (candidates.length === 0) { log(`âš ï¸ ì´ë™ ëŒ€ìƒ ì—†ìŒ`, 'warning'); return; }
            const sel = candidates[Math.floor(Math.random() * candidates.length)];
            performMove(sel.fid, sel.fromLane, targetLane);
        }
        
        window.performRandomMove = function() {
            if (isAnimating) return;
            const lanes = ['run', 'idle', 'stop', 'sudden-stop'], all = [];
            rankingView._lanes.forEach((lane, lid) => { if (lanes.includes(lid)) lane._cards.forEach((card, fid) => all.push({ fid, fromLane: lid })); });
            if (all.length === 0) return;
            const sel = all[Math.floor(Math.random() * all.length)];
            const others = lanes.filter(l => l !== sel.fromLane);
            performMove(sel.fid, sel.fromLane, others[Math.floor(Math.random() * others.length)]);
        };
        
        async function performMove(frontendId, fromLane, toLane) {
            const useAnim = document.getElementById('use-animation').checked;
            const useSorting = document.getElementById('use-sorting').checked;
            const newStatus = getStatus(toLane);
            
            log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'divider');
            log(`ğŸš€ ${frontendId}: ${fromLane} â†’ ${toLane}`, 'move');
            
            const card = rankingView._cardsMap.get(frontendId);
            if (!card) { log(`âŒ ì¹´ë“œ ì—†ìŒ`, 'error'); return; }
            
            const currentData = card.getData();
            const newData = {
                ...currentData, status: newStatus, occurredAt: new Date().toISOString(),
                alarmCode: (toLane === 'run' || toLane === 'idle') ? null : (currentData.alarmCode || Math.floor(Math.random() * 9000) + 1000),
                alarmMessage: (toLane === 'run' || toLane === 'idle') ? null : 'AUTO TEST'
            };
            
            const toLaneComponent = rankingView._lanes.get(toLane);
            const fromLaneComponent = rankingView._lanes.get(fromLane);
            
            // âœ… í•µì‹¬: ê¸°ì¡´ RankingLane._findInsertIndex() ë©”ì„œë“œ ì‚¬ìš©
            let targetIndex = 0;
            if (useSorting && toLaneComponent && typeof toLaneComponent._findInsertIndex === 'function') {
                targetIndex = toLaneComponent._findInsertIndex(newData);
                log(`ğŸ“ RankingLane._findInsertIndex() í˜¸ì¶œ ê²°ê³¼: ${targetIndex}`, 'sort');
                log(`   sortKey: ${toLaneComponent._sortKey}, sortOrder: ${toLaneComponent._sortOrder}`, 'sort');
                log(`   productionCount: ${newData.productionCount}`, 'sort');
            } else {
                log(`âš ï¸ ì •ë ¬ ë¯¸ì‚¬ìš© ë˜ëŠ” ë©”ì„œë“œ ì—†ìŒ (targetIndex=0)`, 'warning');
            }
            
            if (useAnim && animationManager) {
                isAnimating = true;
                setAnimStatus('ì‹¤í–‰ ì¤‘...', true);
                log(`ğŸ¬ AnimationManager.animateLaneChange() í˜¸ì¶œ`, 'anim');
                log(`   targetIndex: ${targetIndex}`, 'anim');
                
                try {
                    await animationManager.animateLaneChange(frontendId, fromLane, toLane, {
                        targetIndex: targetIndex,
                        newData: newData,
                        onComplete: (el, data) => {
                            if (card.updateStatus) card.updateStatus(data, { resetDuration: true });
                            log(`   âœ… onComplete ì½œë°± ì‹¤í–‰ë¨`, 'anim');
                        }
                    });
                    
                    if (fromLaneComponent && toLaneComponent) {
                        fromLaneComponent._cards.delete(frontendId);
                        toLaneComponent._cards.set(frontendId, card);
                        fromLaneComponent._updateEmptyState();
                        fromLaneComponent._updateStats();
                        toLaneComponent._updateEmptyState();
                        toLaneComponent._updateStats();
                    }
                    log(`âœ… ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ`, 'success');
                } catch (err) {
                    log(`âŒ ì—ëŸ¬: ${err.message}`, 'error');
                    directMove(frontendId, fromLane, toLane, card, newData, targetIndex);
                } finally {
                    isAnimating = false;
                    setAnimStatus('ëŒ€ê¸° ì¤‘', false);
                }
            } else {
                directMove(frontendId, fromLane, toLane, card, newData, targetIndex);
            }
            updateStats();
        }
        
        function directMove(fid, from, to, card, newData, targetIndex) {
            log(`ğŸ“¦ ì§ì ‘ ì´ë™ (targetIndex=${targetIndex})`, 'info');
            card.updateStatus(newData, { resetDuration: true });
            const fromLane = rankingView._lanes.get(from), toLane = rankingView._lanes.get(to);
            if (fromLane && toLane) {
                fromLane._cards.delete(fid);
                toLane._cards.set(fid, card);
                const container = toLane._cardsContainer;
                if (targetIndex < container.children.length) container.insertBefore(card.element, container.children[targetIndex]);
                else container.appendChild(card.element);
                fromLane._updateEmptyState(); fromLane._updateStats();
                toLane._updateEmptyState(); toLane._updateStats();
            }
            log(`âœ… ì´ë™ ì™„ë£Œ`, 'success');
        }
        
        // Auto Move
        window.startAutoMove = function() {
            if (autoMoveInterval) return;
            const interval = parseInt(document.getElementById('auto-interval').value);
            autoMoveInterval = setInterval(() => { if (!isAnimating) { performRandomMove(); autoMoveCount++; document.getElementById('auto-count').textContent = `${autoMoveCount}íšŒ`; } }, interval);
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
            document.getElementById('auto-status').classList.add('active');
            document.getElementById('auto-status-text').textContent = 'ì‹¤í–‰ ì¤‘';
            log(`â–¶ï¸ ìë™ ì‹œì‘ (${interval}ms)`, 'success');
        };
        
        window.stopAutoMove = function() {
            if (autoMoveInterval) { clearInterval(autoMoveInterval); autoMoveInterval = null; }
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-stop').disabled = true;
            document.getElementById('auto-status').classList.remove('active');
            document.getElementById('auto-status-text').textContent = 'ì¤‘ì§€';
            log(`â¹ï¸ ìë™ ì¤‘ì§€ (${autoMoveCount}íšŒ)`, 'warning');
        };
        
        window.toggleAutoMove = () => autoMoveInterval ? stopAutoMove() : startAutoMove();
        
        function updateStats() {
            const s = { run: 0, idle: 0, stop: 0 };
            rankingView._lanes.forEach((lane, lid) => {
                const c = lane._cards.size;
                if (lid === 'run') s.run = c;
                else if (lid === 'idle') s.idle = c;
                else if (lid === 'stop' || lid === 'sudden-stop') s.stop += c;
            });
            document.getElementById('stat-run').textContent = s.run;
            document.getElementById('stat-idle').textContent = s.idle;
            document.getElementById('stat-stop').textContent = s.stop;
        }
        
        // Debug
        window.debugSnapshot = function() {
            log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'divider');
            log(`ğŸ“Š ìƒíƒœ ìŠ¤ëƒ…ìƒ·`, 'info');
            log(`_cardsMap: ${rankingView._cardsMap.size}ê°œ`, 'info');
            rankingView._lanes.forEach((lane, lid) => {
                if (lane._cards.size > 0) {
                    const prods = Array.from(lane._cards.values()).map(c => c.getData()?.productionCount || 0);
                    log(`  ${lid}: [${prods.join(' > ')}] (sortKey: ${lane._sortKey})`, 'info');
                }
            });
            log(`AnimationManager: ${animationManager?.isAnimating() ? 'ì‹¤í–‰ ì¤‘' : 'ëŒ€ê¸°'}`, 'info');
        };
        
        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            switch (e.key.toLowerCase()) {
                case 'd': e.preventDefault(); loadTestData(); break;
                case 'c': e.preventDefault(); clearAllData(); break;
                case 's': e.preventDefault(); debugSnapshot(); break;
                case '1': e.preventDefault(); testMoveToRun(); break;
                case '2': e.preventDefault(); testMoveToIdle(); break;
                case '3': e.preventDefault(); testMoveToStop(); break;
                case '4': e.preventDefault(); testMoveToSuddenStop(); break;
                case 'r': e.preventDefault(); performRandomMove(); break;
                case ' ': e.preventDefault(); toggleAutoMove(); break;
                case 'a': e.preventDefault(); const t = document.getElementById('use-animation'); t.checked = !t.checked; log(`ğŸ¬ ì• ë‹ˆë©”ì´ì…˜: ${t.checked ? 'ON' : 'OFF'}`); break;
                case 'h': e.preventDefault(); log(`âŒ¨ï¸ D=ë¡œë“œ C=ì´ˆê¸°í™” S=ìŠ¤ëƒ…ìƒ· 1-4=ì´ë™ R=ëœë¤ Space=ìë™ A=ì• ë‹ˆON/OFF`, 'info'); break;
            }
        });
        
        document.getElementById('auto-interval').addEventListener('input', (e) => {
            document.getElementById('interval-value').textContent = (e.target.value / 1000).toFixed(1) + 's';
            if (autoMoveInterval) { stopAutoMove(); startAutoMove(); }
        });
        
        // Start
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ v3.1 ë¡œë“œ', 'info');
            log('ğŸ”Œ ê¸°ì¡´ ëª¨ë“ˆ Full Import ëª¨ë“œ', 'success');
            init();
            log('ğŸ’¡ D=ë¡œë“œ, Space=ìë™, A=ì• ë‹ˆON/OFF', 'success');
        });
    </script>
</body>
</html>